"use strict";var $i=Object.defineProperty;var Qn=s=>{throw TypeError(s)};var eo=(s,e,t)=>e in s?$i(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var A=(s,e,t)=>eo(s,typeof e!="symbol"?e+"":e,t),cn=(s,e,t)=>e.has(s)||Qn("Cannot "+t);var S=(s,e,t)=>(cn(s,e,"read from private field"),t?t.call(s):e.get(s)),ke=(s,e,t)=>e.has(s)?Qn("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),ge=(s,e,t,a)=>(cn(s,e,"write to private field"),a?a.call(s,t):e.set(s,t),t),Qe=(s,e,t)=>(cn(s,e,"access private method"),t);const Bn=require("siyuan"),yn=!1;var Rr=Array.isArray,to=Array.prototype.indexOf,$a=Array.from,so=Object.defineProperty,aa=Object.getOwnPropertyDescriptor,ao=Object.getOwnPropertyDescriptors,no=Object.prototype,ro=Array.prototype,Br=Object.getPrototypeOf,Xn=Object.isExtensible;function io(s){for(var e=0;e<s.length;e++)s[e]()}function Fr(){var s,e,t=new Promise((a,n)=>{s=a,e=n});return{promise:t,resolve:s,reject:e}}function zr(s,e){if(Array.isArray(s))return s;if(!(Symbol.iterator in s))return Array.from(s);const t=[];for(const a of s)if(t.push(a),t.length===e)break;return t}const $e=2,Ga=4,en=8,jr=1<<24,us=16,ds=32,Ws=64,Fn=128,Ft=512,nt=1024,ft=2048,vs=4096,Et=8192,rs=16384,zn=32768,ua=65536,Jn=1<<17,Pr=1<<18,fa=1<<19,oo=1<<20,as=1<<25,Ys=32768,kn=1<<21,jn=1<<22,Ds=1<<23,ba=Symbol("$state"),lo=Symbol("legacy props"),co=Symbol(""),sa=new class extends Error{constructor(){super(...arguments);A(this,"name","StaleReactionError");A(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function Lr(s){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function uo(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function vo(s){throw new Error("https://svelte.dev/e/effect_in_teardown")}function ho(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function fo(s){throw new Error("https://svelte.dev/e/effect_orphan")}function _o(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function po(s){throw new Error("https://svelte.dev/e/props_invalid_value")}function mo(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function go(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function yo(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function ko(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const bo=1,wo=2,Kr=4,To=8,So=16,Do=1,Eo=4,Ao=8,xo=16,Co=1,Io=2,Xe=Symbol(),Mo="http://www.w3.org/1999/xhtml";function Oo(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function Ur(s){return s===this.v}function qo(s,e){return s!=s?e==e:s!==e||s!==null&&typeof s=="object"||typeof s=="function"}function Hr(s){return!qo(s,this.v)}let No=!1,yt=null;function da(s){yt=s}function Pe(s,e=!1,t){yt={p:yt,i:!1,c:null,e:null,s,x:null,l:null}}function Le(s){var e=yt,t=e.e;if(t!==null){e.e=null;for(var a of t)vi(a)}return e.i=!0,yt=e.p,{}}function Gr(){return!0}let qs=[];function Yr(){var s=qs;qs=[],io(s)}function _a(s){if(qs.length===0&&!wa){var e=qs;queueMicrotask(()=>{e===qs&&Yr()})}qs.push(s)}function Ro(){for(;qs.length>0;)Yr()}function Vr(s){var e=Ae;if(e===null)return pe.f|=Ds,s;if(e.f&zn)va(s,e);else{if(!(e.f&Fn))throw s;e.b.error(s)}}function va(s,e){for(;e!==null;){if(e.f&Fn)try{e.b.error(s);return}catch(t){s=t}e=e.parent}throw s}const Bo=-7169;function Ve(s,e){s.f=s.f&Bo|e}function Pn(s){s.f&Ft||s.deps===null?Ve(s,nt):Ve(s,vs)}function Wr(s){if(s!==null)for(const e of s)!(e.f&$e)||!(e.f&Ys)||(e.f^=Ys,Wr(e.deps))}function Qr(s,e,t){s.f&ft?e.add(s):s.f&vs&&t.add(s),Wr(s.deps),Ve(s,nt)}const Fa=new Set;let be=null,ja=null,Je=null,Rt=[],tn=null,bn=!1,wa=!1;var na,ra,Bs,Fs,Ca,ia,oa,zt,wn,Tn,Xr,Jr;const Xa=class Xa{constructor(){ke(this,zt);A(this,"committed",!1);A(this,"current",new Map);A(this,"previous",new Map);ke(this,na,new Set);ke(this,ra,new Set);ke(this,Bs,0);ke(this,Fs,0);ke(this,Ca,null);ke(this,ia,new Set);ke(this,oa,new Set);A(this,"skipped_effects",new Set);A(this,"is_fork",!1)}is_deferred(){return this.is_fork||S(this,Fs)>0}process(e){var n;Rt=[],ja=null,this.apply();var t=[],a=[];for(const i of e)Qe(this,zt,wn).call(this,i,t,a);this.is_fork||Qe(this,zt,Xr).call(this),this.is_deferred()?(Qe(this,zt,Tn).call(this,a),Qe(this,zt,Tn).call(this,t)):(ja=this,be=null,Zn(a),Zn(t),ja=null,(n=S(this,Ca))==null||n.resolve()),Je=null}capture(e,t){t!==Xe&&!this.previous.has(e)&&this.previous.set(e,t),e.f&Ds||(this.current.set(e,e.v),Je==null||Je.set(e,e.v))}activate(){be=this,this.apply()}deactivate(){be===this&&(be=null,Je=null)}flush(){if(this.activate(),Rt.length>0){if(Zr(),be!==null&&be!==this)return}else S(this,Bs)===0&&this.process([]);this.deactivate()}discard(){for(const e of S(this,ra))e(this);S(this,ra).clear()}increment(e){ge(this,Bs,S(this,Bs)+1),e&&ge(this,Fs,S(this,Fs)+1)}decrement(e){ge(this,Bs,S(this,Bs)-1),e&&ge(this,Fs,S(this,Fs)-1),this.revive()}revive(){for(const e of S(this,ia))S(this,oa).delete(e),Ve(e,ft),os(e);for(const e of S(this,oa))Ve(e,vs),os(e);this.flush()}oncommit(e){S(this,na).add(e)}ondiscard(e){S(this,ra).add(e)}settled(){return(S(this,Ca)??ge(this,Ca,Fr())).promise}static ensure(){if(be===null){const e=be=new Xa;Fa.add(be),wa||Xa.enqueue(()=>{be===e&&e.flush()})}return be}static enqueue(e){_a(e)}apply(){}};na=new WeakMap,ra=new WeakMap,Bs=new WeakMap,Fs=new WeakMap,Ca=new WeakMap,ia=new WeakMap,oa=new WeakMap,zt=new WeakSet,wn=function(e,t,a){e.f^=nt;for(var n=e.first,i=null;n!==null;){var o=n.f,c=(o&(ds|Ws))!==0,l=c&&(o&nt)!==0,u=l||(o&Et)!==0||this.skipped_effects.has(n);if(!u&&n.fn!==null){c?n.f^=nt:i!==null&&o&(Ga|en|jr)?i.b.defer_effect(n):o&Ga?t.push(n):qa(n)&&(o&us&&S(this,ia).add(n),Ea(n));var h=n.first;if(h!==null){n=h;continue}}var p=n.parent;for(n=n.next;n===null&&p!==null;)p===i&&(i=null),n=p.next,p=p.parent}},Tn=function(e){for(var t=0;t<e.length;t+=1)Qr(e[t],S(this,ia),S(this,oa))},Xr=function(){if(S(this,Fs)===0){for(const e of S(this,na))e();S(this,na).clear()}S(this,Bs)===0&&Qe(this,zt,Jr).call(this)},Jr=function(){var n;if(Fa.size>1){this.previous.clear();var e=Je,t=!0;for(const i of Fa){if(i===this){t=!1;continue}const o=[];for(const[l,u]of this.current){if(i.current.has(l))if(t&&u!==i.current.get(l))i.current.set(l,u);else continue;o.push(l)}if(o.length===0)continue;const c=[...i.current.keys()].filter(l=>!this.current.has(l));if(c.length>0){var a=Rt;Rt=[];const l=new Set,u=new Map;for(const h of o)$r(h,c,l,u);if(Rt.length>0){be=i,i.apply();for(const h of Rt)Qe(n=i,zt,wn).call(n,h,[],[]);i.deactivate()}Rt=a}}be=null,Je=e}this.committed=!0,Fa.delete(this)};let ns=Xa;function Fo(s){var e=wa;wa=!0;try{for(var t;;){if(Ro(),Rt.length===0&&(be==null||be.flush(),Rt.length===0))return tn=null,t;Zr()}}finally{wa=e}}function Zr(){var s=Us;bn=!0;var e=null;try{var t=0;for(Va(!0);Rt.length>0;){var a=ns.ensure();if(t++>1e3){var n,i;zo()}a.process(Rt),Es.clear()}}finally{bn=!1,Va(s),tn=null}}function zo(){try{_o()}catch(s){va(s,tn)}}let Pt=null;function Zn(s){var e=s.length;if(e!==0){for(var t=0;t<e;){var a=s[t++];if(!(a.f&(rs|Et))&&qa(a)&&(Pt=new Set,Ea(a),a.deps===null&&a.first===null&&a.nodes===null&&(a.teardown===null&&a.ac===null?pi(a):a.fn=null),(Pt==null?void 0:Pt.size)>0)){Es.clear();for(const n of Pt){if(n.f&(rs|Et))continue;const i=[n];let o=n.parent;for(;o!==null;)Pt.has(o)&&(Pt.delete(o),i.push(o)),o=o.parent;for(let c=i.length-1;c>=0;c--){const l=i[c];l.f&(rs|Et)||Ea(l)}}Pt.clear()}}Pt=null}}function $r(s,e,t,a){if(!t.has(s)&&(t.add(s),s.reactions!==null))for(const n of s.reactions){const i=n.f;i&$e?$r(n,e,t,a):i&(jn|us)&&!(i&ft)&&ei(n,e,a)&&(Ve(n,ft),os(n))}}function ei(s,e,t){const a=t.get(s);if(a!==void 0)return a;if(s.deps!==null)for(const n of s.deps){if(e.includes(n))return!0;if(n.f&$e&&ei(n,e,t))return t.set(n,!0),!0}return t.set(s,!1),!1}function os(s){for(var e=tn=s;e.parent!==null;){e=e.parent;var t=e.f;if(bn&&e===Ae&&t&us&&!(t&Pr))return;if(t&(Ws|ds)){if(!(t&nt))return;e.f^=nt}}Rt.push(e)}function jo(s){let e=0,t=Vs(0),a;return()=>{Kn()&&(r(t),nn(()=>(e===0&&(a=Qs(()=>s(()=>Ta(t)))),e+=1,()=>{_a(()=>{e-=1,e===0&&(a==null||a(),a=void 0,Ta(t))})})))}}var Po=ua|fa|Fn;function Lo(s,e,t){new Ko(s,e,t)}var qt,Rn,Wt,zs,Qt,Nt,_t,Xt,ss,bs,js,ws,Ps,la,ca,Ts,Ja,Ye,Uo,Ho,Sn,Pa,La,Dn;class Ko{constructor(e,t,a){ke(this,Ye);A(this,"parent");A(this,"is_pending",!1);ke(this,qt);ke(this,Rn,null);ke(this,Wt);ke(this,zs);ke(this,Qt);ke(this,Nt,null);ke(this,_t,null);ke(this,Xt,null);ke(this,ss,null);ke(this,bs,null);ke(this,js,0);ke(this,ws,0);ke(this,Ps,!1);ke(this,la,new Set);ke(this,ca,new Set);ke(this,Ts,null);ke(this,Ja,jo(()=>(ge(this,Ts,Vs(S(this,js))),()=>{ge(this,Ts,null)})));ge(this,qt,e),ge(this,Wt,t),ge(this,zs,a),this.parent=Ae.b,this.is_pending=!!S(this,Wt).pending,ge(this,Qt,Un(()=>{Ae.b=this;{var n=Qe(this,Ye,Sn).call(this);try{ge(this,Nt,Bt(()=>a(n)))}catch(i){this.error(i)}S(this,ws)>0?Qe(this,Ye,La).call(this):this.is_pending=!1}return()=>{var i;(i=S(this,bs))==null||i.remove()}},Po))}defer_effect(e){Qr(e,S(this,la),S(this,ca))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!S(this,Wt).pending}update_pending_count(e){Qe(this,Ye,Dn).call(this,e),ge(this,js,S(this,js)+e),S(this,Ts)&&ha(S(this,Ts),S(this,js))}get_effect_pending(){return S(this,Ja).call(this),r(S(this,Ts))}error(e){var t=S(this,Wt).onerror;let a=S(this,Wt).failed;if(S(this,Ps)||!t&&!a)throw e;S(this,Nt)&&(gt(S(this,Nt)),ge(this,Nt,null)),S(this,_t)&&(gt(S(this,_t)),ge(this,_t,null)),S(this,Xt)&&(gt(S(this,Xt)),ge(this,Xt,null));var n=!1,i=!1;const o=()=>{if(n){Oo();return}n=!0,i&&ko(),ns.ensure(),ge(this,js,0),S(this,Xt)!==null&&Ks(S(this,Xt),()=>{ge(this,Xt,null)}),this.is_pending=this.has_pending_snippet(),ge(this,Nt,Qe(this,Ye,Pa).call(this,()=>(ge(this,Ps,!1),Bt(()=>S(this,zs).call(this,S(this,qt)))))),S(this,ws)>0?Qe(this,Ye,La).call(this):this.is_pending=!1};var c=pe;try{pt(null),i=!0,t==null||t(e,o),i=!1}catch(l){va(l,S(this,Qt)&&S(this,Qt).parent)}finally{pt(c)}a&&_a(()=>{ge(this,Xt,Qe(this,Ye,Pa).call(this,()=>{ns.ensure(),ge(this,Ps,!0);try{return Bt(()=>{a(S(this,qt),()=>e,()=>o)})}catch(l){return va(l,S(this,Qt).parent),null}finally{ge(this,Ps,!1)}}))})}}qt=new WeakMap,Rn=new WeakMap,Wt=new WeakMap,zs=new WeakMap,Qt=new WeakMap,Nt=new WeakMap,_t=new WeakMap,Xt=new WeakMap,ss=new WeakMap,bs=new WeakMap,js=new WeakMap,ws=new WeakMap,Ps=new WeakMap,la=new WeakMap,ca=new WeakMap,Ts=new WeakMap,Ja=new WeakMap,Ye=new WeakSet,Uo=function(){try{ge(this,Nt,Bt(()=>S(this,zs).call(this,S(this,qt))))}catch(e){this.error(e)}},Ho=function(){const e=S(this,Wt).pending;e&&(ge(this,_t,Bt(()=>e(S(this,qt)))),ns.enqueue(()=>{var t=Qe(this,Ye,Sn).call(this);ge(this,Nt,Qe(this,Ye,Pa).call(this,()=>(ns.ensure(),Bt(()=>S(this,zs).call(this,t))))),S(this,ws)>0?Qe(this,Ye,La).call(this):(Ks(S(this,_t),()=>{ge(this,_t,null)}),this.is_pending=!1)}))},Sn=function(){var e=S(this,qt);return this.is_pending&&(ge(this,bs,is()),S(this,qt).before(S(this,bs)),e=S(this,bs)),e},Pa=function(e){var t=Ae,a=pe,n=yt;Zt(S(this,Qt)),pt(S(this,Qt)),da(S(this,Qt).ctx);try{return e()}catch(i){return Vr(i),null}finally{Zt(t),pt(a),da(n)}},La=function(){const e=S(this,Wt).pending;S(this,Nt)!==null&&(ge(this,ss,document.createDocumentFragment()),S(this,ss).append(S(this,bs)),yi(S(this,Nt),S(this,ss))),S(this,_t)===null&&ge(this,_t,Bt(()=>e(S(this,qt))))},Dn=function(e){var t;if(!this.has_pending_snippet()){this.parent&&Qe(t=this.parent,Ye,Dn).call(t,e);return}if(ge(this,ws,S(this,ws)+e),S(this,ws)===0){this.is_pending=!1;for(const a of S(this,la))Ve(a,ft),os(a);for(const a of S(this,ca))Ve(a,vs),os(a);S(this,la).clear(),S(this,ca).clear(),S(this,_t)&&Ks(S(this,_t),()=>{ge(this,_t,null)}),S(this,ss)&&(S(this,qt).before(S(this,ss)),ge(this,ss,null))}};function Go(s,e,t,a){const n=sn;if(t.length===0&&s.length===0){a(e.map(n));return}var i=be,o=Ae,c=Yo();function l(){Promise.all(t.map(u=>Vo(u))).then(u=>{c();try{a([...e.map(n),...u])}catch(h){o.f&rs||va(h,o)}i==null||i.deactivate(),Ya()}).catch(u=>{va(u,o)})}s.length>0?Promise.all(s).then(()=>{c();try{return l()}finally{i==null||i.deactivate(),Ya()}}):l()}function Yo(){var s=Ae,e=pe,t=yt,a=be;return function(i=!0){Zt(s),pt(e),da(t),i&&(a==null||a.activate())}}function Ya(){Zt(null),pt(null),da(null)}function sn(s){var e=$e|ft,t=pe!==null&&pe.f&$e?pe:null;return Ae!==null&&(Ae.f|=fa),{ctx:yt,deps:null,effects:null,equals:Ur,f:e,fn:s,reactions:null,rv:0,v:Xe,wv:0,parent:t??Ae,ac:null}}function Vo(s,e,t){let a=Ae;a===null&&uo();var n=a.b,i=void 0,o=Vs(Xe),c=!pe,l=new Map;return nl(()=>{var k;var u=Fr();i=u.promise;try{Promise.resolve(s()).then(u.resolve,u.reject).then(()=>{h===be&&h.committed&&h.deactivate(),Ya()})}catch(x){u.reject(x),Ya()}var h=be;if(c){var p=n.is_rendered();n.update_pending_count(1),h.increment(p),(k=l.get(h))==null||k.reject(sa),l.delete(h),l.set(h,u)}const f=(x,T=void 0)=>{if(h.activate(),T)T!==sa&&(o.f|=Ds,ha(o,T));else{o.f&Ds&&(o.f^=Ds),ha(o,x);for(const[m,g]of l){if(l.delete(m),m===h)break;g.reject(sa)}}c&&(n.update_pending_count(-1),h.decrement(p))};u.promise.then(f,x=>f(null,x||"unknown"))}),di(()=>{for(const u of l.values())u.reject(sa)}),new Promise(u=>{function h(p){function f(){p===i?u(o):h(i)}p.then(f,f)}h(i)})}function Y(s){const e=sn(s);return ki(e),e}function ti(s){const e=sn(s);return e.equals=Hr,e}function si(s){var e=s.effects;if(e!==null){s.effects=null;for(var t=0;t<e.length;t+=1)gt(e[t])}}function Wo(s){for(var e=s.parent;e!==null;){if(!(e.f&$e))return e.f&rs?null:e;e=e.parent}return null}function Ln(s){var e,t=Ae;Zt(Wo(s));try{s.f&=~Ys,si(s),e=Si(s)}finally{Zt(t)}return e}function ai(s){var e=Ln(s);if(!s.equals(e)&&(s.wv=wi(),(!(be!=null&&be.is_fork)||s.deps===null)&&(s.v=e,s.deps===null))){Ve(s,nt);return}As||(Je!==null?(Kn()||be!=null&&be.is_fork)&&Je.set(s,e):Pn(s))}let En=new Set;const Es=new Map;let ni=!1;function Vs(s,e){var t={f:0,v:s,reactions:null,equals:Ur,rv:0,wv:0};return t}function X(s,e){const t=Vs(s);return ki(t),t}function Qo(s,e=!1,t=!0){const a=Vs(s);return e||(a.equals=Hr),a}function _(s,e,t=!1){pe!==null&&(!Kt||pe.f&Jn)&&Gr()&&pe.f&($e|us|jn|Jn)&&!(ht!=null&&ht.includes(s))&&yo();let a=t?fe(e):e;return ha(s,a)}function ha(s,e){if(!s.equals(e)){var t=s.v;As?Es.set(s,e):Es.set(s,t),s.v=e;var a=ns.ensure();if(a.capture(s,t),s.f&$e){const n=s;s.f&ft&&Ln(n),Pn(n)}s.wv=wi(),ri(s,ft),Ae!==null&&Ae.f&nt&&!(Ae.f&(ds|Ws))&&(Ot===null?il([s]):Ot.push(s)),!a.is_fork&&En.size>0&&!ni&&Xo()}return e}function Xo(){ni=!1;var s=Us;Va(!0);const e=Array.from(En);try{for(const t of e)t.f&nt&&Ve(t,vs),qa(t)&&Ea(t)}finally{Va(s)}En.clear()}function $n(s,e=1){var t=r(s),a=e===1?t++:t--;return _(s,t),a}function Ta(s){_(s,s.v+1)}function ri(s,e){var t=s.reactions;if(t!==null)for(var a=t.length,n=0;n<a;n++){var i=t[n],o=i.f,c=(o&ft)===0;if(c&&Ve(i,e),o&$e){var l=i;Je==null||Je.delete(l),o&Ys||(o&Ft&&(i.f|=Ys),ri(l,vs))}else c&&(o&us&&Pt!==null&&Pt.add(i),os(i))}}function fe(s){if(typeof s!="object"||s===null||ba in s)return s;const e=Br(s);if(e!==no&&e!==ro)return s;var t=new Map,a=Rr(s),n=X(0),i=Hs,o=c=>{if(Hs===i)return c();var l=pe,u=Hs;pt(null),ar(i);var h=c();return pt(l),ar(u),h};return a&&t.set("length",X(s.length)),new Proxy(s,{defineProperty(c,l,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&mo();var h=t.get(l);return h===void 0?h=o(()=>{var p=X(u.value);return t.set(l,p),p}):_(h,u.value,!0),!0},deleteProperty(c,l){var u=t.get(l);if(u===void 0){if(l in c){const h=o(()=>X(Xe));t.set(l,h),Ta(n)}}else _(u,Xe),Ta(n);return!0},get(c,l,u){var k;if(l===ba)return s;var h=t.get(l),p=l in c;if(h===void 0&&(!p||(k=aa(c,l))!=null&&k.writable)&&(h=o(()=>{var x=fe(p?c[l]:Xe),T=X(x);return T}),t.set(l,h)),h!==void 0){var f=r(h);return f===Xe?void 0:f}return Reflect.get(c,l,u)},getOwnPropertyDescriptor(c,l){var u=Reflect.getOwnPropertyDescriptor(c,l);if(u&&"value"in u){var h=t.get(l);h&&(u.value=r(h))}else if(u===void 0){var p=t.get(l),f=p==null?void 0:p.v;if(p!==void 0&&f!==Xe)return{enumerable:!0,configurable:!0,value:f,writable:!0}}return u},has(c,l){var f;if(l===ba)return!0;var u=t.get(l),h=u!==void 0&&u.v!==Xe||Reflect.has(c,l);if(u!==void 0||Ae!==null&&(!h||(f=aa(c,l))!=null&&f.writable)){u===void 0&&(u=o(()=>{var k=h?fe(c[l]):Xe,x=X(k);return x}),t.set(l,u));var p=r(u);if(p===Xe)return!1}return h},set(c,l,u,h){var w;var p=t.get(l),f=l in c;if(a&&l==="length")for(var k=u;k<p.v;k+=1){var x=t.get(k+"");x!==void 0?_(x,Xe):k in c&&(x=o(()=>X(Xe)),t.set(k+"",x))}if(p===void 0)(!f||(w=aa(c,l))!=null&&w.writable)&&(p=o(()=>X(void 0)),_(p,fe(u)),t.set(l,p));else{f=p.v!==Xe;var T=o(()=>fe(u));_(p,T)}var m=Reflect.getOwnPropertyDescriptor(c,l);if(m!=null&&m.set&&m.set.call(h,u),!f){if(a&&typeof l=="string"){var g=t.get("length"),M=Number(l);Number.isInteger(M)&&M>=g.v&&_(g,M+1)}Ta(n)}return!0},ownKeys(c){r(n);var l=Reflect.ownKeys(c).filter(p=>{var f=t.get(p);return f===void 0||f.v!==Xe});for(var[u,h]of t)h.v!==Xe&&!(u in c)&&l.push(u);return l},setPrototypeOf(){go()}})}var er,ii,oi,li;function Jo(){if(er===void 0){er=window,ii=/Firefox/.test(navigator.userAgent);var s=Element.prototype,e=Node.prototype,t=Text.prototype;oi=aa(e,"firstChild").get,li=aa(e,"nextSibling").get,Xn(s)&&(s.__click=void 0,s.__className=void 0,s.__attributes=null,s.__style=void 0,s.__e=void 0),Xn(t)&&(t.__t=void 0)}}function is(s=""){return document.createTextNode(s)}function Ss(s){return oi.call(s)}function Oa(s){return li.call(s)}function d(s,e){return Ss(s)}function Me(s,e=!1){{var t=Ss(s);return t instanceof Comment&&t.data===""?Oa(t):t}}function v(s,e=1,t=!1){let a=s;for(;e--;)a=Oa(a);return a}function Zo(s){s.textContent=""}function ci(){return!1}let tr=!1;function $o(){tr||(tr=!0,document.addEventListener("reset",s=>{Promise.resolve().then(()=>{var e;if(!s.defaultPrevented)for(const t of s.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function an(s){var e=pe,t=Ae;pt(null),Zt(null);try{return s()}finally{pt(e),Zt(t)}}function ui(s,e,t,a=t){s.addEventListener(e,()=>an(t));const n=s.__on_r;n?s.__on_r=()=>{n(),a(!0)}:s.__on_r=()=>a(!0),$o()}function el(s){Ae===null&&(pe===null&&fo(),ho()),As&&vo()}function tl(s,e){var t=e.last;t===null?e.last=e.first=s:(t.next=s,s.prev=t,e.last=s)}function hs(s,e,t){var a=Ae;a!==null&&a.f&Et&&(s|=Et);var n={ctx:yt,deps:null,nodes:null,f:s|ft|Ft,first:null,fn:e,last:null,next:null,parent:a,b:a&&a.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{Ea(n),n.f|=zn}catch(c){throw gt(n),c}else e!==null&&os(n);var i=n;if(t&&i.deps===null&&i.teardown===null&&i.nodes===null&&i.first===i.last&&!(i.f&fa)&&(i=i.first,s&us&&s&ua&&i!==null&&(i.f|=ua)),i!==null&&(i.parent=a,a!==null&&tl(i,a),pe!==null&&pe.f&$e&&!(s&Ws))){var o=pe;(o.effects??(o.effects=[])).push(i)}return n}function Kn(){return pe!==null&&!Kt}function di(s){const e=hs(en,null,!1);return Ve(e,nt),e.teardown=s,e}function vt(s){el();var e=Ae.f,t=!pe&&(e&ds)!==0&&(e&zn)===0;if(t){var a=yt;(a.e??(a.e=[])).push(s)}else return vi(s)}function vi(s){return hs(Ga|oo,s,!1)}function sl(s){ns.ensure();const e=hs(Ws|fa,s,!0);return(t={})=>new Promise(a=>{t.outro?Ks(e,()=>{gt(e),a(void 0)}):(gt(e),a(void 0))})}function al(s){return hs(Ga,s,!1)}function nl(s){return hs(jn|fa,s,!0)}function nn(s,e=0){return hs(en|e,s,!0)}function U(s,e=[],t=[],a=[]){Go(a,e,t,n=>{hs(en,()=>s(...n.map(r)),!0)})}function Un(s,e=0){var t=hs(us|e,s,!0);return t}function Bt(s){return hs(ds|fa,s,!0)}function hi(s){var e=s.teardown;if(e!==null){const t=As,a=pe;sr(!0),pt(null);try{e.call(null)}finally{sr(t),pt(a)}}}function fi(s,e=!1){var t=s.first;for(s.first=s.last=null;t!==null;){const n=t.ac;n!==null&&an(()=>{n.abort(sa)});var a=t.next;t.f&Ws?t.parent=null:gt(t,e),t=a}}function rl(s){for(var e=s.first;e!==null;){var t=e.next;e.f&ds||gt(e),e=t}}function gt(s,e=!0){var t=!1;(e||s.f&Pr)&&s.nodes!==null&&s.nodes.end!==null&&(_i(s.nodes.start,s.nodes.end),t=!0),fi(s,e&&!t),Wa(s,0),Ve(s,rs);var a=s.nodes&&s.nodes.t;if(a!==null)for(const i of a)i.stop();hi(s);var n=s.parent;n!==null&&n.first!==null&&pi(s),s.next=s.prev=s.teardown=s.ctx=s.deps=s.fn=s.nodes=s.ac=null}function _i(s,e){for(;s!==null;){var t=s===e?null:Oa(s);s.remove(),s=t}}function pi(s){var e=s.parent,t=s.prev,a=s.next;t!==null&&(t.next=a),a!==null&&(a.prev=t),e!==null&&(e.first===s&&(e.first=a),e.last===s&&(e.last=t))}function Ks(s,e,t=!0){var a=[];mi(s,a,!0);var n=()=>{t&&gt(s),e&&e()},i=a.length;if(i>0){var o=()=>--i||n();for(var c of a)c.out(o)}else n()}function mi(s,e,t){if(!(s.f&Et)){s.f^=Et;var a=s.nodes&&s.nodes.t;if(a!==null)for(const c of a)(c.is_global||t)&&e.push(c);for(var n=s.first;n!==null;){var i=n.next,o=(n.f&ua)!==0||(n.f&ds)!==0&&(s.f&us)!==0;mi(n,e,o?t:!1),n=i}}}function Hn(s){gi(s,!0)}function gi(s,e){if(s.f&Et){s.f^=Et,s.f&nt||(Ve(s,ft),os(s));for(var t=s.first;t!==null;){var a=t.next,n=(t.f&ua)!==0||(t.f&ds)!==0;gi(t,n?e:!1),t=a}var i=s.nodes&&s.nodes.t;if(i!==null)for(const o of i)(o.is_global||e)&&o.in()}}function yi(s,e){if(s.nodes)for(var t=s.nodes.start,a=s.nodes.end;t!==null;){var n=t===a?null:Oa(t);e.append(t),t=n}}let Us=!1;function Va(s){Us=s}let As=!1;function sr(s){As=s}let pe=null,Kt=!1;function pt(s){pe=s}let Ae=null;function Zt(s){Ae=s}let ht=null;function ki(s){pe!==null&&(ht===null?ht=[s]:ht.push(s))}let dt=null,Tt=0,Ot=null;function il(s){Ot=s}let bi=1,Da=0,Hs=Da;function ar(s){Hs=s}function wi(){return++bi}function qa(s){var e=s.f;if(e&ft)return!0;if(e&$e&&(s.f&=~Ys),e&vs){for(var t=s.deps,a=t.length,n=0;n<a;n++){var i=t[n];if(qa(i)&&ai(i),i.wv>s.wv)return!0}e&Ft&&Je===null&&Ve(s,nt)}return!1}function Ti(s,e,t=!0){var a=s.reactions;if(a!==null&&!(ht!=null&&ht.includes(s)))for(var n=0;n<a.length;n++){var i=a[n];i.f&$e?Ti(i,e,!1):e===i&&(t?Ve(i,ft):i.f&nt&&Ve(i,vs),os(i))}}function Si(s){var x;var e=dt,t=Tt,a=Ot,n=pe,i=ht,o=yt,c=Kt,l=Hs,u=s.f;dt=null,Tt=0,Ot=null,pe=u&(ds|Ws)?null:s,ht=null,da(s.ctx),Kt=!1,Hs=++Da,s.ac!==null&&(an(()=>{s.ac.abort(sa)}),s.ac=null);try{s.f|=kn;var h=s.fn,p=h(),f=s.deps;if(dt!==null){var k;if(Wa(s,Tt),f!==null&&Tt>0)for(f.length=Tt+dt.length,k=0;k<dt.length;k++)f[Tt+k]=dt[k];else s.deps=f=dt;if(Kn()&&s.f&Ft)for(k=Tt;k<f.length;k++)((x=f[k]).reactions??(x.reactions=[])).push(s)}else f!==null&&Tt<f.length&&(Wa(s,Tt),f.length=Tt);if(Gr()&&Ot!==null&&!Kt&&f!==null&&!(s.f&($e|vs|ft)))for(k=0;k<Ot.length;k++)Ti(Ot[k],s);return n!==null&&n!==s&&(Da++,Ot!==null&&(a===null?a=Ot:a.push(...Ot))),s.f&Ds&&(s.f^=Ds),p}catch(T){return Vr(T)}finally{s.f^=kn,dt=e,Tt=t,Ot=a,pe=n,ht=i,da(o),Kt=c,Hs=l}}function ol(s,e){let t=e.reactions;if(t!==null){var a=to.call(t,s);if(a!==-1){var n=t.length-1;n===0?t=e.reactions=null:(t[a]=t[n],t.pop())}}if(t===null&&e.f&$e&&(dt===null||!dt.includes(e))){var i=e;i.f&Ft&&(i.f^=Ft,i.f&=~Ys),Pn(i),si(i),Wa(i,0)}}function Wa(s,e){var t=s.deps;if(t!==null)for(var a=e;a<t.length;a++)ol(s,t[a])}function Ea(s){var e=s.f;if(!(e&rs)){Ve(s,nt);var t=Ae,a=Us;Ae=s,Us=!0;try{e&(us|jr)?rl(s):fi(s),hi(s);var n=Si(s);s.teardown=typeof n=="function"?n:null,s.wv=bi;var i;yn&&No&&s.f&ft&&s.deps}finally{Us=a,Ae=t}}}async function Di(){await Promise.resolve(),Fo()}function r(s){var e=s.f,t=(e&$e)!==0;if(pe!==null&&!Kt){var a=Ae!==null&&(Ae.f&rs)!==0;if(!a&&!(ht!=null&&ht.includes(s))){var n=pe.deps;if(pe.f&kn)s.rv<Da&&(s.rv=Da,dt===null&&n!==null&&n[Tt]===s?Tt++:dt===null?dt=[s]:dt.includes(s)||dt.push(s));else{(pe.deps??(pe.deps=[])).push(s);var i=s.reactions;i===null?s.reactions=[pe]:i.includes(pe)||i.push(pe)}}}if(As&&Es.has(s))return Es.get(s);if(t){var o=s;if(As){var c=o.v;return(!(o.f&nt)&&o.reactions!==null||Ai(o))&&(c=Ln(o)),Es.set(o,c),c}var l=(o.f&Ft)===0&&!Kt&&pe!==null&&(Us||(pe.f&Ft)!==0),u=o.deps===null;qa(o)&&(l&&(o.f|=Ft),ai(o)),l&&!u&&Ei(o)}if(Je!=null&&Je.has(s))return Je.get(s);if(s.f&Ds)throw s.v;return s.v}function Ei(s){if(s.deps!==null){s.f|=Ft;for(const e of s.deps)(e.reactions??(e.reactions=[])).push(s),e.f&$e&&!(e.f&Ft)&&Ei(e)}}function Ai(s){if(s.v===Xe)return!0;if(s.deps===null)return!1;for(const e of s.deps)if(Es.has(e)||e.f&$e&&Ai(e))return!0;return!1}function Qs(s){var e=Kt;try{return Kt=!0,s()}finally{Kt=e}}const ll=["touchstart","touchmove"];function cl(s){return ll.includes(s)}const xi=new Set,An=new Set;function ul(s,e,t,a={}){function n(i){if(a.capture||ya.call(e,i),!i.cancelBubble)return an(()=>t==null?void 0:t.call(this,i))}return s.startsWith("pointer")||s.startsWith("touch")||s==="wheel"?_a(()=>{e.addEventListener(s,n,a)}):e.addEventListener(s,n,a),n}function Ze(s,e,t,a,n){var i={capture:a,passive:n},o=ul(s,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&di(()=>{e.removeEventListener(s,o,i)})}function rt(s){for(var e=0;e<s.length;e++)xi.add(s[e]);for(var t of An)t(s)}let nr=null;function ya(s){var m;var e=this,t=e.ownerDocument,a=s.type,n=((m=s.composedPath)==null?void 0:m.call(s))||[],i=n[0]||s.target;nr=s;var o=0,c=nr===s&&s.__root;if(c){var l=n.indexOf(c);if(l!==-1&&(e===document||e===window)){s.__root=e;return}var u=n.indexOf(e);if(u===-1)return;l<=u&&(o=l)}if(i=n[o]||s.target,i!==e){so(s,"currentTarget",{configurable:!0,get(){return i||t}});var h=pe,p=Ae;pt(null),Zt(null);try{for(var f,k=[];i!==null;){var x=i.assignedSlot||i.parentNode||i.host||null;try{var T=i["__"+a];T!=null&&(!i.disabled||s.target===i)&&T.call(i,s)}catch(g){f?k.push(g):f=g}if(s.cancelBubble||x===e||x===null)break;i=x}if(f){for(let g of k)queueMicrotask(()=>{throw g});throw f}}finally{s.__root=e,delete s.currentTarget,pt(h),Zt(p)}}}function Ci(s){var e=document.createElement("template");return e.innerHTML=s.replaceAll("<!>","<!---->"),e.content}function Aa(s,e){var t=Ae;t.nodes===null&&(t.nodes={start:s,end:e,a:null,t:null})}function I(s,e){var t=(e&Co)!==0,a=(e&Io)!==0,n,i=!s.startsWith("<!>");return()=>{n===void 0&&(n=Ci(i?s:"<!>"+s),t||(n=Ss(n)));var o=a||ii?document.importNode(n,!0):n.cloneNode(!0);if(t){var c=Ss(o),l=o.lastChild;Aa(c,l)}else Aa(o,o);return o}}function un(s=""){{var e=is(s+"");return Aa(e,e),e}}function Ge(){var s=document.createDocumentFragment(),e=document.createComment(""),t=is();return s.append(e,t),Aa(e,t),s}function y(s,e){s!==null&&s.before(e)}function F(s,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(s.__t??(s.__t=s.nodeValue))&&(s.__t=t,s.nodeValue=t+"")}function dn(s,e){return dl(s,e)}const ea=new Map;function dl(s,{target:e,anchor:t,props:a={},events:n,context:i,intro:o=!0}){Jo();var c=new Set,l=p=>{for(var f=0;f<p.length;f++){var k=p[f];if(!c.has(k)){c.add(k);var x=cl(k);e.addEventListener(k,ya,{passive:x});var T=ea.get(k);T===void 0?(document.addEventListener(k,ya,{passive:x}),ea.set(k,1)):ea.set(k,T+1)}}};l($a(xi)),An.add(l);var u=void 0,h=sl(()=>{var p=t??e.appendChild(is());return Lo(p,{pending:()=>{}},f=>{if(i){Pe({});var k=yt;k.c=i}n&&(a.$$events=n),u=s(f,a)||{},i&&Le()}),()=>{var x;for(var f of c){e.removeEventListener(f,ya);var k=ea.get(f);--k===0?(document.removeEventListener(f,ya),ea.delete(f)):ea.set(f,k)}An.delete(l),p!==t&&((x=p.parentNode)==null||x.removeChild(p))}});return xn.set(u,h),u}let xn=new WeakMap;function vn(s,e){const t=xn.get(s);return t?(xn.delete(s),t(e)):Promise.resolve()}var Lt,Jt,St,Ls,Ia,Ma,Za;class vl{constructor(e,t=!0){A(this,"anchor");ke(this,Lt,new Map);ke(this,Jt,new Map);ke(this,St,new Map);ke(this,Ls,new Set);ke(this,Ia,!0);ke(this,Ma,()=>{var e=be;if(S(this,Lt).has(e)){var t=S(this,Lt).get(e),a=S(this,Jt).get(t);if(a)Hn(a),S(this,Ls).delete(t);else{var n=S(this,St).get(t);n&&(S(this,Jt).set(t,n.effect),S(this,St).delete(t),n.fragment.lastChild.remove(),this.anchor.before(n.fragment),a=n.effect)}for(const[i,o]of S(this,Lt)){if(S(this,Lt).delete(i),i===e)break;const c=S(this,St).get(o);c&&(gt(c.effect),S(this,St).delete(o))}for(const[i,o]of S(this,Jt)){if(i===t||S(this,Ls).has(i))continue;const c=()=>{if(Array.from(S(this,Lt).values()).includes(i)){var u=document.createDocumentFragment();yi(o,u),u.append(is()),S(this,St).set(i,{effect:o,fragment:u})}else gt(o);S(this,Ls).delete(i),S(this,Jt).delete(i)};S(this,Ia)||!a?(S(this,Ls).add(i),Ks(o,c,!1)):c()}}});ke(this,Za,e=>{S(this,Lt).delete(e);const t=Array.from(S(this,Lt).values());for(const[a,n]of S(this,St))t.includes(a)||(gt(n.effect),S(this,St).delete(a))});this.anchor=e,ge(this,Ia,t)}ensure(e,t){var a=be,n=ci();if(t&&!S(this,Jt).has(e)&&!S(this,St).has(e))if(n){var i=document.createDocumentFragment(),o=is();i.append(o),S(this,St).set(e,{effect:Bt(()=>t(o)),fragment:i})}else S(this,Jt).set(e,Bt(()=>t(this.anchor)));if(S(this,Lt).set(a,e),n){for(const[c,l]of S(this,Jt))c===e?a.skipped_effects.delete(l):a.skipped_effects.add(l);for(const[c,l]of S(this,St))c===e?a.skipped_effects.delete(l.effect):a.skipped_effects.add(l.effect);a.oncommit(S(this,Ma)),a.ondiscard(S(this,Za))}else S(this,Ma).call(this)}}Lt=new WeakMap,Jt=new WeakMap,St=new WeakMap,Ls=new WeakMap,Ia=new WeakMap,Ma=new WeakMap,Za=new WeakMap;function V(s,e,t=!1){var a=new vl(s),n=t?ua:0;function i(o,c){a.ensure(o,c)}Un(()=>{var o=!1;e((c,l=!0)=>{o=!0,i(l,c)}),o||i(!1,null)},n)}function mt(s,e){return e}function hl(s,e,t){for(var a=[],n=e.length,i,o=e.length,c=0;c<n;c++){let p=e[c];Ks(p,()=>{if(i){if(i.pending.delete(p),i.done.add(p),i.pending.size===0){var f=s.outrogroups;Cn($a(i.done)),f.delete(i),f.size===0&&(s.outrogroups=null)}}else o-=1},!1)}if(o===0){var l=a.length===0&&t!==null;if(l){var u=t,h=u.parentNode;Zo(h),h.append(u),s.items.clear()}Cn(e,!l)}else i={pending:new Set(e),done:new Set},(s.outrogroups??(s.outrogroups=new Set)).add(i)}function Cn(s,e=!0){for(var t=0;t<s.length;t++)gt(s[t],e)}var rr;function Ce(s,e,t,a,n,i=null){var o=s,c=new Map,l=(e&Kr)!==0;if(l){var u=s;o=u.appendChild(is())}var h=null,p=ti(()=>{var g=t();return Rr(g)?g:g==null?[]:$a(g)}),f,k=!0;function x(){m.fallback=h,fl(m,f,o,e,a),h!==null&&(f.length===0?h.f&as?(h.f^=as,ka(h,null,o)):Hn(h):Ks(h,()=>{h=null}))}var T=Un(()=>{f=r(p);for(var g=f.length,M=new Set,w=be,C=ci(),R=0;R<g;R+=1){var B=f[R],q=a(B,R),K=k?null:c.get(q);K?(K.v&&ha(K.v,B),K.i&&ha(K.i,R),C&&w.skipped_effects.delete(K.e)):(K=_l(c,k?o:rr??(rr=is()),B,q,R,n,e,t),k||(K.e.f|=as),c.set(q,K)),M.add(q)}if(g===0&&i&&!h&&(k?h=Bt(()=>i(o)):(h=Bt(()=>i(rr??(rr=is()))),h.f|=as)),!k)if(C){for(const[L,Q]of c)M.has(L)||w.skipped_effects.add(Q.e);w.oncommit(x),w.ondiscard(()=>{})}else x();r(p)}),m={effect:T,items:c,outrogroups:null,fallback:h};k=!1}function fl(s,e,t,a,n){var Q,$,H,te,oe,ie,j,E,P;var i=(a&To)!==0,o=e.length,c=s.items,l=s.effect.first,u,h=null,p,f=[],k=[],x,T,m,g;if(i)for(g=0;g<o;g+=1)x=e[g],T=n(x,g),m=c.get(T).e,m.f&as||(($=(Q=m.nodes)==null?void 0:Q.a)==null||$.measure(),(p??(p=new Set)).add(m));for(g=0;g<o;g+=1){if(x=e[g],T=n(x,g),m=c.get(T).e,s.outrogroups!==null)for(const ee of s.outrogroups)ee.pending.delete(m),ee.done.delete(m);if(m.f&as)if(m.f^=as,m===l)ka(m,null,t);else{var M=h?h.next:l;m===s.effect.last&&(s.effect.last=m.prev),m.prev&&(m.prev.next=m.next),m.next&&(m.next.prev=m.prev),ps(s,h,m),ps(s,m,M),ka(m,M,t),h=m,f=[],k=[],l=h.next;continue}if(m.f&Et&&(Hn(m),i&&((te=(H=m.nodes)==null?void 0:H.a)==null||te.unfix(),(p??(p=new Set)).delete(m))),m!==l){if(u!==void 0&&u.has(m)){if(f.length<k.length){var w=k[0],C;h=w.prev;var R=f[0],B=f[f.length-1];for(C=0;C<f.length;C+=1)ka(f[C],w,t);for(C=0;C<k.length;C+=1)u.delete(k[C]);ps(s,R.prev,B.next),ps(s,h,R),ps(s,B,w),l=w,h=B,g-=1,f=[],k=[]}else u.delete(m),ka(m,l,t),ps(s,m.prev,m.next),ps(s,m,h===null?s.effect.first:h.next),ps(s,h,m),h=m;continue}for(f=[],k=[];l!==null&&l!==m;)(u??(u=new Set)).add(l),k.push(l),l=l.next;if(l===null)continue}m.f&as||f.push(m),h=m,l=m.next}if(s.outrogroups!==null){for(const ee of s.outrogroups)ee.pending.size===0&&(Cn($a(ee.done)),(oe=s.outrogroups)==null||oe.delete(ee));s.outrogroups.size===0&&(s.outrogroups=null)}if(l!==null||u!==void 0){var q=[];if(u!==void 0)for(m of u)m.f&Et||q.push(m);for(;l!==null;)!(l.f&Et)&&l!==s.fallback&&q.push(l),l=l.next;var K=q.length;if(K>0){var L=a&Kr&&o===0?t:null;if(i){for(g=0;g<K;g+=1)(j=(ie=q[g].nodes)==null?void 0:ie.a)==null||j.measure();for(g=0;g<K;g+=1)(P=(E=q[g].nodes)==null?void 0:E.a)==null||P.fix()}hl(s,q,L)}}i&&_a(()=>{var ee,J;if(p!==void 0)for(m of p)(J=(ee=m.nodes)==null?void 0:ee.a)==null||J.apply()})}function _l(s,e,t,a,n,i,o,c){var l=o&bo?o&So?Vs(t):Qo(t,!1,!1):null,u=o&wo?Vs(n):null;return{v:l,i:u,e:Bt(()=>(i(e,l??t,u??n,c),()=>{s.delete(a)}))}}function ka(s,e,t){if(s.nodes)for(var a=s.nodes.start,n=s.nodes.end,i=e&&!(e.f&as)?e.nodes.start:t;a!==null;){var o=Oa(a);if(i.before(a),a===n)return;a=o}}function ps(s,e,t){e===null?s.effect.first=t:e.next=t,t===null?s.effect.last=e:t.prev=e}function pl(s,e,t=!1,a=!1,n=!1){var i=s,o="";U(()=>{var c=Ae;if(o!==(o=e()??"")&&(c.nodes!==null&&(_i(c.nodes.start,c.nodes.end),c.nodes=null),o!=="")){var l=o+"";t?l=`<svg>${l}</svg>`:a&&(l=`<math>${l}</math>`);var u=Ci(l);if((t||a)&&(u=Ss(u)),Aa(Ss(u),u.lastChild),t||a)for(;Ss(u);)i.before(Ss(u));else i.before(u)}})}function Ii(s){var e,t,a="";if(typeof s=="string"||typeof s=="number")a+=s;else if(typeof s=="object")if(Array.isArray(s)){var n=s.length;for(e=0;e<n;e++)s[e]&&(t=Ii(s[e]))&&(a&&(a+=" "),a+=t)}else for(t in s)s[t]&&(a&&(a+=" "),a+=t);return a}function ml(){for(var s,e,t=0,a="",n=arguments.length;t<n;t++)(s=arguments[t])&&(e=Ii(s))&&(a&&(a+=" "),a+=e);return a}function gl(s){return typeof s=="object"?ml(s):s??""}const ir=[...` 	
\r\f¬†\v\uFEFF`];function yl(s,e,t){var a=s==null?"":""+s;if(e&&(a=a?a+" "+e:e),t){for(var n in t)if(t[n])a=a?a+" "+n:n;else if(a.length)for(var i=n.length,o=0;(o=a.indexOf(n,o))>=0;){var c=o+i;(o===0||ir.includes(a[o-1]))&&(c===a.length||ir.includes(a[c]))?a=(o===0?"":a.substring(0,o))+a.substring(c+1):o=c}}return a===""?null:a}function kl(s,e){return s==null?null:String(s)}function Fe(s,e,t,a,n,i){var o=s.__className;if(o!==t||o===void 0){var c=yl(t,a,i);c==null?s.removeAttribute("class"):s.className=c,s.__className=t}else if(i&&n!==i)for(var l in i){var u=!!i[l];(n==null||u!==!!n[l])&&s.classList.toggle(l,u)}return i}function Gs(s,e,t,a){var n=s.__style;if(n!==e){var i=kl(e);i==null?s.removeAttribute("style"):s.style.cssText=i,s.__style=e}return a}const bl=Symbol("is custom element"),wl=Symbol("is html");function Mi(s,e){var t=Gn(s);t.value===(t.value=e??void 0)||s.value===e&&(e!==0||s.nodeName!=="PROGRESS")||(s.value=e??"")}function Sa(s,e){var t=Gn(s);t.checked!==(t.checked=e??void 0)&&(s.checked=e)}function Ie(s,e,t,a){var n=Gn(s);n[e]!==(n[e]=t)&&(e==="loading"&&(s[co]=t),t==null?s.removeAttribute(e):typeof t!="string"&&Tl(s).includes(e)?s[e]=t:s.setAttribute(e,t))}function Gn(s){return s.__attributes??(s.__attributes={[bl]:s.nodeName.includes("-"),[wl]:s.namespaceURI===Mo})}var or=new Map;function Tl(s){var e=s.getAttribute("is")||s.nodeName,t=or.get(e);if(t)return t;or.set(e,t=[]);for(var a,n=s,i=Element.prototype;i!==n;){a=ao(n);for(var o in a)a[o].set&&t.push(o);n=Br(n)}return t}function Dt(s,e,t=e){var a=new WeakSet;ui(s,"input",async n=>{var i=n?s.defaultValue:s.value;if(i=hn(s)?fn(i):i,t(i),be!==null&&a.add(be),await Di(),i!==(i=e())){var o=s.selectionStart,c=s.selectionEnd,l=s.value.length;if(s.value=i??"",c!==null){var u=s.value.length;o===c&&c===l&&u>l?(s.selectionStart=u,s.selectionEnd=u):(s.selectionStart=o,s.selectionEnd=Math.min(c,u))}}}),Qs(e)==null&&s.value&&(t(hn(s)?fn(s.value):s.value),be!==null&&a.add(be)),nn(()=>{var n=e();if(s===document.activeElement){var i=ja??be;if(a.has(i))return}hn(s)&&n===fn(s.value)||s.type==="date"&&!n&&!s.value||n!==s.value&&(s.value=n??"")})}function Sl(s,e,t=e){ui(s,"change",a=>{var n=a?s.defaultChecked:s.checked;t(n)}),Qs(e)==null&&t(s.checked),nn(()=>{var a=e();s.checked=!!a})}function hn(s){var e=s.type;return e==="number"||e==="range"}function fn(s){return s===""?null:+s}function lr(s,e){return s===e||(s==null?void 0:s[ba])===e}function Ut(s={},e,t,a){return al(()=>{var n,i;return nn(()=>{n=i,i=(a==null?void 0:a())||[],Qs(()=>{s!==t(...i)&&(e(s,...i),n&&lr(t(...n),s)&&e(null,...n))})}),()=>{_a(()=>{i&&lr(t(...i),s)&&e(null,...i)})}}),s}let za=!1;function Dl(s){var e=za;try{return za=!1,[s(),za]}finally{za=e}}function ls(s,e,t,a){var M;var n=(t&Ao)!==0,i=(t&xo)!==0,o=a,c=!0,l=()=>(c&&(c=!1,o=i?Qs(a):a),o),u;if(n){var h=ba in s||lo in s;u=((M=aa(s,e))==null?void 0:M.set)??(h&&e in s?w=>s[e]=w:void 0)}var p,f=!1;n?[p,f]=Dl(()=>s[e]):p=s[e],p===void 0&&a!==void 0&&(p=l(),u&&(po(),u(p)));var k;if(k=()=>{var w=s[e];return w===void 0?l():(c=!0,w)},!(t&Eo))return k;if(u){var x=s.$$legacy;return function(w,C){return arguments.length>0?((!C||x||f)&&u(C?k():w),w):k()}}var T=!1,m=(t&Do?sn:ti)(()=>(T=!1,k()));n&&r(m);var g=Ae;return function(w,C){if(arguments.length>0){const R=C?r(m):n?fe(w):w;return _(m,R),T=!0,o!==void 0&&(o=R),w}return As&&T||g.f&rs?m.v:r(m)}}function rn(s){yt===null&&Lr(),vt(()=>{const e=Qs(s);if(typeof e=="function")return e})}function El(s){yt===null&&Lr(),rn(()=>()=>Qs(s))}const Al="5";var Nr;typeof window<"u"&&((Nr=window.__svelte??(window.__svelte={})).v??(Nr.v=new Set)).add(Al);function xl(){return{type:"daily",interval:1,time:"09:00"}}function Oi(s){return!s||!s.type||!s.interval||s.interval<1?!1:s.type==="weekly"?Array.isArray(s.weekdays)&&s.weekdays.length>0&&s.weekdays.every(e=>e>=0&&e<=6):s.type==="monthly"?s.dayOfMonth>=1&&s.dayOfMonth<=31:s.type==="yearly"?s.month>=0&&s.month<=11&&s.dayOfMonth>=1&&s.dayOfMonth<=31:!0}const Ns="recurring-tasks-active",Ka="recurring-tasks-archive",cr="recurring-tasks",ur="recurring-tasks.json.bak",dr="n8n-event-settings",vr="n8n-event-queue",Cl="notification-state",Il="recurring-tasks-dock",hr="scheduler-emitted-occurrences",ms=4,In={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},Yn=60*1e3,Ml=30*1e3,_n=2e3,fr="shehab-note-recurring-plugin",_r="1.0.0",Ol=60*60*1e3,ql=3,pr=10,pn=1e3,Ua=100,mr=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],gr={low:"#64748b",normal:"#3b82f6",high:"#f59e0b",urgent:"#ef4444"},Nl=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],yr="last-run-timestamp",kr="custom-recurring-task-id",br="custom-recurring-task-due",wr="custom-recurring-task-enabled";function qi(s,e,t){const a=new Date().toISOString(),n=t||new Date;return{id:Ni(),name:s,lastCompletedAt:void 0,dueAt:n.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:ms,createdAt:a,updatedAt:a}}function Ni(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function Rl(s,e={}){const t=new Date().toISOString();return{...{...s,id:Ni(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function Bl(s){const e=new Date().toISOString();s.completionCount=(s.completionCount||0)+1,s.currentStreak=(s.currentStreak||0)+1,s.bestStreak=Math.max(s.bestStreak||0,s.currentStreak),s.recentCompletions||(s.recentCompletions=[]),s.recentCompletions.push(e),s.recentCompletions.length>pr&&(s.recentCompletions=s.recentCompletions.slice(-pr)),s.snoozeCount=0,s.lastCompletedAt=e,s.updatedAt=e}function Ri(s){s.missCount=(s.missCount||0)+1,s.currentStreak=0,s.updatedAt=new Date().toISOString()}function Bi(s){const e=s.completionCount||0,t=s.missCount||0,a=e+t;if(a===0)return 100;let i=e/a*70;const o=s.currentStreak||0,c=Math.min(30,o*3);return i+=c,Math.round(Math.min(100,i))}function Rs(s){const{message:e,type:t="info",duration:a=3e3,actionLabel:n,onAction:i,showCountdown:o=!1}=s,c=document.createElement("div");c.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const l=document.createElement("span");l.textContent=e,c.appendChild(l);let u=null;if(n&&i){const p=document.createElement("button");p.type="button";let f=Math.max(1,Math.ceil(a/1e3));p.textContent=o?`${n} (${f}s)`:n,p.className="recurring-tasks-toast__action",p.addEventListener("click",()=>{i(),u!==null&&window.clearInterval(u),c.parentElement&&c.parentElement.removeChild(c)}),c.appendChild(p),o&&a>0&&(u=window.setInterval(()=>{f=Math.max(0,f-1),p.textContent=`${n} (${f}s)`,f<=0&&u!==null&&(window.clearInterval(u),u=null)},1e3))}Object.assign(c.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:Fl(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(c);const h=()=>{u!==null&&window.clearInterval(u),c.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{c.parentElement&&c.parentElement.removeChild(c)},300)};a>0&&setTimeout(()=>{h()},a)}function Fl(s){switch(s){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const se={success:(s,e)=>Rs({message:s,type:"success",duration:e}),error:(s,e)=>Rs({message:s,type:"error",duration:e}),warning:(s,e)=>Rs({message:s,type:"warning",duration:e}),info:(s,e)=>Rs({message:s,type:"info",duration:e})};if(typeof document<"u"){const s=document.createElement("style");s.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(s)}class zl{constructor(){A(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var a;return(a=this.handlers.get(e))==null?void 0:a.delete(t)}}emit(e,t){var a;(a=this.handlers.get(e))==null||a.forEach(n=>n(t))}clear(){this.handlers.clear()}}const je=new zl;function mn(s,e){const t=s.findIndex(n=>n.id===e.id);if(t===-1)return[...s,e];const a=[...s];return a[t]=e,a}function Tr(s,e){const t=s.filter(a=>a.id!==e);return t.length===s.length?s:t}function gn(s,e,t){let a=!1;const n=s.map(i=>i.id!==e?i:(a=!0,t(i)));return a?n:s}function jl(s,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),s.filter(a=>a.enabled?new Date(a.dueAt)<=t:!1)}const Pl=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function on(s,e,t){const a={timestamp:new Date().toISOString()},n=`[${s.toUpperCase()}] [${a.timestamp}]`;s==="error"?console.error(n,e,t||""):s==="warn"?console.warn(n,e,t||""):s==="debug"&&Pl?console.debug(n,e,t||""):s==="info"&&console.log(n,e,t||"")}function Fi(s,e){on("debug",s,e)}function re(s,e){on("info",s,e)}function at(s,e){on("warn",s,e)}function me(s,e){on("error",s,e)}async function Ll(s){return new Promise(e=>{try{Bn.fetchPost("/api/block/getBlockInfo",{id:s},t=>{var n,i,o;const a=((n=t==null?void 0:t.data)==null?void 0:n.content)??((i=t==null?void 0:t.data)==null?void 0:i.markdown)??((o=t==null?void 0:t.data)==null?void 0:o.name)??null;e(a?a.trim():null)})}catch(t){at("Failed to fetch block preview",t),e(null)}})}async function Kl(s){return new Promise(e=>{try{Bn.fetchPost("/api/block/getBlockHTML",{id:s},t=>{var n;const a=((n=t==null?void 0:t.data)==null?void 0:n.html)??null;e(a?a.trim():null)})}catch(t){at("Failed to fetch block embed",t),e(null)}})}function zi(s){const[e,t]=s.split(":").map(Number);return{hours:e,minutes:t}}function Ul(s){const e=s.getHours().toString().padStart(2,"0"),t=s.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function Hl(s){return s.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function Mn(s){return s.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Vn(s){const e=new Date;return s.getDate()===e.getDate()&&s.getMonth()===e.getMonth()&&s.getFullYear()===e.getFullYear()}function Gl(s){return s<new Date}function Yl(s){return Gl(s)&&!Vn(s)}function xa(s,e){const t=new Date(s);return t.setDate(t.getDate()+e),t}function Sr(s,e){return xa(s,e*7)}function Vl(s,e,t){const a=new Date(s);a.setHours(e,t,0,0);const n=a.getHours()!==e||a.getMinutes()!==t;return{date:a,shifted:n}}function On(s){const e=new Date(s);return e.setHours(0,0,0,0),e}function Wl(s){const e=new Date(s);return e.setHours(23,59,59,999),e}function Ql(s,e){const a=Math.abs(e.getTime()-s.getTime());return Math.floor(a/864e5)}function Xl(s,e){const t=[];for(let a=0;a<e;a++)t.push(xa(s,a));return t}var Jl=I('<span class="task-card__streak svelte-yjw1ud"> </span>'),Zl=I('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">‚úèÔ∏è</button>'),$l=I('<span class="task-card__relative svelte-yjw1ud"> </span>'),ec=I('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),tc=I('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),sc=I('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),ac=I('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),nc=I('<button class="task-card__snooze-chip svelte-yjw1ud"> </button>'),rc=I('<button class="task-card__snooze-option svelte-yjw1ud" role="menuitem"> </button>'),ic=I('<div class="task-card__snooze-menu svelte-yjw1ud" role="menu" tabindex="0"></div>'),oc=I('<div role="article"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <!> <!></div> <div><div class="task-card__health-bar svelte-yjw1ud"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze svelte-yjw1ud" aria-label="Snooze task">üïí Snooze</button> <div class="task-card__snooze-quick svelte-yjw1ud"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow svelte-yjw1ud" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay svelte-yjw1ud" aria-label="Delay task to tomorrow">üïí Tomorrow</button> <button class="task-card__action task-card__action--skip svelte-yjw1ud" aria-label="Skip this occurrence">‚è≠Ô∏è Skip</button> <button class="task-card__action task-card__action--done svelte-yjw1ud" aria-label="Mark task as done">‚úÖ Done</button></div></div>');function pa(s,e){Pe(e,!0);const t=Y(()=>new Date(e.task.dueAt)),a=Y(()=>Yl(r(t))),n=Y(()=>Vn(r(t))),i=Y(()=>r(a)?Ql(new Date(e.task.dueAt),new Date):0),o=Y(()=>r(a)?"task-card--overdue":r(n)?"task-card--today":""),c=Y(()=>()=>r(a)?`rgba(244, 67, 54, ${Math.min(.45,.12+r(i)*.05)})`:""),l=Y(()=>()=>r(a)?`rgba(244, 67, 54, ${Math.min(.8,.3+r(i)*.08)})`:""),u=Y(()=>e.task.priority?gr[e.task.priority]:gr.normal),h=Y(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(r(t)):""),p=Y(()=>(e.task.currentStreak||0)>0),f=Y(()=>()=>"üî•"),k=Y(()=>Bi(e.task)),x=Y(()=>r(k)>=80?"health--good":r(k)>=50?"health--fair":"health--poor");let T=X(!1),m=X(-1),g=X(fe([])),M=X(!1),w=X(null),C=X(null),R=X(!1);const B=Y(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}‚Ä¶`:e.task.linkedBlockId:""),q=Y(()=>()=>{if(!r(w))return"";const Z=r(w).replace(/\s+/g," ").trim();return Z.length>220?`${Z.slice(0,220)}‚Ä¶`:Z}),K=Y(()=>()=>mr.filter(Z=>[15,60,120].includes(Z.minutes)));vt(()=>{_(w,e.task.linkedBlockContent??null,!0),_(C,null),_(R,!1)});function L(){e.onDone(e.task)}function Q(){e.onDelay(e.task)}function $(){e.onEdit&&e.onEdit(e.task)}function H(){e.onSkip(e.task)}async function te(){_(T,!r(T)),r(T)&&(await Di(),_(m,-1),_(g,[],!0))}function oe(Z){const ve=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:Z}});window.dispatchEvent(ve),_(T,!1),_(m,-1)}function ie(Z){var Se,qe,tt,st;const ve=r(K);Z.key==="ArrowDown"?(Z.preventDefault(),_(m,Math.min(r(m)+1,ve.length-1),!0),(Se=r(g)[r(m)])==null||Se.focus()):Z.key==="ArrowUp"?(Z.preventDefault(),_(m,Math.max(r(m)-1,0),!0),(qe=r(g)[r(m)])==null||qe.focus()):Z.key==="Escape"?(_(T,!1),_(m,-1)):Z.key==="Home"?(Z.preventDefault(),_(m,0),(tt=r(g)[0])==null||tt.focus()):Z.key==="End"&&(Z.preventDefault(),_(m,ve.length-1),(st=r(g)[r(m)])==null||st.focus())}function j(Z){if(Z.key==="Escape"&&r(T)){_(T,!1);return}(Z.key==="Enter"||Z.key===" ")&&(Z.preventDefault(),te())}async function E(){if(_(M,!0),!e.task.linkedBlockId||r(R)||r(C))return;_(R,!0);const[Z,ve]=await Promise.all([Kl(e.task.linkedBlockId),Ll(e.task.linkedBlockId)]);_(C,Z,!0),_(w,ve,!0),_(R,!1)}function P(){_(M,!1)}const ee=Y(()=>()=>`Task: ${e.task.name.replace(/[<>"&]/g,ve=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[ve]||ve)}`);var J=oc();J.__keydown=Z=>{Z.key==="Escape"&&r(T)&&_(T,!1)};var ye=d(J),le=d(ye),_e=d(le),we=v(_e,2),De=d(we),G=v(we,2);{var ae=Z=>{var ve=Jl(),Se=d(ve);U(qe=>{Ie(ve,"title",`${e.task.currentStreak??""} day streak`),F(Se,`${qe??""} ${e.task.currentStreak??""}`)},[()=>r(f)()]),y(Z,ve)};V(G,Z=>{r(p)&&Z(ae)})}var b=v(le,2);{var N=Z=>{var ve=Zl();ve.__click=$,y(Z,ve)};V(b,Z=>{e.onEdit&&Z(N)})}var W=v(ye,2),ne=d(W),ce=v(d(ne),2),D=d(ce),z=v(ce,2);{var de=Z=>{var ve=$l(),Se=d(ve);U(qe=>F(Se,qe),[()=>r(h)()]),y(Z,ve)};V(z,Z=>{e.timezoneHandler&&Z(de)})}var Te=v(ne,2);{var Ke=Z=>{var ve=ec(),Se=v(d(ve),2),qe=d(Se);U(tt=>F(qe,tt),[()=>Mn(new Date(e.task.lastCompletedAt))]),y(Z,ve)};V(Te,Z=>{e.task.lastCompletedAt&&Z(Ke)})}var xe=v(Te,2);{var Oe=Z=>{var ve=ac(),Se=d(ve),qe=d(Se),tt=v(Se,2);{var st=Ct=>{var It=sc(),he=d(It);{var Ee=We=>{var Be=un("Loading preview‚Ä¶");y(We,Be)},Ne=We=>{var Be=Ge(),ze=Me(Be);{var ot=lt=>{var Mt=tc(),ct=d(Mt);pl(ct,()=>r(C)),y(lt,Mt)},bt=lt=>{var Mt=Ge(),ct=Me(Mt);{var jt=wt=>{var ts=un();U(()=>F(ts,r(q))),y(wt,ts)},_s=wt=>{var ts=un("No preview available.");y(wt,ts)};V(ct,wt=>{r(w)?wt(jt):wt(_s,!1)},!0)}y(lt,Mt)};V(ze,lt=>{r(C)?lt(ot):lt(bt,!1)},!0)}y(We,Be)};V(he,We=>{r(R)?We(Ee):We(Ne,!1)})}y(Ct,It)};V(tt,Ct=>{r(M)&&Ct(st)})}U(()=>{Ie(Se,"title",`Linked block: ${e.task.linkedBlockId}`),F(qe,`üìù Block ${r(B)??""}`)}),Ze("mouseenter",Se,E),Ze("mouseleave",Se,P),Ze("focus",Se,E),Ze("blur",Se,P),y(Z,ve)};V(xe,Z=>{e.task.linkedBlockId&&Z(Oe)})}var Ue=v(W,2),$t=d(Ue),kt=v(Ue,2),At=d(kt),Ht=d(At);Ht.__click=te,Ht.__keydown=j;var it=v(Ht,2),Re=d(it);Ce(Re,17,()=>r(K),mt,(Z,ve)=>{var Se=nc();Se.__click=()=>oe(r(ve).minutes);var qe=d(Se);U(()=>{Ie(Se,"aria-label",`Snooze for ${r(ve).label}`),F(qe,r(ve).label)}),y(Z,Se)});var Gt=v(Re,2);Gt.__click=Q;var He=v(it,2);{var fs=Z=>{var ve=ic();ve.__keydown=ie,Ce(ve,21,()=>mr,mt,(Se,qe,tt)=>{var st=rc();st.__click=()=>oe(r(qe).minutes),Ie(st,"tabindex",tt===0?0:-1);var Ct=d(st);Ut(st,(It,he)=>r(g)[he]=It,It=>{var he;return(he=r(g))==null?void 0:he[It]},()=>[tt]),U(()=>F(Ct,r(qe).label)),y(Se,st)}),y(Z,ve)};V(He,Z=>{r(T)&&Z(fs)})}var Yt=v(At,2);Yt.__click=Q;var xt=v(Yt,2);xt.__click=H;var es=v(xt,2);es.__click=L,U((Z,ve)=>{Fe(J,1,`task-card ${r(o)??""}`,"svelte-yjw1ud"),Gs(J,`--overdue-tint: ${r(c)??""}; --overdue-border: ${r(l)??""};`),Ie(J,"aria-label",Z),Gs(_e,`background-color: ${r(u)??""}`),Ie(_e,"title",`Priority: ${(e.task.priority||"normal")??""}`),F(De,e.task.name),F(D,ve),Fe(Ue,1,`task-card__health ${r(x)??""}`,"svelte-yjw1ud"),Ie(Ue,"title",`Task health: ${r(k)??""}%`),Gs($t,`width: ${r(k)??""}%`),Ie(Ht,"aria-expanded",r(T))},[()=>r(ee)(),()=>Mn(r(t))]),y(s,J),Le()}rt(["keydown","click"]);var lc=I(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">üéâ No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),cc=I('<div class="today-tab__card-wrapper svelte-u7986x"><!></div>'),uc=I('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x"><!></div></div>');function dc(s,e){Pe(e,!0);const t=Y(()=>[...e.tasks].sort((T,m)=>new Date(T.dueAt).getTime()-new Date(m.dueAt).getTime()));let a=X(0),n=fe([]);vt(()=>{r(a)>=r(t).length&&_(a,Math.max(0,r(t).length-1),!0)});function i(T){var g;if(r(t).length===0)return;const m=Math.max(0,Math.min(T,r(t).length-1));_(a,m,!0),(g=n[m])==null||g.focus()}function o(T,m){T.key==="ArrowDown"?(T.preventDefault(),i(m+1)):T.key==="ArrowUp"?(T.preventDefault(),i(m-1)):T.key==="Home"?(T.preventDefault(),i(0)):T.key==="End"&&(T.preventDefault(),i(r(t).length-1))}var c=uc(),l=d(c),u=v(d(l),2),h=d(u),p=v(l,2),f=d(p);{var k=T=>{var m=lc();y(T,m)},x=T=>{var m=Ge(),g=Me(m);Ce(g,19,()=>r(t),M=>M.id,(M,w,C)=>{var R=cc();R.__keydown=q=>o(q,r(C));var B=d(R);pa(B,{get task(){return r(w)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),Ut(R,(q,K)=>n[K]=q,q=>n==null?void 0:n[q],()=>[r(C)]),U(()=>Ie(R,"tabindex",r(C)===r(a)?0:-1)),Ze("focus",R,()=>_(a,r(C),!0)),y(M,R)}),y(T,m)};V(f,T=>{r(t).length===0?T(k):T(x,!1)})}U(()=>F(h,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),y(s,c),Le()}rt(["keydown"]);var vc=I('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),hc=I('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),fc=I('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">‚úèÔ∏è</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">üìÑ</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">üóëÔ∏è</button></div></td></tr>'),_c=I('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),pc=I('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),mc=I('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),gc=I('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),yc=I('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">üîç</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function kc(s,e){Pe(e,!0);let t=X(null),a=X(!1),n=X(""),i=X(""),o=X(fe(new Set)),c=X(0),l=fe([]),u=X(null);const h=Y(()=>[...e.tasks].sort((D,z)=>new Date(D.dueAt).getTime()-new Date(z.dueAt).getTime())),p=Y(()=>()=>{const D=r(i).trim().toLowerCase();return D?r(h).filter(z=>{var Te;return[z.name,z.description,z.category,z.linkedBlockContent,(Te=z.tags)==null?void 0:Te.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(D)}):r(h)}),f=Y(()=>r(p).map(D=>D.id)),k=Y(()=>r(o).size>0),x=Y(()=>r(p).length>0&&r(p).every(D=>r(o).has(D.id))),T=Y(()=>r(p).some(D=>r(o).has(D.id))&&!r(x));vt(()=>{const D=new Set([...r(o)].filter(z=>e.tasks.some(de=>de.id===z)));D.size!==r(o).size&&_(o,D,!0)}),vt(()=>{r(u)&&(r(u).indeterminate=r(T))}),vt(()=>{r(c)>=r(p).length&&_(c,Math.max(0,r(p).length-1),!0)}),vt(()=>{const D=window.setTimeout(()=>{_(i,r(n),!0)},300);return()=>{window.clearTimeout(D)}});function m(D){_(t,D,!0)}function g(){r(t)&&(e.onDelete(r(t)),_(t,null))}function M(){_(t,null)}function w(D){const z=new Set(r(o));z.has(D)?z.delete(D):z.add(D),_(o,z,!0)}function C(){const D=new Set(r(o));r(x)?r(f).forEach(z=>D.delete(z)):r(f).forEach(z=>D.add(z)),_(o,D,!0)}function R(D){var de;if(r(p).length===0)return;const z=Math.max(0,Math.min(D,r(p).length-1));_(c,z,!0),(de=l[z])==null||de.focus()}function B(D,z){D.key==="ArrowDown"?(D.preventDefault(),R(z+1)):D.key==="ArrowUp"?(D.preventDefault(),R(z-1)):D.key==="Home"?(D.preventDefault(),R(0)):D.key==="End"&&(D.preventDefault(),R(r(p).length-1))}function q(){if(r(o).size===0){_(a,!1);return}e.onBulkDelete([...r(o)]),_(o,new Set,!0),_(a,!1)}function K(){_(a,!1)}function L(D){const{type:z,interval:de}=D.frequency,Te=z==="daily"?"day":z==="weekly"?"week":z==="monthly"?"month":"year",Ke=de===1?`Every ${Te}`:`Every ${de} ${Te}s`;if(z==="weekly")return`${Ke} on ${D.frequency.weekdays.map(xe=>Nl[xe]??xe).join(", ")}`;if(z==="monthly")return`${Ke} on day ${D.frequency.dayOfMonth}`;if(z==="yearly"){const xe=Q[D.frequency.month]??`Month ${D.frequency.month+1}`;return`${Ke} on ${xe} ${D.frequency.dayOfMonth}`}return Ke}const Q=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var $=yc(),H=Me($),te=d(H),oe=v(d(te),2),ie=d(oe),j=v(d(ie),2),E=v(ie,2);E.__click=function(...D){var z;(z=e.onCreate)==null||z.apply(this,D)};var P=v(te,2),ee=d(P),J=d(ee),ye=d(J),le=v(J,2),_e=d(le);_e.__click=()=>e.onBulkEnable([...r(o)]);var we=v(_e,2);we.__click=()=>e.onBulkDisable([...r(o)]);var De=v(we,2);De.__click=()=>_(a,!0);var G=v(ee,2);{var ae=D=>{var z=vc();y(D,z)},b=D=>{var z=pc(),de=d(z);{var Te=xe=>{var Oe=hc(),Ue=d(Oe),$t=d(Ue);U(kt=>F($t,`No tasks match "${kt??""}".`),[()=>r(i).trim()]),y(xe,Oe)},Ke=xe=>{var Oe=_c(),Ue=d(Oe),$t=d(Ue),kt=d($t),At=d(kt);At.__click=C,Ut(At,it=>_(u,it),()=>r(u));var Ht=v(Ue);Ce(Ht,23,()=>r(p),it=>it.id,(it,Re,Gt)=>{var He=fc();He.__keydown=Be=>B(Be,r(Gt));var fs=d(He),Yt=d(fs);Yt.__click=()=>w(r(Re).id);var xt=v(fs),es=d(xt),Z=v(xt),ve=d(Z),Se=v(Z),qe=d(Se),tt=v(Se),st=d(tt),Ct=d(st);Ct.__change=()=>e.onToggleEnabled(r(Re));var It=v(tt),he=d(It),Ee=d(he);Ee.__click=()=>e.onEdit(r(Re));var Ne=v(Ee,2);Ne.__click=()=>e.onDuplicate(r(Re));var We=v(Ne,2);We.__click=()=>m(r(Re)),Ut(He,(Be,ze)=>l[ze]=Be,Be=>l==null?void 0:l[Be],()=>[r(Gt)]),U((Be,ze,ot,bt)=>{Fe(He,1,gl(r(Re).enabled?"":"disabled"),"svelte-i091qn"),Ie(He,"tabindex",r(Gt)===r(c)?0:-1),Ie(He,"aria-selected",Be),Ie(Yt,"aria-label",`Select ${r(Re).name}`),Sa(Yt,ze),F(es,r(Re).name),F(ve,ot),F(qe,bt),Sa(Ct,r(Re).enabled)},[()=>r(o).has(r(Re).id),()=>r(o).has(r(Re).id),()=>Mn(new Date(r(Re).dueAt)),()=>L(r(Re))]),Ze("focus",He,()=>_(c,r(Gt),!0)),y(it,He)}),U(()=>{Sa(At,r(x)),At.disabled=r(p).length===0}),y(xe,Oe)};V(de,xe=>{r(p).length===0?xe(Te):xe(Ke,!1)})}y(D,z)};V(G,D=>{r(h).length===0?D(ae):D(b,!1)})}var N=v(H,2);{var W=D=>{var z=mc(),de=d(z),Te=v(d(de),2),Ke=d(Te),xe=v(Te,2),Oe=d(xe);Oe.__click=M;var Ue=v(Oe,2);Ue.__click=g,U(()=>F(Ke,`Are you sure you want to delete "${r(t).name??""}"? This action cannot be undone.`)),y(D,z)};V(N,D=>{r(t)&&D(W)})}var ne=v(N,2);{var ce=D=>{var z=gc(),de=d(z),Te=v(d(de),2),Ke=d(Te),xe=v(Te,2),Oe=d(xe);Oe.__click=K;var Ue=v(Oe,2);Ue.__click=q,U(()=>F(Ke,`Are you sure you want to delete ${r(o).size??""} task${r(o).size===1?"":"s"}? This action cannot be undone.`)),y(D,z)};V(ne,D=>{r(a)&&D(ce)})}U(()=>{j.disabled=r(h).length===0,F(ye,`${r(o).size??""} selected`),_e.disabled=!r(k),we.disabled=!r(k),De.disabled=!r(k)}),Dt(j,()=>r(n),D=>_(n,D)),y(s,$),Le()}rt(["click","keydown","change"]);var bc=I('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),wc=I('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Tc=I('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Sc=I('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Dc=I('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),Ec=I('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),Ac=I('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),xc=I('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function Cc(s,e){Pe(e,!0);let t=ls(e,"days",3,30);function a(g){const{frequency:M}=g;if(M.type==="weekly"){const w=[...M.weekdays].sort((C,R)=>C-R).join(",");return`weekly:${M.interval}:${M.time??""}:${w}`}return M.type==="monthly"?`monthly:${M.interval}:${M.time??""}:${M.dayOfMonth}`:M.type==="yearly"?`yearly:${M.interval}:${M.time??""}:${M.month}:${M.dayOfMonth}`:`daily:${M.interval}:${M.time??""}`}function n(g,M){const w=g.map(C=>`${C.id}:${C.enabled}:${C.dueAt}:${a(C)}`).join("|");return`${M}:${w}`}function i(g,M){const w=On(new Date),C=Wl(xa(w,M-1)),R=24*60*60*1e3,q=Xl(w,M).map(K=>({date:K,tasks:[]}));for(const K of g.filter(L=>L.enabled)){const L=new Date(K.dueAt),Q=e.recurrenceEngine.getOccurrencesInRange(w,C,K.frequency,L);for(const $ of Q){const H=On($),te=Math.floor((H.getTime()-w.getTime())/R);te>=0&&te<M&&q[te].tasks.push({task:K,occurrence:$})}}for(const K of q)K.tasks.sort((L,Q)=>L.occurrence.getTime()-Q.occurrence.getTime());return q}const o=(()=>{let g="",M=[];return{get(w,C){const R=n(w,C);return R===g||(g=R,M=i(w,C)),M}}})(),c=Y(()=>o.get(e.tasks,t())),l=Y(()=>r(c).some(g=>g.tasks.length>0));var u=xc(),h=d(u),p=v(d(h),2),f=d(p),k=v(h,2),x=d(k);{var T=g=>{var M=bc(),w=d(M),C=d(w);U(()=>F(C,`No tasks scheduled in the next ${t()??""} days.`)),y(g,M)},m=g=>{var M=Ac();Ce(M,21,()=>r(c),w=>w.date.toISOString(),(w,C)=>{var R=Ge(),B=Me(R);{var q=K=>{var L=Ec(),Q=d(L),$=d(Q),H=d($),te=v($,2),oe=d(te),ie=v(Q,2);Ce(ie,21,()=>r(C).tasks,({task:j,occurrence:E})=>j.id+E.toISOString(),(j,E)=>{let P=()=>r(E).task,ee=()=>r(E).occurrence;var J=Dc(),ye=d(J),le=d(ye),_e=v(ye,2),we=d(_e),De=d(we),G=v(we,2),ae=d(G);{var b=D=>{var z=wc(),de=d(z);U(()=>F(de,`üîó ${P().linkedBlockId??""}`)),y(D,z)};V(ae,D=>{P().linkedBlockId&&D(b)})}var N=v(ae,2);{var W=D=>{var z=Tc(),de=d(z);U(()=>F(de,`‚ö° ${P().priority??""}`)),y(D,z)};V(N,D=>{P().priority&&D(W)})}var ne=v(N,2);{var ce=D=>{var z=Sc(),de=d(z);U(Te=>F(de,`üè∑Ô∏è ${Te??""}`),[()=>P().tags.join(", ")]),y(D,z)};V(ne,D=>{var z;(z=P().tags)!=null&&z.length&&D(ce)})}U(D=>{F(le,D),F(De,P().name)},[()=>Ul(ee())]),y(j,J)}),U((j,E)=>{F(H,j),F(oe,E)},[()=>Hl(r(C).date),()=>r(C).date.toLocaleDateString(void 0,{weekday:"short"})]),y(K,L)};V(B,K=>{r(C).tasks.length>0&&K(q)})}y(w,R)}),y(g,M)};V(x,g=>{r(l)?g(m,!1):g(T)})}U(()=>F(f,`Next ${t()??""} days`)),y(s,u),Le()}var Ic=I('<span class="leaderboard-item__badge svelte-1ptoc1q">üèÜ Best</span>'),Mc=I('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),Oc=I('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">üî• Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),qc=I('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Nc=I('<h4 class="subsection-title svelte-1ptoc1q">‚úÖ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),Rc=I('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Bc=I('<h4 class="subsection-title svelte-1ptoc1q">‚ö†Ô∏è Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),Fc=I('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">‚úÖ</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),zc=I('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),jc=I('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function Pc(s,e){Pe(e,!0);const t=Y(()=>()=>{let j=0,E=0;for(const J of e.tasks)j+=J.completionCount||0,E+=J.missCount||0;const P=j+E,ee=P>0?j/P*100:100;return{totalCompletions:j,totalMisses:E,completionRate:Math.round(ee)}}),a=Y(()=>()=>[...e.tasks].filter(j=>(j.currentStreak||0)>0).sort((j,E)=>(E.currentStreak||0)-(j.currentStreak||0)).slice(0,10)),n=Y(()=>()=>[...e.tasks].map(j=>({task:j,health:Bi(j)})).sort((j,E)=>j.health-E.health)),i=Y(()=>()=>r(n)().slice(-5).reverse()),o=Y(()=>()=>r(n)().slice(0,5)),c=Y(()=>()=>{const j=[];for(const E of e.tasks)if(E.recentCompletions&&E.recentCompletions.length>0)for(const P of E.recentCompletions)j.push({task:E,completedAt:P});return j.sort((E,P)=>new Date(P.completedAt).getTime()-new Date(E.completedAt).getTime()).slice(0,10)});function l(j){return new Date(j).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function u(j){return j>=80?"#10b981":j>=60?"#3b82f6":j>=40?"#f59e0b":"#ef4444"}var h=jc(),p=v(d(h),2),f=d(p),k=v(d(f),2),x=d(k),T=d(x),m=d(T),g=v(x,2),M=d(g),w=d(M),C=v(g,2),R=d(C),B=d(R),q=v(f,2);{var K=j=>{var E=Oc(),P=v(d(E),2);Ce(P,21,()=>r(a)(),mt,(ee,J,ye)=>{var le=Mc(),_e=d(le);_e.textContent=`#${ye+1}`;var we=v(_e,2),De=d(we),G=v(we,2),ae=d(G),b=v(ae);{var N=W=>{var ne=Ic();y(W,ne)};V(b,W=>{r(J).bestStreak&&r(J).currentStreak===r(J).bestStreak&&W(N)})}U(()=>{F(De,r(J).name),F(ae,`${r(J).currentStreak??""} day${r(J).currentStreak!==1?"s":""} `)}),y(ee,le)}),y(j,E)};V(q,j=>{r(a)().length>0&&j(K)})}var L=v(q,2),Q=v(d(L),2);{var $=j=>{var E=Nc(),P=v(Me(E),2);Ce(P,21,()=>r(i)(),mt,(ee,J)=>{let ye=()=>r(J).task,le=()=>r(J).health;var _e=qc(),we=d(_e),De=d(we),G=v(we,2),ae=d(G),b=v(ae,2),N=d(b);U(W=>{F(De,ye().name),Gs(ae,`width: ${le()??""}%; background-color: ${W??""}`),F(N,`${le()??""}/100`)},[()=>u(le())]),y(ee,_e)}),y(j,E)};V(Q,j=>{r(i)().length>0&&j($)})}var H=v(Q,2);{var te=j=>{var E=Bc(),P=v(Me(E),2);Ce(P,21,()=>r(o)(),mt,(ee,J)=>{let ye=()=>r(J).task,le=()=>r(J).health;var _e=Rc(),we=d(_e),De=d(we),G=v(we,2),ae=d(G),b=v(ae,2),N=d(b);U(W=>{F(De,ye().name),Gs(ae,`width: ${le()??""}%; background-color: ${W??""}`),F(N,`${le()??""}/100`)},[()=>u(le())]),y(ee,_e)}),y(j,E)};V(H,j=>{r(o)().length>0&&r(o)()[0].health<80&&j(te)})}var oe=v(L,2);{var ie=j=>{var E=zc(),P=v(d(E),2);Ce(P,21,()=>r(c)(),mt,(ee,J)=>{let ye=()=>r(J).task,le=()=>r(J).completedAt;var _e=Fc(),we=v(d(_e),2),De=d(we),G=d(De),ae=v(De,2),b=d(ae);U(N=>{F(G,ye().name),F(b,N)},[()=>l(le())]),y(ee,_e)}),y(j,E)};V(oe,j=>{r(c)().length>0&&j(ie)})}U((j,E,P)=>{F(m,j),F(w,E),F(B,`${P??""}%`)},[()=>r(t)().totalCompletions,()=>r(t)().totalMisses,()=>r(t)().completionRate]),y(s,h),Le()}var Lc=I('<div class="inbox-tab__empty svelte-1jnb97y"><p class="svelte-1jnb97y">üì• No tasks in inbox</p> <p class="inbox-tab__empty-subtitle svelte-1jnb97y">Create your first task or schedule your existing tasks!</p></div>'),Kc=I('<div class="inbox-tab__card-wrapper svelte-1jnb97y"><!></div>'),Uc=I('<div class="inbox-tab svelte-1jnb97y"><div class="inbox-tab__header svelte-1jnb97y"><h2 class="inbox-tab__title svelte-1jnb97y">Inbox</h2> <p class="inbox-tab__subtitle svelte-1jnb97y"> </p></div> <div class="inbox-tab__content svelte-1jnb97y"><!></div></div>');function Hc(s,e){Pe(e,!0);const t=Y(()=>e.tasks.filter(T=>T.status!=="done"&&T.status!=="cancelled"&&!T.dueAt&&!T.scheduledAt&&!T.startAt).sort((T,m)=>new Date(m.createdAt).getTime()-new Date(T.createdAt).getTime()));let a=X(0),n=fe([]);vt(()=>{r(a)>=r(t).length&&_(a,Math.max(0,r(t).length-1),!0)});function i(T){var g;if(r(t).length===0)return;const m=Math.max(0,Math.min(T,r(t).length-1));_(a,m,!0),(g=n[m])==null||g.focus()}function o(T,m){T.key==="ArrowDown"?(T.preventDefault(),i(m+1)):T.key==="ArrowUp"?(T.preventDefault(),i(m-1)):T.key==="Enter"&&e.onEdit?(T.preventDefault(),e.onEdit(r(t)[m])):T.key===" "&&e.onDone&&(T.preventDefault(),e.onDone(r(t)[m]))}var c=Uc(),l=d(c),u=v(d(l),2),h=d(u),p=v(l,2),f=d(p);{var k=T=>{var m=Lc();y(T,m)},x=T=>{var m=Ge(),g=Me(m);Ce(g,19,()=>r(t),M=>M.id,(M,w,C)=>{var R=Kc();R.__keydown=q=>o(q,r(C));var B=d(R);pa(B,{get task(){return r(w)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Ut(R,(q,K)=>n[K]=q,q=>n==null?void 0:n[q],()=>[r(C)]),U(()=>Ie(R,"tabindex",r(C)===r(a)?0:-1)),Ze("focus",R,()=>_(a,r(C),!0)),y(M,R)}),y(T,m)};V(f,T=>{r(t).length===0?T(k):T(x,!1)})}U(()=>F(h,`${r(t).length??""} task${r(t).length!==1?"s":""} without dates`)),y(s,c),Le()}rt(["keydown"]);var Gc=I('<div class="upcoming-tab__empty svelte-102jr7u"><p class="svelte-102jr7u"> </p> <p class="upcoming-tab__empty-subtitle svelte-102jr7u">You have a clear schedule ahead!</p></div>'),Yc=I('<div class="upcoming-tab__card-wrapper svelte-102jr7u"><!></div>'),Vc=I('<div class="upcoming-tab__date-group svelte-102jr7u"><h3 class="upcoming-tab__date-header svelte-102jr7u"> </h3> <!></div>'),Wc=I('<div class="upcoming-tab svelte-102jr7u"><div class="upcoming-tab__header svelte-102jr7u"><h2 class="upcoming-tab__title svelte-102jr7u">Upcoming</h2> <p class="upcoming-tab__subtitle svelte-102jr7u"> </p></div> <div class="upcoming-tab__content svelte-102jr7u"><!></div></div>');function Qc(s,e){Pe(e,!0);let t=ls(e,"daysAhead",3,7);const a=new Date;a.setHours(0,0,0,0);const n=new Date(a);n.setDate(n.getDate()+t());const i=Y(()=>e.tasks.filter(w=>{if(w.status==="done"||w.status==="cancelled"||!w.dueAt)return!1;const C=new Date(w.dueAt);return C.setHours(0,0,0,0),C>a&&C<=n}).sort((w,C)=>new Date(w.dueAt).getTime()-new Date(C.dueAt).getTime())),o=Y(()=>()=>{const w=new Map;return r(i).forEach(C=>{const R=new Date(C.dueAt);R.setHours(0,0,0,0);const B=R.toISOString().split("T")[0];w.has(B)||w.set(B,[]),w.get(B).push(C)}),w});function c(w){const C=new Date(w),R=Math.floor((C.getTime()-a.getTime())/(1e3*60*60*24)),B=C.toLocaleDateString("en-US",{weekday:"long"}),q=C.toLocaleDateString("en-US",{month:"short",day:"numeric"});return R===1?`Tomorrow - ${B}, ${q}`:`${B}, ${q} (in ${R} days)`}let l=X(0),u=fe([]);vt(()=>{r(l)>=r(i).length&&_(l,Math.max(0,r(i).length-1),!0)});function h(w,C){w.key==="ArrowDown"?(w.preventDefault(),_(l,Math.min(r(l)+1,r(i).length-1),!0)):w.key==="ArrowUp"?(w.preventDefault(),_(l,Math.max(r(l)-1,0),!0)):w.key==="Enter"&&e.onEdit?(w.preventDefault(),e.onEdit(r(i)[C])):w.key===" "&&e.onDone&&(w.preventDefault(),e.onDone(r(i)[C]))}var p=Wc(),f=d(p),k=v(d(f),2),x=d(k),T=v(f,2),m=d(T);{var g=w=>{var C=Gc(),R=d(C),B=d(R);U(()=>F(B,`üìÖ No tasks scheduled for the next ${t()??""} days`)),y(w,C)},M=w=>{var C=Ge(),R=Me(C);Ce(R,17,()=>[...r(o).entries()],mt,(B,q)=>{var K=Y(()=>zr(r(q),2));let L=()=>r(K)[0],Q=()=>r(K)[1];var $=Vc(),H=d($),te=d(H),oe=v(H,2);Ce(oe,19,Q,ie=>ie.id,(ie,j)=>{const E=Y(()=>r(i).indexOf(r(j)));var P=Yc();P.__keydown=J=>h(J,r(E));var ee=d(P);pa(ee,{get task(){return r(j)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Ut(P,(J,ye)=>u[ye]=J,J=>u==null?void 0:u[J],()=>[r(E)]),U(()=>Ie(P,"tabindex",r(E)===r(l)?0:-1)),Ze("focus",P,()=>_(l,r(E),!0)),y(ie,P)}),U(ie=>F(te,ie),[()=>c(L())]),y(B,$)}),y(w,C)};V(m,w=>{r(i).length===0?w(g):w(M,!1)})}U(()=>F(x,`${r(i).length??""} task${r(i).length!==1?"s":""} in the next ${t()??""} days`)),y(s,p),Le()}rt(["keydown"]);var Xc=I('<div class="done-tab__empty svelte-z9ywjc"><p class="svelte-z9ywjc">‚úÖ No completed tasks yet</p> <p class="done-tab__empty-subtitle svelte-z9ywjc">Complete some tasks to see them here!</p></div>'),Jc=I('<button class="done-tab__uncomplete-btn svelte-z9ywjc" title="Mark as not done">Undo</button>'),Zc=I('<div class="done-tab__card-wrapper svelte-z9ywjc"><div class="done-tab__task-header svelte-z9ywjc"><span class="done-tab__done-date svelte-z9ywjc"> </span> <!></div> <!></div>'),$c=I('<div class="done-tab__pagination svelte-z9ywjc"><button class="done-tab__page-btn svelte-z9ywjc">‚Üê Previous</button> <span class="done-tab__page-info svelte-z9ywjc"> </span> <button class="done-tab__page-btn svelte-z9ywjc">Next ‚Üí</button></div>'),eu=I("<!> <!>",1),tu=I('<div class="done-tab svelte-z9ywjc"><div class="done-tab__header svelte-z9ywjc"><h2 class="done-tab__title svelte-z9ywjc">Done</h2> <p class="done-tab__subtitle svelte-z9ywjc"> </p></div> <div class="done-tab__content svelte-z9ywjc"><!></div></div>');function su(s,e){Pe(e,!0);let t=ls(e,"daysBack",3,30),a=X(0);const n=50,i=new Date;i.setDate(i.getDate()-t()),i.setHours(0,0,0,0);const o=Y(()=>e.tasks.filter(q=>q.status!=="done"||!q.doneAt?!1:new Date(q.doneAt)>=i).sort((q,K)=>new Date(K.doneAt).getTime()-new Date(q.doneAt).getTime())),c=Y(()=>Math.ceil(r(o).length/n)),l=Y(()=>r(o).slice(r(a)*n,(r(a)+1)*n));vt(()=>{r(a)>=r(c)&&r(c)>0&&_(a,r(c)-1)});function u(){r(a)<r(c)-1&&$n(a)}function h(){r(a)>0&&$n(a,-1)}function p(q){const K=new Date(q),L=new Date,Q=L.getTime()-K.getTime(),$=Math.floor(Q/(1e3*60*60*24));return $===0?"Today":$===1?"Yesterday":$<7?`${$} days ago`:K.toLocaleDateString("en-US",{month:"short",day:"numeric",year:K.getFullYear()!==L.getFullYear()?"numeric":void 0})}let f=X(0),k=fe([]);vt(()=>{r(f)>=r(l).length&&_(f,Math.max(0,r(l).length-1),!0)});function x(q,K){q.key==="ArrowDown"?(q.preventDefault(),_(f,Math.min(r(f)+1,r(l).length-1),!0)):q.key==="ArrowUp"?(q.preventDefault(),_(f,Math.max(r(f)-1,0),!0)):q.key==="Enter"&&e.onEdit&&(q.preventDefault(),e.onEdit(r(l)[K]))}var T=tu(),m=d(T),g=v(d(m),2),M=d(g),w=v(m,2),C=d(w);{var R=q=>{var K=Xc();y(q,K)},B=q=>{var K=eu(),L=Me(K);Ce(L,19,()=>r(l),H=>H.id,(H,te,oe)=>{var ie=Zc();ie.__keydown=le=>x(le,r(oe));var j=d(ie),E=d(j),P=d(E),ee=v(E,2);{var J=le=>{var _e=Jc();_e.__click=()=>e.onUncomplete(r(te)),y(le,_e)};V(ee,le=>{e.onUncomplete&&le(J)})}var ye=v(j,2);pa(ye,{get task(){return r(te)},get onEdit(){return e.onEdit},get onDelete(){return e.onDelete}}),Ut(ie,(le,_e)=>k[_e]=le,le=>k==null?void 0:k[le],()=>[r(oe)]),U(le=>{Ie(ie,"tabindex",r(oe)===r(f)?0:-1),F(P,`Completed ${le??""}`)},[()=>p(r(te).doneAt)]),Ze("focus",ie,()=>_(f,r(oe),!0)),y(H,ie)});var Q=v(L,2);{var $=H=>{var te=$c(),oe=d(te);oe.__click=h;var ie=v(oe,2),j=d(ie),E=v(ie,2);E.__click=u,U(()=>{oe.disabled=r(a)===0,F(j,`Page ${r(a)+1} of ${r(c)??""}`),E.disabled=r(a)>=r(c)-1}),y(H,te)};V(Q,H=>{r(c)>1&&H($)})}y(q,K)};V(C,q=>{r(o).length===0?q(R):q(B,!1)})}U(()=>F(M,`${r(o).length??""} completed task${r(o).length!==1?"s":""} in the last ${t()??""} days`)),y(s,T),Le()}rt(["keydown","click"]);var au=I('<div class="projects-tab__empty svelte-8ybpha"><p class="svelte-8ybpha">üìÅ No active projects</p> <p class="projects-tab__empty-subtitle svelte-8ybpha">Create tasks to see them organized by project!</p></div>'),nu=I('<div class="projects-tab__card-wrapper svelte-8ybpha"><!></div>'),ru=I('<div class="projects-tab__project-tasks svelte-8ybpha"></div>'),iu=I('<div class="projects-tab__project svelte-8ybpha"><button class="projects-tab__project-header svelte-8ybpha"><span class="projects-tab__expand-icon svelte-8ybpha"> </span> <span class="projects-tab__project-name svelte-8ybpha"> </span> <span class="projects-tab__project-count svelte-8ybpha"> </span></button> <!></div>'),ou=I('<div class="projects-tab svelte-8ybpha"><div class="projects-tab__header svelte-8ybpha"><div class="projects-tab__header-main svelte-8ybpha"><h2 class="projects-tab__title svelte-8ybpha">Projects</h2> <p class="projects-tab__subtitle svelte-8ybpha"> </p></div> <div class="projects-tab__actions svelte-8ybpha"><button class="projects-tab__action-btn svelte-8ybpha">Expand All</button> <button class="projects-tab__action-btn svelte-8ybpha">Collapse All</button></div></div> <div class="projects-tab__content svelte-8ybpha"><!></div></div>');function lu(s,e){Pe(e,!0);const t=Y(()=>()=>{const L=new Map;return e.tasks.filter($=>$.status!=="done"&&$.status!=="cancelled").forEach($=>{const H=$.linkedBlockPath||"Uncategorized";L.has(H)||L.set(H,[]),L.get(H).push($)}),L.forEach($=>{$.sort((H,te)=>!H.dueAt&&!te.dueAt?0:H.dueAt?te.dueAt?new Date(H.dueAt).getTime()-new Date(te.dueAt).getTime():-1:1)}),new Map([...L.entries()].sort(([$],[H])=>$.localeCompare(H)))}),a=Y(()=>[...r(t).values()].reduce((L,Q)=>L+Q.length,0));let n=X(fe(new Set([...r(t).keys()])));function i(L){const Q=new Set(r(n));Q.has(L)?Q.delete(L):Q.add(L),_(n,Q,!0)}function o(){_(n,new Set([...r(t).keys()]),!0)}function c(){_(n,new Set,!0)}let l=X(0),u=fe([]);const h=Y(()=>()=>{const L=[];return r(t).forEach((Q,$)=>{r(n).has($)&&L.push(...Q)}),L});vt(()=>{r(l)>=r(h).length&&_(l,Math.max(0,r(h).length-1),!0)});function p(L,Q){L.key==="ArrowDown"?(L.preventDefault(),_(l,Math.min(r(l)+1,r(h).length-1),!0)):L.key==="ArrowUp"?(L.preventDefault(),_(l,Math.max(r(l)-1,0),!0)):L.key==="Enter"&&e.onEdit?(L.preventDefault(),e.onEdit(r(h)[Q])):L.key===" "&&e.onDone&&(L.preventDefault(),e.onDone(r(h)[Q]))}function f(L){const Q=L.split("/");return Q[Q.length-1]||L}var k=ou(),x=d(k),T=d(x),m=v(d(T),2),g=d(m),M=v(T,2),w=d(M);w.__click=o;var C=v(w,2);C.__click=c;var R=v(x,2),B=d(R);{var q=L=>{var Q=au();y(L,Q)},K=L=>{var Q=Ge(),$=Me(Q);Ce($,17,()=>[...r(t).entries()],mt,(H,te)=>{var oe=Y(()=>zr(r(te),2));let ie=()=>r(oe)[0],j=()=>r(oe)[1];var E=iu(),P=d(E);P.__click=()=>i(ie());var ee=d(P),J=d(ee),ye=v(ee,2),le=d(ye),_e=v(ye,2),we=d(_e),De=v(P,2);{var G=ae=>{var b=ru();Ce(b,23,j,N=>N.id,(N,W)=>{const ne=Y(()=>r(h).indexOf(r(W)));var ce=nu();ce.__keydown=z=>p(z,r(ne));var D=d(ce);pa(D,{get task(){return r(W)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Ut(ce,(z,de)=>u[de]=z,z=>u==null?void 0:u[z],()=>[r(ne)]),U(()=>Ie(ce,"tabindex",r(ne)===r(l)?0:-1)),Ze("focus",ce,()=>_(l,r(ne),!0)),y(N,ce)}),y(ae,b)};V(De,ae=>{r(n).has(ie())&&ae(G)})}U((ae,b)=>{F(J,ae),Ie(ye,"title",ie()),F(le,b),F(we,j().length)},[()=>r(n).has(ie())?"‚ñº":"‚ñ∂",()=>f(ie())]),y(H,E)}),y(L,Q)};V(B,L=>{r(t).size===0?L(q):L(K,!1)})}U(()=>F(g,`${r(a)??""} task${r(a)!==1?"s":""} in ${r(t).size??""} project${r(t).size!==1?"s":""}`)),y(s,k),Le()}rt(["click","keydown"]);class Is extends Error{constructor(e,t,a,n){super(e),this.line=t,this.column=a,this.suggestion=n,this.name="QuerySyntaxError"}}class ta extends Error{constructor(e,t){super(e),this.cause=t,this.name="QueryExecutionError"}}var ks=(s=>(s.TODO="TODO",s.IN_PROGRESS="IN_PROGRESS",s.DONE="DONE",s.CANCELLED="CANCELLED",s.NON_TASK="NON_TASK",s.EMPTY="EMPTY",s))(ks||{});const Vt=class Vt{constructor(e){A(this,"symbol");A(this,"name");A(this,"nextStatusSymbol");A(this,"type");this.symbol=e.symbol,this.name=e.name,this.nextStatusSymbol=e.nextStatusSymbol,this.type=e.type}static getTypeForUnknownSymbol(e){switch(e){case"x":case"X":return"DONE";case"/":return"IN_PROGRESS";case"-":return"CANCELLED";case" ":default:return"TODO"}}isCompleted(){return this.type==="DONE"||this.type==="CANCELLED"}};A(Vt,"TODO",new Vt({symbol:" ",name:"Todo",nextStatusSymbol:"x",type:"TODO"})),A(Vt,"DONE",new Vt({symbol:"x",name:"Done",nextStatusSymbol:" ",type:"DONE"})),A(Vt,"IN_PROGRESS",new Vt({symbol:"/",name:"In Progress",nextStatusSymbol:"x",type:"IN_PROGRESS"})),A(Vt,"CANCELLED",new Vt({symbol:"-",name:"Cancelled",nextStatusSymbol:" ",type:"CANCELLED"}));let gs=Vt;class cu{static parse(e,t=new Date){const a=e.trim().toLowerCase(),n=e;if(!a)return{date:null,isValid:!1,error:"Empty date string",original:n};if(a.match(/^(\d{4})-(\d{2})-(\d{2})$/)){const f=new Date(a);if(!isNaN(f.getTime()))return{date:f,isValid:!0,original:n}}const o=new Date(t);if(o.setHours(0,0,0,0),a==="today")return{date:o,isValid:!0,original:n};if(a==="tomorrow"){const f=new Date(o);return f.setDate(f.getDate()+1),{date:f,isValid:!0,original:n}}if(a==="yesterday"){const f=new Date(o);return f.setDate(f.getDate()-1),{date:f,isValid:!0,original:n}}const c=a.match(/^in\s+(\d+)\s+(day|days|week|weeks|month|months)$/);if(c){const f=parseInt(c[1]),k=c[2],x=new Date(o);return k.startsWith("day")?x.setDate(x.getDate()+f):k.startsWith("week")?x.setDate(x.getDate()+f*7):k.startsWith("month")&&x.setMonth(x.getMonth()+f),{date:x,isValid:!0,original:n}}const l=a.match(/^(\d+)\s+(day|days|week|weeks|month|months)\s+ago$/);if(l){const f=parseInt(l[1]),k=l[2],x=new Date(o);return k.startsWith("day")?x.setDate(x.getDate()-f):k.startsWith("week")?x.setDate(x.getDate()-f*7):k.startsWith("month")&&x.setMonth(x.getMonth()-f),{date:x,isValid:!0,original:n}}const u=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],h=a.match(/^(next|last)\s+(sunday|monday|tuesday|wednesday|thursday|friday|saturday)$/);if(h){const f=h[1],k=u.indexOf(h[2]),x=o.getDay();let T=k-x;f==="next"?T<=0&&(T+=7):T>=0&&(T-=7);const m=new Date(o);return m.setDate(m.getDate()+T),{date:m,isValid:!0,original:n}}const p=a.match(/^(this|next|last)\s+(week|month)$/);if(p){const f=p[1],k=p[2],x=new Date(o);if(k==="week"){const T=x.getDay(),m=T===0?-6:1-T;x.setDate(x.getDate()+m),f==="next"?x.setDate(x.getDate()+7):f==="last"&&x.setDate(x.getDate()-7)}else k==="month"&&(x.setDate(1),f==="next"?x.setMonth(x.getMonth()+1):f==="last"&&x.setMonth(x.getMonth()-1));return{date:x,isValid:!0,original:n}}return{date:null,isValid:!1,error:`Could not parse date: ${e}`,original:n}}static toISODateString(e){return e.toISOString().split("T")[0]}}class ji{constructor(){A(this,"input","");A(this,"position",0);A(this,"line",1);A(this,"column",1);A(this,"referenceDate",new Date)}parse(e,t=new Date){this.input=e.trim(),this.position=0,this.line=1,this.column=1,this.referenceDate=t;const a={filters:[]},n=this.input.split(`
`).map(i=>i.trim()).filter(i=>i.length>0);for(let i=0;i<n.length;i++){this.line=i+1,this.column=1;const o=n[i];if(o.startsWith("sort by "))a.sort=this.parseSortInstruction(o);else if(o.startsWith("group by "))a.group=this.parseGroupInstruction(o);else if(o.startsWith("limit ")||o.startsWith("limit to "))a.limit=this.parseLimitInstruction(o);else{const c=this.parseFilterInstruction(o);c&&a.filters.push(c)}}return a}validate(e){try{return this.parse(e),{valid:!0}}catch(t){return t instanceof Is?{valid:!1,error:t.message}:{valid:!1,error:String(t)}}}parseFilterInstruction(e){if(e==="done")return{type:"done",operator:"is",value:!0};if(e==="not done")return{type:"done",operator:"is",value:!1};if(e.startsWith("status.type is ")){const a=e.substring(15).trim();return{type:"status",operator:"type-is",value:this.parseStatusType(a)}}if(e.startsWith("status.name includes ")){const a=e.substring(21).trim();return{type:"status",operator:"name-includes",value:this.unquote(a)}}if(e.startsWith("status.symbol is ")){const a=e.substring(17).trim();return{type:"status",operator:"symbol-is",value:this.unquote(a)}}const t=this.parseDateFilter(e);if(t)return t;if(e.startsWith("priority is "))return{type:"priority",operator:"is",value:e.substring(12).trim()};if(e.startsWith("priority above "))return{type:"priority",operator:"above",value:e.substring(15).trim()};if(e.startsWith("priority below "))return{type:"priority",operator:"below",value:e.substring(15).trim()};if(e.startsWith("tag includes ")){const a=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(a)}}if(e.startsWith("tag does not include ")){const a=e.substring(21).trim();return{type:"tag",operator:"includes",value:this.unquote(a),negate:!0}}if(e.startsWith("tags include ")){const a=e.substring(13).trim();return{type:"tag",operator:"includes",value:this.unquote(a)}}if(e==="has tags")return{type:"tag",operator:"has",value:!0};if(e==="no tags")return{type:"tag",operator:"has",value:!1};if(e.startsWith("path includes ")){const a=e.substring(14).trim();return{type:"path",operator:"includes",value:this.unquote(a)}}if(e.startsWith("path does not include ")){const a=e.substring(22).trim();return{type:"path",operator:"includes",value:this.unquote(a),negate:!0}}if(e==="is blocked")return{type:"dependency",operator:"is-blocked",value:!0};if(e==="is not blocked")return{type:"dependency",operator:"is-blocked",value:!1};if(e==="is blocking")return{type:"dependency",operator:"is-blocking",value:!0};if(e==="is recurring")return{type:"recurrence",operator:"is",value:!0};if(e==="is not recurring")return{type:"recurrence",operator:"is",value:!1};throw new Is(`Unknown filter instruction: "${e}"`,this.line,this.column,"Check the query syntax documentation for valid filter instructions")}parseDateFilter(e){const t=["due","scheduled","start","created","done","cancelled"];for(const a of t){if(e===`has ${a} date`)return{type:"date",operator:"has",value:{field:a}};if(e===`no ${a} date`)return{type:"date",operator:"has",value:{field:a},negate:!0};const n=["before","after","on","on or before","on or after"];for(const i of n){const o=`${a} ${i} `;if(e.startsWith(o)){const c=e.substring(o.length).trim(),l=cu.parse(c,this.referenceDate);if(!l.isValid||!l.date)throw new Is(`Invalid date value: "${c}"`,this.line,this.column,'Use formats like: today, tomorrow, YYYY-MM-DD, "in 3 days", "next Monday"');return{type:"date",operator:i,value:{field:a,date:l.date}}}}}return null}parseSortInstruction(e){const t=e.match(/^sort by ([a-z.]+)(\s+reverse)?$/i);if(!t)throw new Is(`Invalid sort instruction: "${e}"`,this.line,this.column,'Use format: "sort by FIELD" or "sort by FIELD reverse"');return{field:t[1],reverse:!!t[2]}}parseGroupInstruction(e){const t=e.match(/^group by ([a-z.]+)$/i);if(!t)throw new Is(`Invalid group instruction: "${e}"`,this.line,this.column,'Use format: "group by FIELD"');return{field:t[1]}}parseLimitInstruction(e){let t=e.match(/^limit (\d+)$/);if(t||(t=e.match(/^limit to (\d+) tasks?$/),t))return parseInt(t[1],10);throw new Is(`Invalid limit instruction: "${e}"`,this.line,this.column,'Use format: "limit 10" or "limit to 10 tasks"')}parseStatusType(e){switch(e.toUpperCase().replace(/\s+/g,"_")){case"TODO":return ks.TODO;case"IN_PROGRESS":return ks.IN_PROGRESS;case"DONE":return ks.DONE;case"CANCELLED":return ks.CANCELLED;case"NON_TASK":return ks.NON_TASK;default:throw new Is(`Invalid status type: "${e}"`,this.line,this.column,"Valid types: TODO, IN_PROGRESS, DONE, CANCELLED, NON_TASK")}}unquote(e){return e.startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'")?e.slice(1,-1):e}}class et{}const Os=class Os{constructor(){A(this,"statuses",new Map);this.addDefaultStatuses()}static getInstance(){return Os.instance||(Os.instance=new Os),Os.instance}addDefaultStatuses(){this.add(gs.TODO),this.add(gs.IN_PROGRESS),this.add(gs.DONE),this.add(gs.CANCELLED)}add(e){this.statuses.set(e.symbol,e)}get(e){const t=this.statuses.get(e);return t||new gs({symbol:e,name:"Unknown",nextStatusSymbol:"x",type:gs.getTypeForUnknownSymbol(e)})}getNextStatus(e){return this.get(e.nextStatusSymbol)}getAllStatuses(){return Array.from(this.statuses.values())}reset(){this.statuses.clear(),this.addDefaultStatuses()}};A(Os,"instance",null);let cs=Os;class uu extends et{constructor(e,t=!1){super(),this.statusType=e,this.negate=t}matches(e){const t=cs.getInstance(),a=e.statusSymbol||" ",i=t.get(a).type===this.statusType;return this.negate?!i:i}}class du extends et{constructor(e,t=!1){super(),this.name=e,this.negate=t}matches(e){const t=cs.getInstance(),a=e.statusSymbol||" ",i=t.get(a).name.toLowerCase().includes(this.name.toLowerCase());return this.negate?!i:i}}class vu extends et{constructor(e,t=!1){super(),this.symbol=e,this.negate=t}matches(e){const a=(e.statusSymbol||" ")===this.symbol;return this.negate?!a:a}}class hu extends et{matches(e){const t=cs.getInstance(),a=e.statusSymbol||" ";return t.get(a).type===ks.DONE}}class fu extends et{matches(e){const t=cs.getInstance(),a=e.statusSymbol||" ";return t.get(a).type!==ks.DONE}}class _u extends et{constructor(e,t,a){super(),this.field=e,this.comparator=t,this.targetDate=a}matches(e){const t=this.getTaskDate(e);if(!t)return!1;const a=new Date(this.targetDate);a.setHours(0,0,0,0);const n=new Date(t);switch(n.setHours(0,0,0,0),this.comparator){case"before":return n<a;case"after":return n>a;case"on":return n.getTime()===a.getTime();case"on or before":return n<=a;case"on or after":return n>=a;default:return!1}}getTaskDate(e){let t;switch(this.field){case"due":t=e.dueAt;break;case"scheduled":t=e.scheduledAt;break;case"start":t=e.startAt;break;case"created":t=e.createdAt;break;case"done":t=e.doneAt;break;case"cancelled":t=e.cancelledAt;break}return t?new Date(t):null}}class pu extends et{constructor(e,t=!1){super(),this.field=e,this.negate=t}matches(e){let t=!1;switch(this.field){case"due":t=!!e.dueAt;break;case"scheduled":t=!!e.scheduledAt;break;case"start":t=!!e.startAt;break;case"created":t=!!e.createdAt;break;case"done":t=!!e.doneAt;break;case"cancelled":t=!!e.cancelledAt;break}return this.negate?!t:t}}const Dr={lowest:0,low:1,medium:2,normal:2,high:3,highest:4};function mu(s){switch(s){case"low":return"low";case"normal":return"normal";case"high":return"high";case"urgent":return"highest";default:return"normal"}}class gu extends et{constructor(e,t){super(),this.operator=e,this.level=t}matches(e){const t=mu(e.priority),a=Dr[t],n=Dr[this.level];switch(this.operator){case"is":return a===n;case"above":return a>n;case"below":return a<n;default:return!1}}}class yu extends et{constructor(e,t=!1){super(),this.tag=e,this.negate=t}matches(e){const t=e.tags||[],a=this.tag.toLowerCase(),n=t.some(i=>i.toLowerCase().includes(a));return this.negate?!n:n}}class ku extends et{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.tags&&e.tags.length>0;return this.negate?!t:!!t}}class bu extends et{constructor(e,t=!1){super(),this.pattern=e,this.negate=t}matches(e){const a=(e.path||"").toLowerCase().includes(this.pattern.toLowerCase());return this.negate?!a:a}}class wu extends et{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph){const a=e.blockedBy&&e.blockedBy.length>0;return this.negate?!a:!!a}const t=this.dependencyGraph.isBlocked(e.id);return this.negate?!t:t}}class Tu extends et{constructor(e,t=!1){super(),this.dependencyGraph=e,this.negate=t}matches(e){if(!this.dependencyGraph)return!!this.negate;const t=this.dependencyGraph.isBlocking(e.id);return this.negate?!t:t}}class Su extends et{constructor(e=!1){super(),this.negate=e}matches(e){const t=e.frequency&&e.frequency.type!=="once";return this.negate?!t:!!t}}class Du extends et{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)&&this.right.matches(e)}}class Eu extends et{constructor(e,t){super(),this.left=e,this.right=t}matches(e){return this.left.matches(e)||this.right.matches(e)}}class Au extends et{constructor(e){super(),this.inner=e}matches(e){return!this.inner.matches(e)}}class xs{group(e){const t=new Map;for(const a of e){const n=this.getGroupKey(a);this.addToGroup(t,n,a)}return t}addToGroup(e,t,a){e.has(t)||e.set(t,[]),e.get(t).push(a)}}class xu extends xs{getGroupKey(e){if(!e.dueAt)return"No due date";const t=new Date;t.setHours(0,0,0,0);const a=new Date(e.dueAt);a.setHours(0,0,0,0);const n=a.getTime()-t.getTime(),i=Math.ceil(n/(1e3*60*60*24));return i<0?"Overdue":i===0?"Today":i===1?"Tomorrow":i<=7?"This Week":"Later"}}class Cu extends xs{getGroupKey(e){if(!e.scheduledAt)return"No scheduled date";const t=new Date;t.setHours(0,0,0,0);const a=new Date(e.scheduledAt);a.setHours(0,0,0,0);const n=a.getTime()-t.getTime(),i=Math.ceil(n/(1e3*60*60*24));return i<0?"Past":i===0?"Today":i===1?"Tomorrow":i<=7?"This Week":"Later"}}class Iu extends xs{getGroupKey(e){const t=cs.getInstance(),a=e.statusSymbol||" ";return t.get(a).type}}class Mu extends xs{getGroupKey(e){const t=cs.getInstance(),a=e.statusSymbol||" ";return t.get(a).name}}class Ou extends xs{getGroupKey(e){const t=e.priority||"normal";return t.charAt(0).toUpperCase()+t.slice(1)}}class qu extends xs{getGroupKey(e){return e.path||""||"No path"}}class Nu extends xs{getGroupKey(e){const t=e.path||"";if(!t)return"No folder";const a=t.lastIndexOf("/");return a===-1?"Root":t.substring(0,a)||"Root"}}class Ru extends xs{group(e){const t=new Map;for(const a of e){const n=a.tags||[];if(n.length===0)this.addToGroup(t,"No tags",a);else for(const i of n)this.addToGroup(t,i,a)}return t}getGroupKey(e){const t=e.tags||[];return t.length>0?t[0]:"No tags"}}class Bu{constructor(e){A(this,"dependencyGraph",null);this.taskIndex=e}setDependencyGraph(e){this.dependencyGraph=e}execute(e){const t=performance.now();try{let a=this.taskIndex.getAllTasks();const n=a.length;e.filters.length>0&&(a=this.applyFilters(a,e.filters)),e.sort&&(a=this.applySort(a,e.sort)),e.limit!==void 0&&e.limit>0&&(a=a.slice(0,e.limit));let i;e.group&&(i=this.applyGrouping(a,e.group));const c=performance.now()-t;return{tasks:a,groups:i,totalCount:n,executionTimeMs:c}}catch(a){throw new ta(`Failed to execute query: ${a instanceof Error?a.message:String(a)}`,a instanceof Error?a:void 0)}}executeString(e){const a=new ji().parse(e);return this.execute(a)}applyFilters(e,t){let a=e;for(const n of t){const i=this.createFilter(n);a=a.filter(o=>i.matches(o))}return a}createFilter(e){switch(e.type){case"done":return e.value?new hu:new fu;case"status":if(e.operator==="type-is")return new uu(e.value,e.negate);if(e.operator==="name-includes")return new du(e.value,e.negate);if(e.operator==="symbol-is")return new vu(e.value,e.negate);throw new ta(`Unknown status operator: ${e.operator}`);case"date":return e.operator==="has"?new pu(e.value.field,e.negate):new _u(e.value.field,e.operator,e.value.date);case"priority":return new gu(e.operator,e.value);case"tag":return e.operator==="has"?new ku(!e.value):new yu(e.value,e.negate);case"path":return new bu(e.value,e.negate);case"dependency":if(e.operator==="is-blocked")return new wu(this.dependencyGraph,!e.value);if(e.operator==="is-blocking")return new Tu(this.dependencyGraph,!e.value);throw new ta(`Unknown dependency operator: ${e.operator}`);case"recurrence":return new Su(!e.value);case"boolean":if(e.operator==="AND"&&e.left&&e.right)return new Du(this.createFilter(e.left),this.createFilter(e.right));if(e.operator==="OR"&&e.left&&e.right)return new Eu(this.createFilter(e.left),this.createFilter(e.right));if(e.operator==="NOT"&&e.inner)return new Au(this.createFilter(e.inner));throw new ta(`Invalid boolean operator: ${e.operator}`);default:throw new ta(`Unknown filter type: ${e.type}`)}}applySort(e,t){const a=[...e];return a.sort((n,i)=>{let o=0;switch(t.field){case"due":o=this.compareDates(n.dueAt,i.dueAt);break;case"scheduled":o=this.compareDates(n.scheduledAt,i.scheduledAt);break;case"start":o=this.compareDates(n.startAt,i.startAt);break;case"created":o=this.compareDates(n.createdAt,i.createdAt);break;case"done":o=this.compareDates(n.doneAt,i.doneAt);break;case"priority":o=this.comparePriorities(n.priority,i.priority);break;case"status.type":o=this.compareStatusTypes(n,i);break;case"description":o=(n.description||"").localeCompare(i.description||"");break;case"path":o=(n.path||"").localeCompare(i.path||"");break;default:o=n.name.localeCompare(i.name)}return t.reverse?-o:o}),a}compareDates(e,t){return!e&&!t?0:e?t?new Date(e).getTime()-new Date(t).getTime():-1:1}comparePriorities(e,t){const a={low:1,normal:2,high:3,urgent:4},n=a[e||"normal"]||2,i=a[t||"normal"]||2;return n-i}compareStatusTypes(e,t){const a=n=>{const i=n.statusSymbol||" ";return i===" "?0:i==="/"?1:i==="x"?2:i==="-"?3:0};return a(e)-a(t)}applyGrouping(e,t){return this.createGrouper(t.field).group(e)}createGrouper(e){switch(e){case"due":return new xu;case"scheduled":return new Cu;case"status.type":return new Iu;case"status.name":return new Mu;case"priority":return new Ou;case"path":return new qu;case"folder":return new Nu;case"tags":return new Ru;default:throw new ta(`Unknown grouping field: ${e}`)}}}var Fu=I('<button class="search-tab__btn svelte-1yjlv38"> </button>'),zu=I('<div class="search-tab__error svelte-1yjlv38"> </div>'),ju=I('<div class="search-tab__stats svelte-1yjlv38"> </div>'),Pu=I('<li><button class="search-tab__history-item svelte-1yjlv38"> </button></li>'),Lu=I('<div class="search-tab__history svelte-1yjlv38"><div class="search-tab__history-header svelte-1yjlv38"><h3 class="svelte-1yjlv38">Recent Queries</h3> <button class="search-tab__btn--small svelte-1yjlv38">Clear</button></div> <ul class="search-tab__history-list svelte-1yjlv38"></ul></div>'),Ku=I('<button class="search-tab__example-btn svelte-1yjlv38"><code class="svelte-1yjlv38"> </code></button>'),Uu=I('<div class="search-tab__empty svelte-1yjlv38"><p class="svelte-1yjlv38">üîç No tasks match your query</p> <p class="search-tab__empty-subtitle svelte-1yjlv38">Try adjusting your search criteria</p></div>'),Hu=I('<div class="search-tab__card-wrapper svelte-1yjlv38"><!></div>'),Gu=I(`<div class="search-tab svelte-1yjlv38"><div class="search-tab__header svelte-1yjlv38"><h2 class="search-tab__title svelte-1yjlv38">Search</h2> <p class="search-tab__subtitle svelte-1yjlv38">Use query language to filter and search tasks</p></div> <div class="search-tab__query-section svelte-1yjlv38"><div class="search-tab__input-wrapper svelte-1yjlv38"><textarea class="search-tab__input svelte-1yjlv38" placeholder="Enter query (e.g., 'not done AND priority high')..." rows="2"></textarea> <div class="search-tab__input-actions svelte-1yjlv38"><button class="search-tab__btn search-tab__btn--primary svelte-1yjlv38"> </button> <!></div></div> <!> <!></div> <!> <div class="search-tab__examples svelte-1yjlv38"><h3 class="search-tab__examples-title svelte-1yjlv38">Example Queries</h3> <div class="search-tab__examples-grid svelte-1yjlv38"></div></div> <div class="search-tab__results svelte-1yjlv38"><!></div></div>`);function Yu(s,e){Pe(e,!0);let t=X(""),a=X(fe([])),n=X(""),i=X(0),o=X(fe([])),c=X(!1),l=X(!1);const u=["not done","due today","priority high","status.type IN_PROGRESS","not done AND due before tomorrow","has tags","done after 7 days ago","not done GROUP BY priority"],h={getAllTasks:()=>e.tasks},p=new Bu(h);function f(){if(!r(t).trim()){_(a,[],!0),_(n,"");return}_(l,!0),_(n,"");try{const ae=new ji().parse(r(t)),b=p.execute(ae);if(_(a,b.tasks,!0),_(i,b.executionTimeMs,!0),!r(o).includes(r(t))){_(o,[r(t),...r(o)].slice(0,10),!0);try{localStorage.setItem("query-history",JSON.stringify(r(o)))}catch{}}}catch(G){_(n,G instanceof Error?G.message:String(G),!0),_(a,[],!0),se.error(`Query error: ${r(n)}`)}finally{_(l,!1)}}function k(){try{const G=localStorage.getItem("query-history");G&&_(o,JSON.parse(G),!0)}catch{}}function x(G){_(t,G,!0),f()}function T(G){_(t,G,!0),_(c,!1),f()}function m(){_(o,[],!0);try{localStorage.removeItem("query-history")}catch{}_(c,!1)}function g(G){G.key==="Enter"&&!G.shiftKey&&(G.preventDefault(),f())}vt(()=>{k()});let M=X(0),w=fe([]);vt(()=>{r(M)>=r(a).length&&_(M,Math.max(0,r(a).length-1),!0)});function C(G,ae){G.key==="ArrowDown"?(G.preventDefault(),_(M,Math.min(r(M)+1,r(a).length-1),!0)):G.key==="ArrowUp"?(G.preventDefault(),_(M,Math.max(r(M)-1,0),!0)):G.key==="Enter"&&e.onEdit?(G.preventDefault(),e.onEdit(r(a)[ae])):G.key===" "&&e.onDone&&(G.preventDefault(),e.onDone(r(a)[ae]))}var R=Gu(),B=v(d(R),2),q=d(B),K=d(q);K.__keydown=g;var L=v(K,2),Q=d(L);Q.__click=f;var $=d(Q),H=v(Q,2);{var te=G=>{var ae=Fu();ae.__click=()=>_(c,!r(c));var b=d(ae);U(()=>F(b,`History (${r(o).length??""})`)),y(G,ae)};V(H,G=>{r(o).length>0&&G(te)})}var oe=v(q,2);{var ie=G=>{var ae=zu(),b=d(ae);U(()=>F(b,`‚ö†Ô∏è ${r(n)??""}`)),y(G,ae)};V(oe,G=>{r(n)&&G(ie)})}var j=v(oe,2);{var E=G=>{var ae=ju(),b=d(ae);U(N=>F(b,`Found ${r(a).length??""} task${r(a).length!==1?"s":""} in ${N??""}ms`),[()=>r(i).toFixed(2)]),y(G,ae)};V(j,G=>{r(i)>0&&!r(n)&&G(E)})}var P=v(B,2);{var ee=G=>{var ae=Lu(),b=d(ae),N=v(d(b),2);N.__click=m;var W=v(b,2);Ce(W,21,()=>r(o),mt,(ne,ce)=>{var D=Pu(),z=d(D);z.__click=()=>T(r(ce));var de=d(z);U(()=>F(de,r(ce))),y(ne,D)}),y(G,ae)};V(P,G=>{r(c)&&r(o).length>0&&G(ee)})}var J=v(P,2),ye=v(d(J),2);Ce(ye,21,()=>u,mt,(G,ae)=>{var b=Ku();b.__click=()=>x(r(ae));var N=d(b),W=d(N);U(()=>F(W,r(ae))),y(G,b)});var le=v(J,2),_e=d(le);{var we=G=>{var ae=Uu();y(G,ae)},De=G=>{var ae=Ge(),b=Me(ae);{var N=W=>{var ne=Ge(),ce=Me(ne);Ce(ce,19,()=>r(a),D=>D.id,(D,z,de)=>{var Te=Hu();Te.__keydown=xe=>C(xe,r(de));var Ke=d(Te);pa(Ke,{get task(){return r(z)},get onEdit(){return e.onEdit},get onDone(){return e.onDone},get onDelete(){return e.onDelete}}),Ut(Te,(xe,Oe)=>w[Oe]=xe,xe=>w==null?void 0:w[xe],()=>[r(de)]),U(()=>Ie(Te,"tabindex",r(de)===r(M)?0:-1)),Ze("focus",Te,()=>_(M,r(de),!0)),y(D,Te)}),y(W,ne)};V(b,W=>{r(a).length>0&&W(N)},!0)}y(G,ae)};V(_e,G=>{r(a).length===0&&r(t).trim()&&!r(n)?G(we):G(De,!1)})}U(()=>{Q.disabled=r(l),F($,r(l)?"Searching...":"Search")}),Dt(K,()=>r(t),G=>_(t,G)),y(s,R),Le()}rt(["keydown","click"]);class qn{static parse(e){const t=e,a=e.trim().toLowerCase();if(!a)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence string cannot be empty"};const n=a.match(/^every\s+(.+)$/);if(!n)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence must start with 'every'"};const i=n[1];if(i==="weekday"||i==="weekdays")return{frequency:{type:"weekly",interval:1,weekdays:[0,1,2,3,4]},raw:t,isValid:!0};if(i==="weekend"||i==="weekends")return{frequency:{type:"weekly",interval:1,weekdays:[5,6]},raw:t,isValid:!0};const o=i.match(/^(\d+\s+)?days?$/);if(o)return{frequency:{type:"daily",interval:o[1]?parseInt(o[1]):1},raw:t,isValid:!0};const c=i.match(/^(\d+\s+)?weeks?(?:\s+on\s+(.+))?$/);if(c){const h=c[1]?parseInt(c[1]):1,p=c[2];if(!p)return{frequency:{type:"weekly",interval:h,weekdays:[1]},raw:t,isValid:!0};const f=this.parseDayNames(p);return f.length===0?{frequency:{type:"weekly",interval:h,weekdays:[1]},raw:t,isValid:!1,error:"Invalid day names"}:{frequency:{type:"weekly",interval:h,weekdays:f},raw:t,isValid:!0}}const l=i.match(/^(\d+\s+)?months?(?:\s+on\s+the\s+(\d+)(?:st|nd|rd|th)?)?$/);if(l){const h=l[1]?parseInt(l[1]):1,p=l[2]?parseInt(l[2]):1;return p<1||p>31?{frequency:{type:"monthly",interval:h,dayOfMonth:1},raw:t,isValid:!1,error:"Day of month must be between 1 and 31"}:{frequency:{type:"monthly",interval:h,dayOfMonth:p},raw:t,isValid:!0}}const u=i.match(/^(\d+\s+)?years?$/);return u?{frequency:{type:"yearly",interval:u[1]?parseInt(u[1]):1,month:0,dayOfMonth:1},raw:t,isValid:!0}:{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Unrecognized recurrence pattern"}}static stringify(e){const t=e.interval;switch(e.type){case"daily":return t===1?"every day":`every ${t} days`;case"weekly":{const a=t===1?"week":`${t} weeks`;if(e.weekdays.length===0)return`every ${a}`;const n=e.weekdays.map(i=>this.getDayName(i)).join(", ");return`every ${a} on ${n}`}case"monthly":{const a=t===1?"month":`${t} months`,n=this.getDaySuffix(e.dayOfMonth);return`every ${a} on the ${e.dayOfMonth}${n}`}case"yearly":return`every ${t===1?"year":`${t} years`}`;default:return"every day"}}static parseDayNames(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6},a=e.split(",").map(i=>i.trim().toLowerCase()),n=[];for(const i of a)i in t&&n.push(t[i]);return n}static getDayName(e){return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]||"Monday"}static getDaySuffix(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}var Vu=I('<label><input type="radio" name="priority" class="svelte-1w15n9q"/> <span class="priority-selector__emoji svelte-1w15n9q"> </span> <span class="priority-selector__label svelte-1w15n9q"> </span></label>'),Wu=I('<div class="priority-selector svelte-1w15n9q"></div>');function Qu(s,e){Pe(e,!0);let t=ls(e,"value",15,"normal");const a=[{value:"urgent",label:"Urgent",emoji:"üî¥",color:"var(--b3-theme-error, #ff4444)"},{value:"high",label:"High",emoji:"üü†",color:"#ff8800"},{value:"normal",label:"Normal",emoji:"üü°",color:"#ffcc00"},{value:"low",label:"Low",emoji:"üü¢",color:"#44cc44"}];function n(o){t(o),e.onchange(o)}var i=Wu();Ce(i,21,()=>a,mt,(o,c)=>{var l=Vu();let u;var h=d(l);h.__change=()=>n(r(c).value);var p=v(h,2),f=d(p),k=v(p,2),x=d(k);U(()=>{u=Fe(l,1,"priority-selector__option svelte-1w15n9q",null,u,{active:t()===r(c).value}),Gs(l,`--priority-color: ${r(c).color??""}`),Mi(h,r(c).value),Sa(h,t()===r(c).value),F(f,r(c).emoji),F(x,r(c).label)}),y(o,l)}),y(s,i),Le()}rt(["change"]);var Xu=I('<label><input type="radio" name="status" class="svelte-v9ezc0"/> <span class="status-selector__icon svelte-v9ezc0"> </span> <span class="status-selector__label svelte-v9ezc0"> </span></label>'),Ju=I('<div class="status-selector svelte-v9ezc0"></div>');function Zu(s,e){Pe(e,!0);let t=ls(e,"value",15,"todo");const a=[{value:"todo",label:"Todo",icon:"‚óã",color:"var(--b3-theme-on-surface)"},{value:"done",label:"Done",icon:"‚úì",color:"#44cc44"},{value:"cancelled",label:"Cancelled",icon:"‚úï",color:"#999"}];function n(o){t(o),e.onchange(o)}var i=Ju();Ce(i,21,()=>a,mt,(o,c)=>{var l=Xu();let u;var h=d(l);h.__change=()=>n(r(c).value);var p=v(h,2),f=d(p),k=v(p,2),x=d(k);U(()=>{u=Fe(l,1,"status-selector__option svelte-v9ezc0",null,u,{active:t()===r(c).value}),Gs(l,`--status-color: ${r(c).color??""}`),Mi(h,r(c).value),Sa(h,t()===r(c).value),F(f,r(c).icon),F(x,r(c).label)}),y(o,l)}),y(s,i),Le()}rt(["change"]);var $u=I('<div class="recurrence-input__valid svelte-787fjp">‚úì Valid recurrence pattern</div>'),ed=I('<div class="recurrence-input__error svelte-787fjp"> </div>'),td=I('<div class="recurrence-input__feedback svelte-787fjp"><!></div>'),sd=I('<li class="svelte-787fjp"> </li>'),ad=I('<div class="recurrence-input__preview svelte-787fjp"><div class="recurrence-input__preview-title svelte-787fjp">Next occurrences:</div> <ul class="recurrence-input__preview-list svelte-787fjp"></ul></div>'),nd=I('<div class="recurrence-input svelte-787fjp"><input type="text" placeholder="e.g., every week on Monday"/> <!> <!></div>');function rd(s,e){Pe(e,!0);let t=ls(e,"value",15,""),a=ls(e,"showPreview",3,!0);const n=Y(()=>qn.parse(t())),i=Y(()=>r(n).isValid),o=Y(()=>r(n).error);function c(g,M=3){const w=[],C=new Date;for(let R=0;R<M;R++){const B=new Date(C);switch(g.type){case"daily":B.setDate(C.getDate()+R*g.interval);break;case"weekly":B.setDate(C.getDate()+R*g.interval*7);break;case"monthly":B.setMonth(C.getMonth()+R*g.interval);break;case"yearly":B.setFullYear(C.getFullYear()+R*g.interval);break}w.push(B.toLocaleDateString())}return w}const l=Y(()=>r(i)&&a()?c(r(n).frequency):[]);function u(g){const w=g.target.value;t(w);const C=qn.parse(w);e.onchange(w,C.isValid?C.frequency:null,C.isValid)}var h=nd(),p=d(h);let f;p.__input=u;var k=v(p,2);{var x=g=>{var M=td(),w=d(M);{var C=B=>{var q=$u();y(B,q)},R=B=>{var q=ed(),K=d(q);U(()=>F(K,`‚ö† ${(r(o)||"Invalid recurrence pattern")??""}`)),y(B,q)};V(w,B=>{r(i)?B(C):B(R,!1)})}y(g,M)};V(k,g=>{t().length>0&&g(x)})}var T=v(k,2);{var m=g=>{var M=ad(),w=v(d(M),2);Ce(w,21,()=>r(l),mt,(C,R)=>{var B=sd(),q=d(B);U(()=>F(q,r(R))),y(C,B)}),y(g,M)};V(T,g=>{r(i)&&a()&&r(l).length>0&&g(m)})}U(()=>{f=Fe(p,1,"recurrence-input__field svelte-787fjp",null,f,{valid:r(i),invalid:!r(i)&&t().length>0}),Ie(p,"aria-invalid",!r(i)&&t().length>0)}),Dt(p,t),y(s,h),Le()}rt(["input"]);var id=I('<div class="dependency-picker__chip svelte-10ls0lk"><span class="dependency-picker__chip-text svelte-10ls0lk"> </span> <button type="button" class="dependency-picker__chip-remove svelte-10ls0lk">‚úï</button></div>'),od=I('<div class="dependency-picker__chips svelte-10ls0lk"></div>'),ld=I('<span class="dependency-picker__option-check svelte-10ls0lk">‚úì</span>'),cd=I('<button type="button"><span class="dependency-picker__option-name svelte-10ls0lk"> </span> <!></button>'),ud=I('<div class="dependency-picker__dropdown svelte-10ls0lk"></div>'),dd=I('<div class="dependency-picker svelte-10ls0lk"><label class="dependency-picker__label svelte-10ls0lk"> </label> <!> <div class="dependency-picker__search-wrapper svelte-10ls0lk"><input type="text" class="dependency-picker__search svelte-10ls0lk" placeholder="Search tasks..."/> <!></div></div>');function Er(s,e){Pe(e,!0);let t=ls(e,"selected",31,()=>fe([])),a=ls(e,"label",3,"Select tasks"),n=X(""),i=X(!1);const o=Y(()=>e.repository.getAllTasks().filter(B=>B.id!==e.excludeId)),c=Y(()=>r(n).trim()?r(o).filter(B=>B.name.toLowerCase().includes(r(n).toLowerCase())):r(o)),l=Y(()=>r(o).filter(B=>t().includes(B.id)));function u(B){if(!t().includes(B)){const q=[...t(),B];t(q),e.onchange(q)}_(n,""),_(i,!1)}function h(B){const q=t().filter(K=>K!==B);t(q),e.onchange(q)}function p(){_(i,!0)}function f(){setTimeout(()=>{_(i,!1)},200)}var k=dd(),x=d(k),T=d(x),m=v(x,2);{var g=B=>{var q=od();Ce(q,21,()=>r(l),K=>K.id,(K,L)=>{var Q=id(),$=d(Q),H=d($),te=v($,2);te.__click=()=>h(r(L).id),U(()=>{F(H,r(L).name),Ie(te,"aria-label",`Remove ${r(L).name??""}`)}),y(K,Q)}),y(B,q)};V(m,B=>{r(l).length>0&&B(g)})}var M=v(m,2),w=d(M),C=v(w,2);{var R=B=>{var q=ud();Ce(q,21,()=>r(c).slice(0,10),K=>K.id,(K,L)=>{var Q=cd();let $;Q.__click=()=>u(r(L).id);var H=d(Q),te=d(H),oe=v(H,2);{var ie=j=>{var E=ld();y(j,E)};V(oe,j=>{t().includes(r(L).id)&&j(ie)})}U((j,E)=>{$=Fe(Q,1,"dependency-picker__option svelte-10ls0lk",null,$,j),Q.disabled=E,F(te,r(L).name)},[()=>({selected:t().includes(r(L).id)}),()=>t().includes(r(L).id)]),y(K,Q)}),y(B,q)};V(C,B=>{r(i)&&r(c).length>0&&B(R)})}U(()=>F(T,a())),Ze("focus",w,p),Ze("blur",w,f),Dt(w,()=>r(n),B=>_(n,B)),y(s,k),Le()}rt(["click"]);var vd=I('<div class="task-editor__error svelte-xc3qs9"> </div>'),hd=I('<div class="task-editor__error svelte-xc3qs9"> </div>'),fd=I('<div class="task-editor__error svelte-xc3qs9"> </div>'),_d=I('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Completed:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),pd=I('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Cancelled:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),md=I('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Linked block:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),gd=I('<div class="task-editor-overlay svelte-xc3qs9" role="dialog" aria-modal="true" aria-labelledby="task-editor-title" tabindex="-1"><div class="task-editor-modal svelte-xc3qs9" role="document"><div class="task-editor__header svelte-xc3qs9"><h2 id="task-editor-title" class="svelte-xc3qs9"> </h2> <button class="task-editor__close svelte-xc3qs9" type="button" aria-label="Close">‚úï</button></div> <div class="task-editor__body svelte-xc3qs9"><div class="task-editor__field svelte-xc3qs9"><label for="task-name" class="svelte-xc3qs9">Description *</label> <input id="task-name" type="text" placeholder="Task name" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-description" class="svelte-xc3qs9">Notes</label> <textarea id="task-description" placeholder="Additional details about this task..." rows="3" class="svelte-xc3qs9"></textarea></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Priority</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Status</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-due" class="svelte-xc3qs9">Due Date *</label> <input id="task-due" type="datetime-local" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-scheduled" class="svelte-xc3qs9">Scheduled Date</label> <input id="task-scheduled" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">When you plan to start working on this task</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-start" class="svelte-xc3qs9">Start Date</label> <input id="task-start" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">Earliest date this task can begin</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-recurrence" class="svelte-xc3qs9">Recurrence</label> <!> <!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__timestamps svelte-xc3qs9"><div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Created:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div> <!> <!> <!></div></div> <div class="task-editor__footer svelte-xc3qs9"><button class="task-editor__cancel svelte-xc3qs9" type="button">Cancel</button> <button class="task-editor__save svelte-xc3qs9" type="button"> </button></div> <div class="task-editor__hint-footer svelte-xc3qs9">üí° Press <kbd class="svelte-xc3qs9">Esc</kbd> to close, <kbd class="svelte-xc3qs9">‚åò/Ctrl+Enter</kbd> to save</div></div></div>');function Pi(s,e){var We,Be,ze,ot,bt,lt,Mt,ct,jt,_s,wt,ts;Pe(e,!0);const t="every day",a="Blocked by (tasks that must complete first)",n="Blocks (tasks that depend on this)",i=!e.task;let o=X(fe(((We=e.task)==null?void 0:We.name)||"")),c=X(fe(((Be=e.task)==null?void 0:Be.description)||"")),l=X(fe(((ze=e.task)==null?void 0:ze.priority)||"normal")),u=X(fe(((ot=e.task)==null?void 0:ot.status)||"todo")),h=X(fe((bt=e.task)!=null&&bt.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16))),p=X(fe((lt=e.task)!=null&&lt.scheduledAt?new Date(e.task.scheduledAt).toISOString().slice(0,16):"")),f=X(fe((Mt=e.task)!=null&&Mt.startAt?new Date(e.task.startAt).toISOString().slice(0,16):"")),k=X(fe(((ct=e.task)==null?void 0:ct.recurrenceText)||((jt=e.task)!=null&&jt.frequency?qn.stringify(e.task.frequency):t))),x=X(fe(((_s=e.task)==null?void 0:_s.frequency)||null)),T=X(!0),m=X(fe(((wt=e.task)==null?void 0:wt.blockedBy)||[])),g=X(fe(((ts=e.task)==null?void 0:ts.dependsOn)||[])),M=X(fe({name:!1,dueAt:!1,recurrence:!1})),w=X(!1),C=X(null);const R=Y(()=>r(M).name&&!r(o).trim()?"Task name is required":""),B=Y(()=>r(M).dueAt?r(h)?Number.isNaN(new Date(r(h)).getTime())?"Invalid due date":"":"Due date is required":""),q=Y(()=>r(M).recurrence&&!r(T)?"Invalid recurrence pattern":""),K=Y(()=>!!(r(R)||r(B)||r(q)));rn(()=>{requestAnimationFrame(()=>{var O;(O=r(C))==null||O.focus()})});function L(O,ue,ut){_(k,O,!0),_(x,ue,!0),_(T,ut,!0),r(M).recurrence=!0}function Q(O){_(l,O,!0)}function $(O){_(u,O,!0)}function H(O){_(m,O,!0)}function te(O){_(g,O,!0)}async function oe(){if(_(M,{name:!0,dueAt:!0,recurrence:!0},!0),r(K)){se.warning("Please fix validation errors");return}if(!r(x)){se.error("Invalid recurrence pattern");return}_(w,!0);try{let O;i?O=qi(r(o).trim(),r(x),new Date(r(h))):(O={...e.task},O.name=r(o).trim(),O.frequency=r(x),O.dueAt=new Date(r(h)).toISOString()),O.description=r(c).trim()||void 0,O.priority=r(l),O.status=r(u),O.recurrenceText=r(k),O.scheduledAt=r(p)?new Date(r(p)).toISOString():void 0,O.startAt=r(f)?new Date(r(f)).toISOString():void 0,O.blockedBy=r(m).length>0?r(m):void 0,O.dependsOn=r(g).length>0?r(g):void 0,O.updatedAt=new Date().toISOString(),r(u)==="done"&&!O.lastCompletedAt&&(O.lastCompletedAt=new Date().toISOString()),r(u)==="cancelled"&&!O.cancelledAt&&(O.cancelledAt=new Date().toISOString()),await e.repository.saveTask(O),e.onSave&&e.onSave(O),se.success(`Task "${O.name}" ${i?"created":"updated"}`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(O){se.error(`Failed to save task: ${O}`)}finally{_(w,!1)}}function ie(O){O.key==="Escape"&&e.onClose(),(O.metaKey||O.ctrlKey)&&O.key==="Enter"&&(O.preventDefault(),oe())}function j(O){return O?new Date(O).toLocaleString():"‚Äî"}var E=gd();E.__keydown=ie;var P=d(E),ee=d(P),J=d(ee),ye=d(J),le=v(J,2);le.__click=function(...O){var ue;(ue=e.onClose)==null||ue.apply(this,O)};var _e=v(ee,2),we=d(_e),De=v(d(we),2);De.__input=()=>r(M).name=!0,Ut(De,O=>_(C,O),()=>r(C));var G=v(De,2);{var ae=O=>{var ue=vd(),ut=d(ue);U(()=>F(ut,r(R))),y(O,ue)};V(G,O=>{r(R)&&O(ae)})}var b=v(we,2),N=v(d(b),2),W=v(b,2),ne=v(d(W),2);Qu(ne,{get value(){return r(l)},onchange:Q});var ce=v(W,2),D=v(d(ce),2);Zu(D,{get value(){return r(u)},onchange:$});var z=v(ce,2),de=v(d(z),2);de.__input=()=>r(M).dueAt=!0;var Te=v(de,2);{var Ke=O=>{var ue=hd(),ut=d(ue);U(()=>F(ut,r(B))),y(O,ue)};V(Te,O=>{r(B)&&O(Ke)})}var xe=v(z,2),Oe=v(d(xe),2),Ue=v(xe,2),$t=v(d(Ue),2),kt=v(Ue,2),At=v(d(kt),2);rd(At,{get value(){return r(k)},onchange:L,showPreview:!0});var Ht=v(At,2);{var it=O=>{var ue=fd(),ut=d(ue);U(()=>F(ut,r(q))),y(O,ue)};V(Ht,O=>{r(q)&&O(it)})}var Re=v(kt,2),Gt=d(Re);{let O=Y(()=>{var ue;return(ue=e.task)==null?void 0:ue.id});Er(Gt,{get repository(){return e.repository},get selected(){return r(m)},get excludeId(){return r(O)},onchange:H,label:a})}var He=v(Re,2),fs=d(He);{let O=Y(()=>{var ue;return(ue=e.task)==null?void 0:ue.id});Er(fs,{get repository(){return e.repository},get selected(){return r(g)},get excludeId(){return r(O)},onchange:te,label:n})}var Yt=v(He,2),xt=d(Yt),es=v(d(xt),2),Z=d(es),ve=v(xt,2);{var Se=O=>{var ue=_d(),ut=v(d(ue),2),Cs=d(ut);U(ma=>F(Cs,ma),[()=>j(e.task.lastCompletedAt)]),y(O,ue)};V(ve,O=>{var ue;(ue=e.task)!=null&&ue.lastCompletedAt&&O(Se)})}var qe=v(ve,2);{var tt=O=>{var ue=pd(),ut=v(d(ue),2),Cs=d(ut);U(ma=>F(Cs,ma),[()=>j(e.task.cancelledAt)]),y(O,ue)};V(qe,O=>{var ue;(ue=e.task)!=null&&ue.cancelledAt&&O(tt)})}var st=v(qe,2);{var Ct=O=>{var ue=md(),ut=v(d(ue),2),Cs=d(ut);U(()=>F(Cs,e.task.linkedBlockId)),y(O,ue)};V(st,O=>{var ue;(ue=e.task)!=null&&ue.linkedBlockId&&O(Ct)})}var It=v(_e,2),he=d(It);he.__click=function(...O){var ue;(ue=e.onClose)==null||ue.apply(this,O)};var Ee=v(he,2);Ee.__click=oe;var Ne=d(Ee);U(O=>{F(ye,i?"Create Task":"Edit Task"),Ie(De,"aria-invalid",!!r(R)),Ie(de,"aria-invalid",!!r(B)),F(Z,O),Ee.disabled=r(w),F(Ne,r(w)?"Saving...":i?"Create Task":"Save Changes")},[()=>{var O;return j((O=e.task)==null?void 0:O.createdAt)}]),Ze("blur",De,()=>r(M).name=!0),Dt(De,()=>r(o),O=>_(o,O)),Dt(N,()=>r(c),O=>_(c,O)),Ze("blur",de,()=>r(M).dueAt=!0),Dt(de,()=>r(h),O=>_(h,O)),Dt(Oe,()=>r(p),O=>_(p,O)),Dt($t,()=>r(f),O=>_(f,O)),y(s,E),Le()}rt(["keydown","click","input"]);const yd=[{label:"Create recurring task",description:"Open the task creation flow from the editor selection.",keys:"‚åò‚áßR",context:"Editor"},{label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",keys:"‚åò‚áßT",context:"Global"},{label:"Quick complete next task",description:"Marks the most overdue task as complete.",keys:"‚åò‚áßD",context:"Global"}];var kd=I('<button class="settings__close-btn svelte-1ke3hir">‚úï</button>'),bd=I("<div> </div>"),wd=I('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),Td=I('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"> </div></div>'),Sd=I('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">n8n Integration</h2> <!></div> <div class="settings__content svelte-1ke3hir"><section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section> <section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div></section></div> <div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div></div>');function Dd(s,e){Pe(e,!0);let t=X(fe(In)),a=X(null),n=fe({});vt(()=>{_(t,e.eventService.getConfig(),!0)});async function i(){try{await e.eventService.saveConfig(r(t)),se.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch(H){se.error("Failed to save settings: "+H)}}async function o(){_(a,"n8n"),n.n8n={success:!1,message:"Testing..."};try{const H=await e.eventService.testConnection();n.n8n={success:H.success,message:H.success?"Test successful!":H.message||"Test failed. Check configuration."}}catch(H){n.n8n={success:!1,message:"Error: "+(H instanceof Error?H.message:String(H))}}finally{_(a,null)}}var c=Sd(),l=d(c),u=v(d(l),2);{var h=H=>{var te=kd();te.__click=function(...oe){var ie;(ie=e.onClose)==null||ie.apply(this,oe)},y(H,te)};V(u,H=>{e.onClose&&H(h)})}var p=v(l,2),f=d(p),k=d(f),x=v(d(k),2),T=d(x),m=v(k,2),g=v(d(m),2),M=v(m,2),w=v(d(M),2),C=v(M,2);C.__click=o;var R=d(C),B=v(C,2);{var q=H=>{var te=bd(),oe=d(te);U(()=>{Fe(te,1,`settings__test-result ${n.n8n.success?"success":"error"}`,"svelte-1ke3hir"),F(oe,n.n8n.message)}),y(H,te)};V(B,H=>{n.n8n&&H(q)})}var K=v(f,2),L=v(d(K),2);Ce(L,21,()=>yd,mt,(H,te)=>{var oe=Td(),ie=d(oe),j=d(ie),E=d(j),P=v(j,2),ee=d(P),J=v(P,2);{var ye=we=>{var De=wd(),G=d(De);U(()=>F(G,r(te).context)),y(we,De)};V(J,we=>{r(te).context&&we(ye)})}var le=v(ie,2),_e=d(le);U(()=>{F(E,r(te).label),F(ee,r(te).description),F(_e,r(te).keys)}),y(H,oe)});var Q=v(p,2),$=d(Q);$.__click=i,U(()=>{g.disabled=!r(t).n8n.enabled,w.disabled=!r(t).n8n.enabled,C.disabled=!r(t).n8n.enabled||r(a)==="n8n",F(R,r(a)==="n8n"?"Testing...":"Test Connection")}),Sl(T,()=>r(t).n8n.enabled,H=>r(t).n8n.enabled=H),Dt(g,()=>r(t).n8n.webhookUrl,H=>r(t).n8n.webhookUrl=H),Dt(w,()=>r(t).n8n.sharedSecret,H=>r(t).n8n.sharedSecret=H),y(s,c),Le()}rt(["click"]);var Ed=I('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),Ad=I('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),xd=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Cd=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Id=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Md=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Od=I('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),qd=I('<div class="dashboard__filters svelte-1y1a8hs"><span class="dashboard__filters-label svelte-1y1a8hs">Quick Filters:</span> <button>Not Done</button> <button>Due Today</button> <button>Overdue</button> <button>In Progress</button> <button>Blocked</button> <button>High Priority</button></div>'),Nd=I('<div class="dashboard__tabs svelte-1y1a8hs"><button>üì• Inbox <!></button> <button>üìã Today <!></button> <button>üìÖ Upcoming <!></button> <button>‚úÖ Done <!></button> <button>üìÅ Projects <!></button> <button>üîç Search</button> <button>üìù All <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button></div> <!> <div class="dashboard__content svelte-1y1a8hs"><!></div>',1),Rd=I('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <div class="dashboard__header-actions svelte-1y1a8hs"><button class="dashboard__refresh-btn svelte-1y1a8hs" title="Refresh tasks"> </button> <button class="dashboard__settings-btn svelte-1y1a8hs">‚öôÔ∏è Settings</button></div></div> <!></div>');function Bd(s,e){Pe(e,!0);const t=e.scheduler.getTimezoneHandler(),a=e.scheduler.getRecurrenceEngine();let n=X("today"),i=X(!1),o=X(!1),c=X(void 0),l=X(fe(new Set)),u=X(fe([])),h=Y(()=>jl(r(u))),p=X(!1);const f=Y(()=>()=>{let b=r(u);if(r(l).has("notDone")&&(b=b.filter(N=>N.status!=="done"&&N.status!=="cancelled")),r(l).has("dueToday")){const N=new Date;N.setHours(0,0,0,0);const W=new Date(N);W.setDate(W.getDate()+1),b=b.filter(ne=>{if(!ne.dueAt)return!1;const ce=new Date(ne.dueAt);return ce>=N&&ce<W})}if(r(l).has("overdue")){const N=new Date;N.setHours(0,0,0,0),b=b.filter(W=>!W.dueAt||W.status==="done"||W.status==="cancelled"?!1:new Date(W.dueAt)<N)}return r(l).has("inProgress")&&(b=b.filter(N=>N.status==="todo"&&N.statusSymbol&&N.statusSymbol!==" ")),r(l).has("blocked")&&(b=b.filter(N=>N.blockedBy&&N.blockedBy.length>0)),r(l).has("highPriority")&&(b=b.filter(N=>N.priority==="high"||N.priority==="urgent")),b}),k=Y(()=>r(u).filter(b=>b.status!=="done"&&b.status!=="cancelled"&&!b.dueAt&&!b.scheduledAt&&!b.startAt).length),x=Y(()=>()=>{const b=new Date;b.setHours(0,0,0,0);const N=new Date(b);return N.setDate(N.getDate()+7),r(u).filter(W=>{if(W.status==="done"||W.status==="cancelled"||!W.dueAt)return!1;const ne=new Date(W.dueAt);return ne.setHours(0,0,0,0),ne>b&&ne<=N}).length}),T=Y(()=>()=>{const b=new Date;return b.setDate(b.getDate()-30),b.setHours(0,0,0,0),r(u).filter(N=>N.status!=="done"||!N.doneAt?!1:new Date(N.doneAt)>=b).length}),m=Y(()=>r(u).filter(b=>b.status!=="done"&&b.status!=="cancelled").length);function g(b="initial"){_(p,!0),_(u,e.repository.getAllTasks().map(N=>({...N})),!0),_(p,!1),b!=="initial"&&se.info("Task list reloaded")}g();const M=()=>g("reload");rn(()=>{window.addEventListener("recurring-task-refresh",M)}),El(()=>{window.removeEventListener("recurring-task-refresh",M)});async function w(b){je.emit("task:complete",{taskId:b.id})}async function C(b){const N=r(u),W=gn(r(u),b.id,ne=>{const ce={...ne},D=new Date(ce.dueAt),z=t.tomorrow();return z.setHours(D.getHours(),D.getMinutes(),0,0),ce.dueAt=z.toISOString(),ce.snoozeCount=(ce.snoozeCount||0)+1,ce.updatedAt=new Date().toISOString(),ce});_(u,W,!0),se.info(`Task "${b.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task.snoozed",b),await e.scheduler.delayToTomorrow(b.id)}catch(ne){_(u,N,!0),se.error("Failed to delay task: "+ne),g("external")}}async function R(b){var W;if(!((W=b.name)!=null&&W.trim())){se.error("Task name is required");return}if(!Oi(b.frequency)){se.error("Invalid frequency configuration");return}const N={...b};_(u,mn(r(u),N),!0),_(i,!1),_(c,void 0),se.success(`Task "${b.name}" saved successfully`),e.repository.saveTask(N).catch(ne=>{se.error("Failed to save task: "+ne),g("external")})}async function B(b){const N=r(u);_(u,Tr(r(u),b.id),!0);const W=window.setTimeout(async()=>{try{await e.repository.deleteTask(b.id)}catch(ne){_(u,N,!0),se.error("Failed to delete task: "+ne),g("external")}},5e3);Rs({message:`Task "${b.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(W),_(u,N,!0),se.info(`Restored "${b.name}"`)},showCountdown:!0})}async function q(b){const N=b.name.endsWith(" (copy)")?`${b.name} ${new Date().toLocaleDateString()}`:`${b.name} (copy)`,W=Rl(b,{name:N});_(u,mn(r(u),W),!0),se.success(`Duplicated "${b.name}"`),e.repository.saveTask(W).catch(ne=>{_(u,Tr(r(u),W.id),!0),se.error("Failed to duplicate task: "+ne),g("external")})}async function K(b){const N=!b.enabled,W={...b,enabled:N},ne=gn(r(u),b.id,()=>W);_(u,ne,!0),se.info(`Task ${N?"enabled":"disabled"}`),e.repository.saveTask(W).catch(ce=>{se.error("Failed to update task: "+ce),g("external")})}async function L(b,N){if(b.length===0)return;const W=r(u),ne=new Set(b),ce=r(u).map(D=>ne.has(D.id)?{...D,enabled:N}:D);_(u,ce,!0),se.info(`${N?"Enabled":"Disabled"} ${b.length} task${b.length===1?"":"s"}`);try{const D=ce.filter(z=>ne.has(z.id));await Promise.all(D.map(z=>e.repository.saveTask(z)))}catch(D){_(u,W,!0),se.error(`Failed to ${N?"enable":"disable"} tasks: ${D}`),g("external")}}async function Q(b){if(b.length===0)return;const N=r(u),W=new Set(b),ne=r(u).filter(D=>W.has(D.id));_(u,r(u).filter(D=>!W.has(D.id)),!0);const ce=window.setTimeout(async()=>{try{await Promise.all(ne.map(D=>e.repository.deleteTask(D.id)))}catch(D){_(u,N,!0),se.error("Failed to delete tasks: "+D),g("external")}},5e3);Rs({message:`${ne.length} task${ne.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(ce),_(u,N,!0),se.info("Bulk delete undone")},showCountdown:!0})}function $(b){_(c,b,!0),_(i,!0)}function H(){_(c,void 0),_(i,!0)}function te(){_(i,!1),_(c,void 0)}function oe(){_(o,!0)}function ie(){_(o,!1)}async function j(b){const N=r(u),W=gn(r(u),b.id,ne=>{const ce={...ne};Ri(ce);const D=a.calculateNext(new Date(ce.dueAt),ce.frequency);return ce.dueAt=D.toISOString(),ce});_(u,W,!0),se.info(`Task "${b.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",b),await e.scheduler.skipTaskOccurrence(b.id)}catch(ne){_(u,N,!0),se.error("Failed to skip task: "+ne),g("external")}}function E(b){const N=new Set(r(l));N.has(b)?N.delete(b):N.add(b),_(l,N,!0)}async function P(b){const N={...b,status:"todo",doneAt:void 0};_(u,mn(r(u),N),!0),se.success(`Task "${b.name}" marked as not done`),e.repository.saveTask(N).catch(W=>{se.error("Failed to update task: "+W),g("external")})}var ee=Rd(),J=d(ee),ye=v(d(J),2),le=d(ye);le.__click=()=>g("reload");var _e=d(le),we=v(le,2);we.__click=oe;var De=v(J,2);{var G=b=>{var N=Ed(),W=d(N);Dd(W,{get eventService(){return e.eventService},onClose:ie}),y(b,N)},ae=b=>{var N=Ge(),W=Me(N);{var ne=D=>{var z=Ad(),de=d(z);Pi(de,{get task(){return r(c)},get repository(){return e.repository},onSave:R,onClose:te}),y(D,z)},ce=D=>{var z=Nd(),de=Me(z),Te=d(de);Te.__click=()=>_(n,"inbox");var Ke=v(d(Te));{var xe=he=>{var Ee=xd(),Ne=d(Ee);U(()=>F(Ne,r(k))),y(he,Ee)};V(Ke,he=>{r(k)>0&&he(xe)})}var Oe=v(Te,2);Oe.__click=()=>_(n,"today");var Ue=v(d(Oe));{var $t=he=>{var Ee=Cd(),Ne=d(Ee);U(()=>F(Ne,r(h).length)),y(he,Ee)};V(Ue,he=>{r(h).length>0&&he($t)})}var kt=v(Oe,2);kt.__click=()=>_(n,"upcoming");var At=v(d(kt));{var Ht=he=>{var Ee=Id(),Ne=d(Ee);U(()=>F(Ne,r(x))),y(he,Ee)};V(At,he=>{r(x)>0&&he(Ht)})}var it=v(kt,2);it.__click=()=>_(n,"done");var Re=v(d(it));{var Gt=he=>{var Ee=Md(),Ne=d(Ee);U(()=>F(Ne,r(T))),y(he,Ee)};V(Re,he=>{r(T)>0&&he(Gt)})}var He=v(it,2);He.__click=()=>_(n,"projects");var fs=v(d(He));{var Yt=he=>{var Ee=Od(),Ne=d(Ee);U(()=>F(Ne,r(m))),y(he,Ee)};V(fs,he=>{r(m)>0&&he(Yt)})}var xt=v(He,2);xt.__click=()=>_(n,"search");var es=v(xt,2);es.__click=()=>_(n,"all");var Z=v(d(es)),ve=d(Z),Se=v(de,2);{var qe=he=>{var Ee=qd(),Ne=v(d(Ee),2);Ne.__click=()=>E("notDone");var We=v(Ne,2);We.__click=()=>E("dueToday");var Be=v(We,2);Be.__click=()=>E("overdue");var ze=v(Be,2);ze.__click=()=>E("inProgress");var ot=v(ze,2);ot.__click=()=>E("blocked");var bt=v(ot,2);bt.__click=()=>E("highPriority"),U((lt,Mt,ct,jt,_s,wt)=>{Fe(Ne,1,`dashboard__filter-btn ${lt??""}`,"svelte-1y1a8hs"),Fe(We,1,`dashboard__filter-btn ${Mt??""}`,"svelte-1y1a8hs"),Fe(Be,1,`dashboard__filter-btn ${ct??""}`,"svelte-1y1a8hs"),Fe(ze,1,`dashboard__filter-btn ${jt??""}`,"svelte-1y1a8hs"),Fe(ot,1,`dashboard__filter-btn ${_s??""}`,"svelte-1y1a8hs"),Fe(bt,1,`dashboard__filter-btn ${wt??""}`,"svelte-1y1a8hs")},[()=>r(l).has("notDone")?"active":"",()=>r(l).has("dueToday")?"active":"",()=>r(l).has("overdue")?"active":"",()=>r(l).has("inProgress")?"active":"",()=>r(l).has("blocked")?"active":"",()=>r(l).has("highPriority")?"active":""]),y(he,Ee)};V(Se,he=>{r(n)!=="search"&&r(n)!=="timeline"&&r(n)!=="analytics"&&he(qe)})}var tt=v(Se,2),st=d(tt);{var Ct=he=>{{let Ee=Y(()=>r(l).size>0?r(f):r(u));Hc(he,{get tasks(){return r(Ee)},onEdit:$,onDone:w,onDelete:B})}},It=he=>{var Ee=Ge(),Ne=Me(Ee);{var We=ze=>{{let ot=Y(()=>r(l).size>0?r(f).filter(bt=>r(h).some(lt=>lt.id===bt.id)):r(h));dc(ze,{get tasks(){return r(ot)},onDone:w,onDelay:C,onSkip:j,onEdit:$,get timezoneHandler(){return t}})}},Be=ze=>{var ot=Ge(),bt=Me(ot);{var lt=ct=>{{let jt=Y(()=>r(l).size>0?r(f):r(u));Qc(ct,{get tasks(){return r(jt)},onEdit:$,onDone:w,onDelete:B})}},Mt=ct=>{var jt=Ge(),_s=Me(jt);{var wt=O=>{{let ue=Y(()=>r(l).size>0?r(f):r(u));su(O,{get tasks(){return r(ue)},onEdit:$,onDelete:B,onUncomplete:P})}},ts=O=>{var ue=Ge(),ut=Me(ue);{var Cs=Xs=>{{let Na=Y(()=>r(l).size>0?r(f):r(u));lu(Xs,{get tasks(){return r(Na)},onEdit:$,onDone:w,onDelete:B})}},ma=Xs=>{var Na=Ge(),Ui=Me(Na);{var Hi=Js=>{Yu(Js,{get tasks(){return r(u)},onEdit:$,onDone:w,onDelete:B})},Gi=Js=>{var Wn=Ge(),Yi=Me(Wn);{var Vi=Zs=>{{let Ra=Y(()=>r(l).size>0?r(f):r(u));kc(Zs,{get tasks(){return r(Ra)},onEdit:$,onDelete:B,onDuplicate:q,onToggleEnabled:K,onBulkEnable:ga=>L(ga,!0),onBulkDisable:ga=>L(ga,!1),onBulkDelete:Q,onCreate:H})}},Wi=Zs=>{var Ra=Ge(),ga=Me(Ra);{var Qi=$s=>{{let Ba=Y(()=>e.scheduler.getRecurrenceEngine());Cc($s,{get tasks(){return r(u)},get recurrenceEngine(){return r(Ba)}})}},Xi=$s=>{var Ba=Ge(),Ji=Me(Ba);{var Zi=ln=>{Pc(ln,{get tasks(){return r(u)}})};V(Ji,ln=>{r(n)==="analytics"&&ln(Zi)},!0)}y($s,Ba)};V(ga,$s=>{r(n)==="timeline"?$s(Qi):$s(Xi,!1)},!0)}y(Zs,Ra)};V(Yi,Zs=>{r(n)==="all"?Zs(Vi):Zs(Wi,!1)},!0)}y(Js,Wn)};V(Ui,Js=>{r(n)==="search"?Js(Hi):Js(Gi,!1)},!0)}y(Xs,Na)};V(ut,Xs=>{r(n)==="projects"?Xs(Cs):Xs(ma,!1)},!0)}y(O,ue)};V(_s,O=>{r(n)==="done"?O(wt):O(ts,!1)},!0)}y(ct,jt)};V(bt,ct=>{r(n)==="upcoming"?ct(lt):ct(Mt,!1)},!0)}y(ze,ot)};V(Ne,ze=>{r(n)==="today"?ze(We):ze(Be,!1)},!0)}y(he,Ee)};V(st,he=>{r(n)==="inbox"?he(Ct):he(It,!1)})}U(()=>{Fe(Te,1,`dashboard__tab ${r(n)==="inbox"?"active":""}`,"svelte-1y1a8hs"),Fe(Oe,1,`dashboard__tab ${r(n)==="today"?"active":""}`,"svelte-1y1a8hs"),Fe(kt,1,`dashboard__tab ${r(n)==="upcoming"?"active":""}`,"svelte-1y1a8hs"),Fe(it,1,`dashboard__tab ${r(n)==="done"?"active":""}`,"svelte-1y1a8hs"),Fe(He,1,`dashboard__tab ${r(n)==="projects"?"active":""}`,"svelte-1y1a8hs"),Fe(xt,1,`dashboard__tab ${r(n)==="search"?"active":""}`,"svelte-1y1a8hs"),Fe(es,1,`dashboard__tab ${r(n)==="all"?"active":""}`,"svelte-1y1a8hs"),F(ve,r(u).length)}),y(D,z)};V(W,D=>{r(i)?D(ne):D(ce,!1)},!0)}y(b,N)};V(De,b=>{r(o)?b(G):b(ae,!1)})}U(()=>{le.disabled=r(p),F(_e,r(p)?"‚ü≥":"‚Üª")}),y(s,ee),Le()}rt(["click"]);var Fd=I('<div class="quick-add-card__error svelte-1q3w22"> </div>'),zd=I('<div class="quick-add-card__error svelte-1q3w22"> </div>'),jd=I('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),Pd=I('<button class="quick-add-card__advanced svelte-1q3w22" type="button">Advanced...</button>'),Ld=I('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">‚úï</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <!> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ‚åò/Ctrl + Enter to save.</p></div></div>');function Kd(s,e){var j;Pe(e,!0);let t=X(fe(((j=e.prefill)==null?void 0:j.suggestedName)??"")),a=X(fe(new Date().toISOString().slice(0,16))),n=X(fe({name:!1,dueAt:!1})),i=X(!1),o=X(null);const c=Y(()=>r(n).name&&!r(t).trim()?"Task name is required.":""),l=Y(()=>r(n).dueAt?r(a)?Number.isNaN(new Date(r(a)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),u=Y(()=>!!(r(c)||r(l)));rn(()=>{var E;if((E=e.prefill)!=null&&E.suggestedTime){const P=new Date,[ee,J]=e.prefill.suggestedTime.split(":").map(Number);P.setHours(ee,J,0,0),_(a,P.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var P;(P=r(o))==null||P.focus()})});async function h(){var J,ye;if(_(n,{name:!0,dueAt:!0},!0),r(u)){se.warning("Please fill out the required fields.");return}const E=xl(),P=r(a).slice(11,16);if(E.time=P,!Oi(E)){se.error("Invalid frequency configuration.");return}const ee=qi(r(t).trim(),E,new Date(r(a)));ee.linkedBlockId=((J=e.prefill)==null?void 0:J.linkedBlockId)||void 0,ee.linkedBlockContent=((ye=e.prefill)==null?void 0:ye.linkedBlockContent)||void 0,_(i,!0);try{await e.repository.saveTask(ee),se.success(`Task "${ee.name}" created`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(le){se.error("Failed to create task: "+le)}finally{_(i,!1)}}function p(E){E.key==="Escape"&&e.onClose(),(E.metaKey||E.ctrlKey)&&E.key==="Enter"&&(E.preventDefault(),h())}var f=Ld();f.__keydown=p;var k=d(f),x=d(k),T=v(d(x),2);T.__click=function(...E){var P;(P=e.onClose)==null||P.apply(this,E)};var m=v(x,2),g=v(d(m),2);g.__input=()=>r(n).name=!0,Ut(g,E=>_(o,E),()=>r(o));var M=v(g,2);{var w=E=>{var P=Fd(),ee=d(P);U(()=>F(ee,r(c))),y(E,P)};V(M,E=>{r(c)&&E(w)})}var C=v(m,2),R=v(d(C),2);R.__input=()=>r(n).dueAt=!0;var B=v(R,2);{var q=E=>{var P=zd(),ee=d(P);U(()=>F(ee,r(l))),y(E,P)};V(B,E=>{r(l)&&E(q)})}var K=v(C,2);{var L=E=>{var P=jd(),ee=v(d(P)),J=d(ee);U(()=>F(J,e.prefill.linkedBlockId)),y(E,P)};V(K,E=>{var P;(P=e.prefill)!=null&&P.linkedBlockId&&E(L)})}var Q=v(K,2),$=d(Q);$.__click=function(...E){var P;(P=e.onClose)==null||P.apply(this,E)};var H=v($,2);{var te=E=>{var P=Pd();P.__click=function(...ee){var J;(J=e.onAdvanced)==null||J.apply(this,ee)},y(E,P)};V(H,E=>{e.onAdvanced&&E(te)})}var oe=v(H,2);oe.__click=h;var ie=d(oe);U(()=>{Ie(g,"aria-invalid",!!r(c)),Ie(R,"aria-invalid",!!r(l)),oe.disabled=r(i),F(ie,r(i)?"Saving‚Ä¶":"Create Task")}),Ze("blur",g,()=>r(n).name=!0),Dt(g,()=>r(t),E=>_(t,E)),Ze("blur",R,()=>r(n).dueAt=!0),Dt(R,()=>r(a),E=>_(a,E)),y(s,f),Le()}rt(["keydown","click","input"]);class Ud{constructor(e){A(this,"plugin");this.plugin=e}getCurrentVersion(){return ms}async createBackup(e,t){try{const a=await this.plugin.loadData(e);if(a){const n=new Date().toISOString().replace(/[:.]/g,"-"),i=t!==void 0?`v${t}`:"unknown",o=`${e}-backup-${i}-${n}`;return await this.plugin.saveData(o,a),re(`Created backup: ${o}`),o}throw new Error("No data to backup")}catch(a){throw me("Failed to create backup",a),a}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t)return re("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:ms};const a=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(a.length===0)return re("No data to migrate"),{migrated:!1,tasksAffected:0,toVersion:ms};let n=!1,i,o,c=0;for(let l=0;l<a.length;l++){const u=a[l],h=u.version||0;h<ms&&(n||(o=h,i=await this.createBackup(e,h),n=!0),a[l]=this.migrateTask(u,h),c++,re(`Migrated task ${u.id} from v${h} to v${ms}`))}if(n){const l=Array.isArray(t)?a:{...t,tasks:a};return await this.plugin.saveData(e,l),re(`Migration complete: ${c} tasks migrated`),{migrated:!0,tasksAffected:c,fromVersion:o,toVersion:ms,backupKey:i}}else return re("No migration needed - all tasks up to date"),{migrated:!1,tasksAffected:0,toVersion:ms}}catch(t){throw me("Migration failed",t),t}}migrateTask(e,t){let a={...e};return t<1&&(a.version=1),t<2&&(a={...a,version:2,timezone:a.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:a.completionCount||0,missCount:a.missCount||0,currentStreak:a.currentStreak||0,bestStreak:a.bestStreak||0,recentCompletions:a.recentCompletions||[],priority:a.priority||"normal",tags:a.tags||[],notificationChannels:a.notificationChannels||[],snoozeCount:a.snoozeCount||0,maxSnoozes:a.maxSnoozes||3}),t<3&&(a={...a,version:3,escalationPolicy:a.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:a.linkedBlockContent||void 0,category:a.category||void 0,description:a.description||void 0}),t<4&&(a={...a,version:4,onCompletion:a.onCompletion||"keep",dependsOn:a.dependsOn||[],blockedBy:a.blockedBy||[]}),a}}class Hd{constructor(e,t=50){A(this,"pendingState",null);A(this,"writeInProgress",!1);A(this,"scheduledTimer",null);A(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){me("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return me("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const Nn={},Gd=Object.freeze(Object.defineProperty({__proto__:null,default:Nn},Symbol.toStringTag,{value:"Module"})),Ar=new Set;function Ha(s){const e=`${s.feature}:${s.capability}:${s.message}`;Ar.has(e)||(Ar.add(e),at(s.message,{feature:s.feature,capability:s.capability,cause:s.cause}))}class Li extends Error{constructor(t,a,n){super(n);A(this,"capability");A(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=a}}class Ki extends Error{constructor(t,a,n,i){super(n);A(this,"capability");A(this,"feature");A(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=a,this.cause=i}}class Yd{constructor(e=globalThis){A(this,"supportedCapabilities");A(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,a,n;return typeof((n=(a=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:a.system)==null?void 0:n.dataDir)=="string"}getDataDir(){var e,t,a;return this.isDataDirAvailable()?((a=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:a.dataDir)??null:null}async setBlockAttrs(e,t){const a=this.getSetBlockAttrs();try{await a(e,t)}catch(n){throw new Ki("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",n)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new Li("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const Vd=".tmp";class Wd{constructor(e,t){A(this,"plugin");A(this,"apiAdapter");A(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(Ns);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){me("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),re(`Saved ${e.tasks.length} active tasks`)}catch(t){throw me("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(Ns,e);return}const a=this.resolveStoragePath(Ns);if(!a){await this.plugin.saveData(Ns,e);return}const n=Nn.dirname(a);await t.mkdir(n,{recursive:!0});const i=`${a}${Vd}`,o=JSON.stringify(e),c=await t.open(i,"w");try{await c.writeFile(o,"utf8"),await c.sync()}finally{await c.close()}try{await t.rename(i,a)}catch{await t.rm(a,{force:!0}),await t.rename(i,a)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>Gd);return this.fsPromises=e.promises,this.fsPromises}catch(e){return at("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),a=this.plugin.name;return!t||!a?(t||Ha({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):Nn.join(t,"storage",`p${a}`,`${e}.json`)}}const xr=1,Cr=1e3;class Qd{constructor(e){A(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),a=this.groupByYear(e);for(const[n,i]of a.entries())await this.appendTasksToYear(t,n,i);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const a=this.filterChunks(t.chunks,e),n=[];for(const c of a){const l=await this.loadChunk(c.key);if(l)for(const u of l.tasks)this.matchesQuery(u,e)&&n.push(u)}const i=(e==null?void 0:e.offset)??0,o=(e==null?void 0:e.limit)??n.length;return n.slice(i,i+o)}async loadIndex(){try{const e=await this.plugin.loadData(Ka);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??xr,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){me("Failed to load archive index",e)}return{version:xr,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(Ka,e)}catch(t){throw me("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${Ka}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){me("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(a){throw me("Failed to save archive chunk",{key:e,err:a}),a}}groupByYear(e){const t=new Map;for(const a of e){const n=this.getCompletionTimestamp(a),i=new Date(n).getFullYear(),o=t.get(i);o?o.push(a):t.set(i,[a])}return t}async appendTasksToYear(e,t,a){let n=[...a];for(;n.length>0;){const i=this.findOrCreateChunk(e,t),o=await this.loadChunk(i.key)||{tasks:[]},c=Cr-o.tasks.length,l=n.slice(0,c);o.tasks.push(...l),n=n.slice(l.length);const u=this.updateChunkMeta(i,l);i.count=u.count,i.start=u.start,i.end=u.end,await this.saveChunk(i.key,o),e.totalCount+=l.length}}findOrCreateChunk(e,t){const n=e.chunks.filter(c=>c.year===t).sort((c,l)=>c.sequence-l.sequence).at(-1);if(n&&n.count<Cr)return n;const i=n?n.sequence+1:1,o={key:this.buildChunkKey(t,i),year:t,sequence:i,count:0};return e.chunks.push(o),o}updateChunkMeta(e,t){let a=e.start,n=e.end;for(const i of t){const o=this.getCompletionTimestamp(i);(!a||o<a)&&(a=o),(!n||o>n)&&(n=o)}return{...e,count:e.count+t.length,start:a,end:n}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const a=t!=null&&t.from?new Date(t.from).getTime():null,n=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(i=>{const o=i.start?new Date(i.start).getTime():null,c=i.end?new Date(i.end).getTime():null;return!(a&&c&&c<a||n&&o&&o>n)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const a=this.getCompletionTimestamp(e),n=new Date(a).getTime();return!(t.from&&n<new Date(t.from).getTime()||t.to&&n>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class Xd{constructor(e,t=new Yd){A(this,"plugin");A(this,"activeTasks");A(this,"blockIndex",new Map);A(this,"taskBlockIndex",new Map);A(this,"dueIndex",new Map);A(this,"activeStore");A(this,"archiveStore");A(this,"persistence");A(this,"blockAttrSyncEnabled",!0);A(this,"blockApi");A(this,"apiAdapter");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new Wd(e,t),this.archiveStore=new Qd(e),this.persistence=new Hd(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),re(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex()}async loadActiveTasks(e=1e3,t){const a=await this.activeStore.loadActive(),n=Array.from(a.values()),i=n.length;if(i===0)return[];const o=[];for(let c=0;c<i;c+=e){const l=n.slice(c,Math.min(c+e,i));o.push(...l),t&&t(o.length,i),await new Promise(u=>setTimeout(u,0))}return o}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));re(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);re(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),a=this.dueIndex.get(t);a&&(a.delete(e.id),a.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),a=[];for(const[n]of this.dueIndex)n<=t&&a.push(...this.getTasksForDueKey(n));return a}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const a=[];for(const n of t){const i=this.activeTasks.get(n);if(!i){this.removeStaleDueIndexEntry(e,n,"missing task");continue}if(!i.enabled){this.removeStaleDueIndexEntry(e,n,"task disabled");continue}if(i.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,n,"date mismatch");continue}a.push(i)}return a}removeStaleDueIndexEntry(e,t,a){const n=this.dueIndex.get(e);n&&(n.delete(t),n.size===0&&this.dueIndex.delete(e),at("Removed stale due index entry",{taskId:t,dateKey:e,reason:a}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id),a=this.taskBlockIndex.get(e.id);a&&a!==e.linkedBlockId&&(this.blockIndex.delete(a),this.taskBlockIndex.delete(e.id)),t&&t.enabled&&(t.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(t),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrs(e),a&&a!==e.linkedBlockId&&await this.clearBlockAttrs(a)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[kr]:e.id,[br]:e.dueAt,[wr]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[kr]:"",[br]:"",[wr]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){Ha({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(a){a instanceof Li||a instanceof Ki?Ha({feature:a.feature,capability:a.capability,message:a.message,cause:a.cause}):Ha({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:a}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(a=>new Date(a.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(a=>{const n=new Date(a.dueAt);return n>=e&&n<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(Ns);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(cr);if(!t)return;const a=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(a.length===0)return;await this.plugin.saveData(ur,t),re(`Created legacy backup at ${ur}`);const n=a.filter(c=>!c.enabled&&c.lastCompletedAt),i=a.filter(c=>!n.includes(c)),o=new Map(i.map(c=>[c.id,c]));this.persistence.requestSave({tasks:Array.from(o.values())}),await this.persistence.flush(),n.length>0&&await this.archiveStore.archiveTasks(n),re("Legacy storage migration complete",{activeCount:i.length,archivedCount:n.length,legacyKey:cr,activeKey:Ns,archiveIndexKey:Ka})}}class Jd{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}class Zd{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const a of e)Number.isFinite(a)&&a>=0&&a<=6&&t.add(Math.floor(a));return Array.from(t).sort((a,n)=>a-n)}normalizeDayOfMonth(e,t){const a=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(a,1),31)}normalizeMonth(e,t){const a=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(a,0),11)}calculateNext(e,t,a){const n=a!=null&&a.whenDone&&(a!=null&&a.completionDate)?a.completionDate:e,{type:i,time:o}=t,c=this.normalizeInterval(t.interval);let l;switch(i){case"daily":l=this.calculateNextDaily(n,c);break;case"weekly":l=this.calculateNextWeekly(n,c,this.normalizeWeekdays(t.weekdays));break;case"monthly":l=this.calculateNextMonthly(n,c,this.normalizeDayOfMonth(t.dayOfMonth,n.getDate()));break;case"yearly":l=this.calculateNextYearly(n,c,this.normalizeMonth(t.month,n.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,n.getDate()));break;default:throw new Error(`Unknown frequency type: ${i}`)}if(o){const{hours:u,minutes:h}=zi(o);if(Number.isFinite(u)&&Number.isFinite(h)){const{date:p,shifted:f}=Vl(l,u,h);f&&at("DST shift detected while applying recurrence time",{requestedTime:o,original:l.toISOString(),adjusted:p.toISOString()}),l=p}}return l}calculateNextDaily(e,t){return xa(e,t)}calculateNextWeekly(e,t,a){if(!a||a.length===0)return Sr(e,t);const n=this.getMondayIndex(e),i=Math.min(pn,t*14);for(let o=1;o<=i;o++){if(Math.floor((n+o)/7)%t!==0)continue;const l=xa(e,o),u=this.getMondayIndex(l);if(a.includes(u))return l}return at("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:a}),Sr(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,a){const n=a??e.getDate(),i=e.getFullYear(),c=e.getMonth()+t,l=i+Math.floor(c/12),u=(c%12+12)%12,h=new Date(l,u+1,0).getDate(),p=Math.min(n,h),f=new Date(e);return f.setFullYear(l,u,p),f}calculateNextYearly(e,t,a,n){const i=n??e.getDate(),o=e.getFullYear()+t,c=new Date(o,a+1,0).getDate(),l=Math.min(i,c),u=new Date(e);return u.setFullYear(o,a,l),u}getOccurrencesInRange(e,t,a,n){const i=[];let o=new Date(n),c=0;for(;o<=t&&c<pn;)o>=e&&i.push(new Date(o)),o=this.calculateNext(o,a),c++;return i}getMissedOccurrences(e,t,a,n){const i=[];let o=new Date(n),c=0;for(;o<=e&&c<pn;)o=this.calculateNext(o,a),c++;let l=0;for(;o<t&&l<Ua;)i.push(new Date(o)),o=this.calculateNext(o,a),l++;return l>=Ua&&at("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:a,firstOccurrence:n.toISOString(),cap:Ua}),i}}class $d{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:a,minutes:n}=zi(t);if(!Number.isFinite(a)||!Number.isFinite(n))return new Date(e);const i=new Date(e);return i.setHours(a,n,0,0),i}isSameLocalDay(e,t){const a=new Date(e),n=new Date(t);return a.getFullYear()===n.getFullYear()&&a.getMonth()===n.getMonth()&&a.getDate()===n.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,a=e.getTime()-t.getTime(),n=Math.trunc(a/(1e3*60)),i=Math.trunc(a/(1e3*60*60)),o=Math.trunc(a/(1e3*60*60*24));return Math.abs(a)<1e3*60?"now":Math.abs(n)<60?n>0?`in ${n}m`:`${-n}m ago`:Math.abs(i)<24?i>0?`in ${i}h`:`${-i}h ago`:o>0?`in ${o}d`:`${-o}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const a=new Date(e);return a.setDate(a.getDate()+t),a}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class ev{constructor(e){A(this,"siyuanApi");this.siyuanApi=e}async execute(e,t){try{if(t==="keep")return re(`Task "${e.name}" completed and kept`,{taskId:e.id}),{success:!0};if(t==="delete"){if(!e.linkedBlockId)return at(`Task "${e.name}" has no linkedBlockId, cannot delete from document`,{taskId:e.id}),{success:!0,warnings:["Task has no linked block, removed from task list only"]};if(await this.hasNestedItems(e.linkedBlockId))return at("Cannot delete task with nested items",{taskId:e.id,blockId:e.linkedBlockId}),{success:!1,error:"Cannot delete task with nested items",warnings:['Task has sub-items. Please remove them first or use "keep" mode.']};if(this.siyuanApi&&this.siyuanApi.deleteBlock)await this.siyuanApi.deleteBlock({id:e.linkedBlockId}),re(`Task "${e.name}" completed and deleted from document`,{taskId:e.id,blockId:e.linkedBlockId});else return at("SiYuan API not available, cannot delete block from document"),{success:!0,warnings:["Block could not be deleted from document (API unavailable)"]};return{success:!0}}return{success:!1,error:`Unknown onCompletion action: ${t}`}}catch(a){return me("Failed to execute onCompletion action",{taskId:e.id,action:t,error:a}),{success:!1,error:a instanceof Error?a.message:"Unknown error occurred"}}}async hasNestedItems(e){if(!this.siyuanApi||!this.siyuanApi.getChildBlocks)return at("SiYuan API not available for nested item check"),!0;try{const t=await this.siyuanApi.getChildBlocks({id:e});return t&&t.length>0}catch(t){return me("Failed to check for nested items",{blockId:e,error:t}),!0}}}class tv{constructor(e,t){A(this,"intervalMs");A(this,"timeoutId",null);A(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:Yn,a=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},a)}}class sv{constructor(e,t=Yn,a){A(this,"storage");A(this,"recurrenceEngine");A(this,"onCompletionHandler");A(this,"emittedDue",new Set);A(this,"emittedMissed",new Set);A(this,"timezoneHandler");A(this,"isChecking",!1);A(this,"lastCheckStartTime",0);A(this,"plugin",null);A(this,"listeners",{"task:due":new Set,"task:overdue":new Set});A(this,"MAX_EMITTED_ENTRIES",1e3);A(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);A(this,"persistTimeoutId",null);A(this,"emittedStateReady",null);A(this,"timer");this.storage=e,this.recurrenceEngine=new Zd,this.onCompletionHandler=new ev(a),this.timezoneHandler=new $d,this.plugin=a||null,this.timer=new tv(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),re("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),re("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)at("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const a of t){if(!this.isActive(a))continue;const n=new Date(a.dueAt),i=n<=e;if(i){const c=this.buildOccurrenceKey(a.id,n,"hour");this.emittedDue.has(c)||(this.emitEvent("task:due",{taskId:a.id,dueAt:n,context:"today",task:a}),this.registerEmittedKey("due",c),re(`Task due: ${a.name}`,{taskId:a.id,dueAt:a.dueAt}))}const o=a.lastCompletedAt?new Date(a.lastCompletedAt):null;if(i&&e.getTime()-n.getTime()>=Ol&&(!o||o<n)){const c=this.buildOccurrenceKey(a.id,n,"hour");this.emittedMissed.has(c)||(this.emitEvent("task:overdue",{taskId:a.id,dueAt:n,context:"overdue",task:a}),this.registerEmittedKey("missed",c),at(`Task missed: ${a.name}`,{taskId:a.id,dueAt:a.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){let e=!1;if(this.emittedDue.size>this.MAX_EMITTED_ENTRIES){const t=Array.from(this.emittedDue);this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES/2)),e=!0,re(`Cleaned up emittedDue set: ${t.length} -> ${this.emittedDue.size}`)}if(this.emittedMissed.size>this.MAX_EMITTED_ENTRIES){const t=Array.from(this.emittedMissed);this.emittedMissed=new Set(t.slice(-this.MAX_EMITTED_ENTRIES/2)),e=!0,re(`Cleaned up emittedMissed set: ${t.length} -> ${this.emittedMissed.size}`)}e&&this.schedulePersistEmittedState()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);const a=new Date;t.doneAt=a.toISOString(),Bl(t);const n=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(n);const i=t.onCompletion||"keep",o=await this.onCompletionHandler.execute(t,i);if(o.success||me(`OnCompletion action failed for task "${t.name}"`,{taskId:t.id,action:i,error:o.error}),o.warnings)for(const u of o.warnings)at(u,{taskId:t.id});const c=new Date(t.dueAt),l=this.recurrenceEngine.calculateNext(c,t.frequency,{completionDate:a,whenDone:t.whenDone});t.dueAt=l.toISOString(),t.doneAt=void 0,await this.storage.saveTask(t),re(`Task "${t.name}" completed and rescheduled to ${l.toISOString()}`)}async delayTask(e,t){const a=this.storage.getTask(e);if(!a)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(a);const n=new Date(a.dueAt),i=new Date(n.getTime()+t*60*1e3);a.dueAt=i.toISOString(),a.snoozeCount=(a.snoozeCount||0)+1,await this.storage.saveTask(a),re(`Task "${a.name}" delayed by ${t} minutes to ${i.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const a=new Date(t.dueAt),n=this.timezoneHandler.tomorrow();n.setHours(a.getHours(),a.getMinutes(),0,0),t.dueAt=n.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),re(`Task "${t.name}" delayed to tomorrow: ${n.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);Ri(t);const a=new Date(t.dueAt),n=this.recurrenceEngine.calculateNext(a,t.frequency);t.dueAt=n.toISOString(),await this.storage.saveTask(t),re(`Task "${t.name}" skipped to ${n.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),re("First run detected, no recovery needed");return}re(`Recovering missed tasks since ${e.toISOString()}`);for(const a of this.storage.getEnabledTasks())try{const n=this.recurrenceEngine.getMissedOccurrences(e,t,a.frequency,new Date(a.createdAt));for(const i of n){const o=this.buildOccurrenceKey(a.id,i,"exact");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:a.id,dueAt:i,context:"overdue",task:a}),this.registerEmittedKey("missed",o))}await this.advanceToNextFutureOccurrence(a,t)}catch(n){me(`Failed to recover task ${a.id}:`,n)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),re("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const a=new Date(e.dueAt);if(a>=t)return;let n=a,i=0;for(;n<t&&i<Ua;)n=this.recurrenceEngine.calculateNext(n,e.frequency),i++;n>a&&(e.dueAt=n.toISOString(),await this.storage.saveTask(e),re(`Advanced task "${e.name}" to ${n.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(yr);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){me("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(yr,{timestamp:e.toISOString()})}catch(t){me("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const a=this.listeners[e];for(const n of a)try{const i=n(t);i instanceof Promise&&i.catch(o=>{me(`Scheduler listener error for ${e}:`,o)})}catch(i){me(`Scheduler listener error for ${e}:`,i)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??ql,a=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(a>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(hr),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(n=>typeof n=="string"):[],a=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(n=>typeof n=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(a.slice(-this.MAX_EMITTED_ENTRIES)),re("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){me("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(hr,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){me("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,a){return a==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const av=7,nv=2e3;class rv{constructor(e,t){A(this,"plugin");A(this,"storageKey");A(this,"notifications",new Map);A(this,"escalations",new Map);A(this,"lastCleanup",new Date);A(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const a of t.notifications)this.notifications.set(a.taskKey,a);if(Array.isArray(t.escalations))for(const a of t.escalations)this.escalations.set(a.taskId,a);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),re(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){me("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,Fi("Saved notification state")}catch(e){me("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>nv&&Array.from(this.notifications.keys()).slice(0,100).forEach(a=>this.notifications.delete(a))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const a=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:a,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,a}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const a=new Date(t);return`${e}:${a.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const a=new Date(e.getTime()-av*24*60*60*1e3);let n=0;for(const[i,o]of this.notifications.entries())new Date(o.notifiedAt)<a&&(this.notifications.delete(i),n++);n>0&&(re(`Cleaned up ${n} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function iv(s){return{id:s.id,name:s.name,dueAt:s.dueAt,frequency:s.frequency,linkedBlockId:s.linkedBlockId,linkedBlockContent:s.linkedBlockContent,priority:s.priority,tags:s.tags,notificationChannels:s.notificationChannels,completionCount:s.completionCount,missCount:s.missCount,currentStreak:s.currentStreak,bestStreak:s.bestStreak}}const ov=30*1e3,lv=30*60*1e3,Ms=500;class cv{constructor(e,t={}){A(this,"plugin");A(this,"config");A(this,"queue",[]);A(this,"dedupeKeys",new Set);A(this,"flushIntervalId",null);A(this,"fetcher");A(this,"notificationState");A(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...In},this.notificationState=t.notificationState??new rv(this.plugin,Cl)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(dr);e&&(this.config={...In,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(dr,e)}async loadQueue(){try{const e=await this.plugin.loadData(vr);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>Ms){const a=this.queue.length-Ms;this.queue=this.queue.slice(-Ms),console.warn(`Event queue trimmed to ${Ms} entries (dropped ${a}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-_n);await this.plugin.saveData(vr,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},Ml))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const a=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,a),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const a=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,a),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,a=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const n=this.buildDedupeKey(e,t);if(this.isDuplicate(n))return;const i=this.buildPayload(e,t,n,1,a);await this.sendPayload(i)?(this.markDelivered(n),await this.persistQueue()):this.enqueue(i)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:fr,version:_r,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},a=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return a.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${a.status}: ${a.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const a=[];for(const n of this.queue){if(new Date(n.nextAttemptAt).getTime()>e){a.push(n);continue}const i={...n.payload,delivery:{...n.payload.delivery,attempt:n.attempt}};if(await this.sendPayload(i))this.markDelivered(i.delivery.dedupeKey),t=!0;else{const c=n.attempt+1,l=this.getRetryDelay(c);a.push({...n,attempt:c,nextAttemptAt:new Date(e+l).toISOString()}),t=!0}}t&&(this.queue=a,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,a,n,i=0){const o=new Date,c=new Date(t.dueAt),l=o.getTime()-c.getTime();return{event:e,source:fr,version:_r,occurredAt:o.toISOString(),task:iv(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:l>0?l:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:i,channels:t.notificationChannels||[]},delivery:{dedupeKey:a,attempt:n}}}buildDedupeKey(e,t){const a=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${a}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>_n){const t=Array.from(this.dedupeKeys).slice(-_n);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=Ms){const a=this.queue.length-Ms+1;this.queue.splice(0,a),console.warn(`Event queue capped at ${Ms}. Dropped ${a} oldest entr${a===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=ov*Math.pow(2,e-1);return Math.min(t,lv)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const a=new TextEncoder,n=a.encode(t),i=a.encode(e),o=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),c=await crypto.subtle.sign("HMAC",o,i);return Array.from(new Uint8Array(c)).map(u=>u.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(a){return console.error("Failed to generate signature:",a),""}}async buildHeaders(e){const t=JSON.stringify(e),a=new Date().toISOString();let n="";this.config.n8n.sharedSecret&&(n=await this.generateSignature(t+a,this.config.n8n.sharedSecret));const i={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":a};return n&&(i["X-Shehab-Signature"]=n),this.config.n8n.sharedSecret&&(i["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),i}async sendPayload(e,t=!1){try{const a=JSON.stringify(e),n=await this.buildHeaders(e),i=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:n,body:a});if(!i.ok)return console.error("n8n webhook failed:",i.statusText),!1;if(t){const o=await i.json().catch(()=>null);return!!(o&&o.ok)}return!0}catch(a){return console.error("Failed to send n8n event:",a),!1}}}const ys=class ys{constructor(e){A(this,"plugin");A(this,"isInitialized",!1);A(this,"storage");A(this,"repository");A(this,"scheduler");A(this,"eventService");this.plugin=e}static getInstance(e){if(!ys.instance){if(!e)return null;ys.instance=new ys(e)}return ys.instance}async initialize(){if(this.isInitialized){at("TaskManager already initialized");return}re("Initializing TaskManager"),this.storage=new Xd(this.plugin),await this.storage.init(),this.repository=new Jd(this.storage),this.eventService=new cv(this.plugin),await this.eventService.init(),this.scheduler=new sv(this.storage,Yn,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,re("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:a})=>e(a)),t&&this.scheduler.on("task:overdue",({task:a})=>t(a)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),re("TaskManager started")}async destroy(){re("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,ys.instance=null,re("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};A(ys,"instance",null);let Qa=ys;class uv{constructor(e,t){this.repository=e,this.recurrenceEngine=t}async toggleStatus(e){try{const t=this.repository.getTask(e);if(!t){se.error("Task not found");return}const a=cs.getInstance(),n=t.statusSymbol||" ",i=a.getNextSymbol(n),o={...t,statusSymbol:i},c=a.getStatus(i);c.type==="DONE"?(o.status="done",o.doneAt=new Date().toISOString(),t.frequency&&this.recurrenceEngine&&await this.handleRecurrence(o)):c.type==="CANCELLED"?(o.status="cancelled",o.cancelledAt=new Date().toISOString()):c.type==="TODO"&&(o.status="todo"),await this.repository.saveTask(o),je.emit("task:updated",{taskId:e}),se.success(`Task status updated to ${c.name}`)}catch(t){me("Failed to toggle task status",t),se.error("Failed to toggle status")}}async completeTask(e){try{const t=this.repository.getTask(e);if(!t){se.error("Task not found");return}const a={...t,status:"done",doneAt:new Date().toISOString()};await this.repository.saveTask(a),t.frequency&&this.recurrenceEngine&&await this.handleRecurrence(a),je.emit("task:complete",{taskId:e}),se.success(`Task "${t.name}" completed`)}catch(t){me("Failed to complete task",t),se.error("Failed to complete task")}}async deleteTask(e){try{const t=this.repository.getTask(e);if(!t){se.error("Task not found");return}const n=this.repository.getAllTasks().filter(i=>{var o,c;return((o=i.blockedBy)==null?void 0:o.includes(e))||((c=i.dependsOn)==null?void 0:c.includes(e))});if(n.length>0&&!confirm(`This task is blocking ${n.length} other task(s). Are you sure you want to delete it?`))return;await this.repository.deleteTask(e),je.emit("task:deleted",{taskId:e}),se.success(`Task "${t.name}" deleted`)}catch(t){me("Failed to delete task",t),se.error("Failed to delete task")}}async rescheduleToToday(e){try{const t=this.repository.getTask(e);if(!t){se.error("Task not found");return}const a=new Date;a.setHours(12,0,0,0);const n={...t,scheduledAt:a.toISOString(),updatedAt:new Date().toISOString()};await this.repository.saveTask(n),je.emit("task:updated",{taskId:e}),se.success("Task rescheduled to today")}catch(t){me("Failed to reschedule task",t),se.error("Failed to reschedule task")}}async deferTask(e,t){try{const a=this.repository.getTask(e);if(!a){se.error("Task not found");return}const n={...a,updatedAt:new Date().toISOString()};if(a.dueAt){const i=new Date(a.dueAt);i.setDate(i.getDate()+t),n.dueAt=i.toISOString()}if(a.scheduledAt){const i=new Date(a.scheduledAt);i.setDate(i.getDate()+t),n.scheduledAt=i.toISOString()}await this.repository.saveTask(n),je.emit("task:updated",{taskId:e}),se.success(`Task deferred by ${t} day${t!==1?"s":""}`)}catch(a){me("Failed to defer task",a),se.error("Failed to defer task")}}async handleRecurrence(e){if(!(!e.frequency||!this.recurrenceEngine))try{const t=this.recurrenceEngine.calculateNext(e);e.onCompletion==="delete"&&await this.repository.deleteTask(e.id),await this.repository.saveTask(t),re(`Created next recurrence for task: ${e.name}`),se.info("Next occurrence scheduled")}catch(t){me("Failed to handle recurrence",t),se.error("Failed to create next recurrence")}}}function dv(s,e,t){const a=new uv(e,t);s.addCommand({langKey:"createRecurringTask",hotkey:"‚åò‚áßR",callback:()=>{Ir()}}),s.addCommand({langKey:"openRecurringTasksDock",hotkey:"‚åò‚áßT",callback:()=>{s.openDock()}}),s.addCommand({langKey:"quickCompleteNextTask",hotkey:"‚åò‚áßD",callback:async()=>{await hv(e,a)}}),s.addCommand({langKey:"toggleTaskStatus",hotkey:"‚åò‚áßX",callback:async()=>{const n=await fv();n&&await a.toggleStatus(n)}}),s.addCommand({langKey:"openTaskEditor",hotkey:"‚åò‚áßE",callback:()=>{vv()}}),s.addCommand({langKey:"quickAddTask",hotkey:"‚åò‚áßN",callback:()=>{Ir()}}),re("Registered slash commands and hotkeys")}function Ir(){je.emit("task:create",{source:"command"});const s=new CustomEvent("recurring-task-create",{detail:{source:"command"}});window.dispatchEvent(s)}function vv(){je.emit("task:edit",{source:"command"});const s=new CustomEvent("recurring-task-edit",{detail:{source:"command"}});window.dispatchEvent(s)}async function hv(s,e){try{const t=s.getTodayAndOverdueTasks();if(t.length===0){re("No tasks due today");return}const a=t[0];await e.completeTask(a.id),re(`Quick completing task: ${a.name}`)}catch(t){me("Failed to quick complete task",t)}}async function fv(){return null}function Mr(s,e){je.emit("task:snooze",{taskId:s,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:s,minutes:e}})),re(`Snoozing task ${s} for ${e} minutes`)}function _v(s){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const a=On(t),n=Math.max(0,Math.floor((a.getTime()-e.getTime())/(60*1e3)));je.emit("task:snooze",{taskId:s,minutes:n}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:s,minutes:n}})),re(`Snoozing task ${s} to tomorrow`)}function pv(s){s.eventBus.on("click-blockicon",({detail:e})=>{var o,c,l;const t=e.blockElements;if(!t||t.length===0)return;const a=t[0],n=a==null?void 0:a.getAttribute("data-node-id");if(!n)return;const i=(a==null?void 0:a.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((o=s.i18n)==null?void 0:o.createRecurringTask)||"Create Recurring Task",click:()=>{je.emit("task:create",{source:"block-menu",linkedBlockId:n,linkedBlockContent:i,suggestedName:Or(i),suggestedTime:qr(i)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:n,linkedBlockContent:i,suggestedName:Or(i),suggestedTime:qr(i)}}))}});try{const u=Qa.getInstance();if(u&&u.isReady()){const p=u.getRepository().getTaskByBlockId(n);if(p){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((c=s.i18n)==null?void 0:c.completeTask)||"Complete Task",click:()=>{je.emit("task:complete",{taskId:p.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:p.id}}))}});const f=[{label:"15 minutes",click:()=>Mr(p.id,15)},{label:"1 hour",click:()=>Mr(p.id,60)},{label:"Tomorrow",click:()=>_v(p.id)}];e.menu.addItem({icon:"iconClock",label:((l=s.i18n)==null?void 0:l.snoozeTask)||"Snooze Task",submenu:f})}}}catch{Fi("TaskManager not available for quick actions")}}),re("Registered block context menu")}function Or(s){const e=s.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function qr(s){var a;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=s.match(e);if(t){let n=parseInt(t[1],10);const i=t[2],o=(a=t[3])==null?void 0:a.toUpperCase();return o==="PM"&&n<12?n+=12:o==="AM"&&n===12&&(n=0),`${n.toString().padStart(2,"0")}:${i}`}return null}class mv{constructor(e,t){A(this,"plugin");A(this,"repository");A(this,"topbarElement",null);A(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),re("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),re("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(a=>{const n=new Date(a.dueAt);return n<new Date&&!Vn(n)}).length;if(e.length>0){const a=this.topbarElement.querySelector(".b3-badge");if(a)a.textContent=e.length.toString(),a.style.display="block",t>0?a.style.backgroundColor="var(--b3-theme-error)":a.style.backgroundColor="var(--b3-theme-primary)";else{const n=document.createElement("span");n.className="b3-badge",n.textContent=e.length.toString(),n.style.display="block",n.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(n)}}else{const a=this.topbarElement.querySelector(".b3-badge");a&&a.remove()}}toggleMenu(){je.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class gv extends Bn.Plugin{constructor(){super(...arguments);A(this,"taskManager");A(this,"repository");A(this,"scheduler");A(this,"eventService");A(this,"migrationManager");A(this,"topbarMenu");A(this,"dashboardComponent",null);A(this,"dockEl");A(this,"quickAddComponent",null);A(this,"quickAddContainer",null);A(this,"taskEditorComponent",null);A(this,"taskEditorContainer",null);A(this,"pendingCompletionTimeouts",new Map);A(this,"handleCreateTaskEvent",t=>{try{const a=t;re("Create task event received",a.detail),this.openQuickAdd(a.detail)}catch(a){me("Failed to handle create task event",a),se.error("Failed to open task creator.")}});A(this,"handleSettingsEvent",t=>{try{re("Settings event received",t.detail),this.openDock()}catch(a){me("Failed to handle settings event",a),se.error("Failed to open settings.")}});A(this,"handleCompleteTaskEvent",async t=>{try{const a=t,{taskId:n}=a.detail??{};if(!n)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(n)}catch(a){me("Failed to complete task",a),se.error("Failed to complete task.")}});A(this,"handleSnoozeTaskEvent",async t=>{try{const a=t,{taskId:n,minutes:i}=a.detail??{};if(!n||typeof i!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(n,i)}catch(a){me("Failed to snooze task",a),se.error("Failed to snooze task.")}})}async onload(){re("Loading Recurring Tasks Plugin"),this.migrationManager=new Ud(this);try{await this.migrationManager.migrate(Ns)}catch(a){me("Migration failed, continuing with existing data",a)}const t=Qa.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();try{await this.taskManager.start()}catch(a){me("Failed to start TaskManager",a)}dv(this,this.repository,this.scheduler.getRecurrenceEngine()),pv(this),this.topbarMenu=new mv(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:Il,init:a=>{this.dockEl=a.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),re("Recurring Tasks Plugin loaded successfully")}async onunload(){re("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.closeTaskEditor(),this.removeEventListeners()}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=dn(Bd,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService}}))}destroyDashboard(){this.dashboardComponent&&(vn(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{je.on("task:create",t=>{re("Create task event received",t),this.openQuickAdd(t)}),je.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),je.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),je.on("task:settings",()=>{this.openDock()}),je.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){me("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){je.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const a=this.repository.getTask(t);if(a){if(this.pendingCompletionTimeouts.has(t)){se.info(`Completion already pending for "${a.name}".`);return}const n=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(a),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),re(`Task completed: ${a.name}`)}catch(o){me("Failed to finalize task completion",o),se.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,n);const i=()=>{const o=this.pendingCompletionTimeouts.get(t);o&&(globalThis.clearTimeout(o),this.pendingCompletionTimeouts.delete(t),se.info(`Undo: "${a.name}" restored`))};Rs({message:`Task "${a.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:i,showCountdown:!0})}}async handleSnoozeTask(t,a){const n=this.repository.getTask(t);n&&(await this.eventService.handleTaskSnoozed(n),await this.scheduler.delayTask(t,a),this.topbarMenu&&this.topbarMenu.update(),re(`Task snoozed: ${n.name} for ${a} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=dn(Kd,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd(),onAdvanced:()=>{this.closeQuickAdd(),this.openTaskEditor()}}})}closeQuickAdd(){this.quickAddComponent&&(vn(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}openTaskEditor(t){this.taskEditorComponent&&this.closeTaskEditor(),this.taskEditorContainer=document.createElement("div"),document.body.appendChild(this.taskEditorContainer),this.taskEditorComponent=dn(Pi,{target:this.taskEditorContainer,props:{repository:this.repository,task:t,onClose:()=>this.closeTaskEditor(),onSave:()=>{window.dispatchEvent(new CustomEvent("recurring-task-refresh"))}}})}closeTaskEditor(){this.taskEditorComponent&&(vn(this.taskEditorComponent),this.taskEditorComponent=null),this.taskEditorContainer&&(this.taskEditorContainer.remove(),this.taskEditorContainer=null)}}module.exports=gv;
