"use strict";var _r=Object.defineProperty;var Sa=n=>{throw TypeError(n)};var mr=(n,e,t)=>e in n?_r(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var T=(n,e,t)=>mr(n,typeof e!="symbol"?e+"":e,t),js=(n,e,t)=>e.has(n)||Sa("Cannot "+t);var k=(n,e,t)=>(js(n,e,"read from private field"),t?t.call(n):e.get(n)),ie=(n,e,t)=>e.has(n)?Sa("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),ae=(n,e,t,s)=>(js(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t),Re=(n,e,t)=>(js(n,e,"access private method"),t);const fa=require("siyuan"),Gs=!1;var li=Array.isArray,kr=Array.prototype.indexOf,qs=Array.from,gr=Object.defineProperty,zn=Object.getOwnPropertyDescriptor,pr=Object.getOwnPropertyDescriptors,yr=Object.prototype,wr=Array.prototype,ci=Object.getPrototypeOf,Ea=Object.isExtensible;function br(n){for(var e=0;e<n.length;e++)n[e]()}function di(){var n,e,t=new Promise((s,a)=>{n=s,e=a});return{promise:t,resolve:n,reject:e}}const ze=2,Ss=4,Os=8,ui=1<<24,Yt=16,Vt=32,In=64,ha=128,wt=512,Le=1024,Ye=2048,Qt=4096,lt=8192,Kt=16384,_a=32768,Hn=65536,Da=1<<17,vi=1<<18,Xn=1<<19,Tr=1<<20,Pt=1<<25,An=32768,Js=1<<21,ma=1<<22,ln=1<<23,ts=Symbol("$state"),Sr=Symbol("legacy props"),Er=Symbol(""),Nn=new class extends Error{constructor(){super(...arguments);T(this,"name","StaleReactionError");T(this,"message","The reaction that called `getAbortSignal()` was re-run or destroyed")}};function fi(n){throw new Error("https://svelte.dev/e/lifecycle_outside_component")}function Dr(){throw new Error("https://svelte.dev/e/async_derived_orphan")}function Ar(n){throw new Error("https://svelte.dev/e/effect_in_teardown")}function Cr(){throw new Error("https://svelte.dev/e/effect_in_unowned_derived")}function xr(n){throw new Error("https://svelte.dev/e/effect_orphan")}function Ir(){throw new Error("https://svelte.dev/e/effect_update_depth_exceeded")}function Mr(n){throw new Error("https://svelte.dev/e/props_invalid_value")}function qr(){throw new Error("https://svelte.dev/e/state_descriptors_fixed")}function Or(){throw new Error("https://svelte.dev/e/state_prototype_fixed")}function Rr(){throw new Error("https://svelte.dev/e/state_unsafe_mutation")}function Br(){throw new Error("https://svelte.dev/e/svelte_boundary_reset_onerror")}const Nr=1,zr=2,hi=4,Fr=8,Lr=16,Pr=1,jr=4,Kr=8,Ur=16,Hr=1,Yr=2,Be=Symbol(),Vr="http://www.w3.org/1999/xhtml";function Qr(){console.warn("https://svelte.dev/e/svelte_boundary_reset_noop")}function _i(n){return n===this.v}function Wr(n,e){return n!=n?e==e:n!==e||n!==null&&typeof n=="object"||typeof n=="function"}function mi(n){return!Wr(n,this.v)}let Xr=!1,tt=null;function Yn(n){tt=n}function nt(n,e=!1,t){tt={p:tt,i:!1,c:null,e:null,s:n,x:null,l:null}}function st(n){var e=tt,t=e.e;if(t!==null){e.e=null;for(var s of t)Fi(s)}return e.i=!0,tt=e.p,{}}function ki(){return!0}let hn=[];function gi(){var n=hn;hn=[],br(n)}function Gn(n){if(hn.length===0&&!ns){var e=hn;queueMicrotask(()=>{e===hn&&gi()})}hn.push(n)}function Gr(){for(;hn.length>0;)gi()}function pi(n){var e=ve;if(e===null)return ne.f|=ln,n;if(e.f&_a)Vn(n,e);else{if(!(e.f&ha))throw n;e.b.error(n)}}function Vn(n,e){for(;e!==null;){if(e.f&ha)try{e.b.error(n);return}catch(t){n=t}e=e.parent}throw n}const Jr=-7169;function qe(n,e){n.f=n.f&Jr|e}function ka(n){n.f&wt||n.deps===null?qe(n,Le):qe(n,Qt)}function yi(n){if(n!==null)for(const e of n)!(e.f&ze)||!(e.f&An)||(e.f^=An,yi(e.deps))}function wi(n,e,t){n.f&Ye?e.add(n):n.f&Qt&&t.add(n),yi(n.deps),qe(n,Le)}const _s=new Set;let re=null,ks=null,Ne=null,_t=[],Rs=null,Zs=!1,ns=!1;var Fn,Ln,kn,gn,cs,Pn,jn,bt,$s,ea,bi,Ti;const xs=class xs{constructor(){ie(this,bt);T(this,"committed",!1);T(this,"current",new Map);T(this,"previous",new Map);ie(this,Fn,new Set);ie(this,Ln,new Set);ie(this,kn,0);ie(this,gn,0);ie(this,cs,null);ie(this,Pn,new Set);ie(this,jn,new Set);T(this,"skipped_effects",new Set);T(this,"is_fork",!1)}is_deferred(){return this.is_fork||k(this,gn)>0}process(e){var a;_t=[],ks=null,this.apply();var t=[],s=[];for(const i of e)Re(this,bt,$s).call(this,i,t,s);this.is_fork||Re(this,bt,bi).call(this),this.is_deferred()?(Re(this,bt,ea).call(this,s),Re(this,bt,ea).call(this,t)):(ks=this,re=null,Aa(s),Aa(t),ks=null,(a=k(this,cs))==null||a.resolve()),Ne=null}capture(e,t){t!==Be&&!this.previous.has(e)&&this.previous.set(e,t),e.f&ln||(this.current.set(e,e.v),Ne==null||Ne.set(e,e.v))}activate(){re=this,this.apply()}deactivate(){re===this&&(re=null,Ne=null)}flush(){if(this.activate(),_t.length>0){if(Si(),re!==null&&re!==this)return}else k(this,kn)===0&&this.process([]);this.deactivate()}discard(){for(const e of k(this,Ln))e(this);k(this,Ln).clear()}increment(e){ae(this,kn,k(this,kn)+1),e&&ae(this,gn,k(this,gn)+1)}decrement(e){ae(this,kn,k(this,kn)-1),e&&ae(this,gn,k(this,gn)-1),this.revive()}revive(){for(const e of k(this,Pn))k(this,jn).delete(e),qe(e,Ye),Ht(e);for(const e of k(this,jn))qe(e,Qt),Ht(e);this.flush()}oncommit(e){k(this,Fn).add(e)}ondiscard(e){k(this,Ln).add(e)}settled(){return(k(this,cs)??ae(this,cs,di())).promise}static ensure(){if(re===null){const e=re=new xs;_s.add(re),ns||xs.enqueue(()=>{re===e&&e.flush()})}return re}static enqueue(e){Gn(e)}apply(){}};Fn=new WeakMap,Ln=new WeakMap,kn=new WeakMap,gn=new WeakMap,cs=new WeakMap,Pn=new WeakMap,jn=new WeakMap,bt=new WeakSet,$s=function(e,t,s){e.f^=Le;for(var a=e.first,i=null;a!==null;){var o=a.f,c=(o&(Vt|In))!==0,l=c&&(o&Le)!==0,u=l||(o&lt)!==0||this.skipped_effects.has(a);if(!u&&a.fn!==null){c?a.f^=Le:i!==null&&o&(Ss|Os|ui)?i.b.defer_effect(a):o&Ss?t.push(a):fs(a)&&(o&Yt&&k(this,Pn).add(a),rs(a));var f=a.first;if(f!==null){a=f;continue}}var h=a.parent;for(a=a.next;a===null&&h!==null;)h===i&&(i=null),a=h.next,h=h.parent}},ea=function(e){for(var t=0;t<e.length;t+=1)wi(e[t],k(this,Pn),k(this,jn))},bi=function(){if(k(this,gn)===0){for(const e of k(this,Fn))e();k(this,Fn).clear()}k(this,kn)===0&&Re(this,bt,Ti).call(this)},Ti=function(){var a;if(_s.size>1){this.previous.clear();var e=Ne,t=!0;for(const i of _s){if(i===this){t=!1;continue}const o=[];for(const[l,u]of this.current){if(i.current.has(l))if(t&&u!==i.current.get(l))i.current.set(l,u);else continue;o.push(l)}if(o.length===0)continue;const c=[...i.current.keys()].filter(l=>!this.current.has(l));if(c.length>0){var s=_t;_t=[];const l=new Set,u=new Map;for(const f of o)Ei(f,c,l,u);if(_t.length>0){re=i,i.apply();for(const f of _t)Re(a=i,bt,$s).call(a,f,[],[]);i.deactivate()}_t=s}}re=null,Ne=e}this.committed=!0,_s.delete(this)};let jt=xs;function Zr(n){var e=ns;ns=!0;try{for(var t;;){if(Gr(),_t.length===0&&(re==null||re.flush(),_t.length===0))return Rs=null,t;Si()}}finally{ns=e}}function Si(){var n=Sn;Zs=!0;var e=null;try{var t=0;for(Ds(!0);_t.length>0;){var s=jt.ensure();if(t++>1e3){var a,i;$r()}s.process(_t),cn.clear()}}finally{Zs=!1,Ds(n),Rs=null}}function $r(){try{Ir()}catch(n){Vn(n,Rs)}}let Et=null;function Aa(n){var e=n.length;if(e!==0){for(var t=0;t<e;){var s=n[t++];if(!(s.f&(Kt|lt))&&fs(s)&&(Et=new Set,rs(s),s.deps===null&&s.first===null&&s.nodes===null&&(s.teardown===null&&s.ac===null?Ki(s):s.fn=null),(Et==null?void 0:Et.size)>0)){cn.clear();for(const a of Et){if(a.f&(Kt|lt))continue;const i=[a];let o=a.parent;for(;o!==null;)Et.has(o)&&(Et.delete(o),i.push(o)),o=o.parent;for(let c=i.length-1;c>=0;c--){const l=i[c];l.f&(Kt|lt)||rs(l)}}Et.clear()}}Et=null}}function Ei(n,e,t,s){if(!t.has(n)&&(t.add(n),n.reactions!==null))for(const a of n.reactions){const i=a.f;i&ze?Ei(a,e,t,s):i&(ma|Yt)&&!(i&Ye)&&Di(a,e,s)&&(qe(a,Ye),Ht(a))}}function Di(n,e,t){const s=t.get(n);if(s!==void 0)return s;if(n.deps!==null)for(const a of n.deps){if(e.includes(a))return!0;if(a.f&ze&&Di(a,e,t))return t.set(a,!0),!0}return t.set(n,!1),!1}function Ht(n){for(var e=Rs=n;e.parent!==null;){e=e.parent;var t=e.f;if(Zs&&e===ve&&t&Yt&&!(t&vi))return;if(t&(In|Vt)){if(!(t&Le))return;e.f^=Le}}_t.push(e)}function eo(n){let e=0,t=Cn(0),s;return()=>{pa()&&(r(t),zs(()=>(e===0&&(s=Mn(()=>n(()=>ss(t)))),e+=1,()=>{Gn(()=>{e-=1,e===0&&(s==null||s(),s=void 0,ss(t))})})))}}var to=Hn|Xn|ha;function no(n,e,t){new so(n,e,t)}var ft,va,qt,pn,Ot,ht,Je,Rt,Lt,tn,yn,nn,wn,Kn,Un,sn,Is,Me,ao,io,ta,gs,ps,na;class so{constructor(e,t,s){ie(this,Me);T(this,"parent");T(this,"is_pending",!1);ie(this,ft);ie(this,va,null);ie(this,qt);ie(this,pn);ie(this,Ot);ie(this,ht,null);ie(this,Je,null);ie(this,Rt,null);ie(this,Lt,null);ie(this,tn,null);ie(this,yn,0);ie(this,nn,0);ie(this,wn,!1);ie(this,Kn,new Set);ie(this,Un,new Set);ie(this,sn,null);ie(this,Is,eo(()=>(ae(this,sn,Cn(k(this,yn))),()=>{ae(this,sn,null)})));ae(this,ft,e),ae(this,qt,t),ae(this,pn,s),this.parent=ve.b,this.is_pending=!!k(this,qt).pending,ae(this,Ot,ya(()=>{ve.b=this;{var a=Re(this,Me,ta).call(this);try{ae(this,ht,mt(()=>s(a)))}catch(i){this.error(i)}k(this,nn)>0?Re(this,Me,ps).call(this):this.is_pending=!1}return()=>{var i;(i=k(this,tn))==null||i.remove()}},to))}defer_effect(e){wi(e,k(this,Kn),k(this,Un))}is_rendered(){return!this.is_pending&&(!this.parent||this.parent.is_rendered())}has_pending_snippet(){return!!k(this,qt).pending}update_pending_count(e){Re(this,Me,na).call(this,e),ae(this,yn,k(this,yn)+e),k(this,sn)&&Qn(k(this,sn),k(this,yn))}get_effect_pending(){return k(this,Is).call(this),r(k(this,sn))}error(e){var t=k(this,qt).onerror;let s=k(this,qt).failed;if(k(this,wn)||!t&&!s)throw e;k(this,ht)&&(et(k(this,ht)),ae(this,ht,null)),k(this,Je)&&(et(k(this,Je)),ae(this,Je,null)),k(this,Rt)&&(et(k(this,Rt)),ae(this,Rt,null));var a=!1,i=!1;const o=()=>{if(a){Qr();return}a=!0,i&&Br(),jt.ensure(),ae(this,yn,0),k(this,Rt)!==null&&Tn(k(this,Rt),()=>{ae(this,Rt,null)}),this.is_pending=this.has_pending_snippet(),ae(this,ht,Re(this,Me,gs).call(this,()=>(ae(this,wn,!1),mt(()=>k(this,pn).call(this,k(this,ft)))))),k(this,nn)>0?Re(this,Me,ps).call(this):this.is_pending=!1};var c=ne;try{$e(null),i=!0,t==null||t(e,o),i=!1}catch(l){Vn(l,k(this,Ot)&&k(this,Ot).parent)}finally{$e(c)}s&&Gn(()=>{ae(this,Rt,Re(this,Me,gs).call(this,()=>{jt.ensure(),ae(this,wn,!0);try{return mt(()=>{s(k(this,ft),()=>e,()=>o)})}catch(l){return Vn(l,k(this,Ot).parent),null}finally{ae(this,wn,!1)}}))})}}ft=new WeakMap,va=new WeakMap,qt=new WeakMap,pn=new WeakMap,Ot=new WeakMap,ht=new WeakMap,Je=new WeakMap,Rt=new WeakMap,Lt=new WeakMap,tn=new WeakMap,yn=new WeakMap,nn=new WeakMap,wn=new WeakMap,Kn=new WeakMap,Un=new WeakMap,sn=new WeakMap,Is=new WeakMap,Me=new WeakSet,ao=function(){try{ae(this,ht,mt(()=>k(this,pn).call(this,k(this,ft))))}catch(e){this.error(e)}},io=function(){const e=k(this,qt).pending;e&&(ae(this,Je,mt(()=>e(k(this,ft)))),jt.enqueue(()=>{var t=Re(this,Me,ta).call(this);ae(this,ht,Re(this,Me,gs).call(this,()=>(jt.ensure(),mt(()=>k(this,pn).call(this,t))))),k(this,nn)>0?Re(this,Me,ps).call(this):(Tn(k(this,Je),()=>{ae(this,Je,null)}),this.is_pending=!1)}))},ta=function(){var e=k(this,ft);return this.is_pending&&(ae(this,tn,Ut()),k(this,ft).before(k(this,tn)),e=k(this,tn)),e},gs=function(e){var t=ve,s=ne,a=tt;zt(k(this,Ot)),$e(k(this,Ot)),Yn(k(this,Ot).ctx);try{return e()}catch(i){return pi(i),null}finally{zt(t),$e(s),Yn(a)}},ps=function(){const e=k(this,qt).pending;k(this,ht)!==null&&(ae(this,Lt,document.createDocumentFragment()),k(this,Lt).append(k(this,tn)),Yi(k(this,ht),k(this,Lt))),k(this,Je)===null&&ae(this,Je,mt(()=>e(k(this,ft))))},na=function(e){var t;if(!this.has_pending_snippet()){this.parent&&Re(t=this.parent,Me,na).call(t,e);return}if(ae(this,nn,k(this,nn)+e),k(this,nn)===0){this.is_pending=!1;for(const s of k(this,Kn))qe(s,Ye),Ht(s);for(const s of k(this,Un))qe(s,Qt),Ht(s);k(this,Kn).clear(),k(this,Un).clear(),k(this,Je)&&Tn(k(this,Je),()=>{ae(this,Je,null)}),k(this,Lt)&&(k(this,ft).before(k(this,Lt)),ae(this,Lt,null))}};function ro(n,e,t,s){const a=Bs;if(t.length===0&&n.length===0){s(e.map(a));return}var i=re,o=ve,c=oo();function l(){Promise.all(t.map(u=>lo(u))).then(u=>{c();try{s([...e.map(a),...u])}catch(f){o.f&Kt||Vn(f,o)}i==null||i.deactivate(),Es()}).catch(u=>{Vn(u,o)})}n.length>0?Promise.all(n).then(()=>{c();try{return l()}finally{i==null||i.deactivate(),Es()}}):l()}function oo(){var n=ve,e=ne,t=tt,s=re;return function(i=!0){zt(n),$e(e),Yn(t),i&&(s==null||s.activate())}}function Es(){zt(null),$e(null),Yn(null)}function Bs(n){var e=ze|Ye,t=ne!==null&&ne.f&ze?ne:null;return ve!==null&&(ve.f|=Xn),{ctx:tt,deps:null,effects:null,equals:_i,f:e,fn:n,reactions:null,rv:0,v:Be,wv:0,parent:t??ve,ac:null}}function lo(n,e,t){let s=ve;s===null&&Dr();var a=s.b,i=void 0,o=Cn(Be),c=!ne,l=new Map;return yo(()=>{var b;var u=di();i=u.promise;try{Promise.resolve(n()).then(u.resolve,u.reject).then(()=>{f===re&&f.committed&&f.deactivate(),Es()})}catch(O){u.reject(O),Es()}var f=re;if(c){var h=a.is_rendered();a.update_pending_count(1),f.increment(h),(b=l.get(f))==null||b.reject(Nn),l.delete(f),l.set(f,u)}const g=(O,A=void 0)=>{if(f.activate(),A)A!==Nn&&(o.f|=ln,Qn(o,A));else{o.f&ln&&(o.f^=ln),Qn(o,O);for(const[p,w]of l){if(l.delete(p),p===f)break;w.reject(Nn)}}c&&(a.update_pending_count(-1),f.decrement(h))};u.promise.then(g,O=>g(null,O||"unknown"))}),zi(()=>{for(const u of l.values())u.reject(Nn)}),new Promise(u=>{function f(h){function g(){h===i?u(o):f(i)}h.then(g,g)}f(i)})}function W(n){const e=Bs(n);return Vi(e),e}function Ai(n){const e=Bs(n);return e.equals=mi,e}function Ci(n){var e=n.effects;if(e!==null){n.effects=null;for(var t=0;t<e.length;t+=1)et(e[t])}}function co(n){for(var e=n.parent;e!==null;){if(!(e.f&ze))return e.f&Kt?null:e;e=e.parent}return null}function ga(n){var e,t=ve;zt(co(n));try{n.f&=~An,Ci(n),e=Gi(n)}finally{zt(t)}return e}function xi(n){var e=ga(n);if(!n.equals(e)&&(n.wv=Wi(),(!(re!=null&&re.is_fork)||n.deps===null)&&(n.v=e,n.deps===null))){qe(n,Le);return}dn||(Ne!==null?(pa()||re!=null&&re.is_fork)&&Ne.set(n,e):ka(n))}let sa=new Set;const cn=new Map;let Ii=!1;function Cn(n,e){var t={f:0,v:n,reactions:null,equals:_i,rv:0,wv:0};return t}function H(n,e){const t=Cn(n);return Vi(t),t}function uo(n,e=!1,t=!0){const s=Cn(n);return e||(s.equals=mi),s}function y(n,e,t=!1){ne!==null&&(!At||ne.f&Da)&&ki()&&ne.f&(ze|Yt|ma|Da)&&!(He!=null&&He.includes(n))&&Rr();let s=t?he(e):e;return Qn(n,s)}function Qn(n,e){if(!n.equals(e)){var t=n.v;dn?cn.set(n,e):cn.set(n,t),n.v=e;var s=jt.ensure();if(s.capture(n,t),n.f&ze){const a=n;n.f&Ye&&ga(a),ka(a)}n.wv=Wi(),Mi(n,Ye),ve!==null&&ve.f&Le&&!(ve.f&(Vt|In))&&(vt===null?bo([n]):vt.push(n)),!s.is_fork&&sa.size>0&&!Ii&&vo()}return e}function vo(){Ii=!1;var n=Sn;Ds(!0);const e=Array.from(sa);try{for(const t of e)t.f&Le&&qe(t,Qt),fs(t)&&rs(t)}finally{Ds(n)}sa.clear()}function ss(n){y(n,n.v+1)}function Mi(n,e){var t=n.reactions;if(t!==null)for(var s=t.length,a=0;a<s;a++){var i=t[a],o=i.f,c=(o&Ye)===0;if(c&&qe(i,e),o&ze){var l=i;Ne==null||Ne.delete(l),o&An||(o&wt&&(i.f|=An),Mi(l,Qt))}else c&&(o&Yt&&Et!==null&&Et.add(i),Ht(i))}}function he(n){if(typeof n!="object"||n===null||ts in n)return n;const e=ci(n);if(e!==yr&&e!==wr)return n;var t=new Map,s=li(n),a=H(0),i=En,o=c=>{if(En===i)return c();var l=ne,u=En;$e(null),Ma(i);var f=c();return $e(l),Ma(u),f};return s&&t.set("length",H(n.length)),new Proxy(n,{defineProperty(c,l,u){(!("value"in u)||u.configurable===!1||u.enumerable===!1||u.writable===!1)&&qr();var f=t.get(l);return f===void 0?f=o(()=>{var h=H(u.value);return t.set(l,h),h}):y(f,u.value,!0),!0},deleteProperty(c,l){var u=t.get(l);if(u===void 0){if(l in c){const f=o(()=>H(Be));t.set(l,f),ss(a)}}else y(u,Be),ss(a);return!0},get(c,l,u){var b;if(l===ts)return n;var f=t.get(l),h=l in c;if(f===void 0&&(!h||(b=zn(c,l))!=null&&b.writable)&&(f=o(()=>{var O=he(h?c[l]:Be),A=H(O);return A}),t.set(l,f)),f!==void 0){var g=r(f);return g===Be?void 0:g}return Reflect.get(c,l,u)},getOwnPropertyDescriptor(c,l){var u=Reflect.getOwnPropertyDescriptor(c,l);if(u&&"value"in u){var f=t.get(l);f&&(u.value=r(f))}else if(u===void 0){var h=t.get(l),g=h==null?void 0:h.v;if(h!==void 0&&g!==Be)return{enumerable:!0,configurable:!0,value:g,writable:!0}}return u},has(c,l){var g;if(l===ts)return!0;var u=t.get(l),f=u!==void 0&&u.v!==Be||Reflect.has(c,l);if(u!==void 0||ve!==null&&(!f||(g=zn(c,l))!=null&&g.writable)){u===void 0&&(u=o(()=>{var b=f?he(c[l]):Be,O=H(b);return O}),t.set(l,u));var h=r(u);if(h===Be)return!1}return f},set(c,l,u,f){var C;var h=t.get(l),g=l in c;if(s&&l==="length")for(var b=u;b<h.v;b+=1){var O=t.get(b+"");O!==void 0?y(O,Be):b in c&&(O=o(()=>H(Be)),t.set(b+"",O))}if(h===void 0)(!g||(C=zn(c,l))!=null&&C.writable)&&(h=o(()=>H(void 0)),y(h,he(u)),t.set(l,h));else{g=h.v!==Be;var A=o(()=>he(u));y(h,A)}var p=Reflect.getOwnPropertyDescriptor(c,l);if(p!=null&&p.set&&p.set.call(f,u),!g){if(s&&typeof l=="string"){var w=t.get("length"),M=Number(l);Number.isInteger(M)&&M>=w.v&&y(w,M+1)}ss(a)}return!0},ownKeys(c){r(a);var l=Reflect.ownKeys(c).filter(h=>{var g=t.get(h);return g===void 0||g.v!==Be});for(var[u,f]of t)f.v!==Be&&!(u in c)&&l.push(u);return l},setPrototypeOf(){Or()}})}var Ca,qi,Oi,Ri;function fo(){if(Ca===void 0){Ca=window,qi=/Firefox/.test(navigator.userAgent);var n=Element.prototype,e=Node.prototype,t=Text.prototype;Oi=zn(e,"firstChild").get,Ri=zn(e,"nextSibling").get,Ea(n)&&(n.__click=void 0,n.__className=void 0,n.__attributes=null,n.__style=void 0,n.__e=void 0),Ea(t)&&(t.__t=void 0)}}function Ut(n=""){return document.createTextNode(n)}function an(n){return Oi.call(n)}function vs(n){return Ri.call(n)}function d(n,e){return an(n)}function kt(n,e=!1){{var t=an(n);return t instanceof Comment&&t.data===""?vs(t):t}}function v(n,e=1,t=!1){let s=n;for(;e--;)s=vs(s);return s}function ho(n){n.textContent=""}function Bi(){return!1}let xa=!1;function _o(){xa||(xa=!0,document.addEventListener("reset",n=>{Promise.resolve().then(()=>{var e;if(!n.defaultPrevented)for(const t of n.target.elements)(e=t.__on_r)==null||e.call(t)})},{capture:!0}))}function Ns(n){var e=ne,t=ve;$e(null),zt(null);try{return n()}finally{$e(e),zt(t)}}function Ni(n,e,t,s=t){n.addEventListener(e,()=>Ns(t));const a=n.__on_r;a?n.__on_r=()=>{a(),s(!0)}:n.__on_r=()=>s(!0),_o()}function mo(n){ve===null&&(ne===null&&xr(),Cr()),dn&&Ar()}function ko(n,e){var t=e.last;t===null?e.last=e.first=n:(t.next=n,n.prev=t,e.last=n)}function Wt(n,e,t){var s=ve;s!==null&&s.f&lt&&(n|=lt);var a={ctx:tt,deps:null,nodes:null,f:n|Ye|wt,first:null,fn:e,last:null,next:null,parent:s,b:s&&s.b,prev:null,teardown:null,wv:0,ac:null};if(t)try{rs(a),a.f|=_a}catch(c){throw et(a),c}else e!==null&&Ht(a);var i=a;if(t&&i.deps===null&&i.teardown===null&&i.nodes===null&&i.first===i.last&&!(i.f&Xn)&&(i=i.first,n&Yt&&n&Hn&&i!==null&&(i.f|=Hn)),i!==null&&(i.parent=s,s!==null&&ko(i,s),ne!==null&&ne.f&ze&&!(n&In))){var o=ne;(o.effects??(o.effects=[])).push(i)}return a}function pa(){return ne!==null&&!At}function zi(n){const e=Wt(Os,null,!1);return qe(e,Le),e.teardown=n,e}function rn(n){mo();var e=ve.f,t=!ne&&(e&Vt)!==0&&(e&_a)===0;if(t){var s=tt;(s.e??(s.e=[])).push(n)}else return Fi(n)}function Fi(n){return Wt(Ss|Tr,n,!1)}function go(n){jt.ensure();const e=Wt(In|Xn,n,!0);return(t={})=>new Promise(s=>{t.outro?Tn(e,()=>{et(e),s(void 0)}):(et(e),s(void 0))})}function po(n){return Wt(Ss,n,!1)}function yo(n){return Wt(ma|Xn,n,!0)}function zs(n,e=0){return Wt(Os|e,n,!0)}function U(n,e=[],t=[],s=[]){ro(s,e,t,a=>{Wt(Os,()=>n(...a.map(r)),!0)})}function ya(n,e=0){var t=Wt(Yt|e,n,!0);return t}function mt(n){return Wt(Vt|Xn,n,!0)}function Li(n){var e=n.teardown;if(e!==null){const t=dn,s=ne;Ia(!0),$e(null);try{e.call(null)}finally{Ia(t),$e(s)}}}function Pi(n,e=!1){var t=n.first;for(n.first=n.last=null;t!==null;){const a=t.ac;a!==null&&Ns(()=>{a.abort(Nn)});var s=t.next;t.f&In?t.parent=null:et(t,e),t=s}}function wo(n){for(var e=n.first;e!==null;){var t=e.next;e.f&Vt||et(e),e=t}}function et(n,e=!0){var t=!1;(e||n.f&vi)&&n.nodes!==null&&n.nodes.end!==null&&(ji(n.nodes.start,n.nodes.end),t=!0),Pi(n,e&&!t),As(n,0),qe(n,Kt);var s=n.nodes&&n.nodes.t;if(s!==null)for(const i of s)i.stop();Li(n);var a=n.parent;a!==null&&a.first!==null&&Ki(n),n.next=n.prev=n.teardown=n.ctx=n.deps=n.fn=n.nodes=n.ac=null}function ji(n,e){for(;n!==null;){var t=n===e?null:vs(n);n.remove(),n=t}}function Ki(n){var e=n.parent,t=n.prev,s=n.next;t!==null&&(t.next=s),s!==null&&(s.prev=t),e!==null&&(e.first===n&&(e.first=s),e.last===n&&(e.last=t))}function Tn(n,e,t=!0){var s=[];Ui(n,s,!0);var a=()=>{t&&et(n),e&&e()},i=s.length;if(i>0){var o=()=>--i||a();for(var c of s)c.out(o)}else a()}function Ui(n,e,t){if(!(n.f&lt)){n.f^=lt;var s=n.nodes&&n.nodes.t;if(s!==null)for(const c of s)(c.is_global||t)&&e.push(c);for(var a=n.first;a!==null;){var i=a.next,o=(a.f&Hn)!==0||(a.f&Vt)!==0&&(n.f&Yt)!==0;Ui(a,e,o?t:!1),a=i}}}function wa(n){Hi(n,!0)}function Hi(n,e){if(n.f&lt){n.f^=lt,n.f&Le||(qe(n,Ye),Ht(n));for(var t=n.first;t!==null;){var s=t.next,a=(t.f&Hn)!==0||(t.f&Vt)!==0;Hi(t,a?e:!1),t=s}var i=n.nodes&&n.nodes.t;if(i!==null)for(const o of i)(o.is_global||e)&&o.in()}}function Yi(n,e){if(n.nodes)for(var t=n.nodes.start,s=n.nodes.end;t!==null;){var a=t===s?null:vs(t);e.append(t),t=a}}let Sn=!1;function Ds(n){Sn=n}let dn=!1;function Ia(n){dn=n}let ne=null,At=!1;function $e(n){ne=n}let ve=null;function zt(n){ve=n}let He=null;function Vi(n){ne!==null&&(He===null?He=[n]:He.push(n))}let Ue=null,rt=0,vt=null;function bo(n){vt=n}let Qi=1,is=0,En=is;function Ma(n){En=n}function Wi(){return++Qi}function fs(n){var e=n.f;if(e&Ye)return!0;if(e&ze&&(n.f&=~An),e&Qt){for(var t=n.deps,s=t.length,a=0;a<s;a++){var i=t[a];if(fs(i)&&xi(i),i.wv>n.wv)return!0}e&wt&&Ne===null&&qe(n,Le)}return!1}function Xi(n,e,t=!0){var s=n.reactions;if(s!==null&&!(He!=null&&He.includes(n)))for(var a=0;a<s.length;a++){var i=s[a];i.f&ze?Xi(i,e,!1):e===i&&(t?qe(i,Ye):i.f&Le&&qe(i,Qt),Ht(i))}}function Gi(n){var O;var e=Ue,t=rt,s=vt,a=ne,i=He,o=tt,c=At,l=En,u=n.f;Ue=null,rt=0,vt=null,ne=u&(Vt|In)?null:n,He=null,Yn(n.ctx),At=!1,En=++is,n.ac!==null&&(Ns(()=>{n.ac.abort(Nn)}),n.ac=null);try{n.f|=Js;var f=n.fn,h=f(),g=n.deps;if(Ue!==null){var b;if(As(n,rt),g!==null&&rt>0)for(g.length=rt+Ue.length,b=0;b<Ue.length;b++)g[rt+b]=Ue[b];else n.deps=g=Ue;if(pa()&&n.f&wt)for(b=rt;b<g.length;b++)((O=g[b]).reactions??(O.reactions=[])).push(n)}else g!==null&&rt<g.length&&(As(n,rt),g.length=rt);if(ki()&&vt!==null&&!At&&g!==null&&!(n.f&(ze|Qt|Ye)))for(b=0;b<vt.length;b++)Xi(vt[b],n);return a!==null&&a!==n&&(is++,vt!==null&&(s===null?s=vt:s.push(...vt))),n.f&ln&&(n.f^=ln),h}catch(A){return pi(A)}finally{n.f^=Js,Ue=e,rt=t,vt=s,ne=a,He=i,Yn(o),At=c,En=l}}function To(n,e){let t=e.reactions;if(t!==null){var s=kr.call(t,n);if(s!==-1){var a=t.length-1;a===0?t=e.reactions=null:(t[s]=t[a],t.pop())}}if(t===null&&e.f&ze&&(Ue===null||!Ue.includes(e))){var i=e;i.f&wt&&(i.f^=wt,i.f&=~An),ka(i),Ci(i),As(i,0)}}function As(n,e){var t=n.deps;if(t!==null)for(var s=e;s<t.length;s++)To(n,t[s])}function rs(n){var e=n.f;if(!(e&Kt)){qe(n,Le);var t=ve,s=Sn;ve=n,Sn=!0;try{e&(Yt|ui)?wo(n):Pi(n),Li(n);var a=Gi(n);n.teardown=typeof a=="function"?a:null,n.wv=Qi;var i;Gs&&Xr&&n.f&Ye&&n.deps}finally{Sn=s,ve=t}}}async function Ji(){await Promise.resolve(),Zr()}function r(n){var e=n.f,t=(e&ze)!==0;if(ne!==null&&!At){var s=ve!==null&&(ve.f&Kt)!==0;if(!s&&!(He!=null&&He.includes(n))){var a=ne.deps;if(ne.f&Js)n.rv<is&&(n.rv=is,Ue===null&&a!==null&&a[rt]===n?rt++:Ue===null?Ue=[n]:Ue.includes(n)||Ue.push(n));else{(ne.deps??(ne.deps=[])).push(n);var i=n.reactions;i===null?n.reactions=[ne]:i.includes(ne)||i.push(ne)}}}if(dn&&cn.has(n))return cn.get(n);if(t){var o=n;if(dn){var c=o.v;return(!(o.f&Le)&&o.reactions!==null||$i(o))&&(c=ga(o)),cn.set(o,c),c}var l=(o.f&wt)===0&&!At&&ne!==null&&(Sn||(ne.f&wt)!==0),u=o.deps===null;fs(o)&&(l&&(o.f|=wt),xi(o)),l&&!u&&Zi(o)}if(Ne!=null&&Ne.has(n))return Ne.get(n);if(n.f&ln)throw n.v;return n.v}function Zi(n){if(n.deps!==null){n.f|=wt;for(const e of n.deps)(e.reactions??(e.reactions=[])).push(n),e.f&ze&&!(e.f&wt)&&Zi(e)}}function $i(n){if(n.v===Be)return!0;if(n.deps===null)return!1;for(const e of n.deps)if(cn.has(e)||e.f&ze&&$i(e))return!0;return!1}function Mn(n){var e=At;try{return At=!0,n()}finally{At=e}}const So=["touchstart","touchmove"];function Eo(n){return So.includes(n)}const er=new Set,aa=new Set;function Do(n,e,t,s={}){function a(i){if(s.capture||$n.call(e,i),!i.cancelBubble)return Ns(()=>t==null?void 0:t.call(this,i))}return n.startsWith("pointer")||n.startsWith("touch")||n==="wheel"?Gn(()=>{e.addEventListener(n,a,s)}):e.addEventListener(n,a,s),a}function pt(n,e,t,s,a){var i={capture:s,passive:a},o=Do(n,e,t,i);(e===document.body||e===window||e===document||e instanceof HTMLMediaElement)&&zi(()=>{e.removeEventListener(n,o,i)})}function xt(n){for(var e=0;e<n.length;e++)er.add(n[e]);for(var t of aa)t(n)}let qa=null;function $n(n){var p;var e=this,t=e.ownerDocument,s=n.type,a=((p=n.composedPath)==null?void 0:p.call(n))||[],i=a[0]||n.target;qa=n;var o=0,c=qa===n&&n.__root;if(c){var l=a.indexOf(c);if(l!==-1&&(e===document||e===window)){n.__root=e;return}var u=a.indexOf(e);if(u===-1)return;l<=u&&(o=l)}if(i=a[o]||n.target,i!==e){gr(n,"currentTarget",{configurable:!0,get(){return i||t}});var f=ne,h=ve;$e(null),zt(null);try{for(var g,b=[];i!==null;){var O=i.assignedSlot||i.parentNode||i.host||null;try{var A=i["__"+s];A!=null&&(!i.disabled||n.target===i)&&A.call(i,n)}catch(w){g?b.push(w):g=w}if(n.cancelBubble||O===e||O===null)break;i=O}if(g){for(let w of b)queueMicrotask(()=>{throw w});throw g}}finally{n.__root=e,delete n.currentTarget,$e(f),zt(h)}}}function tr(n){var e=document.createElement("template");return e.innerHTML=n.replaceAll("<!>","<!---->"),e.content}function os(n,e){var t=ve;t.nodes===null&&(t.nodes={start:n,end:e,a:null,t:null})}function q(n,e){var t=(e&Hr)!==0,s=(e&Yr)!==0,a,i=!n.startsWith("<!>");return()=>{a===void 0&&(a=tr(i?n:"<!>"+n),t||(a=an(a)));var o=s||qi?document.importNode(a,!0):a.cloneNode(!0);if(t){var c=an(o),l=o.lastChild;os(c,l)}else os(o,o);return o}}function Ks(n=""){{var e=Ut(n+"");return os(e,e),e}}function on(){var n=document.createDocumentFragment(),e=document.createComment(""),t=Ut();return n.append(e,t),os(e,t),n}function D(n,e){n!==null&&n.before(e)}function z(n,e){var t=e==null?"":typeof e=="object"?e+"":e;t!==(n.__t??(n.__t=n.nodeValue))&&(n.__t=t,n.nodeValue=t+"")}function Us(n,e){return Ao(n,e)}const Bn=new Map;function Ao(n,{target:e,anchor:t,props:s={},events:a,context:i,intro:o=!0}){fo();var c=new Set,l=h=>{for(var g=0;g<h.length;g++){var b=h[g];if(!c.has(b)){c.add(b);var O=Eo(b);e.addEventListener(b,$n,{passive:O});var A=Bn.get(b);A===void 0?(document.addEventListener(b,$n,{passive:O}),Bn.set(b,1)):Bn.set(b,A+1)}}};l(qs(er)),aa.add(l);var u=void 0,f=go(()=>{var h=t??e.appendChild(Ut());return no(h,{pending:()=>{}},g=>{if(i){nt({});var b=tt;b.c=i}a&&(s.$$events=a),u=n(g,s)||{},i&&st()}),()=>{var O;for(var g of c){e.removeEventListener(g,$n);var b=Bn.get(g);--b===0?(document.removeEventListener(g,$n),Bn.delete(g)):Bn.set(g,b)}aa.delete(l),h!==t&&((O=h.parentNode)==null||O.removeChild(h))}});return ia.set(u,f),u}let ia=new WeakMap;function Hs(n,e){const t=ia.get(n);return t?(ia.delete(n),t(e)):Promise.resolve()}var Dt,Bt,ot,bn,ds,us,Ms;class Co{constructor(e,t=!0){T(this,"anchor");ie(this,Dt,new Map);ie(this,Bt,new Map);ie(this,ot,new Map);ie(this,bn,new Set);ie(this,ds,!0);ie(this,us,()=>{var e=re;if(k(this,Dt).has(e)){var t=k(this,Dt).get(e),s=k(this,Bt).get(t);if(s)wa(s),k(this,bn).delete(t);else{var a=k(this,ot).get(t);a&&(k(this,Bt).set(t,a.effect),k(this,ot).delete(t),a.fragment.lastChild.remove(),this.anchor.before(a.fragment),s=a.effect)}for(const[i,o]of k(this,Dt)){if(k(this,Dt).delete(i),i===e)break;const c=k(this,ot).get(o);c&&(et(c.effect),k(this,ot).delete(o))}for(const[i,o]of k(this,Bt)){if(i===t||k(this,bn).has(i))continue;const c=()=>{if(Array.from(k(this,Dt).values()).includes(i)){var u=document.createDocumentFragment();Yi(o,u),u.append(Ut()),k(this,ot).set(i,{effect:o,fragment:u})}else et(o);k(this,bn).delete(i),k(this,Bt).delete(i)};k(this,ds)||!s?(k(this,bn).add(i),Tn(o,c,!1)):c()}}});ie(this,Ms,e=>{k(this,Dt).delete(e);const t=Array.from(k(this,Dt).values());for(const[s,a]of k(this,ot))t.includes(s)||(et(a.effect),k(this,ot).delete(s))});this.anchor=e,ae(this,ds,t)}ensure(e,t){var s=re,a=Bi();if(t&&!k(this,Bt).has(e)&&!k(this,ot).has(e))if(a){var i=document.createDocumentFragment(),o=Ut();i.append(o),k(this,ot).set(e,{effect:mt(()=>t(o)),fragment:i})}else k(this,Bt).set(e,mt(()=>t(this.anchor)));if(k(this,Dt).set(s,e),a){for(const[c,l]of k(this,Bt))c===e?s.skipped_effects.delete(l):s.skipped_effects.add(l);for(const[c,l]of k(this,ot))c===e?s.skipped_effects.delete(l.effect):s.skipped_effects.add(l.effect);s.oncommit(k(this,us)),s.ondiscard(k(this,Ms))}else k(this,us).call(this)}}Dt=new WeakMap,Bt=new WeakMap,ot=new WeakMap,bn=new WeakMap,ds=new WeakMap,us=new WeakMap,Ms=new WeakMap;function Q(n,e,t=!1){var s=new Co(n),a=t?Hn:0;function i(o,c){s.ensure(o,c)}ya(()=>{var o=!1;e((c,l=!0)=>{o=!0,i(l,c)}),o||i(!1,null)},a)}function Nt(n,e){return e}function xo(n,e,t){for(var s=[],a=e.length,i,o=e.length,c=0;c<a;c++){let h=e[c];Tn(h,()=>{if(i){if(i.pending.delete(h),i.done.add(h),i.pending.size===0){var g=n.outrogroups;ra(qs(i.done)),g.delete(i),g.size===0&&(n.outrogroups=null)}}else o-=1},!1)}if(o===0){var l=s.length===0&&t!==null;if(l){var u=t,f=u.parentNode;ho(f),f.append(u),n.items.clear()}ra(e,!l)}else i={pending:new Set(e),done:new Set},(n.outrogroups??(n.outrogroups=new Set)).add(i)}function ra(n,e=!0){for(var t=0;t<n.length;t++)et(n[t],e)}var Oa;function Fe(n,e,t,s,a,i=null){var o=n,c=new Map,l=(e&hi)!==0;if(l){var u=n;o=u.appendChild(Ut())}var f=null,h=Ai(()=>{var w=t();return li(w)?w:w==null?[]:qs(w)}),g,b=!0;function O(){p.fallback=f,Io(p,g,o,e,s),f!==null&&(g.length===0?f.f&Pt?(f.f^=Pt,es(f,null,o)):wa(f):Tn(f,()=>{f=null}))}var A=ya(()=>{g=r(h);for(var w=g.length,M=new Set,C=re,I=Bi(),N=0;N<w;N+=1){var F=g[N],j=s(F,N),K=b?null:c.get(j);K?(K.v&&Qn(K.v,F),K.i&&Qn(K.i,N),I&&C.skipped_effects.delete(K.e)):(K=Mo(c,b?o:Oa??(Oa=Ut()),F,j,N,a,e,t),b||(K.e.f|=Pt),c.set(j,K)),M.add(j)}if(w===0&&i&&!f&&(b?f=mt(()=>i(o)):(f=mt(()=>i(Oa??(Oa=Ut()))),f.f|=Pt)),!b)if(I){for(const[ee,te]of c)M.has(ee)||C.skipped_effects.add(te.e);C.oncommit(O),C.ondiscard(()=>{})}else O();r(h)}),p={effect:A,items:c,outrogroups:null,fallback:f};b=!1}function Io(n,e,t,s,a){var te,oe,Y,Z,de,ke,m,_,E;var i=(s&Fr)!==0,o=e.length,c=n.items,l=n.effect.first,u,f=null,h,g=[],b=[],O,A,p,w;if(i)for(w=0;w<o;w+=1)O=e[w],A=a(O,w),p=c.get(A).e,p.f&Pt||((oe=(te=p.nodes)==null?void 0:te.a)==null||oe.measure(),(h??(h=new Set)).add(p));for(w=0;w<o;w+=1){if(O=e[w],A=a(O,w),p=c.get(A).e,n.outrogroups!==null)for(const B of n.outrogroups)B.pending.delete(p),B.done.delete(p);if(p.f&Pt)if(p.f^=Pt,p===l)es(p,null,t);else{var M=f?f.next:l;p===n.effect.last&&(n.effect.last=p.prev),p.prev&&(p.prev.next=p.next),p.next&&(p.next.prev=p.prev),$t(n,f,p),$t(n,p,M),es(p,M,t),f=p,g=[],b=[],l=f.next;continue}if(p.f&lt&&(wa(p),i&&((Z=(Y=p.nodes)==null?void 0:Y.a)==null||Z.unfix(),(h??(h=new Set)).delete(p))),p!==l){if(u!==void 0&&u.has(p)){if(g.length<b.length){var C=b[0],I;f=C.prev;var N=g[0],F=g[g.length-1];for(I=0;I<g.length;I+=1)es(g[I],C,t);for(I=0;I<b.length;I+=1)u.delete(b[I]);$t(n,N.prev,F.next),$t(n,f,N),$t(n,F,C),l=C,f=F,w-=1,g=[],b=[]}else u.delete(p),es(p,l,t),$t(n,p.prev,p.next),$t(n,p,f===null?n.effect.first:f.next),$t(n,f,p),f=p;continue}for(g=[],b=[];l!==null&&l!==p;)(u??(u=new Set)).add(l),b.push(l),l=l.next;if(l===null)continue}p.f&Pt||g.push(p),f=p,l=p.next}if(n.outrogroups!==null){for(const B of n.outrogroups)B.pending.size===0&&(ra(qs(B.done)),(de=n.outrogroups)==null||de.delete(B));n.outrogroups.size===0&&(n.outrogroups=null)}if(l!==null||u!==void 0){var j=[];if(u!==void 0)for(p of u)p.f&lt||j.push(p);for(;l!==null;)!(l.f&lt)&&l!==n.fallback&&j.push(l),l=l.next;var K=j.length;if(K>0){var ee=s&hi&&o===0?t:null;if(i){for(w=0;w<K;w+=1)(m=(ke=j[w].nodes)==null?void 0:ke.a)==null||m.measure();for(w=0;w<K;w+=1)(E=(_=j[w].nodes)==null?void 0:_.a)==null||E.fix()}xo(n,j,ee)}}i&&Gn(()=>{var B,R;if(h!==void 0)for(p of h)(R=(B=p.nodes)==null?void 0:B.a)==null||R.apply()})}function Mo(n,e,t,s,a,i,o,c){var l=o&Nr?o&Lr?Cn(t):uo(t,!1,!1):null,u=o&zr?Cn(a):null;return{v:l,i:u,e:mt(()=>(i(e,l??t,u??a,c),()=>{n.delete(s)}))}}function es(n,e,t){if(n.nodes)for(var s=n.nodes.start,a=n.nodes.end,i=e&&!(e.f&Pt)?e.nodes.start:t;s!==null;){var o=vs(s);if(i.before(s),s===a)return;s=o}}function $t(n,e,t){e===null?n.effect.first=t:e.next=t,t===null?n.effect.last=e:t.prev=e}function qo(n,e,t=!1,s=!1,a=!1){var i=n,o="";U(()=>{var c=ve;if(o!==(o=e()??"")&&(c.nodes!==null&&(ji(c.nodes.start,c.nodes.end),c.nodes=null),o!=="")){var l=o+"";t?l=`<svg>${l}</svg>`:s&&(l=`<math>${l}</math>`);var u=tr(l);if((t||s)&&(u=an(u)),os(an(u),u.lastChild),t||s)for(;an(u);)i.before(an(u));else i.before(u)}})}function nr(n){var e,t,s="";if(typeof n=="string"||typeof n=="number")s+=n;else if(typeof n=="object")if(Array.isArray(n)){var a=n.length;for(e=0;e<a;e++)n[e]&&(t=nr(n[e]))&&(s&&(s+=" "),s+=t)}else for(t in n)n[t]&&(s&&(s+=" "),s+=t);return s}function Oo(){for(var n,e,t=0,s="",a=arguments.length;t<a;t++)(n=arguments[t])&&(e=nr(n))&&(s&&(s+=" "),s+=e);return s}function Ro(n){return typeof n=="object"?Oo(n):n??""}const Ra=[...` 	
\r\f¬†\v\uFEFF`];function Bo(n,e,t){var s=n==null?"":""+n;if(e&&(s=s?s+" "+e:e),t){for(var a in t)if(t[a])s=s?s+" "+a:a;else if(s.length)for(var i=a.length,o=0;(o=s.indexOf(a,o))>=0;){var c=o+i;(o===0||Ra.includes(s[o-1]))&&(c===s.length||Ra.includes(s[c]))?s=(o===0?"":s.substring(0,o))+s.substring(c+1):o=c}}return s===""?null:s}function No(n,e){return n==null?null:String(n)}function yt(n,e,t,s,a,i){var o=n.__className;if(o!==t||o===void 0){var c=Bo(t,s,i);c==null?n.removeAttribute("class"):n.className=c,n.__className=t}else if(i&&a!==i)for(var l in i){var u=!!i[l];(a==null||u!==!!a[l])&&n.classList.toggle(l,u)}return i}function Dn(n,e,t,s){var a=n.__style;if(a!==e){var i=No(e);i==null?n.removeAttribute("style"):n.style.cssText=i,n.__style=e}return s}const zo=Symbol("is custom element"),Fo=Symbol("is html");function sr(n,e){var t=ba(n);t.value===(t.value=e??void 0)||n.value===e&&(e!==0||n.nodeName!=="PROGRESS")||(n.value=e??"")}function as(n,e){var t=ba(n);t.checked!==(t.checked=e??void 0)&&(n.checked=e)}function Ie(n,e,t,s){var a=ba(n);a[e]!==(a[e]=t)&&(e==="loading"&&(n[Er]=t),t==null?n.removeAttribute(e):typeof t!="string"&&Lo(n).includes(e)?n[e]=t:n.setAttribute(e,t))}function ba(n){return n.__attributes??(n.__attributes={[zo]:n.nodeName.includes("-"),[Fo]:n.namespaceURI===Vr})}var Ba=new Map;function Lo(n){var e=n.getAttribute("is")||n.nodeName,t=Ba.get(e);if(t)return t;Ba.set(e,t=[]);for(var s,a=n,i=Element.prototype;i!==a;){s=pr(a);for(var o in s)s[o].set&&t.push(o);a=ci(a)}return t}function gt(n,e,t=e){var s=new WeakSet;Ni(n,"input",async a=>{var i=a?n.defaultValue:n.value;if(i=Ys(n)?Vs(i):i,t(i),re!==null&&s.add(re),await Ji(),i!==(i=e())){var o=n.selectionStart,c=n.selectionEnd,l=n.value.length;if(n.value=i??"",c!==null){var u=n.value.length;o===c&&c===l&&u>l?(n.selectionStart=u,n.selectionEnd=u):(n.selectionStart=o,n.selectionEnd=Math.min(c,u))}}}),Mn(e)==null&&n.value&&(t(Ys(n)?Vs(n.value):n.value),re!==null&&s.add(re)),zs(()=>{var a=e();if(n===document.activeElement){var i=ks??re;if(s.has(i))return}Ys(n)&&a===Vs(n.value)||n.type==="date"&&!a&&!n.value||a!==n.value&&(n.value=a??"")})}function Po(n,e,t=e){Ni(n,"change",s=>{var a=s?n.defaultChecked:n.checked;t(a)}),Mn(e)==null&&t(n.checked),zs(()=>{var s=e();n.checked=!!s})}function Ys(n){var e=n.type;return e==="number"||e==="range"}function Vs(n){return n===""?null:+n}function Na(n,e){return n===e||(n==null?void 0:n[ts])===e}function Wn(n={},e,t,s){return po(()=>{var a,i;return zs(()=>{a=i,i=(s==null?void 0:s())||[],Mn(()=>{n!==t(...i)&&(e(n,...i),a&&Na(t(...a),n)&&e(null,...a))})}),()=>{Gn(()=>{i&&Na(t(...i),n)&&e(null,...i)})}}),n}let ms=!1;function jo(n){var e=ms;try{return ms=!1,[n(),ms]}finally{ms=e}}function xn(n,e,t,s){var M;var a=(t&Kr)!==0,i=(t&Ur)!==0,o=s,c=!0,l=()=>(c&&(c=!1,o=i?Mn(s):s),o),u;if(a){var f=ts in n||Sr in n;u=((M=zn(n,e))==null?void 0:M.set)??(f&&e in n?C=>n[e]=C:void 0)}var h,g=!1;a?[h,g]=jo(()=>n[e]):h=n[e],h===void 0&&s!==void 0&&(h=l(),u&&(Mr(),u(h)));var b;if(b=()=>{var C=n[e];return C===void 0?l():(c=!0,C)},!(t&jr))return b;if(u){var O=n.$$legacy;return function(C,I){return arguments.length>0?((!I||O||g)&&u(I?b():C),C):b()}}var A=!1,p=(t&Pr?Bs:Ai)(()=>(A=!1,b()));a&&r(p);var w=ve;return function(C,I){if(arguments.length>0){const N=I?r(p):a?he(C):C;return y(p,N),A=!0,o!==void 0&&(o=N),C}return dn&&A||w.f&Kt?p.v:r(p)}}function Fs(n){tt===null&&fi(),rn(()=>{const e=Mn(n);if(typeof e=="function")return e})}function Ko(n){tt===null&&fi(),Fs(()=>()=>Mn(n))}const Uo="5";var oi;typeof window<"u"&&((oi=window.__svelte??(window.__svelte={})).v??(oi.v=new Set)).add(Uo);function Ho(){return{type:"daily",interval:1,time:"09:00"}}function ar(n){return!n||!n.type||!n.interval||n.interval<1?!1:n.type==="weekly"?Array.isArray(n.weekdays)&&n.weekdays.length>0&&n.weekdays.every(e=>e>=0&&e<=6):n.type==="monthly"?n.dayOfMonth>=1&&n.dayOfMonth<=31:n.type==="yearly"?n.month>=0&&n.month<=11&&n.dayOfMonth>=1&&n.dayOfMonth<=31:!0}const _n="recurring-tasks-active",ys="recurring-tasks-archive",za="recurring-tasks",Fa="recurring-tasks.json.bak",La="n8n-event-settings",Pa="n8n-event-queue",Yo="notification-state",Vo="recurring-tasks-dock",ja="scheduler-emitted-occurrences",ws=3,oa={n8n:{webhookUrl:"",sharedSecret:"",enabled:!1}},ir=60*1e3,Qo=30*1e3,Qs=2e3,Ka="shehab-note-recurring-plugin",Ua="1.0.0",Wo=60*60*1e3,Xo=3,Ha=10,Ws=1e3,bs=100,Ya=[{label:"15 minutes",minutes:15},{label:"30 minutes",minutes:30},{label:"1 hour",minutes:60},{label:"2 hours",minutes:120},{label:"4 hours",minutes:240}],Va={low:"#64748b",normal:"#3b82f6",high:"#f59e0b",urgent:"#ef4444"},Go=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Qa="last-run-timestamp",Wa="custom-recurring-task-id",Xa="custom-recurring-task-due",Ga="custom-recurring-task-enabled";function rr(n,e,t){const s=new Date().toISOString(),a=t||new Date;return{id:or(),name:n,lastCompletedAt:void 0,dueAt:a.toISOString(),frequency:e,enabled:!0,priority:"normal",timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0,maxSnoozes:3,version:ws,createdAt:s,updatedAt:s}}function or(){return`task_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}function Jo(n,e={}){const t=new Date().toISOString();return{...{...n,id:or(),createdAt:t,updatedAt:t,lastCompletedAt:void 0,completionCount:0,missCount:0,currentStreak:0,bestStreak:0,recentCompletions:[],snoozeCount:0},...e}}function Zo(n){const e=new Date().toISOString();n.completionCount=(n.completionCount||0)+1,n.currentStreak=(n.currentStreak||0)+1,n.bestStreak=Math.max(n.bestStreak||0,n.currentStreak),n.recentCompletions||(n.recentCompletions=[]),n.recentCompletions.push(e),n.recentCompletions.length>Ha&&(n.recentCompletions=n.recentCompletions.slice(-Ha)),n.snoozeCount=0,n.lastCompletedAt=e,n.updatedAt=e}function lr(n){n.missCount=(n.missCount||0)+1,n.currentStreak=0,n.updatedAt=new Date().toISOString()}function cr(n){const e=n.completionCount||0,t=n.missCount||0,s=e+t;if(s===0)return 100;let i=e/s*70;const o=n.currentStreak||0,c=Math.min(30,o*3);return i+=c,Math.round(Math.min(100,i))}function mn(n){const{message:e,type:t="info",duration:s=3e3,actionLabel:a,onAction:i,showCountdown:o=!1}=n,c=document.createElement("div");c.className=`recurring-tasks-toast recurring-tasks-toast--${t}`;const l=document.createElement("span");l.textContent=e,c.appendChild(l);let u=null;if(a&&i){const h=document.createElement("button");h.type="button";let g=Math.max(1,Math.ceil(s/1e3));h.textContent=o?`${a} (${g}s)`:a,h.className="recurring-tasks-toast__action",h.addEventListener("click",()=>{i(),u!==null&&window.clearInterval(u),c.parentElement&&c.parentElement.removeChild(c)}),c.appendChild(h),o&&s>0&&(u=window.setInterval(()=>{g=Math.max(0,g-1),h.textContent=`${a} (${g}s)`,g<=0&&u!==null&&(window.clearInterval(u),u=null)},1e3))}Object.assign(c.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"6px",backgroundColor:$o(t),color:"white",fontSize:"14px",fontWeight:"500",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.15)",zIndex:"10000",maxWidth:"420px",display:"flex",alignItems:"center",gap:"12px",animation:"slideInRight 0.3s ease-out"}),document.body.appendChild(c);const f=()=>{u!==null&&window.clearInterval(u),c.style.animation="slideOutRight 0.3s ease-out",setTimeout(()=>{c.parentElement&&c.parentElement.removeChild(c)},300)};s>0&&setTimeout(()=>{f()},s)}function $o(n){switch(n){case"success":return"#4caf50";case"error":return"#f44336";case"warning":return"#ff9800";case"info":default:return"#2196f3"}}const se={success:(n,e)=>mn({message:n,type:"success",duration:e}),error:(n,e)=>mn({message:n,type:"error",duration:e}),warning:(n,e)=>mn({message:n,type:"warning",duration:e}),info:(n,e)=>mn({message:n,type:"info",duration:e})};if(typeof document<"u"){const n=document.createElement("style");n.textContent=`
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    .recurring-tasks-toast__action {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      white-space: nowrap;
    }

    .recurring-tasks-toast__action:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  `,document.head.appendChild(n)}class el{constructor(){T(this,"handlers",new Map)}on(e,t){return this.handlers.has(e)||this.handlers.set(e,new Set),this.handlers.get(e).add(t),()=>{var s;return(s=this.handlers.get(e))==null?void 0:s.delete(t)}}emit(e,t){var s;(s=this.handlers.get(e))==null||s.forEach(a=>a(t))}clear(){this.handlers.clear()}}const Ze=new el;function Ja(n,e){const t=n.findIndex(a=>a.id===e.id);if(t===-1)return[...n,e];const s=[...n];return s[t]=e,s}function Za(n,e){const t=n.filter(s=>s.id!==e);return t.length===n.length?n:t}function Xs(n,e,t){let s=!1;const a=n.map(i=>i.id!==e?i:(s=!0,t(i)));return s?a:n}function tl(n,e=new Date){const t=new Date(e);return t.setHours(23,59,59,999),n.filter(s=>s.enabled?new Date(s.dueAt)<=t:!1)}const nl=(()=>{try{if(typeof process<"u"&&process.env)return process.env.DEBUG==="true"}catch{}return!1})();function Ls(n,e,t){const s={timestamp:new Date().toISOString()},a=`[${n.toUpperCase()}] [${s.timestamp}]`;n==="error"?console.error(a,e,t||""):n==="warn"?console.warn(a,e,t||""):n==="debug"&&nl?console.debug(a,e,t||""):n==="info"&&console.log(a,e,t||"")}function dr(n,e){Ls("debug",n,e)}function X(n,e){Ls("info",n,e)}function Ct(n,e){Ls("warn",n,e)}function _e(n,e){Ls("error",n,e)}async function sl(n){return new Promise(e=>{try{fa.fetchPost("/api/block/getBlockInfo",{id:n},t=>{var a,i,o;const s=((a=t==null?void 0:t.data)==null?void 0:a.content)??((i=t==null?void 0:t.data)==null?void 0:i.markdown)??((o=t==null?void 0:t.data)==null?void 0:o.name)??null;e(s?s.trim():null)})}catch(t){Ct("Failed to fetch block preview",t),e(null)}})}async function al(n){return new Promise(e=>{try{fa.fetchPost("/api/block/getBlockHTML",{id:n},t=>{var a;const s=((a=t==null?void 0:t.data)==null?void 0:a.html)??null;e(s?s.trim():null)})}catch(t){Ct("Failed to fetch block embed",t),e(null)}})}function ur(n){const[e,t]=n.split(":").map(Number);return{hours:e,minutes:t}}function il(n){const e=n.getHours().toString().padStart(2,"0"),t=n.getMinutes().toString().padStart(2,"0");return`${e}:${t}`}function rl(n){return n.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}function la(n){return n.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function Ta(n){const e=new Date;return n.getDate()===e.getDate()&&n.getMonth()===e.getMonth()&&n.getFullYear()===e.getFullYear()}function ol(n){return n<new Date}function ll(n){return ol(n)&&!Ta(n)}function ls(n,e){const t=new Date(n);return t.setDate(t.getDate()+e),t}function $a(n,e){return ls(n,e*7)}function cl(n,e,t){const s=new Date(n);s.setHours(e,t,0,0);const a=s.getHours()!==e||s.getMinutes()!==t;return{date:s,shifted:a}}function ca(n){const e=new Date(n);return e.setHours(0,0,0,0),e}function dl(n){const e=new Date(n);return e.setHours(23,59,59,999),e}function ul(n,e){const s=Math.abs(e.getTime()-n.getTime());return Math.floor(s/864e5)}function vl(n,e){const t=[];for(let s=0;s<e;s++)t.push(ls(n,s));return t}var fl=q('<span class="task-card__streak svelte-yjw1ud"> </span>'),hl=q('<button class="task-card__edit-btn svelte-yjw1ud" title="Edit">‚úèÔ∏è</button>'),_l=q('<span class="task-card__relative svelte-yjw1ud"> </span>'),ml=q('<div class="task-card__last-completed svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Last completed:</span> <span class="task-card__value svelte-yjw1ud"> </span></div>'),kl=q('<div class="task-card__block-preview-html svelte-yjw1ud"><!></div>'),gl=q('<div class="task-card__block-preview svelte-yjw1ud" role="tooltip"><!></div>'),pl=q('<div class="task-card__linked-block svelte-yjw1ud"><button class="task-card__block-link svelte-yjw1ud"> </button> <!></div>'),yl=q('<button class="task-card__snooze-chip svelte-yjw1ud"> </button>'),wl=q('<button class="task-card__snooze-option svelte-yjw1ud" role="menuitem"> </button>'),bl=q('<div class="task-card__snooze-menu svelte-yjw1ud" role="menu" tabindex="0"></div>'),Tl=q('<div role="article"><div class="task-card__header svelte-yjw1ud"><div class="task-card__title-row svelte-yjw1ud"><div class="task-card__priority-indicator svelte-yjw1ud"></div> <h3 class="task-card__name svelte-yjw1ud"> </h3> <!></div> <!></div> <div class="task-card__details svelte-yjw1ud"><div class="task-card__due svelte-yjw1ud"><span class="task-card__label svelte-yjw1ud">Due:</span> <span class="task-card__value svelte-yjw1ud"> </span> <!></div> <!> <!></div> <div><div class="task-card__health-bar svelte-yjw1ud"></div></div> <div class="task-card__actions svelte-yjw1ud"><div class="task-card__snooze-container svelte-yjw1ud"><button class="task-card__action task-card__action--snooze svelte-yjw1ud" aria-label="Snooze task">üïí Snooze</button> <div class="task-card__snooze-quick svelte-yjw1ud"><!> <button class="task-card__snooze-chip task-card__snooze-chip--tomorrow svelte-yjw1ud" aria-label="Snooze until tomorrow">Tomorrow</button></div> <!></div> <button class="task-card__action task-card__action--delay svelte-yjw1ud" aria-label="Delay task to tomorrow">üïí Tomorrow</button> <button class="task-card__action task-card__action--skip svelte-yjw1ud" aria-label="Skip this occurrence">‚è≠Ô∏è Skip</button> <button class="task-card__action task-card__action--done svelte-yjw1ud" aria-label="Mark task as done">‚úÖ Done</button></div></div>');function Sl(n,e){nt(e,!0);const t=W(()=>new Date(e.task.dueAt)),s=W(()=>ll(r(t))),a=W(()=>Ta(r(t))),i=W(()=>r(s)?ul(new Date(e.task.dueAt),new Date):0),o=W(()=>r(s)?"task-card--overdue":r(a)?"task-card--today":""),c=W(()=>()=>r(s)?`rgba(244, 67, 54, ${Math.min(.45,.12+r(i)*.05)})`:""),l=W(()=>()=>r(s)?`rgba(244, 67, 54, ${Math.min(.8,.3+r(i)*.08)})`:""),u=W(()=>e.task.priority?Va[e.task.priority]:Va.normal),f=W(()=>()=>e.timezoneHandler?e.timezoneHandler.getRelativeTime(r(t)):""),h=W(()=>(e.task.currentStreak||0)>0),g=W(()=>()=>"üî•"),b=W(()=>cr(e.task)),O=W(()=>r(b)>=80?"health--good":r(b)>=50?"health--fair":"health--poor");let A=H(!1),p=H(-1),w=H(he([])),M=H(!1),C=H(null),I=H(null),N=H(!1);const F=W(()=>()=>e.task.linkedBlockId?e.task.linkedBlockId.length>10?`${e.task.linkedBlockId.slice(0,10)}‚Ä¶`:e.task.linkedBlockId:""),j=W(()=>()=>{if(!r(C))return"";const P=r(C).replace(/\s+/g," ").trim();return P.length>220?`${P.slice(0,220)}‚Ä¶`:P}),K=W(()=>()=>Ya.filter(P=>[15,60,120].includes(P.minutes)));rn(()=>{y(C,e.task.linkedBlockContent??null,!0),y(I,null),y(N,!1)});function ee(){e.onDone(e.task)}function te(){e.onDelay(e.task)}function oe(){e.onEdit&&e.onEdit(e.task)}function Y(){e.onSkip(e.task)}async function Z(){y(A,!r(A)),r(A)&&(await Ji(),y(p,-1),y(w,[],!0))}function de(P){const $=new CustomEvent("task-snooze",{detail:{taskId:e.task.id,minutes:P}});window.dispatchEvent($),y(A,!1),y(p,-1)}function ke(P){var fe,De,Ge,je;const $=r(K);P.key==="ArrowDown"?(P.preventDefault(),y(p,Math.min(r(p)+1,$.length-1),!0),(fe=r(w)[r(p)])==null||fe.focus()):P.key==="ArrowUp"?(P.preventDefault(),y(p,Math.max(r(p)-1,0),!0),(De=r(w)[r(p)])==null||De.focus()):P.key==="Escape"?(y(A,!1),y(p,-1)):P.key==="Home"?(P.preventDefault(),y(p,0),(Ge=r(w)[0])==null||Ge.focus()):P.key==="End"&&(P.preventDefault(),y(p,$.length-1),(je=r(w)[r(p)])==null||je.focus())}function m(P){if(P.key==="Escape"&&r(A)){y(A,!1);return}(P.key==="Enter"||P.key===" ")&&(P.preventDefault(),Z())}async function _(){if(y(M,!0),!e.task.linkedBlockId||r(N)||r(I))return;y(N,!0);const[P,$]=await Promise.all([al(e.task.linkedBlockId),sl(e.task.linkedBlockId)]);y(I,P,!0),y(C,$,!0),y(N,!1)}function E(){y(M,!1)}const B=W(()=>()=>`Task: ${e.task.name.replace(/[<>"&]/g,$=>({"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"})[$]||$)}`);var R=Tl();R.__keydown=P=>{P.key==="Escape"&&r(A)&&y(A,!1)};var V=d(R),J=d(V),ue=d(J),le=v(ue,2),ye=d(le),Ee=v(le,2);{var ge=P=>{var $=fl(),fe=d($);U(De=>{Ie($,"title",`${e.task.currentStreak??""} day streak`),z(fe,`${De??""} ${e.task.currentStreak??""}`)},[()=>r(g)()]),D(P,$)};Q(Ee,P=>{r(h)&&P(ge)})}var Oe=v(J,2);{var Te=P=>{var $=hl();$.__click=oe,D(P,$)};Q(Oe,P=>{e.onEdit&&P(Te)})}var Se=v(V,2),Ve=d(Se),Qe=v(d(Ve),2),x=d(Qe),L=v(Qe,2);{var me=P=>{var $=_l(),fe=d($);U(De=>z(fe,De),[()=>r(f)()]),D(P,$)};Q(L,P=>{e.timezoneHandler&&P(me)})}var ce=v(Ve,2);{var be=P=>{var $=ml(),fe=v(d($),2),De=d(fe);U(Ge=>z(De,Ge),[()=>la(new Date(e.task.lastCompletedAt))]),D(P,$)};Q(ce,P=>{e.task.lastCompletedAt&&P(be)})}var we=v(ce,2);{var Ae=P=>{var $=pl(),fe=d($),De=d(fe),Ge=v(fe,2);{var je=ut=>{var Mt=gl(),Tt=d(Mt);{var un=St=>{var Ke=Ks("Loading preview‚Ä¶");D(St,Ke)},vn=St=>{var Ke=on(),Jt=kt(Ke);{var qn=Ft=>{var Zt=kl(),Rn=d(Zt);qo(Rn,()=>r(I)),D(Ft,Zt)},On=Ft=>{var Zt=on(),Rn=kt(Zt);{var hs=G=>{var xe=Ks();U(()=>z(xe,r(j))),D(G,xe)},S=G=>{var xe=Ks("No preview available.");D(G,xe)};Q(Rn,G=>{r(C)?G(hs):G(S,!1)},!0)}D(Ft,Zt)};Q(Jt,Ft=>{r(I)?Ft(qn):Ft(On,!1)},!0)}D(St,Ke)};Q(Tt,St=>{r(N)?St(un):St(vn,!1)})}D(ut,Mt)};Q(Ge,ut=>{r(M)&&ut(je)})}U(()=>{Ie(fe,"title",`Linked block: ${e.task.linkedBlockId}`),z(De,`üìù Block ${r(F)??""}`)}),pt("mouseenter",fe,_),pt("mouseleave",fe,E),pt("focus",fe,_),pt("blur",fe,E),D(P,$)};Q(we,P=>{e.task.linkedBlockId&&P(Ae)})}var Ce=v(Se,2),We=d(Ce),Xe=v(Ce,2),ct=d(Xe),It=d(ct);It.__click=Z,It.__keydown=m;var at=v(It,2),pe=d(at);Fe(pe,17,()=>r(K),Nt,(P,$)=>{var fe=yl();fe.__click=()=>de(r($).minutes);var De=d(fe);U(()=>{Ie(fe,"aria-label",`Snooze for ${r($).label}`),z(De,r($).label)}),D(P,fe)});var it=v(pe,2);it.__click=te;var Pe=v(at,2);{var Xt=P=>{var $=bl();$.__keydown=ke,Fe($,21,()=>Ya,Nt,(fe,De,Ge)=>{var je=wl();je.__click=()=>de(r(De).minutes),Ie(je,"tabindex",Ge===0?0:-1);var ut=d(je);Wn(je,(Mt,Tt)=>r(w)[Tt]=Mt,Mt=>{var Tt;return(Tt=r(w))==null?void 0:Tt[Mt]},()=>[Ge]),U(()=>z(ut,r(De).label)),D(fe,je)}),D(P,$)};Q(Pe,P=>{r(A)&&P(Xt)})}var dt=v(ct,2);dt.__click=te;var Gt=v(dt,2);Gt.__click=Y;var Jn=v(Gt,2);Jn.__click=ee,U((P,$)=>{yt(R,1,`task-card ${r(o)??""}`,"svelte-yjw1ud"),Dn(R,`--overdue-tint: ${r(c)??""}; --overdue-border: ${r(l)??""};`),Ie(R,"aria-label",P),Dn(ue,`background-color: ${r(u)??""}`),Ie(ue,"title",`Priority: ${(e.task.priority||"normal")??""}`),z(ye,e.task.name),z(x,$),yt(Ce,1,`task-card__health ${r(O)??""}`,"svelte-yjw1ud"),Ie(Ce,"title",`Task health: ${r(b)??""}%`),Dn(We,`width: ${r(b)??""}%`),Ie(It,"aria-expanded",r(A))},[()=>r(B)(),()=>la(r(t))]),D(n,R),st()}xt(["keydown","click"]);var El=q(`<div class="today-tab__empty svelte-u7986x"><p class="svelte-u7986x">üéâ No tasks due today or overdue!</p> <p class="today-tab__empty-subtitle svelte-u7986x">You're all caught up.</p></div>`),Dl=q('<div class="today-tab__card-wrapper svelte-u7986x"><!></div>'),Al=q('<div class="today-tab svelte-u7986x"><div class="today-tab__header svelte-u7986x"><h2 class="today-tab__title svelte-u7986x">Today & Overdue Tasks</h2> <p class="today-tab__subtitle svelte-u7986x"> </p></div> <div class="today-tab__content svelte-u7986x"><!></div></div>');function Cl(n,e){nt(e,!0);const t=W(()=>[...e.tasks].sort((A,p)=>new Date(A.dueAt).getTime()-new Date(p.dueAt).getTime()));let s=H(0),a=he([]);rn(()=>{r(s)>=r(t).length&&y(s,Math.max(0,r(t).length-1),!0)});function i(A){var w;if(r(t).length===0)return;const p=Math.max(0,Math.min(A,r(t).length-1));y(s,p,!0),(w=a[p])==null||w.focus()}function o(A,p){A.key==="ArrowDown"?(A.preventDefault(),i(p+1)):A.key==="ArrowUp"?(A.preventDefault(),i(p-1)):A.key==="Home"?(A.preventDefault(),i(0)):A.key==="End"&&(A.preventDefault(),i(r(t).length-1))}var c=Al(),l=d(c),u=v(d(l),2),f=d(u),h=v(l,2),g=d(h);{var b=A=>{var p=El();D(A,p)},O=A=>{var p=on(),w=kt(p);Fe(w,19,()=>r(t),M=>M.id,(M,C,I)=>{var N=Dl();N.__keydown=j=>o(j,r(I));var F=d(N);Sl(F,{get task(){return r(C)},get onDone(){return e.onDone},get onDelay(){return e.onDelay},get onSkip(){return e.onSkip},get onEdit(){return e.onEdit},get timezoneHandler(){return e.timezoneHandler}}),Wn(N,(j,K)=>a[K]=j,j=>a==null?void 0:a[j],()=>[r(I)]),U(()=>Ie(N,"tabindex",r(I)===r(s)?0:-1)),pt("focus",N,()=>y(s,r(I),!0)),D(M,N)}),D(A,p)};Q(g,A=>{r(t).length===0?A(b):A(O,!1)})}U(()=>z(f,`${e.tasks.length??""} task${e.tasks.length!==1?"s":""} requiring attention`)),D(n,c),st()}xt(["keydown"]);var xl=q('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn">No recurring tasks yet.</p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Create your first task to get started!</p></div>'),Il=q('<div class="all-tasks-tab__empty svelte-i091qn"><p class="svelte-i091qn"> </p> <p class="all-tasks-tab__empty-subtitle svelte-i091qn">Try a different search term.</p></div>'),Ml=q('<tr><td class="all-tasks-tab__select-col svelte-i091qn"><input type="checkbox"/></td><td class="task-name svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"> </td><td class="svelte-i091qn"><label class="toggle-switch svelte-i091qn"><input type="checkbox" class="svelte-i091qn"/> <span class="toggle-slider svelte-i091qn"></span></label></td><td class="svelte-i091qn"><div class="task-actions svelte-i091qn"><button class="task-action-btn task-action-btn--edit svelte-i091qn" title="Edit">‚úèÔ∏è</button> <button class="task-action-btn task-action-btn--duplicate svelte-i091qn" title="Duplicate">üìÑ</button> <button class="task-action-btn task-action-btn--delete svelte-i091qn" title="Delete">üóëÔ∏è</button></div></td></tr>'),ql=q('<table class="all-tasks-tab__table svelte-i091qn"><thead class="svelte-i091qn"><tr class="svelte-i091qn"><th class="all-tasks-tab__select-col svelte-i091qn"><input class="all-tasks-tab__select-all svelte-i091qn" type="checkbox" aria-label="Select all visible tasks"/></th><th class="svelte-i091qn">Task Name</th><th class="svelte-i091qn">Next Due</th><th class="svelte-i091qn">Frequency</th><th class="svelte-i091qn">Status</th><th class="svelte-i091qn">Actions</th></tr></thead><tbody></tbody></table>'),Ol=q('<div class="all-tasks-tab__table-wrapper svelte-i091qn"><!></div>'),Rl=q('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Task?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Bl=q('<div class="delete-confirm-overlay svelte-i091qn"><div class="delete-confirm-dialog svelte-i091qn"><h3 class="svelte-i091qn">Delete Selected Tasks?</h3> <p class="svelte-i091qn"> </p> <div class="delete-confirm-actions svelte-i091qn"><button class="btn-cancel svelte-i091qn">Cancel</button> <button class="btn-delete svelte-i091qn">Delete</button></div></div></div>'),Nl=q('<div class="all-tasks-tab svelte-i091qn"><div class="all-tasks-tab__header svelte-i091qn"><h2 class="all-tasks-tab__title svelte-i091qn">All Recurring Tasks</h2> <div class="all-tasks-tab__actions svelte-i091qn"><div class="all-tasks-tab__search svelte-i091qn"><span class="all-tasks-tab__search-icon svelte-i091qn">üîç</span> <input class="all-tasks-tab__search-input svelte-i091qn" type="search" placeholder="Search tasks (name, tags, block content)" aria-label="Search tasks" title="Searches task names, descriptions, tags, and linked block content."/></div> <button class="all-tasks-tab__create-btn svelte-i091qn">+ Create New Task</button></div></div> <div class="all-tasks-tab__content svelte-i091qn"><div class="all-tasks-tab__bulk svelte-i091qn"><div class="all-tasks-tab__bulk-info"> </div> <div class="all-tasks-tab__bulk-actions svelte-i091qn"><button class="all-tasks-tab__bulk-btn svelte-i091qn">Enable</button> <button class="all-tasks-tab__bulk-btn svelte-i091qn">Disable</button> <button class="all-tasks-tab__bulk-btn all-tasks-tab__bulk-btn--danger svelte-i091qn">Delete</button></div></div> <!></div></div> <!> <!>',1);function zl(n,e){nt(e,!0);let t=H(null),s=H(!1),a=H(""),i=H(""),o=H(he(new Set)),c=H(0),l=he([]),u=H(null);const f=W(()=>[...e.tasks].sort((x,L)=>new Date(x.dueAt).getTime()-new Date(L.dueAt).getTime())),h=W(()=>()=>{const x=r(i).trim().toLowerCase();return x?r(f).filter(L=>{var ce;return[L.name,L.description,L.category,L.linkedBlockContent,(ce=L.tags)==null?void 0:ce.join(" ")].filter(Boolean).join(" ").toLowerCase().includes(x)}):r(f)}),g=W(()=>r(h).map(x=>x.id)),b=W(()=>r(o).size>0),O=W(()=>r(h).length>0&&r(h).every(x=>r(o).has(x.id))),A=W(()=>r(h).some(x=>r(o).has(x.id))&&!r(O));rn(()=>{const x=new Set([...r(o)].filter(L=>e.tasks.some(me=>me.id===L)));x.size!==r(o).size&&y(o,x,!0)}),rn(()=>{r(u)&&(r(u).indeterminate=r(A))}),rn(()=>{r(c)>=r(h).length&&y(c,Math.max(0,r(h).length-1),!0)}),rn(()=>{const x=window.setTimeout(()=>{y(i,r(a),!0)},300);return()=>{window.clearTimeout(x)}});function p(x){y(t,x,!0)}function w(){r(t)&&(e.onDelete(r(t)),y(t,null))}function M(){y(t,null)}function C(x){const L=new Set(r(o));L.has(x)?L.delete(x):L.add(x),y(o,L,!0)}function I(){const x=new Set(r(o));r(O)?r(g).forEach(L=>x.delete(L)):r(g).forEach(L=>x.add(L)),y(o,x,!0)}function N(x){var me;if(r(h).length===0)return;const L=Math.max(0,Math.min(x,r(h).length-1));y(c,L,!0),(me=l[L])==null||me.focus()}function F(x,L){x.key==="ArrowDown"?(x.preventDefault(),N(L+1)):x.key==="ArrowUp"?(x.preventDefault(),N(L-1)):x.key==="Home"?(x.preventDefault(),N(0)):x.key==="End"&&(x.preventDefault(),N(r(h).length-1))}function j(){if(r(o).size===0){y(s,!1);return}e.onBulkDelete([...r(o)]),y(o,new Set,!0),y(s,!1)}function K(){y(s,!1)}function ee(x){const{type:L,interval:me}=x.frequency,ce=L==="daily"?"day":L==="weekly"?"week":L==="monthly"?"month":"year",be=me===1?`Every ${ce}`:`Every ${me} ${ce}s`;if(L==="weekly")return`${be} on ${x.frequency.weekdays.map(we=>Go[we]??we).join(", ")}`;if(L==="monthly")return`${be} on day ${x.frequency.dayOfMonth}`;if(L==="yearly"){const we=te[x.frequency.month]??`Month ${x.frequency.month+1}`;return`${be} on ${we} ${x.frequency.dayOfMonth}`}return be}const te=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var oe=Nl(),Y=kt(oe),Z=d(Y),de=v(d(Z),2),ke=d(de),m=v(d(ke),2),_=v(ke,2);_.__click=function(...x){var L;(L=e.onCreate)==null||L.apply(this,x)};var E=v(Z,2),B=d(E),R=d(B),V=d(R),J=v(R,2),ue=d(J);ue.__click=()=>e.onBulkEnable([...r(o)]);var le=v(ue,2);le.__click=()=>e.onBulkDisable([...r(o)]);var ye=v(le,2);ye.__click=()=>y(s,!0);var Ee=v(B,2);{var ge=x=>{var L=xl();D(x,L)},Oe=x=>{var L=Ol(),me=d(L);{var ce=we=>{var Ae=Il(),Ce=d(Ae),We=d(Ce);U(Xe=>z(We,`No tasks match "${Xe??""}".`),[()=>r(i).trim()]),D(we,Ae)},be=we=>{var Ae=ql(),Ce=d(Ae),We=d(Ce),Xe=d(We),ct=d(Xe);ct.__click=I,Wn(ct,at=>y(u,at),()=>r(u));var It=v(Ce);Fe(It,23,()=>r(h),at=>at.id,(at,pe,it)=>{var Pe=Ml();Pe.__keydown=Ke=>F(Ke,r(it));var Xt=d(Pe),dt=d(Xt);dt.__click=()=>C(r(pe).id);var Gt=v(Xt),Jn=d(Gt),P=v(Gt),$=d(P),fe=v(P),De=d(fe),Ge=v(fe),je=d(Ge),ut=d(je);ut.__change=()=>e.onToggleEnabled(r(pe));var Mt=v(Ge),Tt=d(Mt),un=d(Tt);un.__click=()=>e.onEdit(r(pe));var vn=v(un,2);vn.__click=()=>e.onDuplicate(r(pe));var St=v(vn,2);St.__click=()=>p(r(pe)),Wn(Pe,(Ke,Jt)=>l[Jt]=Ke,Ke=>l==null?void 0:l[Ke],()=>[r(it)]),U((Ke,Jt,qn,On)=>{yt(Pe,1,Ro(r(pe).enabled?"":"disabled"),"svelte-i091qn"),Ie(Pe,"tabindex",r(it)===r(c)?0:-1),Ie(Pe,"aria-selected",Ke),Ie(dt,"aria-label",`Select ${r(pe).name}`),as(dt,Jt),z(Jn,r(pe).name),z($,qn),z(De,On),as(ut,r(pe).enabled)},[()=>r(o).has(r(pe).id),()=>r(o).has(r(pe).id),()=>la(new Date(r(pe).dueAt)),()=>ee(r(pe))]),pt("focus",Pe,()=>y(c,r(it),!0)),D(at,Pe)}),U(()=>{as(ct,r(O)),ct.disabled=r(h).length===0}),D(we,Ae)};Q(me,we=>{r(h).length===0?we(ce):we(be,!1)})}D(x,L)};Q(Ee,x=>{r(f).length===0?x(ge):x(Oe,!1)})}var Te=v(Y,2);{var Se=x=>{var L=Rl(),me=d(L),ce=v(d(me),2),be=d(ce),we=v(ce,2),Ae=d(we);Ae.__click=M;var Ce=v(Ae,2);Ce.__click=w,U(()=>z(be,`Are you sure you want to delete "${r(t).name??""}"? This action cannot be undone.`)),D(x,L)};Q(Te,x=>{r(t)&&x(Se)})}var Ve=v(Te,2);{var Qe=x=>{var L=Bl(),me=d(L),ce=v(d(me),2),be=d(ce),we=v(ce,2),Ae=d(we);Ae.__click=K;var Ce=v(Ae,2);Ce.__click=j,U(()=>z(be,`Are you sure you want to delete ${r(o).size??""} task${r(o).size===1?"":"s"}? This action cannot be undone.`)),D(x,L)};Q(Ve,x=>{r(s)&&x(Qe)})}U(()=>{m.disabled=r(f).length===0,z(V,`${r(o).size??""} selected`),ue.disabled=!r(b),le.disabled=!r(b),ye.disabled=!r(b)}),gt(m,()=>r(a),x=>y(a,x)),D(n,oe),st()}xt(["click","keydown","change"]);var Fl=q('<div class="timeline-tab__empty svelte-11jqy0n"><p> </p></div>'),Ll=q('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Pl=q('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),jl=q('<span class="timeline-task__meta-item svelte-11jqy0n"> </span>'),Kl=q('<div class="timeline-task svelte-11jqy0n"><div class="timeline-task__time svelte-11jqy0n"> </div> <div class="timeline-task__content svelte-11jqy0n"><div class="timeline-task__name svelte-11jqy0n"> </div> <div class="timeline-task__meta svelte-11jqy0n"><!> <!> <!></div></div></div>'),Ul=q('<div class="timeline-day svelte-11jqy0n"><div class="timeline-day__date svelte-11jqy0n"><div class="timeline-day__date-label svelte-11jqy0n"> </div> <div class="timeline-day__weekday svelte-11jqy0n"> </div></div> <div class="timeline-day__tasks svelte-11jqy0n"></div></div>'),Hl=q('<div class="timeline-tab__timeline svelte-11jqy0n"></div>'),Yl=q('<div class="timeline-tab svelte-11jqy0n"><div class="timeline-tab__header svelte-11jqy0n"><h2 class="timeline-tab__title svelte-11jqy0n">Scheduled Timeline</h2> <p class="timeline-tab__subtitle svelte-11jqy0n"> </p></div> <div class="timeline-tab__content svelte-11jqy0n"><!></div></div>');function Vl(n,e){nt(e,!0);let t=xn(e,"days",3,30);function s(w){const{frequency:M}=w;if(M.type==="weekly"){const C=[...M.weekdays].sort((I,N)=>I-N).join(",");return`weekly:${M.interval}:${M.time??""}:${C}`}return M.type==="monthly"?`monthly:${M.interval}:${M.time??""}:${M.dayOfMonth}`:M.type==="yearly"?`yearly:${M.interval}:${M.time??""}:${M.month}:${M.dayOfMonth}`:`daily:${M.interval}:${M.time??""}`}function a(w,M){const C=w.map(I=>`${I.id}:${I.enabled}:${I.dueAt}:${s(I)}`).join("|");return`${M}:${C}`}function i(w,M){const C=ca(new Date),I=dl(ls(C,M-1)),N=24*60*60*1e3,j=vl(C,M).map(K=>({date:K,tasks:[]}));for(const K of w.filter(ee=>ee.enabled)){const ee=new Date(K.dueAt),te=e.recurrenceEngine.getOccurrencesInRange(C,I,K.frequency,ee);for(const oe of te){const Y=ca(oe),Z=Math.floor((Y.getTime()-C.getTime())/N);Z>=0&&Z<M&&j[Z].tasks.push({task:K,occurrence:oe})}}for(const K of j)K.tasks.sort((ee,te)=>ee.occurrence.getTime()-te.occurrence.getTime());return j}const o=(()=>{let w="",M=[];return{get(C,I){const N=a(C,I);return N===w||(w=N,M=i(C,I)),M}}})(),c=W(()=>o.get(e.tasks,t())),l=W(()=>r(c).some(w=>w.tasks.length>0));var u=Yl(),f=d(u),h=v(d(f),2),g=d(h),b=v(f,2),O=d(b);{var A=w=>{var M=Fl(),C=d(M),I=d(C);U(()=>z(I,`No tasks scheduled in the next ${t()??""} days.`)),D(w,M)},p=w=>{var M=Hl();Fe(M,21,()=>r(c),C=>C.date.toISOString(),(C,I)=>{var N=on(),F=kt(N);{var j=K=>{var ee=Ul(),te=d(ee),oe=d(te),Y=d(oe),Z=v(oe,2),de=d(Z),ke=v(te,2);Fe(ke,21,()=>r(I).tasks,({task:m,occurrence:_})=>m.id+_.toISOString(),(m,_)=>{let E=()=>r(_).task,B=()=>r(_).occurrence;var R=Kl(),V=d(R),J=d(V),ue=v(V,2),le=d(ue),ye=d(le),Ee=v(le,2),ge=d(Ee);{var Oe=x=>{var L=Ll(),me=d(L);U(()=>z(me,`üîó ${E().linkedBlockId??""}`)),D(x,L)};Q(ge,x=>{E().linkedBlockId&&x(Oe)})}var Te=v(ge,2);{var Se=x=>{var L=Pl(),me=d(L);U(()=>z(me,`‚ö° ${E().priority??""}`)),D(x,L)};Q(Te,x=>{E().priority&&x(Se)})}var Ve=v(Te,2);{var Qe=x=>{var L=jl(),me=d(L);U(ce=>z(me,`üè∑Ô∏è ${ce??""}`),[()=>E().tags.join(", ")]),D(x,L)};Q(Ve,x=>{var L;(L=E().tags)!=null&&L.length&&x(Qe)})}U(x=>{z(J,x),z(ye,E().name)},[()=>il(B())]),D(m,R)}),U((m,_)=>{z(Y,m),z(de,_)},[()=>rl(r(I).date),()=>r(I).date.toLocaleDateString(void 0,{weekday:"short"})]),D(K,ee)};Q(F,K=>{r(I).tasks.length>0&&K(j)})}D(C,N)}),D(w,M)};Q(O,w=>{r(l)?w(p,!1):w(A)})}U(()=>z(g,`Next ${t()??""} days`)),D(n,u),st()}var Ql=q('<span class="leaderboard-item__badge svelte-1ptoc1q">üèÜ Best</span>'),Wl=q('<div class="leaderboard-item svelte-1ptoc1q"><div class="leaderboard-item__rank svelte-1ptoc1q"></div> <div class="leaderboard-item__name svelte-1ptoc1q"> </div> <div class="leaderboard-item__value svelte-1ptoc1q"> <!></div></div>'),Xl=q('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">üî• Current Streaks</h3> <div class="leaderboard svelte-1ptoc1q"></div></div>'),Gl=q('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),Jl=q('<h4 class="subsection-title svelte-1ptoc1q">‚úÖ Best Performing</h4> <div class="health-list svelte-1ptoc1q"></div>',1),Zl=q('<div class="health-item svelte-1ptoc1q"><div class="health-item__name svelte-1ptoc1q"> </div> <div class="health-item__bar-container svelte-1ptoc1q"><div class="health-item__bar svelte-1ptoc1q"></div> <div class="health-item__score svelte-1ptoc1q"> </div></div></div>'),$l=q('<h4 class="subsection-title svelte-1ptoc1q">‚ö†Ô∏è Needs Attention</h4> <div class="health-list svelte-1ptoc1q"></div>',1),ec=q('<div class="activity-item svelte-1ptoc1q"><div class="activity-item__icon svelte-1ptoc1q">‚úÖ</div> <div class="activity-item__details svelte-1ptoc1q"><div class="activity-item__name svelte-1ptoc1q"> </div> <div class="activity-item__time svelte-1ptoc1q"> </div></div></div>'),tc=q('<div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Recent Activity</h3> <div class="activity-list svelte-1ptoc1q"></div></div>'),nc=q('<div class="analytics-tab svelte-1ptoc1q"><div class="analytics-tab__header svelte-1ptoc1q"><h2 class="analytics-tab__title svelte-1ptoc1q">Task Analytics</h2> <p class="analytics-tab__subtitle svelte-1ptoc1q">Performance insights and statistics</p></div> <div class="analytics-tab__content svelte-1ptoc1q"><div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Overall Performance</h3> <div class="stats-grid svelte-1ptoc1q"><div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Completions</div></div> <div class="stat-card svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Total Misses</div></div> <div class="stat-card stat-card--highlight svelte-1ptoc1q"><div class="stat-card__value svelte-1ptoc1q"> </div> <div class="stat-card__label svelte-1ptoc1q">Completion Rate</div></div></div></div> <!> <div class="analytics-section svelte-1ptoc1q"><h3 class="analytics-section__title svelte-1ptoc1q">Task Health Scores</h3> <!> <!></div> <!></div></div>');function sc(n,e){nt(e,!0);const t=W(()=>()=>{let m=0,_=0;for(const R of e.tasks)m+=R.completionCount||0,_+=R.missCount||0;const E=m+_,B=E>0?m/E*100:100;return{totalCompletions:m,totalMisses:_,completionRate:Math.round(B)}}),s=W(()=>()=>[...e.tasks].filter(m=>(m.currentStreak||0)>0).sort((m,_)=>(_.currentStreak||0)-(m.currentStreak||0)).slice(0,10)),a=W(()=>()=>[...e.tasks].map(m=>({task:m,health:cr(m)})).sort((m,_)=>m.health-_.health)),i=W(()=>()=>r(a)().slice(-5).reverse()),o=W(()=>()=>r(a)().slice(0,5)),c=W(()=>()=>{const m=[];for(const _ of e.tasks)if(_.recentCompletions&&_.recentCompletions.length>0)for(const E of _.recentCompletions)m.push({task:_,completedAt:E});return m.sort((_,E)=>new Date(E.completedAt).getTime()-new Date(_.completedAt).getTime()).slice(0,10)});function l(m){return new Date(m).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function u(m){return m>=80?"#10b981":m>=60?"#3b82f6":m>=40?"#f59e0b":"#ef4444"}var f=nc(),h=v(d(f),2),g=d(h),b=v(d(g),2),O=d(b),A=d(O),p=d(A),w=v(O,2),M=d(w),C=d(M),I=v(w,2),N=d(I),F=d(N),j=v(g,2);{var K=m=>{var _=Xl(),E=v(d(_),2);Fe(E,21,()=>r(s)(),Nt,(B,R,V)=>{var J=Wl(),ue=d(J);ue.textContent=`#${V+1}`;var le=v(ue,2),ye=d(le),Ee=v(le,2),ge=d(Ee),Oe=v(ge);{var Te=Se=>{var Ve=Ql();D(Se,Ve)};Q(Oe,Se=>{r(R).bestStreak&&r(R).currentStreak===r(R).bestStreak&&Se(Te)})}U(()=>{z(ye,r(R).name),z(ge,`${r(R).currentStreak??""} day${r(R).currentStreak!==1?"s":""} `)}),D(B,J)}),D(m,_)};Q(j,m=>{r(s)().length>0&&m(K)})}var ee=v(j,2),te=v(d(ee),2);{var oe=m=>{var _=Jl(),E=v(kt(_),2);Fe(E,21,()=>r(i)(),Nt,(B,R)=>{let V=()=>r(R).task,J=()=>r(R).health;var ue=Gl(),le=d(ue),ye=d(le),Ee=v(le,2),ge=d(Ee),Oe=v(ge,2),Te=d(Oe);U(Se=>{z(ye,V().name),Dn(ge,`width: ${J()??""}%; background-color: ${Se??""}`),z(Te,`${J()??""}/100`)},[()=>u(J())]),D(B,ue)}),D(m,_)};Q(te,m=>{r(i)().length>0&&m(oe)})}var Y=v(te,2);{var Z=m=>{var _=$l(),E=v(kt(_),2);Fe(E,21,()=>r(o)(),Nt,(B,R)=>{let V=()=>r(R).task,J=()=>r(R).health;var ue=Zl(),le=d(ue),ye=d(le),Ee=v(le,2),ge=d(Ee),Oe=v(ge,2),Te=d(Oe);U(Se=>{z(ye,V().name),Dn(ge,`width: ${J()??""}%; background-color: ${Se??""}`),z(Te,`${J()??""}/100`)},[()=>u(J())]),D(B,ue)}),D(m,_)};Q(Y,m=>{r(o)().length>0&&r(o)()[0].health<80&&m(Z)})}var de=v(ee,2);{var ke=m=>{var _=tc(),E=v(d(_),2);Fe(E,21,()=>r(c)(),Nt,(B,R)=>{let V=()=>r(R).task,J=()=>r(R).completedAt;var ue=ec(),le=v(d(ue),2),ye=d(le),Ee=d(ye),ge=v(ye,2),Oe=d(ge);U(Te=>{z(Ee,V().name),z(Oe,Te)},[()=>l(J())]),D(B,ue)}),D(m,_)};Q(de,m=>{r(c)().length>0&&m(ke)})}U((m,_,E)=>{z(p,m),z(C,_),z(F,`${E??""}%`)},[()=>r(t)().totalCompletions,()=>r(t)().totalMisses,()=>r(t)().completionRate]),D(n,f),st()}class da{static parse(e){const t=e,s=e.trim().toLowerCase();if(!s)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence string cannot be empty"};const a=s.match(/^every\s+(.+)$/);if(!a)return{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Recurrence must start with 'every'"};const i=a[1],o=i.match(/^(\d+\s+)?days?$/);if(o)return{frequency:{type:"daily",interval:o[1]?parseInt(o[1]):1},raw:t,isValid:!0};const c=i.match(/^(\d+\s+)?weeks?(?:\s+on\s+(.+))?$/);if(c){const f=c[1]?parseInt(c[1]):1,h=c[2];if(!h)return{frequency:{type:"weekly",interval:f,weekdays:[1]},raw:t,isValid:!0};const g=this.parseDayNames(h);return g.length===0?{frequency:{type:"weekly",interval:f,weekdays:[1]},raw:t,isValid:!1,error:"Invalid day names"}:{frequency:{type:"weekly",interval:f,weekdays:g},raw:t,isValid:!0}}const l=i.match(/^(\d+\s+)?months?(?:\s+on\s+the\s+(\d+)(?:st|nd|rd|th)?)?$/);if(l){const f=l[1]?parseInt(l[1]):1,h=l[2]?parseInt(l[2]):1;return h<1||h>31?{frequency:{type:"monthly",interval:f,dayOfMonth:1},raw:t,isValid:!1,error:"Day of month must be between 1 and 31"}:{frequency:{type:"monthly",interval:f,dayOfMonth:h},raw:t,isValid:!0}}const u=i.match(/^(\d+\s+)?years?$/);return u?{frequency:{type:"yearly",interval:u[1]?parseInt(u[1]):1,month:0,dayOfMonth:1},raw:t,isValid:!0}:{frequency:{type:"daily",interval:1},raw:t,isValid:!1,error:"Unrecognized recurrence pattern"}}static stringify(e){const t=e.interval;switch(e.type){case"daily":return t===1?"every day":`every ${t} days`;case"weekly":{const s=t===1?"week":`${t} weeks`;if(e.weekdays.length===0)return`every ${s}`;const a=e.weekdays.map(i=>this.getDayName(i)).join(", ");return`every ${s} on ${a}`}case"monthly":{const s=t===1?"month":`${t} months`,a=this.getDaySuffix(e.dayOfMonth);return`every ${s} on the ${e.dayOfMonth}${a}`}case"yearly":return`every ${t===1?"year":`${t} years`}`;default:return"every day"}}static parseDayNames(e){const t={monday:0,mon:0,tuesday:1,tue:1,wednesday:2,wed:2,thursday:3,thu:3,friday:4,fri:4,saturday:5,sat:5,sunday:6,sun:6},s=e.split(",").map(i=>i.trim().toLowerCase()),a=[];for(const i of s)i in t&&a.push(t[i]);return a}static getDayName(e){return["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][e]||"Monday"}static getDaySuffix(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}}var ac=q('<label><input type="radio" name="priority" class="svelte-1w15n9q"/> <span class="priority-selector__emoji svelte-1w15n9q"> </span> <span class="priority-selector__label svelte-1w15n9q"> </span></label>'),ic=q('<div class="priority-selector svelte-1w15n9q"></div>');function rc(n,e){nt(e,!0);let t=xn(e,"value",15,"normal");const s=[{value:"urgent",label:"Urgent",emoji:"üî¥",color:"var(--b3-theme-error, #ff4444)"},{value:"high",label:"High",emoji:"üü†",color:"#ff8800"},{value:"normal",label:"Normal",emoji:"üü°",color:"#ffcc00"},{value:"low",label:"Low",emoji:"üü¢",color:"#44cc44"}];function a(o){t(o),e.onchange(o)}var i=ic();Fe(i,21,()=>s,Nt,(o,c)=>{var l=ac();let u;var f=d(l);f.__change=()=>a(r(c).value);var h=v(f,2),g=d(h),b=v(h,2),O=d(b);U(()=>{u=yt(l,1,"priority-selector__option svelte-1w15n9q",null,u,{active:t()===r(c).value}),Dn(l,`--priority-color: ${r(c).color??""}`),sr(f,r(c).value),as(f,t()===r(c).value),z(g,r(c).emoji),z(O,r(c).label)}),D(o,l)}),D(n,i),st()}xt(["change"]);var oc=q('<label><input type="radio" name="status" class="svelte-v9ezc0"/> <span class="status-selector__icon svelte-v9ezc0"> </span> <span class="status-selector__label svelte-v9ezc0"> </span></label>'),lc=q('<div class="status-selector svelte-v9ezc0"></div>');function cc(n,e){nt(e,!0);let t=xn(e,"value",15,"todo");const s=[{value:"todo",label:"Todo",icon:"‚óã",color:"var(--b3-theme-on-surface)"},{value:"done",label:"Done",icon:"‚úì",color:"#44cc44"},{value:"cancelled",label:"Cancelled",icon:"‚úï",color:"#999"}];function a(o){t(o),e.onchange(o)}var i=lc();Fe(i,21,()=>s,Nt,(o,c)=>{var l=oc();let u;var f=d(l);f.__change=()=>a(r(c).value);var h=v(f,2),g=d(h),b=v(h,2),O=d(b);U(()=>{u=yt(l,1,"status-selector__option svelte-v9ezc0",null,u,{active:t()===r(c).value}),Dn(l,`--status-color: ${r(c).color??""}`),sr(f,r(c).value),as(f,t()===r(c).value),z(g,r(c).icon),z(O,r(c).label)}),D(o,l)}),D(n,i),st()}xt(["change"]);var dc=q('<div class="recurrence-input__valid svelte-787fjp">‚úì Valid recurrence pattern</div>'),uc=q('<div class="recurrence-input__error svelte-787fjp"> </div>'),vc=q('<div class="recurrence-input__feedback svelte-787fjp"><!></div>'),fc=q('<li class="svelte-787fjp"> </li>'),hc=q('<div class="recurrence-input__preview svelte-787fjp"><div class="recurrence-input__preview-title svelte-787fjp">Next occurrences:</div> <ul class="recurrence-input__preview-list svelte-787fjp"></ul></div>'),_c=q('<div class="recurrence-input svelte-787fjp"><input type="text" placeholder="e.g., every week on Monday"/> <!> <!></div>');function mc(n,e){nt(e,!0);let t=xn(e,"value",15,""),s=xn(e,"showPreview",3,!0);const a=W(()=>da.parse(t())),i=W(()=>r(a).isValid),o=W(()=>r(a).error);function c(w,M=3){const C=[],I=new Date;for(let N=0;N<M;N++){const F=new Date(I);switch(w.type){case"daily":F.setDate(I.getDate()+N*w.interval);break;case"weekly":F.setDate(I.getDate()+N*w.interval*7);break;case"monthly":F.setMonth(I.getMonth()+N*w.interval);break;case"yearly":F.setFullYear(I.getFullYear()+N*w.interval);break}C.push(F.toLocaleDateString())}return C}const l=W(()=>r(i)&&s()?c(r(a).frequency):[]);function u(w){const C=w.target.value;t(C);const I=da.parse(C);e.onchange(C,I.isValid?I.frequency:null,I.isValid)}var f=_c(),h=d(f);let g;h.__input=u;var b=v(h,2);{var O=w=>{var M=vc(),C=d(M);{var I=F=>{var j=dc();D(F,j)},N=F=>{var j=uc(),K=d(j);U(()=>z(K,`‚ö† ${(r(o)||"Invalid recurrence pattern")??""}`)),D(F,j)};Q(C,F=>{r(i)?F(I):F(N,!1)})}D(w,M)};Q(b,w=>{t().length>0&&w(O)})}var A=v(b,2);{var p=w=>{var M=hc(),C=v(d(M),2);Fe(C,21,()=>r(l),Nt,(I,N)=>{var F=fc(),j=d(F);U(()=>z(j,r(N))),D(I,F)}),D(w,M)};Q(A,w=>{r(i)&&s()&&r(l).length>0&&w(p)})}U(()=>{g=yt(h,1,"recurrence-input__field svelte-787fjp",null,g,{valid:r(i),invalid:!r(i)&&t().length>0}),Ie(h,"aria-invalid",!r(i)&&t().length>0)}),gt(h,t),D(n,f),st()}xt(["input"]);var kc=q('<div class="dependency-picker__chip svelte-10ls0lk"><span class="dependency-picker__chip-text svelte-10ls0lk"> </span> <button type="button" class="dependency-picker__chip-remove svelte-10ls0lk">‚úï</button></div>'),gc=q('<div class="dependency-picker__chips svelte-10ls0lk"></div>'),pc=q('<span class="dependency-picker__option-check svelte-10ls0lk">‚úì</span>'),yc=q('<button type="button"><span class="dependency-picker__option-name svelte-10ls0lk"> </span> <!></button>'),wc=q('<div class="dependency-picker__dropdown svelte-10ls0lk"></div>'),bc=q('<div class="dependency-picker svelte-10ls0lk"><label class="dependency-picker__label svelte-10ls0lk"> </label> <!> <div class="dependency-picker__search-wrapper svelte-10ls0lk"><input type="text" class="dependency-picker__search svelte-10ls0lk" placeholder="Search tasks..."/> <!></div></div>');function ei(n,e){nt(e,!0);let t=xn(e,"selected",31,()=>he([])),s=xn(e,"label",3,"Select tasks"),a=H(""),i=H(!1);const o=W(()=>e.repository.getAllTasks().filter(F=>F.id!==e.excludeId)),c=W(()=>r(a).trim()?r(o).filter(F=>F.name.toLowerCase().includes(r(a).toLowerCase())):r(o)),l=W(()=>r(o).filter(F=>t().includes(F.id)));function u(F){if(!t().includes(F)){const j=[...t(),F];t(j),e.onchange(j)}y(a,""),y(i,!1)}function f(F){const j=t().filter(K=>K!==F);t(j),e.onchange(j)}function h(){y(i,!0)}function g(){setTimeout(()=>{y(i,!1)},200)}var b=bc(),O=d(b),A=d(O),p=v(O,2);{var w=F=>{var j=gc();Fe(j,21,()=>r(l),K=>K.id,(K,ee)=>{var te=kc(),oe=d(te),Y=d(oe),Z=v(oe,2);Z.__click=()=>f(r(ee).id),U(()=>{z(Y,r(ee).name),Ie(Z,"aria-label",`Remove ${r(ee).name??""}`)}),D(K,te)}),D(F,j)};Q(p,F=>{r(l).length>0&&F(w)})}var M=v(p,2),C=d(M),I=v(C,2);{var N=F=>{var j=wc();Fe(j,21,()=>r(c).slice(0,10),K=>K.id,(K,ee)=>{var te=yc();let oe;te.__click=()=>u(r(ee).id);var Y=d(te),Z=d(Y),de=v(Y,2);{var ke=m=>{var _=pc();D(m,_)};Q(de,m=>{t().includes(r(ee).id)&&m(ke)})}U((m,_)=>{oe=yt(te,1,"dependency-picker__option svelte-10ls0lk",null,oe,m),te.disabled=_,z(Z,r(ee).name)},[()=>({selected:t().includes(r(ee).id)}),()=>t().includes(r(ee).id)]),D(K,te)}),D(F,j)};Q(I,F=>{r(i)&&r(c).length>0&&F(N)})}U(()=>z(A,s())),pt("focus",C,h),pt("blur",C,g),gt(C,()=>r(a),F=>y(a,F)),D(n,b),st()}xt(["click"]);var Tc=q('<div class="task-editor__error svelte-xc3qs9"> </div>'),Sc=q('<div class="task-editor__error svelte-xc3qs9"> </div>'),Ec=q('<div class="task-editor__error svelte-xc3qs9"> </div>'),Dc=q('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Completed:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Ac=q('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Cancelled:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),Cc=q('<div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Linked block:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div>'),xc=q('<div class="task-editor-overlay svelte-xc3qs9" role="dialog" aria-modal="true" aria-labelledby="task-editor-title" tabindex="-1"><div class="task-editor-modal svelte-xc3qs9" role="document"><div class="task-editor__header svelte-xc3qs9"><h2 id="task-editor-title" class="svelte-xc3qs9"> </h2> <button class="task-editor__close svelte-xc3qs9" type="button" aria-label="Close">‚úï</button></div> <div class="task-editor__body svelte-xc3qs9"><div class="task-editor__field svelte-xc3qs9"><label for="task-name" class="svelte-xc3qs9">Description *</label> <input id="task-name" type="text" placeholder="Task name" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-description" class="svelte-xc3qs9">Notes</label> <textarea id="task-description" placeholder="Additional details about this task..." rows="3" class="svelte-xc3qs9"></textarea></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Priority</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label class="svelte-xc3qs9">Status</label> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-due" class="svelte-xc3qs9">Due Date *</label> <input id="task-due" type="datetime-local" class="svelte-xc3qs9"/> <!></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-scheduled" class="svelte-xc3qs9">Scheduled Date</label> <input id="task-scheduled" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">When you plan to start working on this task</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-start" class="svelte-xc3qs9">Start Date</label> <input id="task-start" type="datetime-local" class="svelte-xc3qs9"/> <div class="task-editor__hint svelte-xc3qs9">Earliest date this task can begin</div></div> <div class="task-editor__field svelte-xc3qs9"><label for="task-recurrence" class="svelte-xc3qs9">Recurrence</label> <!> <!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__field svelte-xc3qs9"><!></div> <div class="task-editor__timestamps svelte-xc3qs9"><div class="task-editor__timestamp svelte-xc3qs9"><span class="task-editor__timestamp-label svelte-xc3qs9">Created:</span> <span class="task-editor__timestamp-value svelte-xc3qs9"> </span></div> <!> <!> <!></div></div> <div class="task-editor__footer svelte-xc3qs9"><button class="task-editor__cancel svelte-xc3qs9" type="button">Cancel</button> <button class="task-editor__save svelte-xc3qs9" type="button"> </button></div> <div class="task-editor__hint-footer svelte-xc3qs9">üí° Press <kbd class="svelte-xc3qs9">Esc</kbd> to close, <kbd class="svelte-xc3qs9">‚åò/Ctrl+Enter</kbd> to save</div></div></div>');function vr(n,e){var Tt,un,vn,St,Ke,Jt,qn,On,Ft,Zt,Rn,hs;nt(e,!0);const t=!e.task;let s=H(he(((Tt=e.task)==null?void 0:Tt.name)||"")),a=H(he(((un=e.task)==null?void 0:un.description)||"")),i=H(he(((vn=e.task)==null?void 0:vn.priority)||"normal")),o=H(he(((St=e.task)==null?void 0:St.status)||"todo")),c=H(he((Ke=e.task)!=null&&Ke.dueAt?new Date(e.task.dueAt).toISOString().slice(0,16):new Date().toISOString().slice(0,16))),l=H(he((Jt=e.task)!=null&&Jt.scheduledAt?new Date(e.task.scheduledAt).toISOString().slice(0,16):"")),u=H(he((qn=e.task)!=null&&qn.startAt?new Date(e.task.startAt).toISOString().slice(0,16):"")),f=H(he(((On=e.task)==null?void 0:On.recurrenceText)||((Ft=e.task)!=null&&Ft.frequency?da.stringify(e.task.frequency):"every day"))),h=H(he(((Zt=e.task)==null?void 0:Zt.frequency)||null)),g=H(!0),b=H(he(((Rn=e.task)==null?void 0:Rn.blockedBy)||[])),O=H(he(((hs=e.task)==null?void 0:hs.dependsOn)||[])),A=H(he({name:!1,dueAt:!1,recurrence:!1})),p=H(!1),w=H(null);const M=W(()=>r(A).name&&!r(s).trim()?"Task name is required":""),C=W(()=>r(A).dueAt?r(c)?Number.isNaN(new Date(r(c)).getTime())?"Invalid due date":"":"Due date is required":""),I=W(()=>r(A).recurrence&&!r(g)?"Invalid recurrence pattern":""),N=W(()=>!!(r(M)||r(C)||r(I)));Fs(()=>{requestAnimationFrame(()=>{var S;(S=r(w))==null||S.focus()})});function F(S,G,xe){y(f,S,!0),y(h,G,!0),y(g,xe,!0),r(A).recurrence=!0}function j(S){y(i,S,!0)}function K(S){y(o,S,!0)}function ee(S){y(b,S,!0)}function te(S){y(O,S,!0)}async function oe(){if(y(A,{name:!0,dueAt:!0,recurrence:!0},!0),r(N)){se.warning("Please fix validation errors");return}if(!r(h)){se.error("Invalid recurrence pattern");return}y(p,!0);try{let S;t?S=rr(r(s).trim(),r(h),new Date(r(c))):(S={...e.task},S.name=r(s).trim(),S.frequency=r(h),S.dueAt=new Date(r(c)).toISOString()),S.description=r(a).trim()||void 0,S.priority=r(i),S.status=r(o),S.recurrenceText=r(f),S.scheduledAt=r(l)?new Date(r(l)).toISOString():void 0,S.startAt=r(u)?new Date(r(u)).toISOString():void 0,S.blockedBy=r(b).length>0?r(b):void 0,S.dependsOn=r(O).length>0?r(O):void 0,S.updatedAt=new Date().toISOString(),r(o)==="done"&&!S.lastCompletedAt&&(S.lastCompletedAt=new Date().toISOString()),r(o)==="cancelled"&&!S.cancelledAt&&(S.cancelledAt=new Date().toISOString()),await e.repository.saveTask(S),e.onSave&&e.onSave(S),se.success(`Task "${S.name}" ${t?"created":"updated"}`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(S){se.error(`Failed to save task: ${S}`)}finally{y(p,!1)}}function Y(S){S.key==="Escape"&&e.onClose(),(S.metaKey||S.ctrlKey)&&S.key==="Enter"&&(S.preventDefault(),oe())}function Z(S){return S?new Date(S).toLocaleString():"‚Äî"}var de=xc();de.__keydown=Y;var ke=d(de),m=d(ke),_=d(m),E=d(_),B=v(_,2);B.__click=function(...S){var G;(G=e.onClose)==null||G.apply(this,S)};var R=v(m,2),V=d(R),J=v(d(V),2);J.__input=()=>r(A).name=!0,Wn(J,S=>y(w,S),()=>r(w));var ue=v(J,2);{var le=S=>{var G=Tc(),xe=d(G);U(()=>z(xe,r(M))),D(S,G)};Q(ue,S=>{r(M)&&S(le)})}var ye=v(V,2),Ee=v(d(ye),2),ge=v(ye,2),Oe=v(d(ge),2);rc(Oe,{get value(){return r(i)},onchange:j});var Te=v(ge,2),Se=v(d(Te),2);cc(Se,{get value(){return r(o)},onchange:K});var Ve=v(Te,2),Qe=v(d(Ve),2);Qe.__input=()=>r(A).dueAt=!0;var x=v(Qe,2);{var L=S=>{var G=Sc(),xe=d(G);U(()=>z(xe,r(C))),D(S,G)};Q(x,S=>{r(C)&&S(L)})}var me=v(Ve,2),ce=v(d(me),2),be=v(me,2),we=v(d(be),2),Ae=v(be,2),Ce=v(d(Ae),2);mc(Ce,{get value(){return r(f)},onchange:F,showPreview:!0});var We=v(Ce,2);{var Xe=S=>{var G=Ec(),xe=d(G);U(()=>z(xe,r(I))),D(S,G)};Q(We,S=>{r(I)&&S(Xe)})}var ct=v(Ae,2),It=d(ct);{let S=W(()=>{var G;return(G=e.task)==null?void 0:G.id});ei(It,{get repository(){return e.repository},get selected(){return r(b)},get excludeId(){return r(S)},onchange:ee,label:"Blocked by (tasks that must complete first)"})}var at=v(ct,2),pe=d(at);{let S=W(()=>{var G;return(G=e.task)==null?void 0:G.id});ei(pe,{get repository(){return e.repository},get selected(){return r(O)},get excludeId(){return r(S)},onchange:te,label:"Blocks (tasks that depend on this)"})}var it=v(at,2),Pe=d(it),Xt=v(d(Pe),2),dt=d(Xt),Gt=v(Pe,2);{var Jn=S=>{var G=Dc(),xe=v(d(G),2),Zn=d(xe);U(Ps=>z(Zn,Ps),[()=>Z(e.task.lastCompletedAt)]),D(S,G)};Q(Gt,S=>{var G;(G=e.task)!=null&&G.lastCompletedAt&&S(Jn)})}var P=v(Gt,2);{var $=S=>{var G=Ac(),xe=v(d(G),2),Zn=d(xe);U(Ps=>z(Zn,Ps),[()=>Z(e.task.cancelledAt)]),D(S,G)};Q(P,S=>{var G;(G=e.task)!=null&&G.cancelledAt&&S($)})}var fe=v(P,2);{var De=S=>{var G=Cc(),xe=v(d(G),2),Zn=d(xe);U(()=>z(Zn,e.task.linkedBlockId)),D(S,G)};Q(fe,S=>{var G;(G=e.task)!=null&&G.linkedBlockId&&S(De)})}var Ge=v(R,2),je=d(Ge);je.__click=function(...S){var G;(G=e.onClose)==null||G.apply(this,S)};var ut=v(je,2);ut.__click=oe;var Mt=d(ut);U(S=>{z(E,t?"Create Task":"Edit Task"),Ie(J,"aria-invalid",!!r(M)),Ie(Qe,"aria-invalid",!!r(C)),z(dt,S),ut.disabled=r(p),z(Mt,r(p)?"Saving...":t?"Create Task":"Save Changes")},[()=>{var S;return Z((S=e.task)==null?void 0:S.createdAt)}]),pt("blur",J,()=>r(A).name=!0),gt(J,()=>r(s),S=>y(s,S)),gt(Ee,()=>r(a),S=>y(a,S)),pt("blur",Qe,()=>r(A).dueAt=!0),gt(Qe,()=>r(c),S=>y(c,S)),gt(ce,()=>r(l),S=>y(l,S)),gt(we,()=>r(u),S=>y(u,S)),D(n,de),st()}xt(["keydown","click","input"]);const Ic=[{label:"Create recurring task",description:"Open the task creation flow from the editor selection.",keys:"‚åò‚áßR",context:"Editor"},{label:"Open recurring tasks dock",description:"Focus the recurring tasks dashboard.",keys:"‚åò‚áßT",context:"Global"},{label:"Quick complete next task",description:"Marks the most overdue task as complete.",keys:"‚åò‚áßD",context:"Global"}];var Mc=q('<button class="settings__close-btn svelte-1ke3hir">‚úï</button>'),qc=q("<div> </div>"),Oc=q('<div class="settings__shortcut-context svelte-1ke3hir"> </div>'),Rc=q('<div class="settings__shortcut svelte-1ke3hir"><div class="settings__shortcut-main svelte-1ke3hir"><div class="settings__shortcut-label svelte-1ke3hir"> </div> <div class="settings__shortcut-description svelte-1ke3hir"> </div> <!></div> <div class="settings__shortcut-keys svelte-1ke3hir"> </div></div>'),Bc=q('<div class="settings svelte-1ke3hir"><div class="settings__header svelte-1ke3hir"><h2 class="settings__title svelte-1ke3hir">n8n Integration</h2> <!></div> <div class="settings__content svelte-1ke3hir"><section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">n8n Webhook</h3> <label class="settings__toggle svelte-1ke3hir"><input type="checkbox" class="svelte-1ke3hir"/> <span>Enabled</span></label></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-webhook">Webhook URL</label> <input id="n8n-webhook" class="settings__input svelte-1ke3hir" type="url" placeholder="https://your-n8n-instance.com/webhook/..."/></div> <div class="settings__field svelte-1ke3hir"><label class="settings__label svelte-1ke3hir" for="n8n-secret">Shared Secret</label> <input id="n8n-secret" class="settings__input svelte-1ke3hir" type="password" placeholder="Optional shared secret"/></div> <button class="settings__test-btn svelte-1ke3hir"> </button> <!></section> <section class="settings__section svelte-1ke3hir"><div class="settings__section-header svelte-1ke3hir"><h3 class="settings__section-title svelte-1ke3hir">Keyboard Shortcuts</h3></div> <div class="settings__shortcuts svelte-1ke3hir"></div></section></div> <div class="settings__footer svelte-1ke3hir"><button class="settings__save-btn svelte-1ke3hir">Save Settings</button></div></div>');function Nc(n,e){nt(e,!0);let t=H(he(oa)),s=H(null),a=he({});rn(()=>{y(t,e.eventService.getConfig(),!0)});async function i(){try{await e.eventService.saveConfig(r(t)),se.success("Settings saved successfully!"),e.onClose&&e.onClose()}catch(Y){se.error("Failed to save settings: "+Y)}}async function o(){y(s,"n8n"),a.n8n={success:!1,message:"Testing..."};try{const Y=await e.eventService.testConnection();a.n8n={success:Y.success,message:Y.success?"Test successful!":Y.message||"Test failed. Check configuration."}}catch(Y){a.n8n={success:!1,message:"Error: "+(Y instanceof Error?Y.message:String(Y))}}finally{y(s,null)}}var c=Bc(),l=d(c),u=v(d(l),2);{var f=Y=>{var Z=Mc();Z.__click=function(...de){var ke;(ke=e.onClose)==null||ke.apply(this,de)},D(Y,Z)};Q(u,Y=>{e.onClose&&Y(f)})}var h=v(l,2),g=d(h),b=d(g),O=v(d(b),2),A=d(O),p=v(b,2),w=v(d(p),2),M=v(p,2),C=v(d(M),2),I=v(M,2);I.__click=o;var N=d(I),F=v(I,2);{var j=Y=>{var Z=qc(),de=d(Z);U(()=>{yt(Z,1,`settings__test-result ${a.n8n.success?"success":"error"}`,"svelte-1ke3hir"),z(de,a.n8n.message)}),D(Y,Z)};Q(F,Y=>{a.n8n&&Y(j)})}var K=v(g,2),ee=v(d(K),2);Fe(ee,21,()=>Ic,Nt,(Y,Z)=>{var de=Rc(),ke=d(de),m=d(ke),_=d(m),E=v(m,2),B=d(E),R=v(E,2);{var V=le=>{var ye=Oc(),Ee=d(ye);U(()=>z(Ee,r(Z).context)),D(le,ye)};Q(R,le=>{r(Z).context&&le(V)})}var J=v(ke,2),ue=d(J);U(()=>{z(_,r(Z).label),z(B,r(Z).description),z(ue,r(Z).keys)}),D(Y,de)});var te=v(h,2),oe=d(te);oe.__click=i,U(()=>{w.disabled=!r(t).n8n.enabled,C.disabled=!r(t).n8n.enabled,I.disabled=!r(t).n8n.enabled||r(s)==="n8n",z(N,r(s)==="n8n"?"Testing...":"Test Connection")}),Po(A,()=>r(t).n8n.enabled,Y=>r(t).n8n.enabled=Y),gt(w,()=>r(t).n8n.webhookUrl,Y=>r(t).n8n.webhookUrl=Y),gt(C,()=>r(t).n8n.sharedSecret,Y=>r(t).n8n.sharedSecret=Y),D(n,c),st()}xt(["click"]);var zc=q('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),Fc=q('<div class="dashboard__overlay svelte-1y1a8hs"><!></div>'),Lc=q('<span class="dashboard__tab-badge svelte-1y1a8hs"> </span>'),Pc=q('<div class="dashboard__tabs svelte-1y1a8hs"><button>üìã Today & Overdue <!></button> <button>üìù All Tasks <span class="dashboard__tab-badge svelte-1y1a8hs"> </span></button> <button>üìÖ Timeline</button> <button>üìä Analytics</button></div> <div class="dashboard__content svelte-1y1a8hs"><!></div>',1),jc=q('<div class="dashboard svelte-1y1a8hs"><div class="dashboard__header svelte-1y1a8hs"><h1 class="dashboard__title svelte-1y1a8hs">Recurring Tasks</h1> <button class="dashboard__settings-btn svelte-1y1a8hs">‚öôÔ∏è Settings</button></div> <!></div>');function Kc(n,e){nt(e,!0);const t=e.scheduler.getTimezoneHandler(),s=e.scheduler.getRecurrenceEngine();let a=H("today"),i=H(!1),o=H(!1),c=H(void 0),l=H(he([])),u=W(()=>tl(r(l)));function f(m="initial"){y(l,e.repository.getAllTasks().map(_=>({..._})),!0),m!=="initial"&&se.info("Task list reloaded")}f();const h=()=>f("reload");Fs(()=>{window.addEventListener("recurring-task-refresh",h)}),Ko(()=>{window.removeEventListener("recurring-task-refresh",h)});async function g(m){Ze.emit("task:complete",{taskId:m.id})}async function b(m){const _=r(l),E=Xs(r(l),m.id,B=>{const R={...B},V=new Date(R.dueAt),J=t.tomorrow();return J.setHours(V.getHours(),V.getMinutes(),0,0),R.dueAt=J.toISOString(),R.snoozeCount=(R.snoozeCount||0)+1,R.updatedAt=new Date().toISOString(),R});y(l,E,!0),se.info(`Task "${m.name}" delayed to tomorrow`);try{await e.eventService.emitTaskEvent("task.snoozed",m),await e.scheduler.delayToTomorrow(m.id)}catch(B){y(l,_,!0),se.error("Failed to delay task: "+B),f("external")}}async function O(m){var E;if(!((E=m.name)!=null&&E.trim())){se.error("Task name is required");return}if(!ar(m.frequency)){se.error("Invalid frequency configuration");return}const _={...m};y(l,Ja(r(l),_),!0),y(i,!1),y(c,void 0),se.success(`Task "${m.name}" saved successfully`),e.repository.saveTask(_).catch(B=>{se.error("Failed to save task: "+B),f("external")})}async function A(m){const _=r(l);y(l,Za(r(l),m.id),!0);const E=window.setTimeout(async()=>{try{await e.repository.deleteTask(m.id)}catch(B){y(l,_,!0),se.error("Failed to delete task: "+B),f("external")}},5e3);mn({message:`Task "${m.name}" deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(E),y(l,_,!0),se.info(`Restored "${m.name}"`)},showCountdown:!0})}async function p(m){const _=m.name.endsWith(" (copy)")?`${m.name} ${new Date().toLocaleDateString()}`:`${m.name} (copy)`,E=Jo(m,{name:_});y(l,Ja(r(l),E),!0),se.success(`Duplicated "${m.name}"`),e.repository.saveTask(E).catch(B=>{y(l,Za(r(l),E.id),!0),se.error("Failed to duplicate task: "+B),f("external")})}async function w(m){const _=!m.enabled,E={...m,enabled:_},B=Xs(r(l),m.id,()=>E);y(l,B,!0),se.info(`Task ${_?"enabled":"disabled"}`),e.repository.saveTask(E).catch(R=>{se.error("Failed to update task: "+R),f("external")})}async function M(m,_){if(m.length===0)return;const E=r(l),B=new Set(m),R=r(l).map(V=>B.has(V.id)?{...V,enabled:_}:V);y(l,R,!0),se.info(`${_?"Enabled":"Disabled"} ${m.length} task${m.length===1?"":"s"}`);try{const V=R.filter(J=>B.has(J.id));await Promise.all(V.map(J=>e.repository.saveTask(J)))}catch(V){y(l,E,!0),se.error(`Failed to ${_?"enable":"disable"} tasks: ${V}`),f("external")}}async function C(m){if(m.length===0)return;const _=r(l),E=new Set(m),B=r(l).filter(V=>E.has(V.id));y(l,r(l).filter(V=>!E.has(V.id)),!0);const R=window.setTimeout(async()=>{try{await Promise.all(B.map(V=>e.repository.deleteTask(V.id)))}catch(V){y(l,_,!0),se.error("Failed to delete tasks: "+V),f("external")}},5e3);mn({message:`${B.length} task${B.length===1?"":"s"} deleted`,type:"success",duration:5e3,actionLabel:"Undo",onAction:()=>{window.clearTimeout(R),y(l,_,!0),se.info("Bulk delete undone")},showCountdown:!0})}function I(m){y(c,m,!0),y(i,!0)}function N(){y(c,void 0),y(i,!0)}function F(){y(i,!1),y(c,void 0)}function j(){y(o,!0)}function K(){y(o,!1)}async function ee(m){const _=r(l),E=Xs(r(l),m.id,B=>{const R={...B};lr(R);const V=s.calculateNext(new Date(R.dueAt),R.frequency);return R.dueAt=V.toISOString(),R});y(l,E,!0),se.info(`Task "${m.name}" skipped to next occurrence`);try{await e.eventService.emitTaskEvent("task.skipped",m),await e.scheduler.skipTaskOccurrence(m.id)}catch(B){y(l,_,!0),se.error("Failed to skip task: "+B),f("external")}}var te=jc(),oe=d(te),Y=v(d(oe),2);Y.__click=j;var Z=v(oe,2);{var de=m=>{var _=zc(),E=d(_);Nc(E,{get eventService(){return e.eventService},onClose:K}),D(m,_)},ke=m=>{var _=on(),E=kt(_);{var B=V=>{var J=Fc(),ue=d(J);vr(ue,{get task(){return r(c)},get repository(){return e.repository},onSave:O,onClose:F}),D(V,J)},R=V=>{var J=Pc(),ue=kt(J),le=d(ue);le.__click=()=>y(a,"today");var ye=v(d(le));{var Ee=ce=>{var be=Lc(),we=d(be);U(()=>z(we,r(u).length)),D(ce,be)};Q(ye,ce=>{r(u).length>0&&ce(Ee)})}var ge=v(le,2);ge.__click=()=>y(a,"all");var Oe=v(d(ge)),Te=d(Oe),Se=v(ge,2);Se.__click=()=>y(a,"timeline");var Ve=v(Se,2);Ve.__click=()=>y(a,"analytics");var Qe=v(ue,2),x=d(Qe);{var L=ce=>{Cl(ce,{get tasks(){return r(u)},onDone:g,onDelay:b,onSkip:ee,onEdit:I,get timezoneHandler(){return t}})},me=ce=>{var be=on(),we=kt(be);{var Ae=We=>{zl(We,{get tasks(){return r(l)},onEdit:I,onDelete:A,onDuplicate:p,onToggleEnabled:w,onBulkEnable:Xe=>M(Xe,!0),onBulkDisable:Xe=>M(Xe,!1),onBulkDelete:C,onCreate:N})},Ce=We=>{var Xe=on(),ct=kt(Xe);{var It=pe=>{{let it=W(()=>e.scheduler.getRecurrenceEngine());Vl(pe,{get tasks(){return r(l)},get recurrenceEngine(){return r(it)}})}},at=pe=>{var it=on(),Pe=kt(it);{var Xt=dt=>{sc(dt,{get tasks(){return r(l)}})};Q(Pe,dt=>{r(a)==="analytics"&&dt(Xt)},!0)}D(pe,it)};Q(ct,pe=>{r(a)==="timeline"?pe(It):pe(at,!1)},!0)}D(We,Xe)};Q(we,We=>{r(a)==="all"?We(Ae):We(Ce,!1)},!0)}D(ce,be)};Q(x,ce=>{r(a)==="today"?ce(L):ce(me,!1)})}U(()=>{yt(le,1,`dashboard__tab ${r(a)==="today"?"active":""}`,"svelte-1y1a8hs"),yt(ge,1,`dashboard__tab ${r(a)==="all"?"active":""}`,"svelte-1y1a8hs"),z(Te,r(l).length),yt(Se,1,`dashboard__tab ${r(a)==="timeline"?"active":""}`,"svelte-1y1a8hs"),yt(Ve,1,`dashboard__tab ${r(a)==="analytics"?"active":""}`,"svelte-1y1a8hs")}),D(V,J)};Q(E,V=>{r(i)?V(B):V(R,!1)},!0)}D(m,_)};Q(Z,m=>{r(o)?m(de):m(ke,!1)})}D(n,te),st()}xt(["click"]);var Uc=q('<div class="quick-add-card__error svelte-1q3w22"> </div>'),Hc=q('<div class="quick-add-card__error svelte-1q3w22"> </div>'),Yc=q('<div class="quick-add-card__linked svelte-1q3w22">Linked block: <span class="svelte-1q3w22"> </span></div>'),Vc=q('<button class="quick-add-card__advanced svelte-1q3w22" type="button">Advanced...</button>'),Qc=q('<div class="quick-add-overlay svelte-1q3w22" role="dialog" aria-modal="true" aria-labelledby="quick-add-title"><div class="quick-add-card svelte-1q3w22" role="document"><div class="quick-add-card__header svelte-1q3w22"><h2 id="quick-add-title" class="svelte-1q3w22">Quick Add</h2> <button class="quick-add-card__close svelte-1q3w22" type="button" aria-label="Close">‚úï</button></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-name">Task Name *</label> <input id="quick-task-name" type="text" placeholder="e.g. Review daily notes" class="svelte-1q3w22"/> <!></div> <div class="quick-add-card__field svelte-1q3w22"><label for="quick-task-due">Due *</label> <input id="quick-task-due" type="datetime-local" class="svelte-1q3w22"/> <!></div> <!> <div class="quick-add-card__actions svelte-1q3w22"><button class="quick-add-card__cancel svelte-1q3w22" type="button">Cancel</button> <!> <button class="quick-add-card__save svelte-1q3w22" type="button"> </button></div> <p class="quick-add-card__hint svelte-1q3w22">Tip: Press ‚åò/Ctrl + Enter to save.</p></div></div>');function Wc(n,e){var m;nt(e,!0);let t=H(he(((m=e.prefill)==null?void 0:m.suggestedName)??"")),s=H(he(new Date().toISOString().slice(0,16))),a=H(he({name:!1,dueAt:!1})),i=H(!1),o=H(null);const c=W(()=>r(a).name&&!r(t).trim()?"Task name is required.":""),l=W(()=>r(a).dueAt?r(s)?Number.isNaN(new Date(r(s)).getTime())?"Enter a valid date and time.":"":"Due date and time are required.":""),u=W(()=>!!(r(c)||r(l)));Fs(()=>{var _;if((_=e.prefill)!=null&&_.suggestedTime){const E=new Date,[B,R]=e.prefill.suggestedTime.split(":").map(Number);E.setHours(B,R,0,0),y(s,E.toISOString().slice(0,16),!0)}requestAnimationFrame(()=>{var E;(E=r(o))==null||E.focus()})});async function f(){var R,V;if(y(a,{name:!0,dueAt:!0},!0),r(u)){se.warning("Please fill out the required fields.");return}const _=Ho(),E=r(s).slice(11,16);if(_.time=E,!ar(_)){se.error("Invalid frequency configuration.");return}const B=rr(r(t).trim(),_,new Date(r(s)));B.linkedBlockId=((R=e.prefill)==null?void 0:R.linkedBlockId)||void 0,B.linkedBlockContent=((V=e.prefill)==null?void 0:V.linkedBlockContent)||void 0,y(i,!0);try{await e.repository.saveTask(B),se.success(`Task "${B.name}" created`),window.dispatchEvent(new CustomEvent("recurring-task-refresh")),e.onClose()}catch(J){se.error("Failed to create task: "+J)}finally{y(i,!1)}}function h(_){_.key==="Escape"&&e.onClose(),(_.metaKey||_.ctrlKey)&&_.key==="Enter"&&(_.preventDefault(),f())}var g=Qc();g.__keydown=h;var b=d(g),O=d(b),A=v(d(O),2);A.__click=function(..._){var E;(E=e.onClose)==null||E.apply(this,_)};var p=v(O,2),w=v(d(p),2);w.__input=()=>r(a).name=!0,Wn(w,_=>y(o,_),()=>r(o));var M=v(w,2);{var C=_=>{var E=Uc(),B=d(E);U(()=>z(B,r(c))),D(_,E)};Q(M,_=>{r(c)&&_(C)})}var I=v(p,2),N=v(d(I),2);N.__input=()=>r(a).dueAt=!0;var F=v(N,2);{var j=_=>{var E=Hc(),B=d(E);U(()=>z(B,r(l))),D(_,E)};Q(F,_=>{r(l)&&_(j)})}var K=v(I,2);{var ee=_=>{var E=Yc(),B=v(d(E)),R=d(B);U(()=>z(R,e.prefill.linkedBlockId)),D(_,E)};Q(K,_=>{var E;(E=e.prefill)!=null&&E.linkedBlockId&&_(ee)})}var te=v(K,2),oe=d(te);oe.__click=function(..._){var E;(E=e.onClose)==null||E.apply(this,_)};var Y=v(oe,2);{var Z=_=>{var E=Vc();E.__click=function(...B){var R;(R=e.onAdvanced)==null||R.apply(this,B)},D(_,E)};Q(Y,_=>{e.onAdvanced&&_(Z)})}var de=v(Y,2);de.__click=f;var ke=d(de);U(()=>{Ie(w,"aria-invalid",!!r(c)),Ie(N,"aria-invalid",!!r(l)),de.disabled=r(i),z(ke,r(i)?"Saving‚Ä¶":"Create Task")}),pt("blur",w,()=>r(a).name=!0),gt(w,()=>r(t),_=>y(t,_)),pt("blur",N,()=>r(a).dueAt=!0),gt(N,()=>r(s),_=>y(s,_)),D(n,g),st()}xt(["keydown","click","input"]);class Xc{constructor(e){T(this,"plugin");this.plugin=e}getCurrentVersion(){return ws}async createBackup(e){try{const t=await this.plugin.loadData(e);if(t){const s=`${e}-backup-${Date.now()}`;await this.plugin.saveData(s,t),X(`Created backup: ${s}`)}}catch(t){throw _e("Failed to create backup",t),t}}async migrate(e){try{const t=await this.plugin.loadData(e);if(!t){X("No data to migrate");return}const s=Array.isArray(t)?t:Array.isArray(t.tasks)?t.tasks:[];if(s.length===0){X("No data to migrate");return}let a=!1;for(let i=0;i<s.length;i++){const o=s[i],c=o.version||0;c<ws&&(a||(await this.createBackup(e),a=!0),s[i]=this.migrateTask(o,c),X(`Migrated task ${o.id} from v${c} to v${ws}`))}if(a){const i=Array.isArray(t)?s:{...t,tasks:s};await this.plugin.saveData(e,i),X(`Migration complete: ${s.length} tasks processed`)}else X("No migration needed - all tasks up to date")}catch(t){throw _e("Migration failed",t),t}}migrateTask(e,t){let s={...e};return t<1&&(s.version=1),t<2&&(s={...s,version:2,timezone:s.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,completionCount:s.completionCount||0,missCount:s.missCount||0,currentStreak:s.currentStreak||0,bestStreak:s.bestStreak||0,recentCompletions:s.recentCompletions||[],priority:s.priority||"normal",tags:s.tags||[],notificationChannels:s.notificationChannels||[],snoozeCount:s.snoozeCount||0,maxSnoozes:s.maxSnoozes||3}),t<3&&(s={...s,version:3,escalationPolicy:s.escalationPolicy||{enabled:!1,levels:[]},linkedBlockContent:s.linkedBlockContent||void 0,category:s.category||void 0,description:s.description||void 0}),s}}class Gc{constructor(e,t=50){T(this,"pendingState",null);T(this,"writeInProgress",!1);T(this,"scheduledTimer",null);T(this,"flushResolvers",[]);this.writer=e,this.debounceMs=t}requestSave(e){this.pendingState=e,!(this.writeInProgress||this.scheduledTimer)&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}async flush(){if(!(!this.pendingState&&!this.writeInProgress&&!this.scheduledTimer))return new Promise(e=>{this.flushResolvers.push(e),!this.writeInProgress&&!this.scheduledTimer&&this.pendingState&&this.drainQueue()})}async drainQueue(){if(!this.writeInProgress){this.writeInProgress=!0;try{for(;this.pendingState;){const e=this.pendingState;if(this.pendingState=null,!await this.writeWithRetry(e)){this.pendingState=e;break}}}finally{this.writeInProgress=!1,this.pendingState||this.resolveFlushes(),this.pendingState&&!this.scheduledTimer&&(this.scheduledTimer=setTimeout(()=>{this.scheduledTimer=null,this.drainQueue()},this.debounceMs))}}}async writeWithRetry(e){try{return await this.writer.write(e),!0}catch(t){_e("Task persistence write failed, retrying once",t)}try{return await this.writer.write(e),!0}catch(t){return _e("Task persistence write failed after retry",t),!1}}resolveFlushes(){if(this.flushResolvers.length===0)return;const e=[...this.flushResolvers];this.flushResolvers=[];for(const t of e)t()}}const ua={},Jc=Object.freeze(Object.defineProperty({__proto__:null,default:ua},Symbol.toStringTag,{value:"Module"})),ti=new Set;function Ts(n){const e=`${n.feature}:${n.capability}:${n.message}`;ti.has(e)||(ti.add(e),Ct(n.message,{feature:n.feature,capability:n.capability,cause:n.cause}))}class fr extends Error{constructor(t,s,a){super(a);T(this,"capability");T(this,"feature");this.name="SiYuanCapabilityError",this.feature=t,this.capability=s}}class hr extends Error{constructor(t,s,a,i){super(a);T(this,"capability");T(this,"feature");T(this,"cause");this.name="SiYuanApiExecutionError",this.feature=t,this.capability=s,this.cause=i}}class Zc{constructor(e=globalThis){T(this,"supportedCapabilities");T(this,"globalScope");this.globalScope=e,this.supportedCapabilities={setBlockAttrs:this.isSetBlockAttrsAvailable(),dataDir:this.isDataDirAvailable()}}isSetBlockAttrsAvailable(){var e;return typeof((e=this.globalScope)==null?void 0:e.setBlockAttrs)=="function"}isDataDirAvailable(){var e,t,s,a;return typeof((a=(s=(t=(e=this.globalScope)==null?void 0:e.siyuan)==null?void 0:t.config)==null?void 0:s.system)==null?void 0:a.dataDir)=="string"}getDataDir(){var e,t,s;return this.isDataDirAvailable()?((s=(t=(e=this.globalScope.siyuan)==null?void 0:e.config)==null?void 0:t.system)==null?void 0:s.dataDir)??null:null}async setBlockAttrs(e,t){const s=this.getSetBlockAttrs();try{await s(e,t)}catch(a){throw new hr("Block attribute sync","setBlockAttrs","Failed to sync block attributes via SiYuan API.",a)}}getSetBlockAttrs(){if(!this.isSetBlockAttrsAvailable())throw new fr("Block attribute sync","setBlockAttrs","Block attribute sync unavailable in this SiYuan version. Tasks will continue without block sync.");return this.globalScope.setBlockAttrs}}const $c=".tmp";class ed{constructor(e,t){T(this,"plugin");T(this,"apiAdapter");T(this,"fsPromises");this.plugin=e,this.apiAdapter=t}async loadActive(){try{const e=await this.plugin.loadData(_n);if(e&&Array.isArray(e.tasks))return new Map(e.tasks.map(t=>[t.id,t]))}catch(e){_e("Failed to load active tasks",e)}return new Map}async saveActive(e){await this.write({tasks:Array.from(e.values())})}async write(e){try{await this.saveActiveAtomic(e),X(`Saved ${e.tasks.length} active tasks`)}catch(t){throw _e("Failed to save active tasks",t),t}}async saveActiveAtomic(e){const t=await this.getFsPromises();if(!t){await this.plugin.saveData(_n,e);return}const s=this.resolveStoragePath(_n);if(!s){await this.plugin.saveData(_n,e);return}const a=ua.dirname(s);await t.mkdir(a,{recursive:!0});const i=`${s}${$c}`,o=JSON.stringify(e),c=await t.open(i,"w");try{await c.writeFile(o,"utf8"),await c.sync()}finally{await c.close()}try{await t.rename(i,s)}catch{await t.rm(s,{force:!0}),await t.rename(i,s)}}async getFsPromises(){if(this.fsPromises!==void 0)return this.fsPromises;try{const e=await Promise.resolve().then(()=>Jc);return this.fsPromises=e.promises,this.fsPromises}catch(e){return Ct("Node.js fs unavailable; falling back to plugin storage without atomic writes.",e),this.fsPromises=null,null}}resolveStoragePath(e){const t=this.apiAdapter.getDataDir(),s=this.plugin.name;return!t||!s?(t||Ts({feature:"Atomic task storage",capability:"dataDir",message:"SiYuan dataDir unavailable; falling back to plugin storage without atomic writes."}),null):ua.join(t,"storage",`p${s}`,`${e}.json`)}}const ni=1,si=1e3;class td{constructor(e){T(this,"plugin");this.plugin=e}async archiveTask(e){await this.archiveTasks([e])}async archiveTasks(e){if(e.length===0)return;const t=await this.loadIndex(),s=this.groupByYear(e);for(const[a,i]of s.entries())await this.appendTasksToYear(t,a,i);await this.saveIndex(t)}async loadArchive(e){const t=await this.loadIndex();if(t.chunks.length===0)return[];const s=this.filterChunks(t.chunks,e),a=[];for(const c of s){const l=await this.loadChunk(c.key);if(l)for(const u of l.tasks)this.matchesQuery(u,e)&&a.push(u)}const i=(e==null?void 0:e.offset)??0,o=(e==null?void 0:e.limit)??a.length;return a.slice(i,i+o)}async loadIndex(){try{const e=await this.plugin.loadData(ys);if(e&&typeof e=="object"&&Array.isArray(e.chunks))return{version:e.version??ni,totalCount:e.totalCount??0,chunks:e.chunks}}catch(e){_e("Failed to load archive index",e)}return{version:ni,totalCount:0,chunks:[]}}async saveIndex(e){try{await this.plugin.saveData(ys,e)}catch(t){throw _e("Failed to save archive index",t),t}}buildChunkKey(e,t){return`${ys}-${e}-${t}`}async loadChunk(e){try{const t=await this.plugin.loadData(e);if(t&&Array.isArray(t.tasks))return t}catch(t){_e("Failed to load archive chunk",{key:e,err:t})}return null}async saveChunk(e,t){try{await this.plugin.saveData(e,t)}catch(s){throw _e("Failed to save archive chunk",{key:e,err:s}),s}}groupByYear(e){const t=new Map;for(const s of e){const a=this.getCompletionTimestamp(s),i=new Date(a).getFullYear(),o=t.get(i);o?o.push(s):t.set(i,[s])}return t}async appendTasksToYear(e,t,s){let a=[...s];for(;a.length>0;){const i=this.findOrCreateChunk(e,t),o=await this.loadChunk(i.key)||{tasks:[]},c=si-o.tasks.length,l=a.slice(0,c);o.tasks.push(...l),a=a.slice(l.length);const u=this.updateChunkMeta(i,l);i.count=u.count,i.start=u.start,i.end=u.end,await this.saveChunk(i.key,o),e.totalCount+=l.length}}findOrCreateChunk(e,t){const a=e.chunks.filter(c=>c.year===t).sort((c,l)=>c.sequence-l.sequence).at(-1);if(a&&a.count<si)return a;const i=a?a.sequence+1:1,o={key:this.buildChunkKey(t,i),year:t,sequence:i,count:0};return e.chunks.push(o),o}updateChunkMeta(e,t){let s=e.start,a=e.end;for(const i of t){const o=this.getCompletionTimestamp(i);(!s||o<s)&&(s=o),(!a||o>a)&&(a=o)}return{...e,count:e.count+t.length,start:s,end:a}}filterChunks(e,t){if(!(t!=null&&t.from)&&!(t!=null&&t.to))return e;const s=t!=null&&t.from?new Date(t.from).getTime():null,a=t!=null&&t.to?new Date(t.to).getTime():null;return e.filter(i=>{const o=i.start?new Date(i.start).getTime():null,c=i.end?new Date(i.end).getTime():null;return!(s&&c&&c<s||a&&o&&o>a)})}matchesQuery(e,t){if(!t)return!0;if(t.taskId&&e.id!==t.taskId)return!1;const s=this.getCompletionTimestamp(e),a=new Date(s).getTime();return!(t.from&&a<new Date(t.from).getTime()||t.to&&a>new Date(t.to).getTime())}getCompletionTimestamp(e){return e.lastCompletedAt||e.updatedAt||e.dueAt}}class nd{constructor(e,t=new Zc){T(this,"plugin");T(this,"activeTasks");T(this,"blockIndex",new Map);T(this,"taskBlockIndex",new Map);T(this,"dueIndex",new Map);T(this,"activeStore");T(this,"archiveStore");T(this,"persistence");T(this,"blockAttrSyncEnabled",!0);T(this,"blockApi");T(this,"apiAdapter");this.plugin=e,this.activeTasks=new Map,this.apiAdapter=t,this.blockApi=t,this.activeStore=new ed(e,t),this.archiveStore=new td(e),this.persistence=new Gc(this.activeStore)}async init(){await this.migrateLegacyStorage(),this.activeTasks=await this.activeStore.loadActive(),X(`Loaded ${this.activeTasks.size} active tasks from storage`),this.rebuildBlockIndex(),this.rebuildDueIndex()}rebuildBlockIndex(){this.blockIndex.clear(),this.taskBlockIndex.clear();for(const e of this.activeTasks.values())e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId));X(`Rebuilt block index with ${this.blockIndex.size} entries`)}rebuildDueIndex(){this.dueIndex.clear();for(const e of this.activeTasks.values())e.enabled&&this.addToDueIndex(e);X(`Rebuilt due index with ${this.dueIndex.size} date entries`)}addToDueIndex(e){const t=e.dueAt.slice(0,10);this.dueIndex.has(t)||this.dueIndex.set(t,new Set),this.dueIndex.get(t).add(e.id)}removeFromDueIndex(e){const t=e.dueAt.slice(0,10),s=this.dueIndex.get(t);s&&(s.delete(e.id),s.size===0&&this.dueIndex.delete(t))}getTasksDueOn(e){const t=e.toISOString().slice(0,10);return this.getTasksForDueKey(t)}getTasksDueOnOrBefore(e){const t=e.toISOString().slice(0,10),s=[];for(const[a]of this.dueIndex)a<=t&&s.push(...this.getTasksForDueKey(a));return s}getTasksForDueKey(e){const t=this.dueIndex.get(e);if(!t)return[];const s=[];for(const a of t){const i=this.activeTasks.get(a);if(!i){this.removeStaleDueIndexEntry(e,a,"missing task");continue}if(!i.enabled){this.removeStaleDueIndexEntry(e,a,"task disabled");continue}if(i.dueAt.slice(0,10)!==e){this.removeStaleDueIndexEntry(e,a,"date mismatch");continue}s.push(i)}return s}removeStaleDueIndexEntry(e,t,s){const a=this.dueIndex.get(e);a&&(a.delete(t),a.size===0&&this.dueIndex.delete(e),Ct("Removed stale due index entry",{taskId:t,dateKey:e,reason:s}))}async save(){this.persistence.requestSave({tasks:Array.from(this.activeTasks.values())})}async flush(){await this.persistence.flush()}getAllTasks(){return Array.from(this.activeTasks.values())}getTask(e){return this.activeTasks.get(e)}getTaskByBlockId(e){const t=this.blockIndex.get(e);return t?this.activeTasks.get(t):void 0}async saveTask(e){const t=this.activeTasks.get(e.id),s=this.taskBlockIndex.get(e.id);s&&s!==e.linkedBlockId&&(this.blockIndex.delete(s),this.taskBlockIndex.delete(e.id)),t&&t.enabled&&(t.dueAt!==e.dueAt||!e.enabled)&&this.removeFromDueIndex(t),e.linkedBlockId&&(this.blockIndex.set(e.linkedBlockId,e.id),this.taskBlockIndex.set(e.id,e.linkedBlockId)),e.enabled&&this.addToDueIndex(e),e.updatedAt=new Date().toISOString(),this.activeTasks.set(e.id,e),await this.save(),e.linkedBlockId&&await this.syncTaskToBlockAttrs(e),s&&s!==e.linkedBlockId&&await this.clearBlockAttrs(s)}async syncTaskToBlockAttrs(e){e.linkedBlockId&&await this.updateBlockAttrs(e.linkedBlockId,{[Wa]:e.id,[Xa]:e.dueAt,[Ga]:e.enabled?"true":"false"})}async clearBlockAttrs(e){await this.updateBlockAttrs(e,{[Wa]:"",[Xa]:"",[Ga]:""})}async updateBlockAttrs(e,t){if(this.blockAttrSyncEnabled){if(!this.apiAdapter.supportedCapabilities.setBlockAttrs){Ts({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Block attribute sync unavailable in current SiYuan version. Tasks will continue to function without block sync."}),this.blockAttrSyncEnabled=!1;return}try{await this.blockApi.setBlockAttrs(e,t)}catch(s){s instanceof fr||s instanceof hr?Ts({feature:s.feature,capability:s.capability,message:s.message,cause:s.cause}):Ts({feature:"Block attribute sync",capability:"setBlockAttrs",message:"Unexpected error while syncing block attributes. Block sync disabled to keep tasks stable.",cause:s}),this.blockAttrSyncEnabled=!1}}}async deleteTask(e){const t=this.activeTasks.get(e);t!=null&&t.linkedBlockId&&(this.blockIndex.delete(t.linkedBlockId),await this.clearBlockAttrs(t.linkedBlockId)),this.taskBlockIndex.delete(e),t&&this.removeFromDueIndex(t),this.activeTasks.delete(e),await this.save()}getEnabledTasks(){return this.getAllTasks().filter(e=>e.enabled)}getTodayAndOverdueTasks(){const e=new Date,t=new Date(e);return t.setHours(23,59,59,999),this.getEnabledTasks().filter(s=>new Date(s.dueAt)<=t)}getTasksInRange(e,t){return this.getEnabledTasks().filter(s=>{const a=new Date(s.dueAt);return a>=e&&a<=t})}async clearAll(){this.activeTasks.clear(),await this.save()}async loadActive(){return this.activeStore.loadActive()}async saveActive(e){this.persistence.requestSave({tasks:Array.from(e.values())})}async archiveTask(e){await this.archiveStore.archiveTask(e)}async loadArchive(e){return this.archiveStore.loadArchive(e)}async migrateLegacyStorage(){const e=await this.plugin.loadData(_n);if(e&&Array.isArray(e.tasks))return;const t=await this.plugin.loadData(za);if(!t)return;const s=Array.isArray(t.tasks)?t.tasks:Array.isArray(t)?t:[];if(s.length===0)return;await this.plugin.saveData(Fa,t),X(`Created legacy backup at ${Fa}`);const a=s.filter(c=>!c.enabled&&c.lastCompletedAt),i=s.filter(c=>!a.includes(c)),o=new Map(i.map(c=>[c.id,c]));this.persistence.requestSave({tasks:Array.from(o.values())}),await this.persistence.flush(),a.length>0&&await this.archiveStore.archiveTasks(a),X("Legacy storage migration complete",{activeCount:i.length,archivedCount:a.length,legacyKey:za,activeKey:_n,archiveIndexKey:ys})}}class sd{constructor(e){this.storage=e}getAllTasks(){return this.storage.getAllTasks()}getTask(e){return this.storage.getTask(e)}getTaskByBlockId(e){return this.storage.getTaskByBlockId(e)}getEnabledTasks(){return this.storage.getEnabledTasks()}getTasksDueOnOrBefore(e){return this.storage.getTasksDueOnOrBefore(e)}getTodayAndOverdueTasks(){return this.storage.getTodayAndOverdueTasks()}getTasksInRange(e,t){return this.storage.getTasksInRange(e,t)}async saveTask(e){await this.storage.saveTask(e)}async deleteTask(e){await this.storage.deleteTask(e)}async archiveTask(e){await this.storage.archiveTask(e)}async loadArchive(e){return this.storage.loadArchive(e)}async flush(){await this.storage.flush()}}class ad{normalizeInterval(e){return!Number.isFinite(e)||e<1?1:Math.floor(e)}normalizeWeekdays(e){if(!Array.isArray(e))return[];const t=new Set;for(const s of e)Number.isFinite(s)&&s>=0&&s<=6&&t.add(Math.floor(s));return Array.from(t).sort((s,a)=>s-a)}normalizeDayOfMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,1),31)}normalizeMonth(e,t){const s=Number.isFinite(e)?Math.floor(e):t;return Math.min(Math.max(s,0),11)}calculateNext(e,t){const{type:s,time:a}=t,i=this.normalizeInterval(t.interval);let o;switch(s){case"daily":o=this.calculateNextDaily(e,i);break;case"weekly":o=this.calculateNextWeekly(e,i,this.normalizeWeekdays(t.weekdays));break;case"monthly":o=this.calculateNextMonthly(e,i,this.normalizeDayOfMonth(t.dayOfMonth,e.getDate()));break;case"yearly":o=this.calculateNextYearly(e,i,this.normalizeMonth(t.month,e.getMonth()),this.normalizeDayOfMonth(t.dayOfMonth,e.getDate()));break;default:throw new Error(`Unknown frequency type: ${s}`)}if(a){const{hours:c,minutes:l}=ur(a);if(Number.isFinite(c)&&Number.isFinite(l)){const{date:u,shifted:f}=cl(o,c,l);f&&Ct("DST shift detected while applying recurrence time",{requestedTime:a,original:o.toISOString(),adjusted:u.toISOString()}),o=u}}return o}calculateNextDaily(e,t){return ls(e,t)}calculateNextWeekly(e,t,s){if(!s||s.length===0)return $a(e,t);const a=this.getMondayIndex(e),i=Math.min(Ws,t*14);for(let o=1;o<=i;o++){if(Math.floor((a+o)/7)%t!==0)continue;const l=ls(e,o),u=this.getMondayIndex(l);if(s.includes(u))return l}return Ct("Weekly recurrence guard hit, falling back to interval weeks.",{currentDue:e.toISOString(),interval:t,weekdays:s}),$a(e,t)}getMondayIndex(e){return(e.getDay()+6)%7}calculateNextMonthly(e,t,s){const a=s??e.getDate(),i=e.getFullYear(),c=e.getMonth()+t,l=i+Math.floor(c/12),u=(c%12+12)%12,f=new Date(l,u+1,0).getDate(),h=Math.min(a,f),g=new Date(e);return g.setFullYear(l,u,h),g}calculateNextYearly(e,t,s,a){const i=a??e.getDate(),o=e.getFullYear()+t,c=new Date(o,s+1,0).getDate(),l=Math.min(i,c),u=new Date(e);return u.setFullYear(o,s,l),u}getOccurrencesInRange(e,t,s,a){const i=[];let o=new Date(a),c=0;for(;o<=t&&c<Ws;)o>=e&&i.push(new Date(o)),o=this.calculateNext(o,s),c++;return i}getMissedOccurrences(e,t,s,a){const i=[];let o=new Date(a),c=0;for(;o<=e&&c<Ws;)o=this.calculateNext(o,s),c++;let l=0;for(;o<t&&l<bs;)i.push(new Date(o)),o=this.calculateNext(o,s),l++;return l>=bs&&Ct("Recovery iteration cap hit while computing missed occurrences",{lastCheckedAt:e.toISOString(),now:t.toISOString(),frequency:s,firstOccurrence:a.toISOString(),cap:bs}),i}}class id{getTimezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone}toLocal(e){return new Date(e)}createLocalDateTime(e,t){const{hours:s,minutes:a}=ur(t);if(!Number.isFinite(s)||!Number.isFinite(a))return new Date(e);const i=new Date(e);return i.setHours(s,a,0,0),i}isSameLocalDay(e,t){const s=new Date(e),a=new Date(t);return s.getFullYear()===a.getFullYear()&&s.getMonth()===a.getMonth()&&s.getDate()===a.getDate()}startOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(0,0,0,0),t}endOfLocalDay(e){const t=e?new Date(e):new Date;return t.setHours(23,59,59,999),t}formatLocal(e){return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatLocalTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}formatLocalDate(e){return e.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}getRelativeTime(e){const t=new Date,s=e.getTime()-t.getTime(),a=Math.trunc(s/(1e3*60)),i=Math.trunc(s/(1e3*60*60)),o=Math.trunc(s/(1e3*60*60*24));return Math.abs(s)<1e3*60?"now":Math.abs(a)<60?a>0?`in ${a}m`:`${-a}m ago`:Math.abs(i)<24?i>0?`in ${i}h`:`${-i}h ago`:o>0?`in ${o}d`:`${-o}d ago`}isToday(e){return this.isSameLocalDay(e,new Date)}isPast(e){return e<new Date}isOverdue(e){return this.isPast(e)&&!this.isToday(e)}addDays(e,t){const s=new Date(e);return s.setDate(s.getDate()+t),s}tomorrow(){return this.addDays(new Date,1)}nextWeek(){return this.addDays(new Date,7)}}class rd{constructor(e,t){T(this,"intervalMs");T(this,"timeoutId",null);T(this,"isRunning",!1);this.onTick=t,this.intervalMs=e}start(){this.isRunning||(this.isRunning=!0,this.scheduleNextTick())}stop(){this.timeoutId!==null&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=null),this.isRunning=!1}setInterval(e){this.intervalMs=e}isActive(){return this.isRunning}scheduleNextTick(){if(!this.isRunning)return;const e=Date.now(),t=this.intervalMs>0?this.intervalMs:ir,s=t-e%t;this.timeoutId=globalThis.setTimeout(()=>{this.onTick(),this.scheduleNextTick()},s)}}class od{constructor(e,t=SCHEDULER_INTERVAL_MS,s){T(this,"storage");T(this,"recurrenceEngine");T(this,"emittedDue",new Set);T(this,"emittedMissed",new Set);T(this,"timezoneHandler");T(this,"isChecking",!1);T(this,"lastCheckStartTime",0);T(this,"plugin",null);T(this,"listeners",{"task:due":new Set,"task:overdue":new Set});T(this,"MAX_EMITTED_ENTRIES",1e3);T(this,"EMITTED_SAVE_DEBOUNCE_MS",1500);T(this,"persistTimeoutId",null);T(this,"emittedStateReady",null);T(this,"timer");this.storage=e,this.recurrenceEngine=new ad,this.timezoneHandler=new id,this.plugin=s||null,this.timer=new rd(t,()=>{this.checkDueTasks()})}on(e,t){return this.listeners[e].add(t),()=>this.listeners[e].delete(t)}start(){this.ensureEmittedStateLoaded().finally(()=>{this.checkDueTasks(),this.timer.start(),X("Scheduler started")})}stop(){this.timer.stop(),this.persistEmittedState(),X("Scheduler stopped")}runOnce(){this.checkDueTasks()}isActive(e){return e.enabled===!0}checkDueTasks(){if(this.isChecking)if(Date.now()-(this.lastCheckStartTime||0)>3e4)Ct("Scheduler check timeout detected, forcing reset"),this.isChecking=!1;else return;this.isChecking=!0,this.lastCheckStartTime=Date.now();const e=new Date,t=this.storage.getTasksDueOnOrBefore(e);try{for(const s of t){if(!this.isActive(s))continue;const a=new Date(s.dueAt),i=a<=e;if(i){const c=this.buildOccurrenceKey(s.id,a,"hour");this.emittedDue.has(c)||(this.emitEvent("task:due",{taskId:s.id,dueAt:a,context:"today",task:s}),this.registerEmittedKey("due",c),X(`Task due: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}const o=s.lastCompletedAt?new Date(s.lastCompletedAt):null;if(i&&e.getTime()-a.getTime()>=Wo&&(!o||o<a)){const c=this.buildOccurrenceKey(s.id,a,"hour");this.emittedMissed.has(c)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:a,context:"overdue",task:s}),this.registerEmittedKey("missed",c),Ct(`Task missed: ${s.name}`,{taskId:s.id,dueAt:s.dueAt}))}}this.cleanupEmittedSets()}finally{this.isChecking=!1}}cleanupEmittedSets(){let e=!1;if(this.emittedDue.size>this.MAX_EMITTED_ENTRIES){const t=Array.from(this.emittedDue);this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES/2)),e=!0,X(`Cleaned up emittedDue set: ${t.length} -> ${this.emittedDue.size}`)}if(this.emittedMissed.size>this.MAX_EMITTED_ENTRIES){const t=Array.from(this.emittedMissed);this.emittedMissed=new Set(t.slice(-this.MAX_EMITTED_ENTRIES/2)),e=!0,X(`Cleaned up emittedMissed set: ${t.length} -> ${this.emittedMissed.size}`)}e&&this.schedulePersistEmittedState()}async markTaskDone(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);Zo(t);const s=JSON.parse(JSON.stringify(t));await this.storage.archiveTask(s);const a=new Date(t.dueAt),i=this.recurrenceEngine.calculateNext(a,t.frequency);t.dueAt=i.toISOString(),await this.storage.saveTask(t),X(`Task "${t.name}" completed and rescheduled to ${i.toISOString()}`)}async delayTask(e,t){const s=this.storage.getTask(e);if(!s)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(s);const a=new Date(s.dueAt),i=new Date(a.getTime()+t*60*1e3);s.dueAt=i.toISOString(),s.snoozeCount=(s.snoozeCount||0)+1,await this.storage.saveTask(s),X(`Task "${s.name}" delayed by ${t} minutes to ${i.toISOString()}`)}async delayToTomorrow(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);this.assertSnoozeAvailable(t);const s=new Date(t.dueAt),a=this.timezoneHandler.tomorrow();a.setHours(s.getHours(),s.getMinutes(),0,0),t.dueAt=a.toISOString(),t.snoozeCount=(t.snoozeCount||0)+1,await this.storage.saveTask(t),X(`Task "${t.name}" delayed to tomorrow: ${a.toISOString()}`)}async skipOccurrence(e){const t=this.storage.getTask(e);if(!t)throw new Error(`Task not found: ${e}`);lr(t);const s=new Date(t.dueAt),a=this.recurrenceEngine.calculateNext(s,t.frequency);t.dueAt=a.toISOString(),await this.storage.saveTask(t),X(`Task "${t.name}" skipped to ${a.toISOString()}`)}async delayTaskToTomorrow(e){return this.delayToTomorrow(e)}async skipTaskOccurrence(e){return this.skipOccurrence(e)}async recoverMissedTasks(){await this.ensureEmittedStateLoaded();const e=await this.loadLastRunTimestamp(),t=new Date;if(!e){await this.saveLastRunTimestamp(t),X("First run detected, no recovery needed");return}X(`Recovering missed tasks since ${e.toISOString()}`);for(const s of this.storage.getEnabledTasks())try{const a=this.recurrenceEngine.getMissedOccurrences(e,t,s.frequency,new Date(s.createdAt));for(const i of a){const o=this.buildOccurrenceKey(s.id,i,"exact");this.emittedMissed.has(o)||(this.emitEvent("task:overdue",{taskId:s.id,dueAt:i,context:"overdue",task:s}),this.registerEmittedKey("missed",o))}await this.advanceToNextFutureOccurrence(s,t)}catch(a){_e(`Failed to recover task ${s.id}:`,a)}await this.saveLastRunTimestamp(t),this.cleanupEmittedSets(),X("Missed task recovery completed")}async advanceToNextFutureOccurrence(e,t){const s=new Date(e.dueAt);if(s>=t)return;let a=s,i=0;for(;a<t&&i<bs;)a=this.recurrenceEngine.calculateNext(a,e.frequency),i++;a>s&&(e.dueAt=a.toISOString(),await this.storage.saveTask(e),X(`Advanced task "${e.name}" to ${a.toISOString()}`))}async loadLastRunTimestamp(){if(!this.plugin)return null;try{const e=await this.plugin.loadData(Qa);if(e&&e.timestamp)return new Date(e.timestamp)}catch(e){_e("Failed to load last run timestamp:",e)}return null}async saveLastRunTimestamp(e){if(this.plugin)try{await this.plugin.saveData(Qa,{timestamp:e.toISOString()})}catch(t){_e("Failed to save last run timestamp:",t)}}getRecurrenceEngine(){return this.recurrenceEngine}getTimezoneHandler(){return this.timezoneHandler}emitEvent(e,t){const s=this.listeners[e];for(const a of s)try{const i=a(t);i instanceof Promise&&i.catch(o=>{_e(`Scheduler listener error for ${e}:`,o)})}catch(i){_e(`Scheduler listener error for ${e}:`,i)}}assertSnoozeAvailable(e){const t=e.maxSnoozes??Xo,s=e.snoozeCount??0;if(t<=0)throw new Error("Snoozing is disabled for this task.");if(s>=t)throw new Error(`Snooze limit reached (${t}).`)}registerEmittedKey(e,t){e==="due"?this.emittedDue.add(t):this.emittedMissed.add(t),this.schedulePersistEmittedState()}ensureEmittedStateLoaded(){return this.emittedStateReady||(this.emittedStateReady=this.restoreEmittedState()),this.emittedStateReady}async restoreEmittedState(){if(this.plugin)try{const e=await this.plugin.loadData(ja),t=Array.isArray(e==null?void 0:e.due)?e.due.filter(a=>typeof a=="string"):[],s=Array.isArray(e==null?void 0:e.missed)?e.missed.filter(a=>typeof a=="string"):[];this.emittedDue=new Set(t.slice(-this.MAX_EMITTED_ENTRIES)),this.emittedMissed=new Set(s.slice(-this.MAX_EMITTED_ENTRIES)),X("Restored scheduler emitted state",{due:this.emittedDue.size,missed:this.emittedMissed.size})}catch(e){_e("Failed to restore scheduler emitted state:",e)}}schedulePersistEmittedState(){this.plugin&&this.persistTimeoutId===null&&(this.persistTimeoutId=globalThis.setTimeout(()=>{this.persistTimeoutId=null,this.persistEmittedState()},this.EMITTED_SAVE_DEBOUNCE_MS))}async persistEmittedState(){if(this.plugin)try{await this.plugin.saveData(ja,{due:Array.from(this.emittedDue),missed:Array.from(this.emittedMissed)})}catch(e){_e("Failed to persist scheduler emitted state:",e)}}buildOccurrenceKey(e,t,s){return s==="exact"?`${e}:${t.toISOString()}`:`${e}:${t.toISOString().slice(0,13)}`}}const ld=7,cd=2e3;class dd{constructor(e,t){T(this,"plugin");T(this,"storageKey");T(this,"notifications",new Map);T(this,"escalations",new Map);T(this,"lastCleanup",new Date);T(this,"isDirty",!1);this.plugin=e,this.storageKey=t}async load(){try{const e=await this.plugin.loadData(this.storageKey);if(e){const t=e;if(Array.isArray(t.notifications))for(const s of t.notifications)this.notifications.set(s.taskKey,s);if(Array.isArray(t.escalations))for(const s of t.escalations)this.escalations.set(s.taskId,s);t.lastCleanup&&(this.lastCleanup=new Date(t.lastCleanup)),X(`Loaded notification state: ${this.notifications.size} notifications, ${this.escalations.size} escalations`),this.cleanupOldEntries()}}catch(e){_e("Failed to load notification state",e),this.notifications.clear(),this.escalations.clear()}}async save(){if(this.isDirty)try{const e={notifications:Array.from(this.notifications.values()),escalations:Array.from(this.escalations.values()),lastCleanup:this.lastCleanup.toISOString()};await this.plugin.saveData(this.storageKey,e),this.isDirty=!1,dr("Saved notification state")}catch(e){_e("Failed to save notification state",e)}}async forceSave(){this.isDirty=!0,await this.save()}hasNotified(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="due"}markNotified(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"due"}),this.isDirty=!0,this.notifications.size>cd&&Array.from(this.notifications.keys()).slice(0,100).forEach(s=>this.notifications.delete(s))}hasMissed(e){const t=this.notifications.get(e);return t!==void 0&&t.type==="missed"}markMissed(e){this.notifications.set(e,{taskKey:e,notifiedAt:new Date().toISOString(),type:"missed"}),this.isDirty=!0}getEscalationLevel(e){const t=this.escalations.get(e);return(t==null?void 0:t.level)||0}incrementEscalation(e){const s=this.getEscalationLevel(e)+1;return this.escalations.set(e,{taskId:e,level:s,lastEscalatedAt:new Date().toISOString()}),this.isDirty=!0,s}resetEscalation(e){this.escalations.delete(e),this.isDirty=!0}generateTaskKey(e,t){const s=new Date(t);return`${e}:${s.toISOString().slice(0,13)}`}cleanupOldEntries(){const e=new Date;if((e.getTime()-this.lastCleanup.getTime())/(1e3*60*60*24)<1)return;const s=new Date(e.getTime()-ld*24*60*60*1e3);let a=0;for(const[i,o]of this.notifications.entries())new Date(o.notifiedAt)<s&&(this.notifications.delete(i),a++);a>0&&(X(`Cleaned up ${a} old notification records`),this.isDirty=!0),this.lastCleanup=e}}function ud(n){return{id:n.id,name:n.name,dueAt:n.dueAt,frequency:n.frequency,linkedBlockId:n.linkedBlockId,linkedBlockContent:n.linkedBlockContent,priority:n.priority,tags:n.tags,notificationChannels:n.notificationChannels,completionCount:n.completionCount,missCount:n.missCount,currentStreak:n.currentStreak,bestStreak:n.bestStreak}}const vd=30*1e3,fd=30*60*1e3,fn=500;class hd{constructor(e,t={}){T(this,"plugin");T(this,"config");T(this,"queue",[]);T(this,"dedupeKeys",new Set);T(this,"flushIntervalId",null);T(this,"fetcher");T(this,"notificationState");T(this,"schedulerUnsubscribe",[]);this.plugin=e,this.fetcher=t.fetcher??fetch,this.config={...oa},this.notificationState=t.notificationState??new dd(this.plugin,Yo)}async init(){await this.notificationState.load(),await this.loadConfig(),await this.loadQueue(),await this.flushQueueOnStartup(),this.startQueueWorker()}async flushQueueOnStartup(){this.queue.length>0&&(console.log(`Found ${this.queue.length} pending events from previous session`),await this.flushQueue())}async loadConfig(){try{const e=await this.plugin.loadData(La);e&&(this.config={...oa,...e})}catch(e){console.error("Failed to load event config:",e)}}async saveConfig(e){this.config=e,await this.plugin.saveData(La,e)}async loadQueue(){try{const e=await this.plugin.loadData(Pa);if(e){this.queue=Array.isArray(e.queue)?e.queue:[];const t=Array.isArray(e.dedupeKeys)?e.dedupeKeys:[];if(this.dedupeKeys=new Set(t),this.queue.length>fn){const s=this.queue.length-fn;this.queue=this.queue.slice(-fn),console.warn(`Event queue trimmed to ${fn} entries (dropped ${s}).`)}}}catch(e){console.error("Failed to load event queue:",e),this.queue=[],this.dedupeKeys=new Set}}async persistQueue(){const e=Array.from(this.dedupeKeys).slice(-Qs);await this.plugin.saveData(Pa,{queue:this.queue,dedupeKeys:e})}startQueueWorker(){this.flushIntervalId===null&&(this.flushQueue(),this.flushIntervalId=globalThis.setInterval(()=>{this.flushQueue()},Qo))}stopQueueWorker(){this.flushIntervalId!==null&&(globalThis.clearInterval(this.flushIntervalId),this.flushIntervalId=null)}async shutdown(){this.stopQueueWorker(),await this.notificationState.forceSave()}bindScheduler(e){this.unbindScheduler(),this.schedulerUnsubscribe=[e.on("task:due",t=>{this.handleTaskDue(t)}),e.on("task:overdue",t=>{this.handleTaskOverdue(t)})]}unbindScheduler(){this.schedulerUnsubscribe.forEach(e=>e()),this.schedulerUnsubscribe=[]}async handleTaskCompleted(e){await this.emitTaskEvent("task.completed",e,0),this.notificationState.resetEscalation(e.id),await this.notificationState.save()}async handleTaskSnoozed(e){await this.emitTaskEvent("task.snoozed",e,0)}async handleTaskDue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasNotified(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.due",e.task,s),this.notificationState.markNotified(t),this.notificationState.save()}async handleTaskOverdue(e){const t=this.notificationState.generateTaskKey(e.taskId,e.dueAt.toISOString());if(this.notificationState.hasMissed(t))return;const s=this.notificationState.getEscalationLevel(e.taskId);await this.emitTaskEvent("task.missed",e.task,s),this.notificationState.markMissed(t),this.notificationState.incrementEscalation(e.taskId),this.notificationState.save()}async emitTaskEvent(e,t,s=0){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const a=this.buildDedupeKey(e,t);if(this.isDuplicate(a))return;const i=this.buildPayload(e,t,a,1,s);await this.sendPayload(i)?(this.markDelivered(a),await this.persistQueue()):this.enqueue(i)}async testConnection(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return{success:!1,message:"n8n webhook not configured"};try{const e=`test.ping:${new Date().toISOString()}`,t={event:"test.ping",source:Ka,version:Ua,occurredAt:new Date().toISOString(),delivery:{dedupeKey:e,attempt:1}},s=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:await this.buildHeaders(t),body:JSON.stringify(t)});return s.ok?{success:!0,message:"Connection successful"}:{success:!1,message:`HTTP ${s.status}: ${s.statusText}`}}catch(e){return{success:!1,message:`Connection failed: ${e.message}`}}}async flushQueue(){if(!this.config.n8n.enabled||!this.config.n8n.webhookUrl)return;const e=Date.now();let t=!1;const s=[];for(const a of this.queue){if(new Date(a.nextAttemptAt).getTime()>e){s.push(a);continue}const i={...a.payload,delivery:{...a.payload.delivery,attempt:a.attempt}};if(await this.sendPayload(i))this.markDelivered(i.delivery.dedupeKey),t=!0;else{const c=a.attempt+1,l=this.getRetryDelay(c);s.push({...a,attempt:c,nextAttemptAt:new Date(e+l).toISOString()}),t=!0}}t&&(this.queue=s,await this.persistQueue())}getConfig(){return{...this.config}}buildPayload(e,t,s,a,i=0){const o=new Date,c=new Date(t.dueAt),l=o.getTime()-c.getTime();return{event:e,source:Ka,version:Ua,occurredAt:o.toISOString(),task:ud(t),context:{timezone:t.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,delayMs:l>0?l:void 0,previousDueAt:t.lastCompletedAt,nextDueAt:void 0},routing:{escalationLevel:i,channels:t.notificationChannels||[]},delivery:{dedupeKey:s,attempt:a}}}buildDedupeKey(e,t){const s=new Date(t.dueAt).toISOString().slice(0,16);return`${e}:${t.id}:${s}`}isDuplicate(e){return this.dedupeKeys.has(e)?!0:this.queue.some(t=>t.payload.delivery.dedupeKey===e)}markDelivered(e){if(this.dedupeKeys.add(e),this.dedupeKeys.size>Qs){const t=Array.from(this.dedupeKeys).slice(-Qs);this.dedupeKeys=new Set(t)}}enqueue(e){const t=Date.now();if(this.queue.length>=fn){const s=this.queue.length-fn+1;this.queue.splice(0,s),console.warn(`Event queue capped at ${fn}. Dropped ${s} oldest entr${s===1?"y":"ies"}.`)}this.queue.push({id:`${e.delivery.dedupeKey}:${e.delivery.attempt}`,payload:e,attempt:e.delivery.attempt,nextAttemptAt:new Date(t+this.getRetryDelay(e.delivery.attempt)).toISOString()}),this.persistQueue()}getRetryDelay(e){const t=vd*Math.pow(2,e-1);return Math.min(t,fd)}async generateSignature(e,t){try{if(typeof crypto<"u"&&crypto.subtle){const s=new TextEncoder,a=s.encode(t),i=s.encode(e),o=await crypto.subtle.importKey("raw",a,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),c=await crypto.subtle.sign("HMAC",o,i);return Array.from(new Uint8Array(c)).map(u=>u.toString(16).padStart(2,"0")).join("")}return console.warn("Web Crypto API not available - signature generation disabled"),""}catch(s){return console.error("Failed to generate signature:",s),""}}async buildHeaders(e){const t=JSON.stringify(e),s=new Date().toISOString();let a="";this.config.n8n.sharedSecret&&(a=await this.generateSignature(t+s,this.config.n8n.sharedSecret));const i={"Content-Type":"application/json","X-Shehab-Event":e.event,"X-Shehab-Timestamp":s};return a&&(i["X-Shehab-Signature"]=a),this.config.n8n.sharedSecret&&(i["X-Shehab-Note-Secret"]=this.config.n8n.sharedSecret),i}async sendPayload(e,t=!1){try{const s=JSON.stringify(e),a=await this.buildHeaders(e),i=await this.fetcher(this.config.n8n.webhookUrl,{method:"POST",headers:a,body:s});if(!i.ok)return console.error("n8n webhook failed:",i.statusText),!1;if(t){const o=await i.json().catch(()=>null);return!!(o&&o.ok)}return!0}catch(s){return console.error("Failed to send n8n event:",s),!1}}}const en=class en{constructor(e){T(this,"plugin");T(this,"isInitialized",!1);T(this,"storage");T(this,"repository");T(this,"scheduler");T(this,"eventService");this.plugin=e}static getInstance(e){if(!en.instance){if(!e)return null;en.instance=new en(e)}return en.instance}async initialize(){if(this.isInitialized){Ct("TaskManager already initialized");return}X("Initializing TaskManager"),this.storage=new nd(this.plugin),await this.storage.init(),this.repository=new sd(this.storage),this.eventService=new hd(this.plugin),await this.eventService.init(),this.scheduler=new od(this.storage,ir,this.plugin),this.eventService.bindScheduler(this.scheduler),this.isInitialized=!0,X("TaskManager initialized successfully")}async start(e,t){if(!this.isInitialized)throw new Error("TaskManager must be initialized before starting");e&&this.scheduler.on("task:due",({task:s})=>e(s)),t&&this.scheduler.on("task:overdue",({task:s})=>t(s)),this.scheduler.start(),await this.scheduler.recoverMissedTasks(),X("TaskManager started")}async destroy(){X("Destroying TaskManager"),this.scheduler&&this.scheduler.stop(),this.eventService&&await this.eventService.shutdown(),this.storage&&await this.storage.flush(),this.isInitialized=!1,en.instance=null,X("TaskManager destroyed")}getStorage(){return this.ensureInitialized(),this.storage}getRepository(){return this.ensureInitialized(),this.repository}getScheduler(){return this.ensureInitialized(),this.scheduler}getEventService(){return this.ensureInitialized(),this.eventService}isReady(){return this.isInitialized}ensureInitialized(){if(!this.isInitialized)throw new Error("TaskManager is not initialized. Call initialize() first.")}};T(en,"instance",null);let Cs=en;function _d(n,e){n.addCommand({langKey:"createRecurringTask",hotkey:"‚åò‚áßR",callback:()=>{md()}}),n.addCommand({langKey:"openRecurringTasksDock",hotkey:"‚åò‚áßT",callback:()=>{n.openDock()}}),n.addCommand({langKey:"quickCompleteNextTask",hotkey:"‚åò‚áßD",callback:async()=>{await kd(e)}}),X("Registered slash commands and hotkeys")}function md(){Ze.emit("task:create",{source:"command"});const n=new CustomEvent("recurring-task-create",{detail:{source:"command"}});window.dispatchEvent(n)}async function kd(n){try{const e=n.getTodayAndOverdueTasks();if(e.length===0){X("No tasks due today");return}const t=e[0];Ze.emit("task:complete",{taskId:t.id});const s=new CustomEvent("recurring-task-complete",{detail:{taskId:t.id}});window.dispatchEvent(s),X(`Quick completing task: ${t.name}`)}catch(e){_e("Failed to quick complete task",e)}}function ai(n,e){Ze.emit("task:snooze",{taskId:n,minutes:e}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:n,minutes:e}})),X(`Snoozing task ${n} for ${e} minutes`)}function gd(n){const e=new Date,t=new Date(e);t.setDate(t.getDate()+1);const s=ca(t),a=Math.max(0,Math.floor((s.getTime()-e.getTime())/(60*1e3)));Ze.emit("task:snooze",{taskId:n,minutes:a}),window.dispatchEvent(new CustomEvent("task-snooze",{detail:{taskId:n,minutes:a}})),X(`Snoozing task ${n} to tomorrow`)}function pd(n){n.eventBus.on("click-blockicon",({detail:e})=>{var o,c,l;const t=e.blockElements;if(!t||t.length===0)return;const s=t[0],a=s==null?void 0:s.getAttribute("data-node-id");if(!a)return;const i=(s==null?void 0:s.textContent)||"";e.menu.addItem({icon:"iconCalendar",label:((o=n.i18n)==null?void 0:o.createRecurringTask)||"Create Recurring Task",click:()=>{Ze.emit("task:create",{source:"block-menu",linkedBlockId:a,linkedBlockContent:i,suggestedName:ii(i),suggestedTime:ri(i)}),window.dispatchEvent(new CustomEvent("recurring-task-create",{detail:{source:"block-menu",linkedBlockId:a,linkedBlockContent:i,suggestedName:ii(i),suggestedTime:ri(i)}}))}});try{const u=Cs.getInstance();if(u&&u.isReady()){const h=u.getRepository().getTaskByBlockId(a);if(h){e.menu.addSeparator(),e.menu.addItem({icon:"iconCheck",label:((c=n.i18n)==null?void 0:c.completeTask)||"Complete Task",click:()=>{Ze.emit("task:complete",{taskId:h.id}),window.dispatchEvent(new CustomEvent("recurring-task-complete",{detail:{taskId:h.id}}))}});const g=[{label:"15 minutes",click:()=>ai(h.id,15)},{label:"1 hour",click:()=>ai(h.id,60)},{label:"Tomorrow",click:()=>gd(h.id)}];e.menu.addItem({icon:"iconClock",label:((l=n.i18n)==null?void 0:l.snoozeTask)||"Snooze Task",submenu:g})}}}catch{dr("TaskManager not available for quick actions")}}),X("Registered block context menu")}function ii(n){const e=n.split(`
`)[0].trim();return e.length>50?e.substring(0,50)+"...":e}function ri(n){var s;const e=/\b(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)?\b/,t=n.match(e);if(t){let a=parseInt(t[1],10);const i=t[2],o=(s=t[3])==null?void 0:s.toUpperCase();return o==="PM"&&a<12?a+=12:o==="AM"&&a===12&&(a=0),`${a.toString().padStart(2,"0")}:${i}`}return null}class yd{constructor(e,t){T(this,"plugin");T(this,"repository");T(this,"topbarElement",null);T(this,"updateIntervalId",null);this.plugin=e,this.repository=t}init(){this.createTopbarButton(),this.startAutoUpdate(),X("Topbar menu initialized")}destroy(){this.updateIntervalId!==null&&(window.clearInterval(this.updateIntervalId),this.updateIntervalId=null),this.topbarElement&&(this.topbarElement.remove(),this.topbarElement=null),X("Topbar menu destroyed")}createTopbarButton(){const e=this.plugin.addTopBar({icon:"iconCalendar",title:"Recurring Tasks",position:"right",callback:()=>{this.toggleMenu()}});this.topbarElement=e,this.updateBadge()}updateBadge(){if(!this.topbarElement)return;const e=this.repository.getTodayAndOverdueTasks(),t=e.filter(s=>{const a=new Date(s.dueAt);return a<new Date&&!Ta(a)}).length;if(e.length>0){const s=this.topbarElement.querySelector(".b3-badge");if(s)s.textContent=e.length.toString(),s.style.display="block",t>0?s.style.backgroundColor="var(--b3-theme-error)":s.style.backgroundColor="var(--b3-theme-primary)";else{const a=document.createElement("span");a.className="b3-badge",a.textContent=e.length.toString(),a.style.display="block",a.style.backgroundColor=t>0?"var(--b3-theme-error)":"var(--b3-theme-primary)",this.topbarElement.appendChild(a)}}else{const s=this.topbarElement.querySelector(".b3-badge");s&&s.remove()}}toggleMenu(){Ze.emit("task:settings",{action:"toggle"});const e=new CustomEvent("recurring-task-settings",{detail:{action:"toggle"}});window.dispatchEvent(e)}startAutoUpdate(){this.updateIntervalId=window.setInterval(()=>{this.updateBadge()},60*1e3)}update(){this.updateBadge()}}class wd extends fa.Plugin{constructor(){super(...arguments);T(this,"taskManager");T(this,"repository");T(this,"scheduler");T(this,"eventService");T(this,"migrationManager");T(this,"topbarMenu");T(this,"dashboardComponent",null);T(this,"dockEl");T(this,"quickAddComponent",null);T(this,"quickAddContainer",null);T(this,"taskEditorComponent",null);T(this,"taskEditorContainer",null);T(this,"pendingCompletionTimeouts",new Map);T(this,"handleCreateTaskEvent",t=>{try{const s=t;X("Create task event received",s.detail),this.openQuickAdd(s.detail)}catch(s){_e("Failed to handle create task event",s),se.error("Failed to open task creator.")}});T(this,"handleSettingsEvent",t=>{try{X("Settings event received",t.detail),this.openDock()}catch(s){_e("Failed to handle settings event",s),se.error("Failed to open settings.")}});T(this,"handleCompleteTaskEvent",async t=>{try{const s=t,{taskId:a}=s.detail??{};if(!a)throw new Error("Missing taskId for completion event.");await this.handleCompleteTask(a)}catch(s){_e("Failed to complete task",s),se.error("Failed to complete task.")}});T(this,"handleSnoozeTaskEvent",async t=>{try{const s=t,{taskId:a,minutes:i}=s.detail??{};if(!a||typeof i!="number")throw new Error("Missing task snooze details.");await this.handleSnoozeTask(a,i)}catch(s){_e("Failed to snooze task",s),se.error("Failed to snooze task.")}})}async onload(){X("Loading Recurring Tasks Plugin"),this.migrationManager=new Xc(this);try{await this.migrationManager.migrate(_n)}catch(s){_e("Migration failed, continuing with existing data",s)}const t=Cs.getInstance(this);if(!t)throw new Error("TaskManager failed to initialize");this.taskManager=t,await this.taskManager.initialize(),this.repository=this.taskManager.getRepository(),this.scheduler=this.taskManager.getScheduler(),this.eventService=this.taskManager.getEventService();try{await this.taskManager.start()}catch(s){_e("Failed to start TaskManager",s)}_d(this,this.repository),pd(this),this.topbarMenu=new yd(this,this.repository),this.topbarMenu.init(),this.addDock({config:{position:"RightBottom",size:{width:400,height:600},icon:"iconCalendar",title:"Recurring Tasks"},data:null,type:Vo,init:s=>{this.dockEl=s.element,this.renderDashboard()},destroy:()=>{this.destroyDashboard()}}),this.addEventListeners(),X("Recurring Tasks Plugin loaded successfully")}async onunload(){X("Unloading Recurring Tasks Plugin"),this.pendingCompletionTimeouts.forEach(t=>{globalThis.clearTimeout(t)}),this.pendingCompletionTimeouts.clear(),this.taskManager&&await this.taskManager.destroy(),this.topbarMenu&&this.topbarMenu.destroy(),this.destroyDashboard(),this.closeQuickAdd(),this.closeTaskEditor(),this.removeEventListeners()}renderDashboard(){this.dockEl&&!this.dashboardComponent&&(this.dashboardComponent=Us(Kc,{target:this.dockEl,props:{repository:this.repository,scheduler:this.scheduler,eventService:this.eventService}}))}destroyDashboard(){this.dashboardComponent&&(Hs(this.dashboardComponent),this.dashboardComponent=null)}addEventListeners(){try{Ze.on("task:create",t=>{X("Create task event received",t),this.openQuickAdd(t)}),Ze.on("task:complete",async t=>{await this.handleCompleteTask(t.taskId)}),Ze.on("task:snooze",async t=>{await this.handleSnoozeTask(t.taskId,t.minutes)}),Ze.on("task:settings",()=>{this.openDock()}),Ze.on("task:refresh",()=>{}),window.addEventListener("recurring-task-create",this.handleCreateTaskEvent),window.addEventListener("recurring-task-settings",this.handleSettingsEvent),window.addEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.addEventListener("task-snooze",this.handleSnoozeTaskEvent)}catch(t){_e("Failed to add event listeners",t),this.removeEventListeners()}}removeEventListeners(){Ze.clear(),window.removeEventListener("recurring-task-create",this.handleCreateTaskEvent),window.removeEventListener("recurring-task-settings",this.handleSettingsEvent),window.removeEventListener("recurring-task-complete",this.handleCompleteTaskEvent),window.removeEventListener("task-snooze",this.handleSnoozeTaskEvent)}async handleCompleteTask(t){const s=this.repository.getTask(t);if(s){if(this.pendingCompletionTimeouts.has(t)){se.info(`Completion already pending for "${s.name}".`);return}const a=globalThis.setTimeout(async()=>{this.pendingCompletionTimeouts.delete(t);try{await this.eventService.handleTaskCompleted(s),await this.scheduler.markTaskDone(t),this.topbarMenu&&this.topbarMenu.update(),X(`Task completed: ${s.name}`)}catch(o){_e("Failed to finalize task completion",o),se.error("Failed to complete task.")}},5e3);this.pendingCompletionTimeouts.set(t,a);const i=()=>{const o=this.pendingCompletionTimeouts.get(t);o&&(globalThis.clearTimeout(o),this.pendingCompletionTimeouts.delete(t),se.info(`Undo: "${s.name}" restored`))};mn({message:`Task "${s.name}" completed.`,type:"success",duration:5e3,actionLabel:"Undo",onAction:i,showCountdown:!0})}}async handleSnoozeTask(t,s){const a=this.repository.getTask(t);a&&(await this.eventService.handleTaskSnoozed(a),await this.scheduler.delayTask(t,s),this.topbarMenu&&this.topbarMenu.update(),X(`Task snoozed: ${a.name} for ${s} minutes`))}openQuickAdd(t){this.quickAddComponent&&this.closeQuickAdd(),this.quickAddContainer=document.createElement("div"),document.body.appendChild(this.quickAddContainer),this.quickAddComponent=Us(Wc,{target:this.quickAddContainer,props:{repository:this.repository,prefill:t,onClose:()=>this.closeQuickAdd(),onAdvanced:()=>{this.closeQuickAdd(),this.openTaskEditor()}}})}closeQuickAdd(){this.quickAddComponent&&(Hs(this.quickAddComponent),this.quickAddComponent=null),this.quickAddContainer&&(this.quickAddContainer.remove(),this.quickAddContainer=null)}openTaskEditor(t){this.taskEditorComponent&&this.closeTaskEditor(),this.taskEditorContainer=document.createElement("div"),document.body.appendChild(this.taskEditorContainer),this.taskEditorComponent=Us(vr,{target:this.taskEditorContainer,props:{repository:this.repository,task:t,onClose:()=>this.closeTaskEditor(),onSave:()=>{window.dispatchEvent(new CustomEvent("recurring-task-refresh"))}}})}closeTaskEditor(){this.taskEditorComponent&&(Hs(this.taskEditorComponent),this.taskEditorComponent=null),this.taskEditorContainer&&(this.taskEditorContainer.remove(),this.taskEditorContainer=null)}}module.exports=wd;
